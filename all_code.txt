TOJEM Application - Full Codebase
Generated on: 07/25/2025 12:20:12


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\api\firebase.js
==================================================
// src/api/firebase.js

import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';
import { getFunctions } from 'firebase/functions'; // Import getFunctions

// Your web app's Firebase configuration from the .env.local file
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Initialize and export Firebase services
export const auth = getAuth(app);
export const db = getFirestore(app);
export const functions = getFunctions(app); // Initialize and export getFunctions

export default app;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\api\firestore.js
==================================================
// src/api/firestore.js (UPDATED with Audit Logging)
// A new `logAuditEvent` function has been added to create a secure, permanent record
// of important actions taken within the application, such as user creation or stock reconciliation.

import {
    collection,
    getDocs,
    addDoc,
    deleteDoc,
    doc,
    serverTimestamp,
    onSnapshot,
    query,
    orderBy,
    updateDoc,
    where,
    getDoc,
    writeBatch,
    setDoc,
    runTransaction,
    increment,
    limit,
    startAfter
} from 'firebase/firestore';
import { db, functions } from './firebase';
import { httpsCallable } from 'firebase/functions';

// =================================================================================================
// NEW: AUDIT LOGGING API
// =================================================================================================

/**
 * Creates a secure audit log for a sensitive action.
 * @param {string} action - The action being performed (e.g., 'user_created', 'stock_reconciled').
 * @param {string} userId - The UID of the user performing the action.
 * @param {string} userEmail - The email of the user performing the action.
 * @param {Object} details - An object containing relevant details about the event.
 * @returns {Promise}
 */
export const logAuditEvent = (action, userId, userEmail, details) => {
    const auditLogsCollection = collection(db, 'auditLogs');
    return addDoc(auditLogsCollection, {
        action,
        userId,
        userEmail,
        details,
        timestamp: serverTimestamp(),
    });
};


// =================================================================================================
// UNIFIED INVENTORY API
// =================================================================================================

const inventoryCollection = collection(db, 'inventoryItems');

export const getAllInventoryItems = async (category) => {
    let q = inventoryCollection;
    if (category) {
        q = query(inventoryCollection, where('category', '==', category));
    }
    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};

export const addInventoryItem = (itemData) => {
    if (!itemData.category) {
        return Promise.reject(new Error("Item data must include a 'category' field."));
    }
    return addDoc(inventoryCollection, { ...itemData, createdAt: serverTimestamp() });
};

export const updateInventoryItem = (itemId, updatedData) => {
    const itemDoc = doc(db, 'inventoryItems', itemId);
    const { id, ...dataToSave } = updatedData;
    return updateDoc(itemDoc, dataToSave);
};

export const deleteInventoryItem = async (itemId) => {
    const batch = writeBatch(db);
    batch.delete(doc(db, 'inventoryItems', itemId));
    const pricingSnapshot = await getDocs(query(collection(db, 'supplierItemPricing'), where('itemId', '==', itemId)));
    pricingSnapshot.forEach(priceDoc => batch.delete(priceDoc.ref));
    return batch.commit();
};

export const findInventoryItemByItemCode = async (itemCode) => {
    if (!itemCode) throw new Error("Item code is required.");
    const q = query(inventoryCollection, where("itemCode", "==", itemCode), limit(1));
    const querySnapshot = await getDocs(q);
    if (querySnapshot.empty) {
        throw new Error(`No inventory item found with code: ${itemCode}`);
    }
    const itemDoc = querySnapshot.docs[0];
    return { id: itemDoc.id, ...itemDoc.data() };
};

export const updateStockByWeight = async (itemId, grossWeight) => {
    if (!itemId || isNaN(parseFloat(grossWeight))) {
        throw new Error("Item ID and a valid gross weight are required.");
    }
    const itemRef = doc(db, 'inventoryItems', itemId);
    return runTransaction(db, async (transaction) => {
        const itemDoc = await transaction.get(itemRef);
        if (!itemDoc.exists()) throw new Error("Inventory item not found.");
        
        const itemData = itemDoc.data();
        const tareWeight = parseFloat(itemData.tareWeight) || 0;
        const unitWeight = parseFloat(itemData.unitWeight) || 1;
        if (unitWeight <= 0) throw new Error("Item has an invalid unit weight of zero or less.");

        const netWeight = parseFloat(grossWeight) - tareWeight;
        const newQuantity = Math.round(netWeight / unitWeight);
        if (newQuantity < 0) throw new Error("Calculated quantity is negative. Please check weights.");
        
        transaction.update(itemRef, { currentStock: newQuantity });
        return { newQuantity };
    });
};

// =================================================================================================
// ALL OTHER APIs
// =================================================================================================

export const logScanEvent = (jobData, newStatus, options = {}) => {
    const { haltReason = null } = options;
    const eventData = {
        employeeId: jobData.employeeId,
        employeeName: jobData.employeeName,
        jobId: jobData.jobId,
        statusUpdatedTo: newStatus,
        timestamp: serverTimestamp(),
        notes: haltReason ? `Halted: ${haltReason}` : `Status changed to ${newStatus}`,
        haltReason: haltReason,
    };
    return addDoc(collection(db, 'scanEvents'), eventData);
};

export const addKaizenSuggestion = (suggestionData) => addDoc(collection(db, 'kaizenSuggestions'), { ...suggestionData, createdAt: serverTimestamp(), status: 'new' });
export const addPraise = (praiseData) => addDoc(collection(db, 'praise'), { ...praiseData, createdAt: serverTimestamp() });
export const listenToPraiseForEmployee = (employeeId, callback) => {
    const q = query(collection(db, 'praise'), where('recipientId', '==', employeeId), orderBy('createdAt', 'desc'));
    return onSnapshot(q, (snapshot) => callback(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))));
};

export const listenToSystemStatus = (callback) => {
    const statusDocRef = doc(db, 'systemStatus', 'latest');
    return onSnapshot(statusDocRef, (doc) => {
        if (doc.exists()) {
            callback(doc.data());
        } else {
            callback({ bottleneckToolName: 'N/A', bottleneckUtilization: 0 });
        }
    });
};

export const getDepartments = async () => getDocs(collection(db, 'departments')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addDepartment = (departmentName) => addDoc(collection(db, 'departments'), { name: departmentName, requiredSkills: [] });
export const deleteDepartment = (departmentId) => deleteDoc(doc(db, 'departments', departmentId));
export const updateDepartmentRequiredSkills = async (departmentId, requiredSkillsData) => {
    const departmentDocRef = doc(db, 'departments', departmentId);
    const filteredSkillsData = requiredSkillsData.filter(skill =>
        skill.minimumProficiency > 0 || skill.importanceWeight > 0
    );
    return updateDoc(departmentDocRef, { requiredSkills: filteredSkillsData });
};
export const getDepartmentSkills = async (departmentId) => {
    if (!departmentId) return [];
    const departmentDocRef = doc(db, 'departments', departmentId);
    const departmentDoc = await getDoc(departmentDocRef);
    if (departmentDoc.exists()) {
        const data = departmentDoc.data();
        return data.requiredSkills || [];
    }
    return [];
};

export const getSkills = async () => getDocs(query(collection(db, 'skills'), orderBy('name'))).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addSkill = (skillName) => addDoc(collection(db, 'skills'), { name: skillName });
export const updateSkill = (skillId, updatedData) => updateDoc(doc(db, 'skills', skillId), updatedData);
export const deleteSkill = (skillId) => deleteDoc(doc(db, 'skills', skillId));
export const getSkillHistoryForEmployee = async (employeeId) => {
    const q = query(collection(db, 'skillHistory'), where('employeeId', '==', employeeId));
    return getDocs(q).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
};

export const getTools = async () => getDocs(collection(db, 'tools')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addTool = (toolData) => addDoc(collection(db, 'tools'), { ...toolData, associatedSkills: toolData.associatedSkills || [] });
export const deleteTool = (toolId) => deleteDoc(doc(db, 'tools', toolId));
export const getToolAccessories = async () => getDocs(collection(db, 'toolAccessories')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addToolAccessory = (accessoryData) => addDoc(collection(db, 'toolAccessories'), { ...accessoryData, associatedSkills: accessoryData.associatedSkills || [] });
export const deleteToolAccessory = (accessoryId) => deleteDoc(doc(db, 'toolAccessories', accessoryId));

export const getEmployees = async () => getDocs(collection(db, 'employees')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addEmployee = (employeeData) => addDoc(collection(db, 'employees'), employeeData);
export const deleteEmployee = (employeeId) => deleteDoc(doc(db, 'employees', employeeId));
export const getEmployeeSkills = async (employeeId) => {
    const employeeDoc = await getDoc(doc(db, 'employees', employeeId));
    return employeeDoc.exists() ? (employeeDoc.data().skills || {}) : {};
};
export const updateEmployeeSkillsAndLogHistory = async (employee, skillsData, allSkills) => {
    const batch = writeBatch(db);
    const filteredSkillsData = {};
    for (const skillId in skillsData) {
        if (skillsData[skillId] > 0) filteredSkillsData[skillId] = skillsData[skillId];
    }
    batch.update(doc(db, 'employees', employee.id), { skills: filteredSkillsData });
    const allSkillsMap = new Map(allSkills.map(s => [s.id, s.name]));
    for (const skillId in filteredSkillsData) {
        const proficiency = filteredSkillsData[skillId];
        const newHistoryRef = doc(collection(db, 'skillHistory'));
        batch.set(newHistoryRef, {
            employeeId: employee.id,
            employeeName: employee.name,
            skillId: skillId,
            skillName: allSkillsMap.get(skillId) || 'Unknown Skill',
            proficiency: proficiency,
            assessmentDate: serverTimestamp()
        });
    }
    return batch.commit();
};

export const getSuppliers = async () => getDocs(collection(db, 'suppliers')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addSupplier = (supplierData) => addDoc(collection(db, 'suppliers'), supplierData);
export const updateSupplier = (supplierId, updatedData) => updateDoc(doc(db, 'suppliers', supplierId), updatedData);
export const deleteSupplier = (supplierId) => deleteDoc(doc(db, 'suppliers', supplierId));
export const getSupplierPricingForItem = async (itemId) => {
    if (!itemId) return [];
    const q = query(collection(db, 'supplierItemPricing'), where('itemId', '==', itemId));
    return getDocs(q).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
};
export const addSupplierPrice = (priceData) => addDoc(collection(db, 'supplierItemPricing'), priceData);
export const updateSupplierPrice = (priceId, updatedData) => updateDoc(doc(db, 'supplierItemPricing', priceId), updatedData);
export const deleteSupplierPrice = (priceId) => deleteDoc(doc(db, 'supplierItemPricing', priceId));

export const getOverheadCategories = async () => getDocs(collection(db, 'overheadsCategories')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addOverheadCategory = (categoryData) => addDoc(collection(db, 'overheadsCategories'), categoryData);
export const updateOverheadCategory = (categoryId, updatedData) => updateDoc(doc(db, 'overheadsCategories', categoryId), updatedData);
export const deleteOverheadCategory = async (categoryId) => {
    const categoryDocRef = doc(db, 'overheadsCategories', categoryId);
    const expensesSnapshot = await getDocs(collection(categoryDocRef, 'expenses'));
    const batch = writeBatch(db);
    expensesSnapshot.docs.forEach(expDoc => batch.delete(expDoc.ref));
    batch.delete(categoryDocRef);
    return batch.commit();
};
export const getOverheadExpenses = async (categoryId) => getDocs(collection(db, 'overheadsCategories', categoryId, 'expenses')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addOverheadExpense = (categoryId, expenseData) => addDoc(collection(db, 'overheadsCategories', categoryId, 'expenses'), expenseData);
export const updateOverheadExpense = (categoryId, expenseId, updatedData) => updateDoc(doc(db, 'overheadsCategories', categoryId, 'expenses', expenseId), updatedData);
export const deleteOverheadExpense = (categoryId, expenseId) => deleteDoc(doc(db, 'overheadsCategories', categoryId, 'expenses', expenseId));

const purchaseQueueCollection = collection(db, 'purchaseQueue');
export const getPurchaseQueue = async () => {
    const snapshot = await getDocs(purchaseQueueCollection);
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};
export const listenToPurchaseQueue = (callback) => {
    const q = query(purchaseQueueCollection, orderBy('queuedAt', 'desc'));
    return onSnapshot(q, (snapshot) => callback(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))));
};
export const addToPurchaseQueue = (itemData) => addDoc(purchaseQueueCollection, { ...itemData, status: 'pending', queuedAt: serverTimestamp() });
export const markItemsAsOrdered = async (supplier, itemsToOrder, orderQuantities) => {
    const batch = writeBatch(db);
    itemsToOrder.forEach(item => {
        const docRef = doc(db, 'purchaseQueue', item.id);
        const recommendedQty = Math.max(0, (item.standardStockLevel || 0) - (item.currentStock || 0));
        const orderQty = orderQuantities[item.id] || recommendedQty;
        batch.update(docRef, {
            status: 'ordered',
            orderDate: serverTimestamp(),
            orderedQty: Number(orderQty),
            orderedFromSupplierId: supplier.id,
            orderedFromSupplierName: supplier.name
        });
    });
    return batch.commit();
};
export const receiveStockAndUpdateInventory = async (queuedItem, quantityReceived) => {
    if (!queuedItem || !quantityReceived || quantityReceived <= 0) throw new Error("Invalid item or quantity.");
    const inventoryDocRef = doc(db, 'inventoryItems', queuedItem.itemId);
    const purchaseQueueDocRef = doc(db, 'purchaseQueue', queuedItem.id);
    return runTransaction(db, async (transaction) => {
        const inventoryDoc = await transaction.get(inventoryDocRef);
        if (!inventoryDoc.exists()) throw new Error("Original inventory item not found.");
        transaction.update(inventoryDocRef, { currentStock: increment(Number(quantityReceived)) });
        transaction.update(purchaseQueueDocRef, { status: 'completed' });
    });
};
export const requeueOrDeleteItem = async (queuedItem) => {
    const inventoryDocRef = doc(db, 'inventoryItems', queuedItem.itemId);
    const purchaseQueueDocRef = doc(db, 'purchaseQueue', queuedItem.id);
    const inventoryDoc = await getDoc(inventoryDocRef);
    if (!inventoryDoc.exists()) return deleteDoc(purchaseQueueDocRef);
    const itemData = inventoryDoc.data();
    if (itemData.currentStock < itemData.reorderLevel) {
        return updateDoc(purchaseQueueDocRef, { status: 'pending' });
    } else {
        return deleteDoc(purchaseQueueDocRef);
    }
};

export const getJobStepDetails = async () => getDocs(collection(db, 'jobStepDetails')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const setJobStepDetail = (productId, departmentId, data) => {
    const recipeId = `${productId}_${departmentId}`;
    const docRef = doc(db, 'jobStepDetails', recipeId);
    return setDoc(docRef, { ...data, productId, departmentId });
};
export const getRecipeForProductDepartment = async (productId, departmentId) => {
    const recipeId = `${productId}_${departmentId}`;
    const docSnap = await getDoc(doc(db, 'jobStepDetails', recipeId));
    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
};
export const updateStandardRecipe = async (jobData) => {
    if (!jobData.partId || !jobData.departmentId) {
        throw new Error("Cannot update recipe without a valid Part ID and Department ID.");
    }
    const recipeId = `${jobData.partId}_${jobData.departmentId}`;
    const recipeRef = doc(db, 'jobStepDetails', recipeId);
    const recipeDataToUpdate = {
        description: jobData.description,
        estimatedTime: jobData.estimatedTime,
        steps: jobData.steps.map((step, index) => ({ text: step, time: 0, order: index })),
        tools: jobData.tools.map(tool => tool.id),
        accessories: jobData.accessories.map(acc => acc.id),
        consumables: jobData.consumables,
    };
    return updateDoc(recipeRef, recipeDataToUpdate);
};

const jobCardsCollection = collection(db, 'createdJobCards');
export const addJobCard = (jobCardData) => addDoc(jobCardsCollection, { ...jobCardData, createdAt: serverTimestamp() });

export const listenToJobCards = (callback, options = {}) => {
    const jobsCollectionRef = collection(db, 'createdJobCards');
    let q = query(jobsCollectionRef, orderBy('createdAt', 'desc'));
    if (options.limit) {
        if (options.startAfter) {
            q = query(q, startAfter(options.startAfter));
        }
        q = query(q, limit(options.limit));
        
        return onSnapshot(q, (snapshot) => {
            const jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const lastVisible = snapshot.docs[snapshot.docs.length - 1];
            callback({ jobs, lastVisible }); 
        }, (error) => {
            console.error("Error listening to paginated job cards:", error);
        });
    } else {
        return onSnapshot(q, (snapshot) => {
            const jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            callback(jobs);
        }, (error) => {
            console.error("Error listening to all job cards:", error);
        });
    }
};

export const getJobByJobId = async (jobId) => {
    const q = query(jobCardsCollection, where("jobId", "==", jobId));
    const querySnapshot = await getDocs(q);
    if (querySnapshot.empty) throw new Error(`No job found with ID: ${jobId}`);
    const jobDoc = querySnapshot.docs[0];
    return { id: jobDoc.id, ...jobDoc.data() };
};
export const updateJobPriorities = async (orderedJobs) => {
    const batch = writeBatch(db);
    orderedJobs.forEach((job, index) => {
        const jobRef = doc(db, 'createdJobCards', job.id);
        batch.update(jobRef, { priority: index });
    });
    return batch.commit();
};

export const getJobsAwaitingQC = async () => {
    const q = query(jobCardsCollection, where('status', '==', 'Awaiting QC'));
    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};
export const updateJobCardWithAdjustments = (jobId, timeAdjustment, consumableAdjustments, adjustmentReason, userId) => {
    const updateFn = httpsCallable(functions, 'updateJobCardWithAdjustments');
    return updateFn({ jobId, timeAdjustment, consumableAdjustments, adjustmentReason, userId });
};
export const processQcDecision = async (job, isApproved, options = {}) => {
    const { rejectionReason = '', preventStockDeduction = false, reworkDetails = null } = options;
    return runTransaction(db, async (transaction) => {
        const jobRef = doc(db, 'createdJobCards', job.id);
        const jobDoc = await transaction.get(jobRef);
        if (!jobDoc.exists()) throw "Job document does not exist!";
        const currentJobData = jobDoc.data();
        const dataToUpdate = {};
        if (isApproved) {
            dataToUpdate.status = 'Complete';
            if (!currentJobData.completedAt) dataToUpdate.completedAt = serverTimestamp();
            if (job.partId) {
                const productRef = doc(db, 'inventoryItems', job.partId);
                transaction.update(productRef, { currentStock: increment(job.quantity || 1) });
            }
        } else {
            if (reworkDetails && reworkDetails.requeue) {
                dataToUpdate.status = 'Pending';
                dataToUpdate.issueReason = `REWORK: ${rejectionReason}`;
                dataToUpdate.employeeId = reworkDetails.newEmployeeId || job.employeeId;
                dataToUpdate.employeeName = reworkDetails.newEmployeeName || job.employeeName;
                dataToUpdate.completedAt = null;
            } else {
                dataToUpdate.status = 'Issue';
                dataToUpdate.issueReason = rejectionReason;
            }
        }
        if (!preventStockDeduction && currentJobData.processedConsumables?.length > 0) {
            for (const consumable of currentJobData.processedConsumables) {
                const itemRef = doc(db, 'inventoryItems', consumable.id);
                transaction.update(itemRef, { currentStock: increment(-consumable.quantity) });
            }
        }
        transaction.update(jobRef, dataToUpdate);
    });
};

export const updateDocument = async (collectionName, docId, data) => {
    const docRef = doc(db, collectionName, docId);
    const dataToSave = { ...data };
    delete dataToSave.id;
    return updateDoc(docRef, dataToSave);
};
export const deleteDocument = async (collectionName, docId) => {
    const docRef = doc(db, collectionName, docId);
    return deleteDoc(docRef);
};

export const getProducts = async () => getAllInventoryItems('Product');
export const addProduct = async (productData) => {
    const q = query(inventoryCollection, where("partNumber", "==", productData.partNumber), where("category", "==", "Product"));
    const querySnapshot = await getDocs(q);
    if (!querySnapshot.empty) throw new Error(`A product with Part Number "${productData.partNumber}" already exists.`);
    return addInventoryItem({ ...productData, category: 'Product' });
};
export const updateProduct = (productId, updatedData) => updateInventoryItem(productId, updatedData);
export const deleteProduct = (productId) => deleteInventoryItem(productId);

const productCategoriesCollection = collection(db, 'productCategories');
export const getProductCategories = async () => getDocs(query(productCategoriesCollection, orderBy('name'))).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addProductCategory = (categoryName) => addDoc(productCategoriesCollection, { name: categoryName });
export const deleteProductCategory = (categoryId) => deleteDoc(doc(db, 'productCategories', categoryId));

const productRecipeLinksCollection = collection(db, 'productRecipeLinks');
export const getLinkedRecipesForProduct = async (productId) => {
    const q = query(productRecipeLinksCollection, where('productId', '==', productId));
    return getDocs(q).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
};
export const linkRecipeToProduct = (linkData) => addDoc(productRecipeLinksCollection, linkData);
export const unlinkRecipeFromProduct = (linkId) => deleteDoc(doc(db, 'productRecipeLinks', linkId));

export const getCompletedJobsInRange = async (startDate, endDate) => {
    const q = query(jobCardsCollection, where('status', '==', 'Complete'), where('completedAt', '>=', startDate), where('completedAt', '<=', endDate));
    return getDocs(q).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
};
export const getCompletedJobsForEmployee = async (employeeId) => {
    if (!employeeId) return [];
    const q = query(jobCardsCollection, where('employeeId', '==', employeeId), where('status', 'in', ['Complete', 'Issue', 'Archived - Issue']));
    return getDocs(q).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
};

export const getAllUsers = async () => getDocs(collection(db, 'users')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const updateUserRole = async (userId, newRole, discountPercentage, companyName) => {
    const dataToUpdate = { role: newRole };
    if (discountPercentage !== undefined) dataToUpdate.discountPercentage = Number(discountPercentage) || 0;
    if (companyName !== undefined) dataToUpdate.companyName = companyName;
    return setDoc(doc(db, 'users', userId), dataToUpdate, { merge: true });
};
export const createUserWithRole = httpsCallable(functions, 'createUserAndSetRole');
export const deleteUserWithRole = httpsCallable(functions, 'deleteUserAndRole');

export const getRoles = async () => getDocs(collection(db, 'roles')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));

export const getCampaigns = async () => getDocs(query(collection(db, 'marketingCampaigns'), orderBy('startDate', 'desc'))).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addCampaign = (campaignData) => addDoc(collection(db, 'marketingCampaigns'), { ...campaignData, leadsGenerated: 0, createdAt: serverTimestamp() });
export const updateCampaign = (campaignId, updatedData) => updateDoc(doc(db, 'marketingCampaigns', campaignId), updatedData);
export const deleteCampaign = (campaignId) => deleteDoc(doc(db, 'marketingCampaigns', campaignId));

export const getTrainingResources = async () => getDocs(collection(db, 'trainingResources')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addTrainingResource = (data) => addDoc(collection(db, 'trainingResources'), data);
export const updateTrainingResource = (id, data) => updateDoc(doc(db, 'trainingResources', id), data);
export const deleteTrainingResource = (id) => deleteDoc(doc(db, 'trainingResources', id));

export const addSubcontractorAdHocLog = (logData) => addDoc(collection(db, 'subcontractorAdHocLogs'), { ...logData, createdAt: serverTimestamp() });
export const addSubcontractorTeamLog = (logData) => addDoc(collection(db, 'subcontractorTeamLogs'), { ...logData, createdAt: serverTimestamp() });

export const addQuote = (quoteData) => addDoc(collection(db, 'quotes'), { ...quoteData, status: 'draft', createdAt: serverTimestamp() });
export const createSalesOrderFromQuote = async (quote) => {
    const batch = writeBatch(db);
    const salesOrderRef = doc(collection(db, 'salesOrders'));
    batch.set(salesOrderRef, {
        salesOrderId: `SO-${quote.quoteId.replace('Q-', '')}`,
        customerName: quote.customerName,
        customerEmail: quote.customerEmail,
        total: quote.total,
        status: 'Pending Production',
        createdAt: serverTimestamp(),
        lineItems: quote.lineItems.map(item => ({ ...item, id: doc(collection(db, '_')).id, status: 'Pending' }))
    });
    batch.update(doc(db, 'quotes', quote.id), { status: 'Accepted' });
    return batch.commit();
};
export const listenToSalesOrders = (callback) => onSnapshot(query(collection(db, 'salesOrders'), orderBy('createdAt', 'desc')), s => callback(s.docs.map(d => ({ id: d.id, ...d.data() }))));
export const listenToOneOffPurchases = (callback) => onSnapshot(query(collection(db, 'oneOffPurchases'), orderBy('createdAt', 'desc')), s => callback(s.docs.map(d => ({ id: d.id, ...d.data() }))));
export const addPurchasedItemToQueue = (lineItem, salesOrder) => addDoc(collection(db, 'oneOffPurchases'), {
    itemName: lineItem.description,
    quantity: lineItem.quantity,
    estimatedCost: lineItem.unitCost,
    salesOrderId: salesOrder.salesOrderId,
    customerName: salesOrder.customerName,
    status: 'Pending Purchase',
    createdAt: serverTimestamp()
});
export const markOneOffItemsAsOrdered = async (itemIds) => {
    const batch = writeBatch(db);
    itemIds.forEach(id => batch.update(doc(db, 'oneOffPurchases', id), { status: 'Ordered' }));
    return batch.commit();
};
export const updateSalesOrderLineItemStatus = async (orderId, lineItemId, newStatus) => {
    const orderRef = doc(db, 'salesOrders', orderId);
    const orderDoc = await getDoc(orderRef);
    if (!orderDoc.exists()) throw new Error("Sales Order not found");
    const updatedLineItems = orderDoc.data().lineItems.map(item =>
        item.id === lineItemId ? { ...item, status: newStatus } : item
    );
    return updateDoc(orderRef, { lineItems: updatedLineItems });
};

export const updateStockCount = async (itemId, category, newCount, sessionId) => {
    const itemRef = doc(db, 'inventoryItems', itemId);
    return updateDoc(itemRef, {
        currentStock: Number(newCount),
        lastCountedInSessionId: sessionId
    });
};

export const reconcileStockLevels = async (itemsToReconcile) => {
    const BATCH_LIMIT = 500;
    const batches = [];
    
    for (let i = 0; i < itemsToReconcile.length; i += BATCH_LIMIT) {
        const batch = writeBatch(db);
        const chunk = itemsToReconcile.slice(i, i + BATCH_LIMIT);
        for (const item of chunk) {
            const itemRef = doc(db, 'inventoryItems', item.id);
            batch.update(itemRef, { currentStock: item.newCount });
        }
        batches.push(batch.commit());
    }

    return Promise.all(batches);
};

export const submitCustomerOrder = httpsCallable(functions, 'submitCustomerOrder');
export const listenToCustomerSalesOrders = (customerEmail, callback) => {
    const q = query(collection(db, 'salesOrders'), where('customerEmail', '==', customerEmail));
    return onSnapshot(q, (snapshot) => {
        const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        orders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
        callback(orders);
    });
};
export const listenToJobsForSalesOrder = (salesOrderId, callback) => {
    if (!salesOrderId) return () => {};
    const q = query(collection(db, 'createdJobCards'), where('salesOrderId', '==', salesOrderId));
    return onSnapshot(q, (snapshot) => callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
};
export const addCustomerFeedback = (feedbackData) => addDoc(collection(db, 'customerFeedback'), { ...feedbackData, submittedAt: serverTimestamp() });

export const getReworkReasons = async () => getDocs(query(collection(db, 'reworkReasons'), orderBy('name'))).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const giveKudosToJob = (jobId) => updateDoc(doc(db, 'createdJobCards', jobId), { kudos: true });
export const listenToReworkQueue = (callback) => {
    const q = query(collection(db, 'createdJobCards'), where('status', 'in', ['Issue', 'Halted - Issue']));
    return onSnapshot(q, (snapshot) => callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
};
export const resolveReworkJob = (jobDocId) => updateDoc(doc(db, 'createdJobCards', jobDocId), { status: 'Pending', issueReason: 'Rework Resolved - Re-queued' });

export const getRoutineTasks = async () => getDocs(query(collection(db, 'routineTasks'), orderBy('timeOfDay'))).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addRoutineTask = (taskData) => addDoc(collection(db, 'routineTasks'), taskData);
export const updateRoutineTask = (taskId, updatedData) => updateDoc(doc(db, 'routineTasks', taskId), updatedData);
export const deleteRoutineTask = (taskId) => deleteDoc(doc(db, 'routineTasks', taskId));

export const listenToPickingLists = (callback) => {
    const q = query(collection(db, 'pickingLists'), where('status', '==', 'pending'));
    return onSnapshot(q, (snapshot) => {
        const lists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        lists.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
        callback(lists);
    });
};
export const markPickingListAsCompleted = (listId) => updateDoc(doc(db, 'pickingLists', listId), { status: 'completed' });

export const getClientUsers = async () => getDocs(query(collection(db, 'users'), where('role', '==', 'Client'))).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const listenToConsignmentStockForClient = (clientId, callback) => {
    if (!clientId) return () => {};
    const q = query(collection(db, 'consignmentStock'), where('clientId', '==', clientId), orderBy('productName'));
    return onSnapshot(q, (snapshot) => callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
};
export const addConsignmentItem = (itemData) => addDoc(collection(db, 'consignmentStock'), { ...itemData, lastCounted: serverTimestamp() });
export const updateConsignmentStockCounts = async (updates) => {
    if (!updates || updates.length === 0) return;
    const batch = writeBatch(db);
    updates.forEach(update => {
        batch.update(doc(db, 'consignmentStock', update.id), { 
            quantity: Number(update.newCount),
            lastCounted: serverTimestamp()
        });
    });
    return batch.commit();
};

export const getLearningPaths = async () => getDocs(query(collection(db, 'learningPaths'), orderBy('name'))).then(s => s.docs.map(d => ({ id: d.id, ...d.data() })));
export const addLearningPath = (pathData) => addDoc(collection(db, 'learningPaths'), { ...pathData, skillIds: [] });
export const updateLearningPath = (pathId, updatedData) => updateDoc(doc(db, 'learningPaths', pathId), updatedData);
export const deleteLearningPath = (pathId) => deleteDoc(doc(db, 'learningPaths', pathId));

// Export `collection`, `query`, and `where` to be used in other files if needed
export { collection, query, where, getDocs, onSnapshot };



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\api\firestore.test.js
==================================================
// src/api/firestore.test.js

/**
 * @jest-environment node
 */
// Import all as firebaseTesting and then destructure to handle potential module export variations
import * as firebaseTesting from '@firebase/rules-unit-testing';
import { doc, getDoc, setDoc, deleteDoc } from 'firebase/firestore';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url'; // Import fileURLToPath for ES Modules

// Destructure the necessary components from the imported module
const { initializeTestEnvironment, assertFails, assertSucceeds, RulesTestEnvironment } = firebaseTesting;

// FIX for __dirname in ES Modules: Get the current directory from import.meta.url
// This correctly resolves the path for modules when __dirname is not available.
const currentDir = fileURLToPath(new URL('.', import.meta.url));

// We are now reading your actual security rules file to load into the test environment.
// Use currentDir instead of __dirname
const firestoreRules = fs.readFileSync(path.resolve(currentDir, '../../firestore.rules'), 'utf8');

// Mock the actual firestore.js functions we want to test
// In a real application, updateStockByWeight_logic would likely be imported from another file.
// For testing purposes, it's defined here to be directly callable.
const updateStockByWeight_logic = async (db, itemId, grossWeight) => {
    const itemRef = doc(db, 'inventoryItems', itemId);
    // In a real scenario, this would ideally be wrapped in a transaction to ensure atomicity.
    // For unit testing the logic, a direct get/set is often sufficient if not testing transaction integrity itself.
    const itemDoc = await getDoc(itemRef);
    if (!itemDoc.exists()) {
        throw new Error("Inventory item not found.");
    }
    const itemData = itemDoc.data();
    const tareWeight = parseFloat(itemData.tareWeight) || 0;
    const unitWeight = parseFloat(itemData.unitWeight) || 1; // Default to 1 to prevent division by zero

    if (unitWeight <= 0) {
        throw new Error("Item has an invalid unit weight of zero or less.");
    }
    
    const netWeight = parseFloat(grossWeight) - tareWeight;
    // Ensure newQuantity is a whole number as stock usually is. Round to nearest integer.
    const newQuantity = Math.round(netWeight / unitWeight);

    if (newQuantity < 0) {
        throw new Error("Calculated quantity is negative. Please check weights.");
    }

    // Update the document with the new stock quantity
    await setDoc(itemRef, { currentStock: newQuantity }, { merge: true });
    return { newQuantity }; // Return the calculated quantity for assertion
};


describe('Firestore API Tests', () => {
  let testEnv; // Variable to hold the test environment instance

  // Set up the test environment before all tests in this describe block run
  beforeAll(async () => {
    testEnv = await initializeTestEnvironment({
      projectId: 'tojem-os-test-environment', // A unique project ID for this test environment
      firestore: {
        rules: firestoreRules, // Load the Firestore security rules from the file
        host: 'localhost',    // Connect to the local Firebase Emulator Suite
        port: 8080,           // Default Firestore emulator port
      },
    });
  });

  // Clean up the test environment after all tests are done
  afterAll(async () => {
    await testEnv.cleanup(); // Shut down the emulators and clean up resources
  });

  // Clear the database before each test to ensure a clean slate for independent tests
  beforeEach(async () => {
    await testEnv.clearFirestore(); // Clears all data from the Firestore emulator
  });

  describe('updateStockByWeight', () => {
    it('should correctly calculate and update the stock quantity from weight', async () => {
      // Get a database instance for an authenticated user with a 'Manager' role
      // This context allows us to test rules that depend on user authentication/roles.
      const managerDb = testEnv.authenticatedContext('manager_user', { role: 'Manager' }).firestore();
      
      // 1. Setup: Create a mock inventory item in the test database
      const testItemId = 'test-item-123';
      const itemRef = doc(managerDb, 'inventoryItems', testItemId);
      await setDoc(itemRef, {
        name: 'Test Bolt',
        unitWeight: 2.5, // Each bolt weighs 2.5g
        tareWeight: 50,  // The container weighs 50g
        currentStock: 100 // The old stock count (will be updated)
      });

      // 2. Action: Run the function we want to test
      // If grossWeight is 550g, and tare is 50g, net is 500g.
      // 500g / 2.5g/bolt = 200 bolts.
      const grossWeight = 550; 
      const result = await updateStockByWeight_logic(managerDb, testItemId, grossWeight);

      // 3. Assertion: Verify the results
      expect(result.newQuantity).toBe(200);

      // Verify that the database itself was updated correctly
      const updatedItemDoc = await getDoc(itemRef);
      expect(updatedItemDoc.exists()).toBe(true);
      expect(updatedItemDoc.data().currentStock).toBe(200);
    });

    it('should throw an error if the item does not exist', async () => {
        // Get a database instance for a manager
        const managerDb = testEnv.authenticatedContext('manager_user', { role: 'Manager' }).firestore();
        // Expect the function to reject (throw an error) with the specified message
        await expect(updateStockByWeight_logic(managerDb, 'non-existent-item', 100)).rejects.toThrow("Inventory item not found.");
    });

    // You can add more tests here, for example:
    // - Test with unitWeight = 0 or negative
    // - Test with negative calculated quantity
    // - Test with different roles and assertFails based on your security rules
  });
});


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\api\jobUtils.test.js
==================================================
// src/utils/jobUtils.test.js

/**
 * @jest-environment node
 */
import { calculateJobDuration } from './jobUtils';

// Helper to create mock date objects from seconds for consistent testing
// This mimics how Firebase/Firestore Timestamps behave, having a .toDate() method.
const createTimestamp = (seconds) => ({ 
    seconds: seconds, 
    nanoseconds: 0, // Add nanoseconds for completeness, though not used in .toDate() here
    toDate: () => new Date(seconds * 1000) 
});

describe('calculateJobDuration', () => {

    // A fixed point in time for live calculations, in milliseconds.
    // This represents 2025-07-07T16:00:00Z UTC.
    const MOCK_CURRENT_TIME = new Date('2025-07-07T16:00:00Z').getTime();

    test('should return null if job has not started', () => {
        const job = { status: 'Pending' };
        expect(calculateJobDuration(job, MOCK_CURRENT_TIME)).toBeNull();
    });

    test('should calculate duration for a simple completed job', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720360800), // 2024-07-07T14:00:00Z (60 mins before 15:00:00)
            completedAt: createTimestamp(1720364400) // 2024-07-07T15:00:00Z
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('1h 0m 0s'); // Expected to be 1 hour
        expect(duration.totalMinutes).toBe(60);
    });

    test('should calculate duration for an active "In Progress" job', () => {
        const job = {
            status: 'In Progress',
            startedAt: createTimestamp(1720366800) // 2024-07-07T15:40:00Z
        };
        // MOCK_CURRENT_TIME is 16:00:00Z, so duration should be 20 minutes (16:00 - 15:40)
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('20m 0s');
        expect(duration.totalMinutes).toBe(20);
    });

    test('should correctly subtract paused time from a completed job', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720360800), // 2024-07-07T14:00:00Z
            completedAt: createTimestamp(1720364400), // 2024-07-07T15:00:00Z (Total 60 mins gross)
            totalPausedMilliseconds: 600000 // 10 minutes (60 - 10 = 50 mins net)
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('50m 0s');
        expect(duration.totalMinutes).toBe(50);
    });
    
    test('should calculate duration correctly for a job that is currently paused', () => {
        const job = {
            status: 'Paused',
            startedAt: createTimestamp(1720364400), // 2024-07-07T15:00:00Z
            pausedAt: createTimestamp(1720366200), // 2024-07-07T15:30:00Z (Paused after 30 mins)
            totalPausedMilliseconds: 0 // No prior paused time
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('30m 0s');
        expect(duration.totalMinutes).toBe(30);
    });

    test('should return null for jobs with inconsistent timestamps (completedAt before startedAt)', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720364400), // 15:00:00 UTC
            completedAt: createTimestamp(1720360800) // 14:00:00 UTC (Inconsistent)
        };
        expect(calculateJobDuration(job, MOCK_CURRENT_TIME)).toBeNull();
    });

    test('should calculate duration with seconds if present', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720360800), // 14:00:00 UTC
            completedAt: createTimestamp(1720360825) // 14:00:25 UTC (25 seconds)
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('0m 25s');
        expect(duration.totalMinutes).toBe(0);
    });

    test('should handle duration less than a minute', () => {
        const job = {
            status: 'In Progress',
            startedAt: createTimestamp(MOCK_CURRENT_TIME / 1000 - 45), // 45 seconds before MOCK_CURRENT_TIME
            totalPausedMilliseconds: 0
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('0m 45s');
        expect(duration.totalMinutes).toBe(0);
    });

    test('should return "0m 0s" for a job with zero duration', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720360800), // 14:00:00 UTC
            completedAt: createTimestamp(1720360800), // 14:00:00 UTC
            totalPausedMilliseconds: 0
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('0m 0s');
        expect(duration.totalMinutes).toBe(0);
    });
});


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\calendar\SchedulingAssistantModal.jsx
==================================================
// src/components/features/calendar/SchedulingAssistantModal.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { listenToJobCards, getEmployees, getSkills } from '../../../api/firestore';
import { writeBatch, doc } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import Button from '../../ui/Button';
import { X, Bot, Clock } from 'lucide-react';
import toast from 'react-hot-toast';

const SchedulingAssistantModal = ({ onClose, onScheduleComplete }) => {
    const [pendingJobs, setPendingJobs] = useState([]);
    const [allEmployees, setAllEmployees] = useState([]);
    const [allSkills, setAllSkills] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isScheduling, setIsScheduling] = useState(false);
    const [schedulePlan, setSchedulePlan] = useState([]);

    useEffect(() => {
        const unsubscribe = listenToJobCards((allJobs) => {
            const unscheduled = allJobs.filter(job => job.status === 'Pending' && !job.scheduledDate);
            setPendingJobs(unscheduled);
        });

        const fetchAdditionalData = async () => {
             try {
                const [employees, skills] = await Promise.all([
                    getEmployees(),
                    getSkills()
                ]);
                setAllEmployees(employees);
                setAllSkills(skills);
            } catch (error) {
                console.error("Error fetching employees or skills for scheduling:", error);
                toast.error("Failed to load employee/skill data for scheduling.");
            } finally {
                 setLoading(false);
            }
        };

        fetchAdditionalData();

        return () => unsubscribe();
    }, []);

    const generateSchedule = async () => {
        setIsScheduling(true);
        const workHoursPerDay = 8;
        const workMinutesPerDay = workHoursPerDay * 60;

        const availableEmployees = allEmployees.map(emp => ({
            ...emp,
            skillsMap: new Map(Object.entries(emp.skills || {})),
        }));

        const employeeAvailability = new Map(availableEmployees.map(emp => [emp.id, {
            freeUntil: new Date(),
            dailyMinutesAssigned: 0,
        }]));
        
        const plan = [];
        const sortedJobs = [...pendingJobs].sort((a, b) => (b.estimatedTime || 0) - (a.estimatedTime || 0));
        let currentDay = new Date();
        currentDay.setHours(9, 0, 0, 0);

        for (const job of sortedJobs) {
            const jobDuration = job.estimatedTime || 60;

            let assignedEmployee = null;
            let proposedStartTime = null;
            let bestEmployeeScore = -1;
            
            const requiredSkills = job.requiredSkills || [];

            for (const emp of availableEmployees) {
                let skillMatchScore = 0;
                let meetsAllMinimums = true;

                if (requiredSkills.length > 0) {
                    for (const required of requiredSkills) {
                        const employeeProficiency = emp.skillsMap.get(required.skillId) || 0;
                        if (employeeProficiency < required.minProficiency) {
                            meetsAllMinimums = false;
                            break;
                        }
                        skillMatchScore += employeeProficiency; 
                    }
                } else {
                    meetsAllMinimums = true;
                    skillMatchScore = 1;
                }

                if (!meetsAllMinimums) {
                    continue;
                }
                
                const empAvailability = employeeAvailability.get(emp.id);
                let currentEmpTime = new Date(Math.max(currentDay.getTime(), empAvailability.freeUntil.getTime()));
                currentEmpTime.setSeconds(0,0);
                while (currentEmpTime.getDay() === 0 || currentEmpTime.getDay() === 6) {
                    currentEmpTime.setDate(currentEmpTime.getDate() + 1);
                    currentEmpTime.setHours(9, 0, 0, 0);
                    empAvailability.dailyMinutesAssigned = 0;
                }
                if (currentEmpTime.getHours() < 9 || currentEmpTime.getHours() >= (9 + workHoursPerDay)) {
                    currentEmpTime.setDate(currentEmpTime.getDate() + 1);
                    currentEmpTime.setHours(9, 0, 0, 0);
                    empAvailability.dailyMinutesAssigned = 0;
                }
                if (empAvailability.dailyMinutesAssigned + jobDuration > workMinutesPerDay) {
                     currentEmpTime.setDate(currentEmpTime.getDate() + 1);
                     currentEmpTime.setHours(9, 0, 0, 0);
                     empAvailability.dailyMinutesAssigned = 0;
                     while (currentEmpTime.getDay() === 0 || currentEmpTime.getDay() === 6) {
                        currentEmpTime.setDate(currentEmpTime.getDate() + 1);
                        currentEmpTime.setHours(9, 0, 0, 0);
                     }
                }

                const timeToFree = (currentEmpTime.getTime() - new Date().getTime()) / (1000 * 60);
                const currentScore = (skillMatchScore * 1000) - timeToFree;

                if (currentScore > bestEmployeeScore) {
                    bestEmployeeScore = currentScore;
                    assignedEmployee = emp;
                    proposedStartTime = currentEmpTime;
                }
            }

            if (assignedEmployee && proposedStartTime) {
                const empAvailability = employeeAvailability.get(assignedEmployee.id);
                const jobEndTime = new Date(proposedStartTime.getTime() + jobDuration * 60 * 1000);
                empAvailability.freeUntil = jobEndTime;
                empAvailability.dailyMinutesAssigned += jobDuration;
                plan.push({
                    ...job,
                    proposedDate: proposedStartTime,
                    proposedEmployeeId: assignedEmployee.id,
                    proposedEmployeeName: assignedEmployee.name
                });
            } else {
                plan.push({ ...job, proposedDate: new Date(currentDay), proposedEmployeeId: 'unassigned', proposedEmployeeName: 'Unassigned (No qualified employee found)' });
                currentDay.setDate(currentDay.getDate() + 1);
                currentDay.setHours(9, 0, 0, 0);
            }
        }
        setSchedulePlan(plan);
        setIsScheduling(false);
    };

    const commitSchedule = async () => {
        if (schedulePlan.length === 0) return;
        setIsScheduling(true);
        try {
            const batch = writeBatch(db);
            schedulePlan.forEach(job => {
                if(job.proposedEmployeeId !== 'unassigned') {
                    const jobRef = doc(db, 'createdJobCards', job.id);
                    batch.update(jobRef, {
                        scheduledDate: job.proposedDate,
                        employeeId: job.proposedEmployeeId,
                        employeeName: job.proposedEmployeeName
                    });
                }
            });
            await batch.commit();
            onScheduleComplete();
        } catch (error) {
            console.error("Error committing schedule:", error);
            toast.error("Failed to save the schedule. Please try again.");
        } finally {
            setIsScheduling(false);
        }
    };
    
    return (
        <div 
            onClick={onClose}
            className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in"
        >
            <div 
                onClick={(e) => e.stopPropagation()}
                className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-4xl h-[90vh] flex flex-col"
            >
                <div className="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                    <div>
                        <h2 className="text-xl font-bold text-white">Scheduling Assistant</h2>
                        <p className="text-sm text-gray-400">Auto-schedule pending jobs based on employee skills and availability.</p>
                    </div>
                    <Button onClick={onClose} variant="secondary" className="p-2">
                        <X size={20} />
                    </Button>
                </div>

                <div className="p-6 flex-grow overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold text-white">
                            {schedulePlan.length > 0 ? 'Proposed Schedule' : `Found ${pendingJobs.length} Unscheduled Jobs`}
                        </h3>
                        {schedulePlan.length === 0 ? (
                             <Button onClick={generateSchedule} disabled={loading || pendingJobs.length === 0 || isScheduling}>
                                {isScheduling ? <><Clock size={16} className="mr-2 animate-spin"/> Generating...</> : <><Bot size={18} className="mr-2"/>Generate Optimal Schedule</>}
                             </Button>
                        ) : (
                            <div className="flex gap-2">
                                <Button onClick={() => setSchedulePlan([])} variant="secondary">Clear</Button>
                                <Button onClick={commitSchedule} variant="primary" disabled={isScheduling}>
                                    {isScheduling ? 'Saving...' : 'Commit Schedule to Calendar'}
                                </Button>
                            </div>
                        )}
                    </div>
                    
                    <div className="bg-gray-900/50 p-4 rounded-lg">
                        {loading ? <p>Loading pending jobs, employees, and skills...</p> : 
                         schedulePlan.length > 0 ? (
                            <ul className="space-y-2">
                                {schedulePlan.map(job => (
                                    <li key={job.id} className="p-3 bg-gray-700 rounded-md text-sm">
                                        <p className="font-bold text-white">{job.partName} <span className="text-xs font-mono text-gray-400">({job.jobId})</span></p>
                                        <p className="text-blue-400">Scheduled for: {job.proposedDate.toLocaleString('en-ZA')} by {job.proposedEmployeeName}</p>
                                    </li>
                                ))}
                            </ul>
                         ) : (
                            <ul className="space-y-2">
                                {pendingJobs.map(job => (
                                    <li key={job.id} className="p-2 bg-gray-700 rounded-md text-sm">
                                        {job.partName} ({job.estimatedTime || 'N/A'} mins)
                                    </li>
                                ))}
                                {pendingJobs.length === 0 && <p className="text-gray-500 text-center">No unscheduled jobs found.</p>}
                            </ul>
                         )
                        }
                    </div>
                </div>
            </div>
        </div>
    );
};

export default SchedulingAssistantModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\dashboard\ManagerFocusWidget.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { listenToJobCards, listenToPurchaseQueue, collection, onSnapshot, query, where } from '../../../api/firestore';
import { db } from '../../../api/firebase';
import { Link } from 'react-router-dom';
import { AlertTriangle, Clock, Lightbulb, ShoppingCart, ArrowRight } from 'lucide-react';

// A reusable component for each quadrant in the matrix
const FocusQuadrant = ({ title, items, icon, color, emptyText, linkTo }) => (
    <div className={`bg-gray-900/50 p-4 rounded-lg border-l-4 ${color}`}>
        <h4 className="font-bold text-white mb-3 flex items-center gap-2">
            {icon}
            {title} ({items.length})
        </h4>
        <div className="space-y-2 max-h-48 overflow-y-auto pr-2">
            {items.length > 0 ? (
                items.map(item => (
                    <div key={item.id} className="bg-gray-800 p-2 rounded-md text-sm">
                        <p className="text-gray-200 font-medium truncate">{item.primaryText}</p>
                        <p className="text-xs text-gray-400">{item.secondaryText}</p>
                    </div>
                ))
            ) : (
                <p className="text-sm text-gray-500 text-center py-4">{emptyText}</p>
            )}
        </div>
        <Link to={linkTo} className="text-xs text-blue-400 hover:underline mt-3 inline-flex items-center gap-1">
            Go to section <ArrowRight size={12} />
        </Link>
    </div>
);

// Main widget component
const ManagerFocusWidget = () => {
    const [urgentImportant, setUrgentImportant] = useState([]);
    const [importantNotUrgent, setImportantNotUrgent] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);

        // Listener for Halted Jobs and long-waiting QC jobs (Urgent & Important)
        const unsubscribeJobs = listenToJobCards(allJobs => {
            const halted = allJobs
                .filter(j => j.status === 'Halted - Issue')
                .map(j => ({
                    id: j.id,
                    primaryText: j.partName,
                    secondaryText: `Halted: ${j.issueReason || 'No reason given'}`
                }));
            
            const oldQc = allJobs
                .filter(j => j.status === 'Awaiting QC' && j.completedAt?.toDate() < twoHoursAgo)
                .map(j => ({
                    id: j.id,
                    primaryText: j.partName,
                    secondaryText: `Awaiting QC for over 2 hours`
                }));

            setUrgentImportant([...halted, ...oldQc]);
        });

        // Listener for Kaizen Suggestions (Important & Not Urgent)
        const kaizenQuery = query(collection(db, 'kaizenSuggestions'), where('status', '==', 'new'));
        const unsubscribeKaizen = onSnapshot(kaizenQuery, snapshot => {
            const suggestions = snapshot.docs.map(doc => ({
                id: doc.id,
                primaryText: doc.data().partName,
                secondaryText: `Suggestion by ${doc.data().submittedBy}`
            }));
            // We will combine this with purchase queue items later
            setImportantNotUrgent(prev => [
                ...suggestions, 
                ...prev.filter(item => item.type !== 'kaizen') // Keep other types
            ].map(item => ({...item, type: 'kaizen'})));
        });

        // Listener for Purchase Queue (Important & Not Urgent)
        const unsubscribePurchase = listenToPurchaseQueue(items => {
            const purchaseItems = items
                .filter(i => i.status === 'pending')
                .map(i => ({
                    id: i.id,
                    primaryText: i.itemName,
                    secondaryText: 'Awaiting purchase order'
                }));
            
            setImportantNotUrgent(prev => [
                ...purchaseItems,
                ...prev.filter(item => item.type !== 'purchase') // Keep other types
            ].map(item => ({...item, type: 'purchase'})));
        });

        setLoading(false);

        return () => {
            unsubscribeJobs();
            unsubscribeKaizen();
            unsubscribePurchase();
        };
    }, []);

    if (loading) {
        return <p className="text-gray-400">Loading Manager's Focus...</p>;
    }

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-2xl font-bold text-white mb-4">Manager's Focus</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <FocusQuadrant
                    title="Urgent & Important"
                    items={urgentImportant}
                    icon={<AlertTriangle size={20} />}
                    color="border-red-500"
                    emptyText="No immediate crises."
                    linkTo="/issues"
                />
                <FocusQuadrant
                    title="Important, Not Urgent"
                    items={importantNotUrgent}
                    icon={<Clock size={20} />}
                    color="border-blue-500"
                    emptyText="No strategic items pending."
                    linkTo="/purchasing"
                />
                <div className="bg-gray-900/50 p-4 rounded-lg border-l-4 border-yellow-500">
                     <h4 className="font-bold text-white mb-3 flex items-center gap-2"><Lightbulb size={20}/> Delegate or Minimize</h4>
                     <p className="text-sm text-gray-400">Review new job assignments, handle non-critical emails, and assess meeting invitations. Empower your team leads.</p>
                </div>
                 <div className="bg-gray-900/50 p-4 rounded-lg border-l-4 border-gray-600">
                     <h4 className="font-bold text-white mb-3 flex items-center gap-2"><ShoppingCart size={20}/> Eliminate</h4>
                     <p className="text-sm text-gray-400">Identify and reduce time spent on low-value activities to free up capacity for strategic work.</p>
                </div>
            </div>
        </div>
    );
};

export default ManagerFocusWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\dashboard\RoutineTasksWidget.jsx
==================================================
// src/components/features/dashboard/RoutineTasksWidget.jsx (UPDATED with Fallback UI)
// The widget now displays a user-friendly message when there are no tasks for the day,
// instead of just disappearing from the UI.

import React from 'react';
import { CheckSquare, Square } from 'lucide-react';

const RoutineTasksWidget = ({ tasks }) => {
    // A simple (non-functional) handler for now. In a future version, this could save completion status to Firestore.
    const handleToggle = (taskName) => {
        console.log(`Task "${taskName}" toggled.`);
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full">
            <h3 className="font-bold text-white mb-4">
                Today's Routine Tasks
            </h3>
            {/* --- NEW: Conditional Rendering Logic --- */}
            {(!tasks || tasks.length === 0) ? (
                <div className="flex items-center justify-center h-full text-center text-gray-500">
                    <p>No routine tasks scheduled for today.</p>
                </div>
            ) : (
                <div className="space-y-3">
                    {tasks.map((task, index) => (
                        <div key={index} className="bg-gray-700/50 p-4 rounded-lg">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="font-semibold text-white">{task.name}</p>
                                    <p className="text-xs text-gray-400">Scheduled for {task.timeOfDay}</p>
                                </div>
                                <button onClick={() => handleToggle(task.name)} className="text-gray-300 hover:text-white">
                                    <Square size={24} />
                                </button>
                            </div>
                            {task.description && (
                                <ul className="mt-2 list-disc list-inside pl-1 text-sm text-gray-300 space-y-1">
                                    {task.description.split('\n').map((item, i) => (
                                        <li key={i}>{item}</li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

export default RoutineTasksWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\dispatch\DispatchQueue.jsx
==================================================
// src/components/features/dispatch/DispatchQueue.jsx (NEW FILE)

import React, { useState, useEffect, useMemo } from 'react';
import { getEmployees, listenToJobCards, updateJobPriorities, updateDocument } from '../../../api/firestore';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';
import { GripVertical, Save } from 'lucide-react';
import Button from '../../ui/Button';
import toast from 'react-hot-toast';

const JobItem = ({ job, index }) => (
    <Draggable draggableId={job.id} index={index}>
        {(provided, snapshot) => (
            <div
                ref={provided.innerRef}
                {...provided.draggableProps}
                {...provided.dragHandleProps}
                className={`p-3 rounded-lg flex items-center gap-3 transition-colors ${snapshot.isDragging ? 'bg-blue-600 shadow-lg' : 'bg-gray-700'}`}
            >
                <GripVertical className="text-gray-500" />
                <div>
                    <p className="font-semibold text-white">{job.partName}</p>
                    <p className="text-xs text-gray-400">{job.jobId}</p>
                </div>
            </div>
        )}
    </Draggable>
);

const EmployeeQueue = ({ employee, jobs, onSavePriority }) => {
    return (
        <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
            <div className="flex justify-between items-center mb-4">
                <h4 className="text-lg font-bold text-white">{employee.name}'s Queue</h4>
                <Button onClick={() => onSavePriority(employee.id)} size="sm" variant="secondary">
                    <Save size={16} className="mr-2" />
                    Save Priority
                </Button>
            </div>
            <Droppable droppableId={employee.id}>
                {(provided, snapshot) => (
                    <div
                        {...provided.droppableProps}
                        ref={provided.innerRef}
                        className={`space-y-2 p-2 rounded-lg min-h-[100px] transition-colors ${snapshot.isDraggingOver ? 'bg-gray-900/50' : ''}`}
                    >
                        {jobs.map((job, index) => (
                            <JobItem key={job.id} job={job} index={index} />
                        ))}
                        {provided.placeholder}
                        {jobs.length === 0 && <p className="text-sm text-center text-gray-500 pt-4">No pending jobs.</p>}
                    </div>
                )}
            </Droppable>
        </div>
    );
};

const DispatchQueue = () => {
    const [employees, setEmployees] = useState([]);
    const [jobsByEmployee, setJobsByEmployee] = useState({});
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchInitialData = async () => {
            const emps = await getEmployees();
            setEmployees(emps.filter(e => e.employeeType === 'permanent'));
        };
        fetchInitialData();

        const unsubscribe = listenToJobCards(allJobs => {
            const pendingJobs = allJobs.filter(j => j.status === 'Pending' && j.employeeId);
            
            pendingJobs.sort((a, b) => {
                const priorityA = a.priority ?? Infinity;
                const priorityB = b.priority ?? Infinity;
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
            });

            const grouped = pendingJobs.reduce((acc, job) => {
                if (!acc[job.employeeId]) {
                    acc[job.employeeId] = [];
                }
                acc[job.employeeId].push(job);
                return acc;
            }, {});
            setJobsByEmployee(grouped);
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    const onDragEnd = (result) => {
        const { source, destination, draggableId } = result;
        if (!destination) return;

        const sourceEmployeeId = source.droppableId;
        const destEmployeeId = destination.droppableId;

        const newJobsByEmployee = JSON.parse(JSON.stringify(jobsByEmployee));

        if (sourceEmployeeId === destEmployeeId) {
            const items = Array.from(newJobsByEmployee[sourceEmployeeId] || []);
            const [reorderedItem] = items.splice(source.index, 1);
            items.splice(destination.index, 0, reorderedItem);
            newJobsByEmployee[sourceEmployeeId] = items;
        } else {
            const sourceItems = Array.from(newJobsByEmployee[sourceEmployeeId] || []);
            const destItems = newJobsByEmployee[destEmployeeId] ? Array.from(newJobsByEmployee[destEmployeeId]) : [];
            const [movedItem] = sourceItems.splice(source.index, 1);
            
            const destEmployee = employees.find(e => e.id === destEmployeeId);
            movedItem.employeeId = destEmployeeId;
            movedItem.employeeName = destEmployee.name;
            
            updateDocument('createdJobCards', draggableId, {
                employeeId: destEmployeeId,
                employeeName: destEmployee.name
            }).catch(err => toast.error("Failed to re-assign employee."));

            destItems.splice(destination.index, 0, movedItem);
            
            newJobsByEmployee[sourceEmployeeId] = sourceItems;
            newJobsByEmployee[destEmployeeId] = destItems;
        }

        setJobsByEmployee(newJobsByEmployee);
    };

    const handleSavePriorityForEmployee = async (employeeId) => {
        const orderedJobs = jobsByEmployee[employeeId];
        if (!orderedJobs) return;
        try {
            await updateJobPriorities(orderedJobs);
            const employee = employees.find(e => e.id === employeeId);
            toast.success(`Priorities saved for ${employee.name}`);
        } catch (error) {
            toast.error("Failed to save priorities.");
            console.error(error);
        }
    };

    if (loading) return <p className="text-center text-gray-400">Loading Dispatch Queues...</p>;

    return (
        <DragDropContext onDragEnd={onDragEnd}>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {employees.map(employee => (
                    <EmployeeQueue 
                        key={employee.id}
                        employee={employee}
                        jobs={jobsByEmployee[employee.id] || []}
                        onSavePriority={handleSavePriorityForEmployee}
                    />
                ))}
            </div>
        </DragDropContext>
    );
};

export default DispatchQueue;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\floorplan\FloorPlan.jsx
==================================================
// src/components/features/floorplan/FloorPlan.jsx (NEW FILE)

import React, { useMemo } from 'react';
import { HardHat } from 'lucide-react';

// A component to represent a single job on the floor plan
const JobMarker = ({ job }) => (
    <div 
        className="bg-blue-500 text-white text-[10px] px-1.5 py-0.5 rounded-md shadow-lg flex items-center gap-1 animate-fade-in"
        title={`${job.partName} (${job.jobId}) - ${job.employeeName}`}
    >
        <HardHat size={10} />
        <span className="truncate">{job.partName}</span>
    </div>
);

// A component to represent a department area on the floor plan
const DepartmentArea = ({ department, jobs }) => (
    <div className="bg-gray-800/50 border-2 border-dashed border-gray-700 rounded-xl p-4 min-h-[200px]">
        <h3 className="font-bold text-white border-b border-gray-600 pb-2 mb-3">{department.name}</h3>
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
            {jobs.map(job => (
                <JobMarker key={job.id} job={job} />
            ))}
        </div>
    </div>
);

const FloorPlan = ({ jobs, departments }) => {
    // Filter for only jobs that are currently "In Progress"
    const activeJobs = useMemo(() => {
        return jobs.filter(job => job.status === 'In Progress');
    }, [jobs]);

    // Group the active jobs by their department ID
    const jobsByDepartment = useMemo(() => {
        return activeJobs.reduce((acc, job) => {
            const deptId = job.departmentId;
            if (!acc[deptId]) {
                acc[deptId] = [];
            }
            acc[deptId].push(job);
            return acc;
        }, {});
    }, [activeJobs]);

    return (
        <div className="space-y-6">
            {departments.map(dept => (
                <DepartmentArea 
                    key={dept.id}
                    department={dept}
                    jobs={jobsByDepartment[dept.id] || []}
                />
            ))}
            {departments.length === 0 && (
                <p className="text-center text-gray-500 py-10">No departments found. Please add departments in Settings.</p>
            )}
        </div>
    );
};

export default FloorPlan;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\job_cards\CustomJobCreator.jsx
==================================================
// src/components/features/job_cards/CustomJobCreator.jsx (Upgraded with Category, VIN, and Standardized Printing)

import React, { useState, useEffect, useRef } from 'react';
import Input from '../../ui/Input';
import Textarea from '../../ui/Textarea';
import Dropdown from '../../ui/Dropdown';
import Button from '../../ui/Button';
import { 
    addJobCard, 
    getDepartments, 
    getEmployees, 
    getTools, 
    getToolAccessories, 
    getAllInventoryItems, 
    getDepartmentSkills, 
    listenToJobCards 
} from '../../../api/firestore';
import { Search } from 'lucide-react';
import toast from 'react-hot-toast';
import PrintConfirmationModal from './PrintConfirmationModal';
import QRCode from 'qrcode';

// Base64 encoded logo to ensure it prints correctly
const tojemLogoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA... (base64 string would be very long)"; // Replace with your actual full base64 string

const CustomJobCreator = ({ campaignId }) => {
    const [jobData, setJobData] = useState({
        jobName: '',
        departmentId: '',
        employeeId: '',
        quantity: 1,
        description: '',
        estimatedTime: '',
        steps: '',
        selectedTools: new Set(),
        selectedAccessories: new Set(),
        consumables: [],
        jobCategory: 'Production',
        requiresVin: false,
        vinNumber: '',
    });

    const [allPastJobs, setAllPastJobs] = useState([]);
    const [similarJobResults, setSimilarJobResults] = useState([]);
    const searchRef = useRef(null);
    
    const [allDepartments, setAllDepartments] = useState([]);
    const [allEmployees, setAllEmployees] = useState([]);
    const [allTools, setAllTools] = useState([]);
    const [allToolAccessories, setAllToolAccessories] = useState([]);
    const [allInventoryItems, setAllInventoryItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [consumableSearchTerm, setConsumableSearchTerm] = useState('');
    const [filteredConsumableOptions, setFilteredConsumableOptions] = useState([]);
    const [selectedConsumableItem, setSelectedConsumableItem] = useState(null);
    const [consumableQuantity, setConsumableQuantity] = useState('');
    const consumableSearchRef = useRef(null);
    const [jobToConfirm, setJobToConfirm] = useState(null);

    const jobCategoryOptions = [
        { id: 'Production', name: 'Production' },
        { id: 'Development', name: 'Development' },
        { id: 'Maintenance', name: 'Maintenance' },
    ];

    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            try {
                const [departments, employees, tools, toolAccessories, inventoryItems] = await Promise.all([
                    getDepartments(), getEmployees(), getTools(), getToolAccessories(), getAllInventoryItems()
                ]);
                setAllDepartments(departments);
                setAllEmployees(employees);
                setAllTools(tools);
                setAllToolAccessories(toolAccessories);
                setAllInventoryItems(inventoryItems);
            } catch (error) {
                console.error("Error fetching data:", error);
                toast.error("Failed to load necessary data.");
            } finally {
                setLoading(false);
            }
        };
        fetchData();

        const unsubscribe = listenToJobCards(setAllPastJobs);
        return () => unsubscribe();
    }, []);

    useEffect(() => {
        if (jobData.jobName.length > 2) {
            const searchLower = jobData.jobName.toLowerCase();
            const results = allPastJobs
                .filter(job => job.partName && job.partName.toLowerCase().includes(searchLower))
                .slice(0, 5);
            setSimilarJobResults(results);
        } else {
            setSimilarJobResults([]);
        }
    }, [jobData.jobName, allPastJobs]);
    
    const handleSelectSimilarJob = (job) => {
        toast.success(`Loaded details from job: ${job.jobId}`);
        setJobData({
            ...jobData,
            jobName: job.partName,
            description: job.description,
            estimatedTime: job.estimatedTime,
            steps: Array.isArray(job.steps) ? job.steps.join('\n') : '',
            selectedTools: new Set(job.tools?.map(t => t.id) || []),
            selectedAccessories: new Set(job.accessories?.map(a => a.id) || []),
            consumables: job.processedConsumables || [],
        });
        setSimilarJobResults([]);
    };

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (searchRef.current && !searchRef.current.contains(event.target)) {
                setSimilarJobResults([]);
            }
            if (consumableSearchRef.current && !consumableSearchRef.current.contains(event.target)) {
                setFilteredConsumableOptions([]);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        const val = type === 'checkbox' ? checked : value;
        setJobData(prev => ({ ...prev, [name]: val }));
    };

    const handleToolToggle = (toolId) => {
        setJobData(prev => {
            const newTools = new Set(prev.selectedTools);
            if (newTools.has(toolId)) {
                newTools.delete(toolId);
                const accessoriesOfTool = allToolAccessories.filter(a => a.toolId === toolId).map(a => a.id);
                const newAccessories = new Set(prev.selectedAccessories);
                accessoriesOfTool.forEach(accId => newAccessories.delete(accId));
                return { ...prev, selectedTools: newTools, selectedAccessories: newAccessories };
            } else {
                newTools.add(toolId);
                return { ...prev, selectedTools: newTools };
            }
        });
    };

    const handleAccessoryToggle = (accessoryId) => {
        setJobData(prev => {
            const newAccessories = new Set(prev.selectedAccessories);
            newAccessories.has(accessoryId) ? newAccessories.delete(accessoryId) : newAccessories.add(accessoryId);
            return { ...prev, selectedAccessories: newAccessories };
        });
    };

    const selectConsumableFromSearch = (item) => {
        setSelectedConsumableItem(item);
        setConsumableSearchTerm(item.name);
        setFilteredConsumableOptions([]);
    };

    const addConsumable = () => {
        if (!selectedConsumableItem || parseFloat(consumableQuantity) <= 0 || isNaN(parseFloat(consumableQuantity))) {
            toast.error("Please select a consumable and enter a valid quantity.");
            return;
        }
        const isDuplicate = jobData.consumables.some(c => c.id === selectedConsumableItem.id);
        if (isDuplicate) {
            toast.error("This consumable has already been added.");
            return;
        }
        setJobData(prev => ({
            ...prev,
            consumables: [...prev.consumables, {
                id: selectedConsumableItem.id,
                name: selectedConsumableItem.name,
                quantity: parseFloat(consumableQuantity),
                unit: selectedConsumableItem.unit || 'units',
                price: selectedConsumableItem.price || 0
            }]
        }));
        setSelectedConsumableItem(null);
        setConsumableQuantity('');
        setConsumableSearchTerm('');
        setFilteredConsumableOptions([]);
    };

    const removeConsumable = (indexToRemove) => {
        setJobData(prev => ({
            ...prev,
            consumables: prev.consumables.filter((_, index) => index !== indexToRemove)
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!jobData.jobName.trim() || !jobData.departmentId || !jobData.description.trim() || !jobData.steps.trim()) {
            toast.error("Please fill in Job Name, Department, Description, and Steps.");
            return;
        }
        // --- ADDED: Time validation ---
        if (!jobData.estimatedTime || parseFloat(jobData.estimatedTime) <= 0) {
            toast.error("Please enter a valid estimated time for the job.");
            return;
        }
        if (jobData.requiresVin && !jobData.vinNumber.trim()) {
            return toast.error("A VIN number is required for this job.");
        }
        
        let departmentRequiredSkills = await getDepartmentSkills(jobData.departmentId);

        const newJobId = `CUSTOM-${Date.now()}`;
        const finalJobData = {
            jobId: newJobId,
            partName: jobData.jobName.trim(),
            departmentId: jobData.departmentId,
            departmentName: allDepartments.find(d => d.id === jobData.departmentId)?.name || 'Unknown',
            employeeId: jobData.employeeId || 'unassigned',
            employeeName: allEmployees.find(e => e.id === jobData.employeeId)?.name || 'Unassigned',
            quantity: Number(jobData.quantity) || 1,
            status: 'Pending',
            description: jobData.description.trim(),
            estimatedTime: parseFloat(jobData.estimatedTime) || 0,
            steps: jobData.steps.split('\n').filter(s => s.trim() !== ''),
            tools: Array.from(jobData.selectedTools).map(toolId => allTools.find(t => t.id === toolId)).filter(Boolean),
            accessories: Array.from(jobData.selectedAccessories).map(accId => allToolAccessories.find(a => a.id === accId)).filter(Boolean),
            processedConsumables: jobData.consumables,
            isCustomJob: true,
            campaignId: campaignId || null,
            requiredSkills: departmentRequiredSkills,
            jobCategory: jobData.jobCategory,
            vinNumber: jobData.requiresVin ? jobData.vinNumber.trim() : null,
        };
        
        setJobToConfirm(finalJobData);
    };

    const handleConfirmPrint = async () => {
        if (!jobToConfirm) return;

        try {
            await addJobCard(jobToConfirm);
            toast.success(`Custom Job Card ${jobToConfirm.jobId} created successfully!`);
            
            const qrCodeDataUrl = await QRCode.toDataURL(jobToConfirm.jobId, { width: 80 });
            
            // --- UPDATED: Using base64 logo ---
            const printContents = `
                <div style="font-family: sans-serif; padding: 20px; color: #333;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                        <div>
                            <img src="${tojemLogoBase64}" alt="Company Logo" style="height: 50px; margin-bottom: 10px;"/>
                            <h1 style="font-size: 28px; font-weight: bold; margin: 0;">Job Card (Custom)</h1>
                            <p style="font-size: 14px; color: #666; margin: 0;">Part: <span style="font-weight: 600;">${jobToConfirm.partName} (x${jobToConfirm.quantity})</span></p>
                            <p style="font-size: 14px; color: #666; margin: 0;">Department: <span style="font-weight: 600;">${jobToConfirm.departmentName}</span></p>
                            ${jobToConfirm.vinNumber ? `<p style="font-size: 14px; color: #666; margin: 0;">VIN: <span style="font-weight: 600;">${jobToConfirm.vinNumber}</span></p>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <img src="${qrCodeDataUrl}" alt="QR Code" style="margin-bottom: 5px;"/>
                            <p style="font-size: 10px; color: #999; margin: 0;">${jobToConfirm.jobId}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div style="font-size: 13px; line-height: 1.6;">
                            <p style="margin: 0;"><b>Employee:</b> ${jobToConfirm.employeeName}</p>
                            <p style="margin: 0;"><b>Est. Time:</b> ${jobToConfirm.estimatedTime || 'N/A'} mins</p>
                            <p style="margin: 0;"><b>Description:</b> ${jobToConfirm.description || 'No description.'}</p>
                        </div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            <div>
                                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Required Tools & Accessories</h3>
                                <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                    ${jobToConfirm.tools?.length > 0 ? jobToConfirm.tools.map(tool => `<li>${tool.name}</li>`).join('') : '<li>No tools specified.</li>'}
                                    ${jobToConfirm.accessories?.length > 0 ? jobToConfirm.accessories.map(acc => `<li style="margin-left: 15px;">${acc.name}</li>`).join('') : ''}
                                </ul>
                            </div>
                            <div style="margin-top: 20px;">
                                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Required Consumables</h3>
                                <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                    ${jobToConfirm.processedConsumables?.length > 0 ? jobToConfirm.processedConsumables.map(c => `<li><span style="font-weight: 600;">${c.name}</span>: ${c.quantity} ${c.unit}</li>`).join('') : '<li>No consumables specified.</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                        <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Steps</h3>
                        <ol style="list-style: decimal; padding-left: 20px; margin: 0;">
                            ${jobToConfirm.steps?.length > 0 ? jobToConfirm.steps.map(step => `<li>${step}</li>`).join('') : '<li>No steps defined.</li>'}
                        </ol>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank', 'height=800,width=1000');
            if (printWindow) {
                printWindow.document.write(`<html><head><title>Custom Job Card ${jobToConfirm.jobId}</title></head><body>${printContents}</body></html>`);
                printWindow.document.close();
                printWindow.onload = () => { setTimeout(() => printWindow.print(), 500); };
            } else {
                toast("The print window was blocked. Please allow popups.", { icon: 'â„¹ï¸' });
            }

            setJobData({ jobName: '', departmentId: '', employeeId: '', quantity: 1, description: '', estimatedTime: '', steps: '', selectedTools: new Set(), selectedAccessories: new Set(), consumables: [], jobCategory: 'Production', requiresVin: false, vinNumber: '' });
            setSelectedConsumableItem(null);
            setConsumableQuantity('');
            setConsumableSearchTerm('');
            setFilteredConsumableOptions([]);
            setJobToConfirm(null);

        } catch (error) {
            console.error("Error creating custom job card:", error);
            toast.error("Failed to create custom job card.");
        }
    };

    if (loading) return <p className="text-center text-gray-400">Loading custom job form data...</p>;
    
    return (
        <>
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-4xl mx-auto">
                <h3 className="text-lg font-semibold text-white mb-4">Create a One-Off / Custom Job Card</h3>
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="relative" ref={searchRef}>
                        <Input 
                            label="Job Name / Part Description" 
                            name="jobName" 
                            value={jobData.jobName} 
                            onChange={handleInputChange} 
                            placeholder="e.g., Repair Customer's Custom Bracket" 
                            autoComplete="off"
                        />
                        {similarJobResults.length > 0 && (
                            <ul className="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                                {similarJobResults.map(job => (
                                    <li 
                                        key={job.id} 
                                        onClick={() => handleSelectSimilarJob(job)}
                                        className="p-3 hover:bg-blue-600 cursor-pointer"
                                    >
                                        <p className="font-semibold text-white">{job.partName}</p>
                                        <p className="text-xs text-gray-400">Job ID: {job.jobId}</p>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Input label="Quantity" name="quantity" type="number" min="1" value={jobData.quantity} onChange={handleInputChange} />
                        <Dropdown label="Department" name="departmentId" value={jobData.departmentId} onChange={handleInputChange} options={allDepartments} placeholder="Select Department..." />
                        <Dropdown label="Job Category" name="jobCategory" value={jobData.jobCategory} onChange={handleInputChange} options={jobCategoryOptions} />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <Dropdown label="Employee (Optional)" name="employeeId" value={jobData.employeeId} onChange={handleInputChange} options={allEmployees.filter(e => e.departmentId === jobData.departmentId)} placeholder="Select Employee..." />
                        <div className="flex items-center pt-6">
                            <input type="checkbox" id="requiresVin" name="requiresVin" checked={jobData.requiresVin} onChange={handleInputChange} className="h-4 w-4 rounded bg-gray-700 text-blue-600 focus:ring-blue-500"/>
                            <label htmlFor="requiresVin" className="ml-2 text-sm font-medium text-gray-300">This job requires a VIN number</label>
                        </div>
                    </div>

                    {jobData.requiresVin && (
                        <div className="animate-fade-in">
                            <Input label="VIN Number" name="vinNumber" value={jobData.vinNumber} onChange={handleInputChange} placeholder="Enter Vehicle Identification Number..." />
                        </div>
                    )}

                    <Textarea label="Job Description" name="description" value={jobData.description} onChange={handleInputChange} placeholder="e.g., Weld crack in bracket and repaint" rows={3} />
                    
                    <Input label="Estimated Time (Minutes)" name="estimatedTime" type="number" min="1" value={jobData.estimatedTime} onChange={handleInputChange} placeholder="e.g., 90" />

                    <Textarea label="Steps (one per line)" name="steps" value={jobData.steps} onChange={handleInputChange} placeholder="1. Clean area&#10;2. Weld crack&#10;3. Sand smooth&#10;4. Paint" rows={5} />

                    <div>
                        <h4 className="font-semibold text-white mb-2">Required Tools & Accessories</h4>
                        <div className="max-h-60 overflow-y-auto space-y-3 p-4 bg-gray-900/50 rounded-lg">
                            {(allTools || []).map(tool => (
                                <div key={tool.id}>
                                    <label className="flex items-center space-x-2 text-sm font-semibold text-gray-200">
                                        <input type="checkbox" checked={jobData.selectedTools.has(tool.id)} onChange={() => handleToolToggle(tool.id)} className="h-4 w-4 rounded bg-gray-700 text-blue-600 focus:ring-blue-500" />
                                        <span>{tool.name}</span>
                                    </label>
                                    {jobData.selectedTools.has(tool.id) && (
                                        <div className="pl-6 mt-1 space-y-1 text-xs border-l-2 border-gray-700">
                                            {(allToolAccessories.filter(acc => acc.toolId === tool.id)).map(accessory => (
                                                <label key={accessory.id} className="flex items-center space-x-2 text-xs text-gray-300">
                                                    <input type="checkbox" checked={jobData.selectedAccessories.has(accessory.id)} onChange={() => handleAccessoryToggle(accessory.id)} className="h-3 w-3 rounded bg-gray-700 text-blue-600 focus:ring-blue-500" />
                                                    <span>{accessory.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div>
                        <h4 className="font-semibold text-white mb-2">Required Consumables (Select from Inventory)</h4>
                        <div className="p-4 bg-gray-900/50 rounded-lg space-y-3">
                            <div className="flex items-end gap-2" ref={consumableSearchRef}>
                                <div className="flex-grow relative">
                                    <Input
                                        label="Consumable Item"
                                        name="consumableSearch"
                                        value={consumableSearchTerm}
                                        onChange={(e) => {
                                            setConsumableSearchTerm(e.target.value);
                                            setSelectedConsumableItem(null);
                                        }}
                                        placeholder="Search by name or code..."
                                    />
                                    <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                                    {consumableSearchTerm.length > 0 && filteredConsumableOptions.length > 0 && (
                                        <ul className="absolute z-10 bg-gray-700 border border-gray-600 rounded-md w-full mt-1 max-h-48 overflow-y-auto shadow-lg">
                                            {filteredConsumableOptions.map(item => (
                                                <li
                                                    key={item.id}
                                                    className="p-2 text-sm text-gray-200 hover:bg-blue-600 hover:text-white cursor-pointer"
                                                    onClick={() => selectConsumableFromSearch(item)}
                                                    >
                                                    {item.name} ({item.itemCode || 'N/A'}) - {item.unit} (R{item.price.toFixed(2)})
                                                </li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                                <div className="w-24">
                                    <Input
                                        label="Quantity"
                                        name="quantity"
                                        type="number"
                                        step="any"
                                        value={consumableQuantity}
                                        onChange={(e) => setConsumableQuantity(e.target.value)}
                                        placeholder="e.g., 0.5"
                                    />
                                </div>
                                <Button type="button" onClick={addConsumable} disabled={!selectedConsumableItem || parseFloat(consumableQuantity) <= 0 || isNaN(parseFloat(consumableQuantity))}>Add</Button>
                            </div>
                            <ul className="space-y-2 max-h-40 overflow-y-auto border-t border-gray-700 pt-3">
                                {jobData.consumables.length > 0 ? (
                                    jobData.consumables.map((c, index) => (
                                        <li key={index} className="flex justify-between items-center bg-gray-700 p-2 rounded text-sm text-gray-200">
                                            <span>{c.name} : {c.quantity} {c.unit} (R{c.price.toFixed(2)})</span>
                                            <Button type="button" onClick={() => removeConsumable(index)} variant="danger" className="py-0.5 px-2 text-xs">X</Button>
                                        </li>
                                    ))
                                    ) : (
                                    <li className="text-gray-400 text-sm">No consumables added yet.</li>
                                )}
                            </ul>
                        </div>
                    </div>

                    <div className="text-center">
                        <Button type="submit" variant="primary">Create Custom Job Card</Button>
                    </div>
                </form>
            </div>
            
            {jobToConfirm && (
                <PrintConfirmationModal 
                    jobDetails={jobToConfirm}
                    onClose={() => setJobToConfirm(null)}
                    onConfirmPrint={handleConfirmPrint}
                />
            )}
        </>
    );
};

export default CustomJobCreator;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\job_cards\JobCardCreator.jsx
==================================================
// src/components/features/job_cards/JobCardCreator.jsx

import React, { useState, useEffect, useMemo } from 'react';
import {
    getProducts, getProductCategories,
    getDepartments, getEmployees, addJobCard, getJobStepDetails, getTools,
    getToolAccessories, getAllInventoryItems, getDepartmentSkills,
    setJobStepDetail,
    getSkills
} from '../../../api/firestore';
import { processConsumables } from '../../../utils/jobUtils';
import Dropdown from '../../ui/Dropdown';
import Button from '../../ui/Button';
import Textarea from '../../ui/Textarea';
import Input from '../../ui/Input';
import ConsumableEditor from '/src/components/features/recipes/ConsumableEditor.jsx';
import PrintConfirmationModal from './PrintConfirmationModal';
import toast from 'react-hot-toast';
import QRCode from 'qrcode';

// Base64 encoded logo to ensure it prints correctly
const tojemLogoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA... (base64 string would be very long)"; // Replace with your actual full base64 string

const JobCardCreator = ({ campaignId }) => {
    const [allData, setAllData] = useState({ products: [], categories: [], departments: [], employees: [], allRecipes: [], tools: [], toolAccessories: [], allConsumables: [], allSkills: [] });
    const [loading, setLoading] = useState(true);
    const [selection, setSelection] = useState({ categoryId: '', productId: '', departmentId: '', employeeId: '', quantity: 1, vinNumber: '', jobCategory: 'Production' });
    const [jobDetails, setJobDetails] = useState(null);
    const [currentTemp, setCurrentTemp] = useState(20);
    const [showDefineRecipeForm, setShowDefineRecipeForm] = useState(false);
    const [tempRecipeDetails, setTempRecipeDetails] = useState({ description: '', estimatedTime: '', steps: '', tools: new Set(), accessories: new Set(), consumables: [] });
    const [isSavingNewRecipe, setIsSavingNewRecipe] = useState(false);
    const [jobToConfirm, setJobToConfirm] = useState(null);

    const jobCategoryOptions = [
        { id: 'Production', name: 'Production' },
        { id: 'Development', name: 'Development' },
        { id: 'Maintenance', name: 'Maintenance' },
    ];

    useEffect(() => {
        const fetchAllData = async () => {
            setLoading(true);
            try {
                const weatherResponse = await fetch("https://api.open-meteo.com/v1/forecast?latitude=-33.92&longitude=18.42&current=temperature_2m");
                const weatherData = await weatherResponse.json();
                     setCurrentTemp(weatherData.current.temperature_2m);

                const [prods, cats, depts, emps, recipes, tools, toolAccessories, consumables, skills] = await Promise.all([
                    getProducts(), getProductCategories(), getDepartments(), getEmployees(), getJobStepDetails(), getTools(), getToolAccessories(), getAllInventoryItems(), getSkills()
                ]);

                setAllData({ products: prods, categories: cats, departments: depts, employees: emps, allRecipes: recipes, tools, toolAccessories, allConsumables: consumables, allSkills: skills });
             } catch (error) {
                console.error("Failed to fetch initial data:", error);
                toast.error("Error fetching page data.");
            } finally {
                setLoading(false);
            }
        };
        fetchAllData();
    }, []);

    const handleSelection = (e) => {
        const { name, value } = e.target;
        setSelection(prev => {
            const updated = { ...prev, [name]: value };
            if (name === 'categoryId') { updated.productId = ''; }
                 if (name === 'departmentId') { updated.employeeId = ''; }
            return updated;
        });
        setShowDefineRecipeForm(false);
        setTempRecipeDetails({ description: '', estimatedTime: '', steps: '', tools: new Set(), accessories: new Set(), consumables: [] });
    };

    const filteredProducts = useMemo(() => allData.products.filter(p => p.categoryId === selection.categoryId), [allData.products, selection.categoryId]);
    const filteredEmployees = useMemo(() => allData.employees.filter(e => e.departmentId === selection.departmentId), [allData.employees, selection.departmentId]);

    const recipeRequiresVin = useMemo(() => {
        const { productId, departmentId } = selection;
        if (productId && departmentId) {
            const recipeId = `${productId}_${departmentId}`;
            const standardRecipe = allData.allRecipes.find(recipe => recipe.id === recipeId);
            return standardRecipe?.requiresVin || false;
        }
        return false;
    }, [selection, allData.allRecipes]);

    useEffect(() => {
        const updateJobDetails = async () => {
            const { productId, departmentId, employeeId, quantity, vinNumber, jobCategory } = selection;
                 if (productId && departmentId) {
                const product = allData.products.find(p => p.id === productId);
                const department = allData.departments.find(d => d.id === departmentId);
                const employee = allData.employees.find(e => e.id === employeeId);

                const recipeId = `${productId}_${departmentId}`;
                const standardRecipe = allData.allRecipes.find(recipe => recipe.id === recipeId);

                     let finalRecipeDetails = null;
                let finalRequiredSkills = [];

                if (standardRecipe) {
                    setShowDefineRecipeForm(false);
                    finalRecipeDetails = standardRecipe;
                    finalRequiredSkills = standardRecipe.requiredSkills || await getDepartmentSkills(departmentId);
                 } else {
                    setShowDefineRecipeForm(true);
                    finalRecipeDetails = {
                        description: tempRecipeDetails.description || product.name,
                        estimatedTime: tempRecipeDetails.estimatedTime || 0,
                        steps: tempRecipeDetails.steps.split('\n').filter(s => s.trim() !== ''),
                         tools: Array.from(tempRecipeDetails.tools),
                        accessories: Array.from(tempRecipeDetails.accessories),
                        consumables: tempRecipeDetails.consumables,
                    };
                    finalRequiredSkills = await getDepartmentSkills(departmentId);
                }

                const processed = processConsumables(finalRecipeDetails.consumables, allData.allConsumables, currentTemp);
                const toolsForDisplay = (finalRecipeDetails.tools || []).map(toolId => allData.tools.find(t => t.id === toolId)).filter(Boolean);
                const accessoriesForDisplay = (finalRecipeDetails.accessories || []).map(accId => allData.toolAccessories.find(a => a.id === accId)).filter(Boolean);

                // --- FIX: Changed productName to partName and productId to partId ---
                setJobDetails({
                    jobId: `JOB-${Date.now()}`,
                    partName: product.name, // Corrected field name
                    photoUrl: product.photoUrl,
                    partId: product.id, // Corrected field name
                    departmentId: department.id,
                     departmentName: department.name,
                    employeeId: employee ? employee.id : 'unassigned',
                    employeeName: employee ? employee.name : 'Unassigned',
                    status: 'Pending',
                    description: finalRecipeDetails.description,
                    quantity: Number(quantity) || 1,
                    vinNumber: recipeRequiresVin ? vinNumber : null,
                    jobCategory: jobCategory,
                     estimatedTime: parseFloat(finalRecipeDetails.estimatedTime) || 0,
                    steps: finalRecipeDetails.steps.map ? (finalRecipeDetails.steps.map(s => s.text || s)) : [],
                    tools: toolsForDisplay,
                    accessories: accessoriesForDisplay,
                    consumables: finalRecipeDetails.consumables || [],
                    processedConsumables: processed,
                     campaignId: campaignId || null,
                    requiredSkills: finalRequiredSkills,
                });
            } else {
                setJobDetails(null);
            }
        };
        updateJobDetails();
    }, [selection, allData, currentTemp, tempRecipeDetails, campaignId, recipeRequiresVin]);

    const handleTempRecipeInputChange = (e) => {
        const { name, value } = e.target;
        setTempRecipeDetails(prev => ({ ...prev, [name]: value }));
    };
    const handleTempRecipeToolToggle = (toolId) => {
           setTempRecipeDetails(prev => {
            const newTools = new Set(prev.tools);
            newTools.has(toolId) ? newTools.delete(toolId) : newTools.add(toolId);
            return { ...prev, tools: newTools };
        });
    };
    const handleTempRecipeAccessoryToggle = (accId) => {
        setTempRecipeDetails(prev => {
            const newAccessories = new Set(prev.accessories);
            newAccessories.has(accId) ? newAccessories.delete(accId) : newAccessories.add(accId);
            return { ...prev, accessories: newAccessories };
        });
    };
    const handleTempRecipeConsumableAdd = (consumable) => {
        setTempRecipeDetails(prev => ({ ...prev, consumables: [...prev.consumables, consumable] }));
    };
    const handleTempRecipeConsumableRemove = (itemId) => {
        setTempRecipeDetails(prev => ({ ...prev, consumables: prev.consumables.filter(c => c.itemId !== itemId) }));
    };

    const handleResetFormAndPreview = () => {
        setSelection({ categoryId: '', productId: '', departmentId: '', employeeId: '', quantity: 1, vinNumber: '', jobCategory: 'Production' });
        setJobDetails(null);
        setShowDefineRecipeForm(false);
        setTempRecipeDetails({ description: '', estimatedTime: '', steps: '', tools: new Set(), accessories: new Set(), consumables: [] });
        setJobToConfirm(null);
    };
    
    const handleGenerateNewJobCard = () => {
        if (!jobDetails) return toast.error("Please select a product and department.");
        if (!jobDetails.estimatedTime || jobDetails.estimatedTime <= 0) {
            return toast.error("A valid estimated time is required to create this job card.");
        }
        if (recipeRequiresVin && !selection.vinNumber.trim()) {
            return toast.error("This job requires a VIN number.");
        }
        setJobToConfirm(jobDetails);
    };
    
    const saveNewRecipeAndCreateJob = async () => {
        if (!jobDetails || !selection.productId || !selection.departmentId) return;
        if (!tempRecipeDetails.description.trim() || !tempRecipeDetails.estimatedTime || !tempRecipeDetails.steps.trim()) {
             return toast.error("Please fill in Description, Estimated Time, and Steps for the new recipe.");
        }
        
        setIsSavingNewRecipe(true);
        try {
            const recipeData = {
                description: tempRecipeDetails.description.trim(),
                estimatedTime: Number(tempRecipeDetails.estimatedTime),
                steps: tempRecipeDetails.steps.split('\n').filter(s => s.trim() !== '').map((s, i) => ({ text: s, time: 0, order: i })),
                 tools: Array.from(tempRecipeDetails.tools),
                accessories: Array.from(tempRecipeDetails.accessories),
                consumables: tempRecipeDetails.consumables,
                requiredSkills: jobDetails.requiredSkills || [],
            };
            await setJobStepDetail(selection.productId, selection.departmentId, recipeData);
            toast.success("New recipe saved successfully!");
            
            setJobToConfirm(jobDetails);

        } catch (error) {
            console.error("Error saving new recipe:", error);
            toast.error("Failed to save new recipe.");
        } finally {
            setIsSavingNewRecipe(false);
        }
    };

    const handleConfirmPrint = async () => {
        if (!jobToConfirm) return;
        try {
            await addJobCard(jobToConfirm);
            toast.success(`Job Card ${jobToConfirm.jobId} created successfully!`);
            
            const qrCodeDataUrl = await QRCode.toDataURL(jobToConfirm.jobId, { width: 80 });
            
            const printContents = `
                <div style="font-family: sans-serif; padding: 20px; color: #333;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                        <div>
                            <img src="${tojemLogoBase64}" alt="Company Logo" style="height: 50px; margin-bottom: 10px;"/>
                            <h1 style="font-size: 28px; font-weight: bold; margin: 0;">Job Card</h1>
                            <p style="font-size: 14px; color: #666; margin: 0;">Part: <span style="font-weight: 600;">${jobToConfirm.partName} (x${jobToConfirm.quantity})</span></p>
                            <p style="font-size: 14px; color: #666; margin: 0;">Department: <span style="font-weight: 600;">${jobToConfirm.departmentName}</span></p>
                            ${jobToConfirm.vinNumber ? `<p style="font-size: 14px; color: #666; margin: 0;">VIN: <span style="font-weight: 600;">${jobToConfirm.vinNumber}</span></p>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <img src="${qrCodeDataUrl}" alt="QR Code" style="margin-bottom: 5px;"/>
                            <p style="font-size: 10px; color: #999; margin: 0;">${jobToConfirm.jobId}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            ${jobToConfirm.photoUrl ? `<img src="${jobToConfirm.photoUrl}" alt="${jobToConfirm.partName}" style="width: 100%; height: 150px; border-radius: 8px; object-fit: cover; margin-bottom: 15px; border: 1px solid #ddd;" />` : `<div style="border-radius: 8px; width: 100%; height: 150px; margin-bottom: 15px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #aaa; border: 1px solid #ddd;"><span>No Image</span></div>`}
                            <div style="font-size: 13px; line-height: 1.6;">
                                <p style="margin: 0;"><b>Employee:</b> ${jobToConfirm.employeeName}</p>
                                <p style="margin: 0;"><b>Est. Time:</b> ${jobToConfirm.estimatedTime || 'N/A'} mins</p>
                                <p style="margin: 0;"><b>Description:</b> ${jobToConfirm.description || 'No description.'}</p>
                            </div>
                        </div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            <div>
                                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Required Tools & Accessories</h3>
                                <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                    ${jobToConfirm.tools?.length > 0 ? jobToConfirm.tools.map(tool => `<li>${tool.name}</li>`).join('') : '<li>No tools specified.</li>'}
                                    ${jobToConfirm.accessories?.length > 0 ? jobToConfirm.accessories.map(acc => `<li style="margin-left: 15px;">${acc.name}</li>`).join('') : ''}
                                </ul>
                            </div>
                            <div style="margin-top: 20px;">
                                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Required Consumables</h3>
                                <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                    ${jobToConfirm.processedConsumables?.length > 0 ? jobToConfirm.processedConsumables.map(c => `<li><span style="font-weight: 600;">${c.name}</span>: ${c.quantity} ${c.unit}</li>`).join('') : '<li>No consumables specified.</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                        <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Steps</h3>
                        <ol style="list-style: decimal; padding-left: 20px; margin: 0;">
                            ${jobToConfirm.steps?.length > 0 ? jobToConfirm.steps.map(step => `<li>${step}</li>`).join('') : '<li>No steps defined.</li>'}
                        </ol>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank', 'height=800,width=1000');
            if (printWindow) {
                printWindow.document.write(`<html><head><title>Job Card ${jobToConfirm.jobId}</title></head><body>${printContents}</body></html>`);
                printWindow.document.close();
                printWindow.onload = () => { setTimeout(() => printWindow.print(), 500); };
            } else {
                toast("The print window was blocked. Please allow popups.", { icon: 'â„¹ï¸' });
            }

            handleResetFormAndPreview();

        } catch (error) {
            console.error("Error creating job card:", error);
            toast.error("Failed to generate job card.");
        }
    };

    const renderActionButton = () => {
        if (!jobDetails) return null;
        if (showDefineRecipeForm) {
            return (
                <Button onClick={saveNewRecipeAndCreateJob} variant="primary" disabled={isSavingNewRecipe}>
                     {isSavingNewRecipe ? 'Saving...' : 'Define Recipe & Create Job'}
                </Button>
            );
        } else {
            return (
                <Button onClick={handleGenerateNewJobCard} variant="primary">
                    Generate New Job Card
                </Button>
                 );
        }
    };

    if (loading) return <p className="text-center text-gray-400">Loading Product Catalog & Recipes...</p>;

    return (
        <>
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg mt-8">
                <h3 className="text-lg font-semibold text-white mb-6 text-center">
                    Create New Job from Catalog
                </h3>
                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <Dropdown label="1. Product Category" name="categoryId" value={selection.categoryId} onChange={handleSelection} options={allData.categories} placeholder="Select Category..." />
                    <Dropdown label="2. Product" name="productId" value={selection.productId} onChange={handleSelection} options={filteredProducts} placeholder="Select Product..." disabled={!selection.categoryId} />
                    <div className="grid grid-cols-2 gap-4">
                        <Input label="3. Quantity" name="quantity" type="number" min="1" value={selection.quantity} onChange={handleSelection} />
                        <Dropdown label="4. Department" name="departmentId" value={selection.departmentId} onChange={handleSelection} options={allData.departments} placeholder="Select Dept..." />
                    </div>
                    <Dropdown label="5. Employee (Optional)" name="employeeId" value={selection.employeeId} onChange={handleSelection} options={filteredEmployees} placeholder="Select Employee..." disabled={!selection.departmentId} />
                    <Dropdown label="6. Job Category" name="jobCategory" value={selection.jobCategory} onChange={handleSelection} options={jobCategoryOptions} />
                    {recipeRequiresVin && (
                        <Input label="7. VIN Number" name="vinNumber" value={selection.vinNumber} onChange={handleSelection} placeholder="Enter Vehicle VIN..." />
                    )}
                </div>
                
                {showDefineRecipeForm && selection.productId && selection.departmentId && (
                    <div className="mt-8 p-6 bg-gray-900/50 rounded-lg border border-gray-700 animate-fade-in">
                        <h4 className="text-xl font-bold text-white mb-4">Define Recipe for New Product-Department Combination</h4>
                         <p className="text-gray-400 text-sm mb-4">No standard recipe found. Please define it now to create the first job card and save for future use.</p>
                        <div className="space-y-4">
                            <Input label="Description" name="description" value={tempRecipeDetails.description} onChange={handleTempRecipeInputChange} placeholder="e.g., Final assembly of side skirt" />
                           <Input label="Estimated Time (minutes)" name="estimatedTime" type="number" value={tempRecipeDetails.estimatedTime} onChange={handleTempRecipeInputChange} placeholder="e.g., 45" />
                            <Textarea label="Steps (one per line)" name="steps" value={tempRecipeDetails.steps} onChange={handleTempRecipeInputChange} rows={5} placeholder="1. Align panels...&#10;2. Apply adhesive..." />
                            <div>
                                <h5 className="font-semibold text-white mb-2">Required Tools & Accessories for Recipe</h5>
                                <div className="max-h-40 overflow-y-auto space-y-2 p-3 bg-gray-800 rounded-lg">
                                    {(allData.tools || []).map(tool => (
                                        <div key={tool.id}>
                                             <label className="flex items-center space-x-2 text-sm font-semibold text-gray-200">
                                                <input type="checkbox" checked={tempRecipeDetails.tools.has(tool.id)} onChange={() => handleTempRecipeToolToggle(tool.id)} className="h-4 w-4 rounded bg-gray-700 text-blue-600 focus:ring-blue-500" />
                                                 <span>{tool.name}</span>
                                            </label>
                                            {tempRecipeDetails.tools.has(tool.id) && (
                                                   <div className="pl-6 mt-1 space-y-1 text-xs border-l-2 border-gray-700">
                                                    {(allData.toolAccessories.filter(acc => acc.toolId === tool.id)).map(accessory => (
                                                         <label key={accessory.id} className="flex items-center space-x-2 text-xs text-gray-300">
                                                            <input type="checkbox" checked={tempRecipeDetails.accessories.has(accessory.id)} onChange={() => handleTempRecipeAccessoryToggle(accessory.id)} className="h-3 w-3 rounded bg-gray-700 text-blue-600 focus:ring-blue-500" />
                                                                   <span>{accessory.name}</span>
                                                        </label>
                                                     ))}
                                                </div>
                                            )}
                                         </div>
                                    ))}
                                </div>
                             </div>
                            <div>
                                <ConsumableEditor
                                    allConsumables={allData.allConsumables}
                                     selectedConsumables={tempRecipeDetails.consumables}
                                    onAdd={handleTempRecipeConsumableAdd}
                                    onRemove={handleTempRecipeConsumableRemove}
                                />
                                 </div>
                        </div>
                    </div>
                )}
                
                 {jobDetails && (
                           <div className="mt-8 text-center">
                        {renderActionButton()}
                    </div>
                )}
            </div>

            {jobToConfirm && (
                     <PrintConfirmationModal 
                    jobDetails={jobToConfirm}
                    onClose={() => setJobToConfirm(null)}
                    onConfirmPrint={handleConfirmPrint}
                />
            )}
        </>
    );
};

export default JobCardCreator;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\job_cards\JobDetailsPanel.jsx
==================================================
// src/components/features/job_cards/JobDetailsPanel.jsx

import React, { useEffect, useState } from 'react';
import { getJobByJobId, listenToJobCards } from '../../../api/firestore';
import toast from 'react-hot-toast';

const JobDetailsPanel = ({ jobId }) => {
  const [job, setJob] = useState(null);
  const [relatedJobs, setRelatedJobs] = useState([]);

  useEffect(() => {
    const load = async () => {
      try {
        const jobData = await getJobByJobId(jobId);
        setJob(jobData);

        if (jobData.parentJobId) {
          const unsub = listenToJobCards(all => {
            const siblings = all.filter(j => j.parentJobId === jobData.parentJobId);
            setRelatedJobs(siblings);
          });
          return () => unsub();
        }
      } catch (err) {
        console.error(err);
        toast.error("Failed to load job details.");
      }
    };

    load();
  }, [jobId]);

  if (!job) return <p className="text-gray-400">Loading job details...</p>;

  return (
    <div className="bg-gray-800 p-6 rounded-xl text-white shadow-lg border border-gray-700">
      <h2 className="text-xl font-bold mb-2">{job.partName}</h2>
      <p className="text-sm text-gray-400 mb-2">{job.jobId}</p>
      <p><strong>Department:</strong> {job.departmentName}</p>
      <p><strong>Employee:</strong> {job.employeeName}</p>
      <p><strong>Status:</strong> {job.status}</p>
      <p><strong>Quantity:</strong> {job.quantity}</p>
      <p><strong>Estimated Time:</strong> {job.estimatedTime} mins</p>
      {job.totalCost && (
        <div className="mt-2">
          <p><strong>Total Cost:</strong> R{job.totalCost.toFixed(2)}</p>
          <ul className="text-sm text-gray-300">
            <li>Material: R{job.materialCost?.toFixed(2)}</li>
            <li>Labor: R{job.laborCost?.toFixed(2)}</li>
            <li>Machine: R{job.machineCost?.toFixed(2)}</li>
          </ul>
        </div>
      )}
      {job.issueReason && (
        <p className="text-red-400 mt-2"><strong>Issue:</strong> {job.issueReason}</p>
      )}

      {job.parentJobId && (
        <div className="mt-4">
          <h4 className="text-lg font-bold mb-1">Linked Stages (Batch ID: {job.parentJobId})</h4>
          <ul className="text-sm bg-gray-700 rounded-lg p-2 space-y-1">
            {relatedJobs.sort((a, b) => a.jobId.localeCompare(b.jobId)).map(j => (
              <li key={j.id} className={`${j.jobId === jobId ? 'text-blue-400' : 'text-white'}`}>
                {j.jobId}: {j.departmentName} â€” {j.status}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};

export default JobDetailsPanel;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\job_cards\MultiStageJobWizard.jsx
==================================================
// src/components/features/job_cards/MultiStageJobWizard.jsx

import React, { useEffect, useState } from 'react';
import {
  getDepartments,
  getEmployees,
  getProducts,
  getJobStepDetails,
  addJobCard
} from '../../../api/firestore';
import Dropdown from '../../ui/Dropdown';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import toast from 'react-hot-toast';

const MultiStageJobWizard = () => {
  const [products, setProducts] = useState([]);
  const [departments, setDepartments] = useState([]);
  const [employees, setEmployees] = useState([]);
  const [jobStepMap, setJobStepMap] = useState({});
  const [selectedProductId, setSelectedProductId] = useState('');
  const [quantity, setQuantity] = useState(1);
  const [loading, setLoading] = useState(true);
  const [creating, setCreating] = useState(false);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [prods, depts, emps, steps] = await Promise.all([
          getProducts(),
          getDepartments(),
          getEmployees(),
          getJobStepDetails()
        ]);
        setProducts(prods);
        setDepartments(depts);
        setEmployees(emps);

        const stepMap = {};
        steps.forEach(step => {
          if (!step.productId || !step.departmentId) return;
          const key = `${step.productId}_${step.departmentId}`;
          stepMap[key] = step;
        });
        setJobStepMap(stepMap);
      } catch (err) {
        console.error(err);
        toast.error("Error loading data.");
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  const createMultiStageJobs = async () => {
    if (!selectedProductId || quantity <= 0) {
      toast.error("Please select a product and enter a valid quantity.");
      return;
    }

    const jobIdPrefix = `ROUTED-${Date.now()}`;
    const selectedProduct = products.find(p => p.id === selectedProductId);
    const relevantSteps = Object.entries(jobStepMap)
      .filter(([key, step]) => key.startsWith(selectedProductId))
      .map(([_, step]) => step)
      .sort((a, b) => (a.order || 0) - (b.order || 0));

    if (relevantSteps.length === 0) {
      toast.error("No job steps found for this product.");
      return;
    }

    setCreating(true);

    try {
      for (let i = 0; i < relevantSteps.length; i++) {
        const step = relevantSteps[i];
        const dept = departments.find(d => d.id === step.departmentId);
        const employee = employees.find(e => e.skills?.[step.requiredSkillId] > 0) || { id: 'unassigned', name: 'Unassigned' };

        await addJobCard({
          jobId: `${jobIdPrefix}-${i + 1}`,
          partId: selectedProduct.id,
          partName: selectedProduct.name,
          quantity,
          departmentId: step.departmentId,
          departmentName: dept?.name || 'Unknown',
          employeeId: employee.id,
          employeeName: employee.name,
          status: 'Pending',
          description: step.description || '',
          estimatedTime: step.estimatedTime || 60,
          steps: step.steps || [],
          tools: step.tools || [],
          accessories: step.accessories || [],
          processedConsumables: step.consumables || [],
          isCustomJob: false,
          parentJobId: jobIdPrefix,
          requiredSkills: dept?.requiredSkills || []
        });
      }

      toast.success(`Created ${relevantSteps.length} staged jobs successfully.`);
    } catch (err) {
      console.error(err);
      toast.error("Failed to create staged jobs.");
    } finally {
      setCreating(false);
    }
  };

  if (loading) return <p className="text-gray-400 text-center">Loading product and routing data...</p>;

  return (
    <div className="p-6 bg-gray-900 border border-gray-700 rounded-xl shadow-lg max-w-3xl mx-auto">
      <h2 className="text-xl font-bold text-white mb-4">Multi-Stage Job Creator</h2>
      <div className="mb-4">
        <Dropdown
          label="Select Product"
          options={products.map(p => ({ label: p.name, value: p.id }))}
          value={selectedProductId}
          onChange={setSelectedProductId}
        />
      </div>
      <div className="mb-4">
        <Input
          label="Quantity"
          type="number"
          value={quantity}
          onChange={(e) => setQuantity(Number(e.target.value))}
        />
      </div>
      <Button onClick={createMultiStageJobs} disabled={creating}>
        {creating ? "Creating..." : "Create Multi-Stage Jobs"}
      </Button>
    </div>
  );
};

export default MultiStageJobWizard;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\job_cards\PrintConfirmationModal.jsx
==================================================
// src/components/features/job_cards/PrintConfirmationModal.jsx (NEW FILE)

import React from 'react';
import Button from '../../ui/Button';
import { X, Printer } from 'lucide-react';

const DetailItem = ({ label, value }) => (
    <div>
        <p className="text-xs text-gray-400">{label}</p>
        <p className="text-sm text-white font-semibold">{value || 'N/A'}</p>
    </div>
);

const PrintConfirmationModal = ({ jobDetails, onClose, onConfirmPrint }) => {
    if (!jobDetails) return null;

    return (
        <div 
            onClick={onClose} 
            className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-fade-in"
        >
            <div 
                onClick={(e) => e.stopPropagation()} 
                className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg"
            >
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white">Confirm Job Card Details</h3>
                    <Button onClick={onClose} variant="secondary" className="p-2">
                        <X size={20} />
                    </Button>
                </div>
                <div className="p-6 space-y-4">
                    <h4 className="text-2xl text-blue-400 font-bold">{jobDetails.partName}</h4>
                    <div className="grid grid-cols-2 gap-4">
                        <DetailItem label="Job ID" value={jobDetails.jobId} />
                        <DetailItem label="Department" value={jobDetails.departmentName} />
                        <DetailItem label="Assigned Employee" value={jobDetails.employeeName} />
                        <DetailItem label="Estimated Time" value={`${jobDetails.estimatedTime} minutes`} />
                        <DetailItem label="Quantity" value={jobDetails.quantity} />
                        <DetailItem label="Category" value={jobDetails.jobCategory} />
                        {jobDetails.vinNumber && <DetailItem label="VIN Number" value={jobDetails.vinNumber} />}
                    </div>
                    <div>
                        <p className="text-xs text-gray-400 mb-1">Steps Overview</p>
                        <p className="text-sm text-gray-300 bg-gray-900/50 p-3 rounded-md max-h-24 overflow-y-auto">
                            {(jobDetails.steps || []).join(', ')}
                        </p>
                    </div>
                </div>
                <div className="p-4 bg-gray-900/50 flex justify-end gap-2">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button variant="primary" onClick={onConfirmPrint}>
                        <Printer size={18} className="mr-2"/>
                        Confirm & Print
                    </Button>
                </div>
            </div>
        </div>
    );
};

export default PrintConfirmationModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\job_cards\StandardJobCreatorModal.jsx
==================================================
// src/components/features/job_cards/StandardJobCreatorModal.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { getDepartments, getEmployees, addJobCard, getRecipeForProductDepartment, getProducts, getAllInventoryItems, getTools, getToolAccessories } from '../../../api/firestore';
import { processConsumables } from '../../../utils/jobUtils';
import Dropdown from '../../ui/Dropdown';
import Button from '../../ui/Button';
import { X, Package } from 'lucide-react';
import QRCode from 'qrcode';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const StandardJobCreatorModal = ({ salesOrder, lineItem, onClose }) => {
    const [departments, setDepartments] = useState([]);
    const [employees, setEmployees] = useState([]);
    const [allProducts, setAllProducts] = useState([]);
    const [allInventory, setAllInventory] = useState([]);
    const [allTools, setAllTools] = useState([]);
    const [allAccessories, setAllAccessories] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selection, setSelection] = useState({ departmentId: '', employeeId: '' });

    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            try {
                const [depts, emps, prods, inventory, tools, accessories] = await Promise.all([
                    getDepartments(), 
                    getEmployees(), 
                    getProducts(),
                    getAllInventoryItems(),
                    getTools(),
                    getToolAccessories()
                ]);
                setDepartments(depts);
                setEmployees(emps);
                setAllProducts(prods);
                setAllInventory(inventory);
                setAllTools(tools);
                setAllAccessories(accessories);
            } catch (error) {
                toast.error("Failed to load necessary data for job creation."); // --- REPLACE ALERT ---
                console.error(error);
            }
            setLoading(false);
        };
        fetchData();
    }, []);

    const handleSelectionChange = (e) => {
        const { name, value } = e.target;
        setSelection(prev => ({...prev, [name]: value}));
    };

    const handleSubmit = async () => {
        if (!selection.departmentId) {
            return toast.error("Please select a department."); // --- REPLACE ALERT ---
        }
        
        const product = allProducts.find(p => p.id === lineItem.productId);
        if (!product) {
            return toast.error("Could not find the product details for this line item."); // --- REPLACE ALERT ---
        }
        
        const recipe = await getRecipeForProductDepartment(lineItem.productId, selection.departmentId);
        if (!recipe) {
            return toast.error(`No recipe found for "${product.name}" in the selected department. Please define one in Settings first.`); // --- REPLACE ALERT ---
        }
        
        const department = departments.find(d => d.id === selection.departmentId);
        const employee = employees.find(e => e.id === selection.employeeId);
        const newJobId = `JOB-${Date.now()}`;

        const toolsForJobCard = allTools.filter(t => (recipe.tools || []).includes(t.id));
        const accessoriesForJobCard = allAccessories.filter(a => (recipe.accessories || []).includes(a.id));
        const processedConsumables = processConsumables(recipe.consumables, allInventory, 20);

        const finalJobData = {
            jobId: newJobId,
            partName: product.name,
            partId: product.id,
            departmentId: selection.departmentId,
            departmentName: department?.name || 'Unknown',
            employeeId: selection.employeeId || 'unassigned',
            employeeName: employee?.name || 'Unassigned',
            status: 'Pending',
            description: recipe.description,
            estimatedTime: recipe.estimatedTime,
            steps: recipe.steps.map(s => s.text || s),
            tools: toolsForJobCard,
            accessories: accessoriesForJobCard,
            consumables: recipe.consumables,
            processedConsumables: processedConsumables,
            isCustomJob: false,
            salesOrderId: salesOrder.id,
            requiredSkills: recipe.requiredSkills || [],
        };
        
        try {
            const qrCodeDataUrl = await QRCode.toDataURL(newJobId, { width: 80 });

            await addJobCard(finalJobData);
            toast.success(`Job card created successfully for ${product.name}!`); // --- REPLACE ALERT ---
            
            const imageSection = product.photoUrl
                ? `<img src="${product.photoUrl}" alt="${product.name}" style="width: 100%; height: 200px; border-radius: 8px; object-fit: cover; margin-bottom: 15px; border: 1px solid #ddd;" />`
                : `<div style="border-radius: 8px; width: 100%; height: 200px; margin-bottom: 15px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #aaa; border: 1px solid #ddd;"><span>No Image Available</span></div>`;

            const printContents = `
                <div style="font-family: sans-serif; padding: 20px; color: #333;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: bold; margin: 0;">Job Card</h1>
                            <p style="font-size: 14px; color: #666; margin: 0;">Part: <span style="font-weight: 600;">${finalJobData.partName}</span></p>
                            <p style="font-size: 14px; color: #666; margin: 0;">Department: <span style="font-weight: 600;">${finalJobData.departmentName}</span></p>
                        </div>
                        <div style="text-align: right;">
                            <img src="${qrCodeDataUrl}" alt="QR Code" style="margin-bottom: 5px;"/>
                            <p style="font-size: 10px; color: #999; margin: 0;">${newJobId}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            ${imageSection}
                            <div style="font-size: 13px; line-height: 1.6;">
                                <p style="margin: 0;"><b>Employee:</b> ${finalJobData.employeeName}</p>
                                <p style="margin: 0;"><b>Est. Time:</b> ${finalJobData.estimatedTime || 'N/A'} mins</p>
                                <p style="margin: 0;"><b>Description:</b> ${finalJobData.description || 'No description.'}</p>
                            </div>
                        </div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            <div>
                                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Required Tools & Accessories</h3>
                                <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                    ${finalJobData.tools?.length > 0 ? finalJobData.tools.map(tool => `<li>${tool.name}</li>`).join('') : '<li>No tools required.</li>'}
                                    ${finalJobData.accessories?.length > 0 ? finalJobData.accessories.map(acc => `<li style="margin-left: 15px;">${acc.name}</li>`).join('') : ''}
                                </ul>
                            </div>
                            <div style="margin-top: 20px;">
                                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Required Consumables</h3>
                                <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                    ${finalJobData.processedConsumables?.length > 0 ? finalJobData.processedConsumables.map(c => `<li><span style="font-weight: 600;">${c.name}</span>: ${c.quantity.toFixed(2)} ${c.unit}</li>`).join('') : '<li>No consumables required.</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                        <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Steps</h3>
                        <ol style="list-style: decimal; padding-left: 20px; margin: 0;">
                            ${finalJobData.steps?.length > 0 ? finalJobData.steps.map(step => `<li>${step}</li>`).join('') : '<li>No steps defined.</li>'}
                        </ol>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank', 'height=800,width=1000');
            if (printWindow) {
                printWindow.document.write(`<html><head><title>Job Card ${newJobId}</title></head><body>${printContents}</body></html>`);
                printWindow.document.close();
                printWindow.onload = () => { setTimeout(() => printWindow.print(), 500); };
            }

            onClose();
        } catch (error) {
            console.error("Error creating job card:", error);
            toast.error("Failed to create job card."); // --- REPLACE ALERT ---
        }
    };

    if (loading) {
        return (
            <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                 <div className="relative bg-gray-800 p-6 rounded-xl border border-gray-700 w-full max-w-lg">
                    <p className="text-center text-white">Loading data...</p>
                 </div>
            </div>
        );
    }

    return (
        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div className="relative bg-gray-800 p-6 rounded-xl border border-gray-700 w-full max-w-lg">
                <Button onClick={onClose} variant="danger" className="absolute -top-3 -right-3 z-10 rounded-full h-8 w-8 p-1">
                    <X size={16}/>
                </Button>
                
                <div className="flex items-center gap-3 mb-4">
                    <Package size={24} className="text-blue-400" />
                    <div>
                        <h3 className="text-xl font-bold text-white">Create Standard Job</h3>
                        <p className="text-gray-300">For Product: {lineItem.description}</p>
                    </div>
                </div>

                <div className="space-y-4">
                    <Dropdown
                        label="Assign to Department"
                        name="departmentId"
                        value={selection.departmentId}
                        onChange={handleSelectionChange}
                        options={departments}
                        placeholder="Select a department..."
                    />
                    <Dropdown
                        label="Assign to Employee (Optional)"
                        name="employeeId"
                        value={selection.employeeId}
                        onChange={handleSelectionChange}
                        options={employees.filter(e => e.departmentId === selection.departmentId)}
                        placeholder="Select an employee..."
                        disabled={!selection.departmentId}
                    />
                </div>

                <div className="mt-6 flex justify-end">
                    <Button onClick={handleSubmit} variant="primary">Generate Job Card & Print</Button>
                </div>
            </div>
        </div>
    );
};

export default StandardJobCreatorModal;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\kanban\KanbanBoard.jsx
==================================================
// src/components/features/kanban/KanbanBoard.jsx (UPDATED with Optimistic UI)
// The onDragEnd handler has been significantly improved to provide a smooth,
// instantaneous user experience by manually updating the local state immediately
// after a drag, preventing the "jumping" effect caused by Firestore latency.

import React, { useMemo, useState, useEffect } from 'react';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';
import { logScanEvent } from '../../../api/firestore';
import toast from 'react-hot-toast';
import { GripVertical, GraduationCap } from 'lucide-react';

const JobCard = ({ job, index }) => {
    const isTrainingRecommended = useMemo(() => {
        if (!job.requiredSkills || !job.employeeSkills) return false;
        return job.requiredSkills.some(reqSkill => {
            const employeeProficiency = job.employeeSkills[reqSkill.skillId] || 0;
            return reqSkill.minProficiency > 1 && employeeProficiency < reqSkill.minProficiency;
        });
    }, [job.requiredSkills, job.employeeSkills]);

    return (
        <Draggable draggableId={job.id} index={index}>
            {(provided, snapshot) => (
                <div
                    ref={provided.innerRef}
                    {...provided.draggableProps}
                    {...provided.dragHandleProps}
                    className={`p-3 rounded-lg bg-gray-700 border border-gray-600 shadow-md mb-3 transition-all ${snapshot.isDragging ? 'ring-2 ring-blue-500 shadow-xl' : ''}`}
                >
                    <div className="flex items-start gap-2">
                        <GripVertical className="text-gray-500 mt-1 flex-shrink-0" />
                        <div>
                            <p className="font-semibold text-white text-sm">{job.partName}</p>
                            <p className="text-xs text-gray-400 font-mono">{job.jobId}</p>
                            <div className="flex items-center gap-2 mt-1">
                                <p className="text-xs text-blue-400">{job.employeeName || 'Unassigned'}</p>
                                {isTrainingRecommended && (
                                    <span title="Training recommended for this job">
                                        <GraduationCap size={16} className="text-yellow-400" />
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </Draggable>
    );
};

const KanbanColumn = ({ status, jobs }) => {
    const statusConfig = {
        'Pending': { title: 'Pending', color: 'border-t-yellow-400' },
        'In Progress': { title: 'In Progress', color: 'border-t-blue-400' },
        'Awaiting QC': { title: 'Awaiting QC', color: 'border-t-purple-400' },
    };
    const config = statusConfig[status];

    return (
        <div className={`bg-gray-800/50 rounded-xl p-4 w-full md:w-1/3 border-t-4 ${config.color}`}>
            <h3 className="font-bold text-white mb-4">{config.title} ({jobs.length})</h3>
            <Droppable droppableId={status}>
                {(provided, snapshot) => (
                    <div
                        ref={provided.innerRef}
                        {...provided.droppableProps}
                        className={`min-h-[400px] transition-colors rounded-lg ${snapshot.isDraggingOver ? 'bg-blue-900/20' : ''}`}
                    >
                        {jobs.map((job, index) => (
                            <JobCard 
                                key={job.id} 
                                job={job} 
                                index={index} 
                            />
                        ))}
                        {provided.placeholder}
                    </div>
                )}
            </Droppable>
        </div>
    );
};

const KanbanBoard = ({ jobs, employees }) => {
    // --- NEW: Local state to manage the jobs for a smooth UI ---
    const [localJobs, setLocalJobs] = useState(jobs);

    // When the jobs from props change (from Firestore), update our local state
    useEffect(() => {
        const employeesMap = new Map(employees.map(e => [e.id, e]));
        const enrichedJobs = jobs.map(job => {
            const employee = employeesMap.get(job.employeeId);
            return {
                ...job,
                employeeSkills: employee ? employee.skills : {},
                employeeName: employee ? employee.name : 'Unassigned'
            };
        });
        setLocalJobs(enrichedJobs);
    }, [jobs, employees]);

    const columns = useMemo(() => {
        const pending = localJobs.filter(j => j.status === 'Pending').sort((a,b) => (a.priority ?? Infinity) - (b.priority ?? Infinity));
        const inProgress = localJobs.filter(j => j.status === 'In Progress');
        const awaitingQc = localJobs.filter(j => j.status === 'Awaiting QC');
        return { 'Pending': pending, 'In Progress': inProgress, 'Awaiting QC': awaitingQc };
    }, [localJobs]);

    const onDragEnd = (result) => {
        const { source, destination, draggableId } = result;
        if (!destination || (source.droppableId === destination.droppableId && source.index === destination.index)) {
            return;
        }

        const jobToMove = localJobs.find(j => j.id === draggableId);
        if (!jobToMove) return;

        // WIP Limit Check
        if (destination.droppableId === 'In Progress') {
            const employeeWip = localJobs.filter(j => j.employeeId === jobToMove.employeeId && j.status === 'In Progress');
            if (employeeWip.length > 0) {
                toast.error(`${jobToMove.employeeName} is already working on another job.`);
                return;
            }
        }
        
        // --- THIS IS THE FIX: Optimistic UI Update ---
        // 1. Manually update the local state immediately for a smooth visual transition.
        const updatedJobs = localJobs.map(job => 
            job.id === draggableId 
                ? { ...job, status: destination.droppableId } 
                : job
        );
        setLocalJobs(updatedJobs);
        // --- END OF FIX ---

        // 2. Send the update to the backend in the background.
        // The Firestore listener will eventually send this same update back, but our UI won't flicker.
        logScanEvent(jobToMove, destination.droppableId)
            .then(() => {
                toast.success(`Job moved to "${destination.droppableId}"`);
            })
            .catch(error => {
                console.error("Failed to log scan event:", error);
                toast.error("Failed to update job status.");
                // If the backend update fails, revert the local state to show the error.
                setLocalJobs(jobs); 
            });
    };

    return (
        <DragDropContext onDragEnd={onDragEnd}>
            <div className="flex flex-col md:flex-row gap-6 h-full overflow-x-auto">
                <KanbanColumn status="Pending" jobs={columns['Pending']} />
                <KanbanColumn status="In Progress" jobs={columns['In Progress']} />
                <KanbanColumn status="Awaiting QC" jobs={columns['Awaiting QC']} />
            </div>
        </DragDropContext>
    );
};

export default KanbanBoard;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\payroll\LivePayrollSummary.jsx
==================================================
// src/components/features/payroll/LivePayrollSummary.jsx (FIXED)

import React, { useState, useEffect } from 'react';
// --- CORRECTED IMPORTS ---
import { collection, query, where, getDocs } from 'firebase/firestore';
import { getEmployees } from '../../../api/firestore';
import { db } from '../../../api/firebase';
// -------------------------
import { DollarSign, Clock } from 'lucide-react';

const KpiCard = ({ icon, title, value }) => (
    <div className="bg-gray-900/50 p-6 rounded-lg border border-gray-700">
        <div className="flex items-start space-x-4">
            <div className="p-3 rounded-full bg-blue-500/20 text-blue-400">
                {icon}
            </div>
            <div>
                <p className="text-gray-400 text-sm">{title}</p>
                <p className="text-3xl font-bold text-white">{value}</p>
            </div>
        </div>
    </div>
);

const calculateWorkdayHours = (startTime, endTime) => {
    if (!startTime || !endTime) return 0;
    const breakMinutes = 45;
    const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);
    const workMinutes = Math.max(0, durationMinutes - breakMinutes);
    return workMinutes / 60;
};

const LivePayrollSummary = () => {
    const [loading, setLoading] = useState(true);
    const [stats, setStats] = useState({ totalHours: 0, accruedWages: 0 });

    useEffect(() => {
        const calculateSummary = async () => {
            setLoading(true);
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const [employees, scanEventsSnapshot] = await Promise.all([
                getEmployees(),
                getDocs(query(collection(db, 'scanEvents'), where('timestamp', '>=', startOfMonth)))
            ]);

            const permanentStaff = employees.filter(e => e.employeeType === 'permanent');
            const staffRates = new Map(permanentStaff.map(s => [s.id, s.hourlyRate || 0]));
            const scanEvents = scanEventsSnapshot.docs.map(d => ({ ...d.data(), timestamp: d.data().timestamp.toDate() }));

            const dailyScans = {};
            for (const event of scanEvents) {
                if (!event.employeeId || !staffRates.has(event.employeeId)) continue;
                const dateStr = event.timestamp.toISOString().split('T')[0];
                const key = `${event.employeeId}_${dateStr}`;
                if (!dailyScans[key]) {
                    dailyScans[key] = { employeeId: event.employeeId, scans: [] };
                }
                dailyScans[key].scans.push(event.timestamp);
            }

            let totalHours = 0;
            let accruedWages = 0;

            Object.values(dailyScans).forEach(dayData => {
                const firstScan = dayData.scans[0];
                const lastScan = dayData.scans[dayData.scans.length - 1];
                const hours = calculateWorkdayHours(firstScan, lastScan);
                const rate = staffRates.get(dayData.employeeId);
                
                totalHours += hours;
                accruedWages += hours * rate;
            });

            setStats({ totalHours, accruedWages });
            setLoading(false);
        };

        calculateSummary();
    }, []);

    if (loading) {
        return <p className="text-sm text-center text-gray-400">Calculating live payroll summary...</p>;
    }

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <KpiCard 
                icon={<Clock size={24} />} 
                title="Total Hours Logged (This Month)" 
                value={stats.totalHours.toFixed(1)} 
            />
            <KpiCard 
                icon={<DollarSign size={24} />} 
                title="Accrued Staff Wages (This Month)" 
                value={`R ${stats.accruedWages.toLocaleString('en-ZA', { minimumFractionDigits: 2 })}`} 
            />
        </div>
    );
};

export default LivePayrollSummary;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\payroll\PermanentPayroll.jsx
==================================================
// src/components/features/payroll/PermanentPayroll.jsx (REFACTORED)
// This component is now highly efficient as it queries the pre-calculated `employeeDailyLogs` collection
// instead of processing thousands of raw scan events on the client-side.

import React, { useState, useEffect } from 'react';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { getDocs, collection, query, where, orderBy } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import { getEmployees } from '../../../api/firestore';
import { ChevronDown, ChevronRight } from 'lucide-react';
import toast from 'react-hot-toast';

const PermanentPayroll = () => {
    const [employees, setEmployees] = useState([]);
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');
    const [payrollResults, setPayrollResults] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [expandedEmployeeId, setExpandedEmployeeId] = useState(null);

    // Fetch the list of permanent employees once on component mount.
    useEffect(() => {
        const fetchEmployeesData = async () => {
            try {
                const fetchedEmployees = await getEmployees();
                setEmployees(fetchedEmployees.filter(e => e.employeeType === 'permanent'));
            } catch (err) {
                console.error("Error fetching employees:", err);
                setError("Failed to load employee data.");
                toast.error("Failed to load employee data.");
            }
        };
        fetchEmployeesData();
    }, []);

    /**
     * Handles the calculation of payroll for the selected date range.
     * Queries the pre-aggregated `employeeDailyLogs` collection.
     */
    const handleCalculatePayroll = async () => {
        if (!startDate || !endDate) {
            setError("Please select both a start and end date.");
            toast.error("Please select both a start and end date.");
            return;
        }
        setLoading(true);
        setError(null);
        setPayrollResults(null);

        try {
            // THE KEY CHANGE: Query the new, clean, and pre-calculated collection.
            // This query is fast and scalable.
            const logsQuery = query(
                collection(db, 'employeeDailyLogs'),
                where('date', '>=', startDate),
                where('date', '<=', endDate),
                orderBy('date', 'asc')
            );
            const logsSnapshot = await getDocs(logsQuery);
            const dailyLogs = logsSnapshot.docs.map(d => d.data());
            
            // Map over your list of employees to structure the results.
            const results = employees.map(employee => {
                const employeeLogs = dailyLogs.filter(log => log.employeeId === employee.id);
                const totalHours = employeeLogs.reduce((sum, log) => sum + (log.totalHours || 0), 0);
                const totalPay = totalHours * (employee.hourlyRate || 0);

                return {
                    ...employee,
                    totalHours,
                    totalPay,
                    dailyBreakdown: employeeLogs.map(log => ({
                        date: new Date(log.date),
                        startTime: log.startTime.toDate(),
                        endTime: log.endTime.toDate(),
                        totalHours: log.totalHours || 0,
                    })),
                };
            });

            setPayrollResults(results);
            toast.success("Payroll report generated successfully.");

        } catch (err) {
            console.error("Error calculating payroll:", err);
            setError("Failed to calculate payroll. Check console for details.");
            toast.error("An error occurred while generating the report.");
        } finally {
            setLoading(false);
        }
    };
    
    // Toggles the visibility of the detailed daily breakdown for an employee.
    const toggleEmployeeDetails = (employeeId) => {
        setExpandedEmployeeId(prevId => (prevId === employeeId ? null : employeeId));
    };

    return (
        <div className="space-y-6">
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4">Calculate Payroll Period</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-4">
                    <Input label="Period Start Date" type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} />
                    <Input label="Period End Date" type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} />
                    <Button onClick={handleCalculatePayroll} disabled={loading}>
                        {loading ? 'Calculating...' : 'Generate Hours Report'}
                    </Button>
                </div>
                {error && <p className="text-red-400 text-center">{error}</p>}
            </div>

            {payrollResults && (
                <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-gray-900/50">
                            <tr className="border-b border-gray-600">
                                <th className="p-3 font-semibold text-gray-400"></th>
                                <th className="p-3 font-semibold text-gray-400">Employee</th>
                                <th className="p-3 font-semibold text-gray-400">Total Hours</th>
                                <th className="p-3 font-semibold text-gray-400">Total Pay</th>
                            </tr>
                        </thead>
                        <tbody>
                            {payrollResults.map(result => (
                                <React.Fragment key={result.id}>
                                    <tr onClick={() => toggleEmployeeDetails(result.id)} className="border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer">
                                        <td className="p-3 text-center">
                                            {expandedEmployeeId === result.id ? <ChevronDown size={16}/> : <ChevronRight size={16}/>}
                                        </td>
                                        <td className="p-3 text-gray-200 font-medium">{result.name}</td>
                                        <td className="p-3 text-gray-300 font-mono">{result.totalHours.toFixed(2)}</td>
                                        <td className="p-3 text-green-400 font-bold font-mono">R {result.totalPay.toFixed(2)}</td>
                                    </tr>
                                    {expandedEmployeeId === result.id && (
                                        <tr className="bg-gray-900">
                                            <td colSpan="4" className="p-4">
                                                <h4 className="font-bold text-white mb-2">Daily Breakdown</h4>
                                                <div className="space-y-2">
                                                    {result.dailyBreakdown.length > 0 ? result.dailyBreakdown.map(day => (
                                                        <div key={day.date.toISOString()} className="grid grid-cols-4 gap-4 bg-gray-800 p-2 rounded-md">
                                                            <span className="font-semibold text-gray-300">{day.date.toLocaleDateString('en-ZA', { weekday: 'long', day: 'numeric', month: 'short' })}</span>
                                                            <span className="text-gray-300">In: {day.startTime.toLocaleTimeString()}</span>
                                                            <span className="text-gray-300">Out: {day.endTime.toLocaleTimeString()}</span>
                                                            <span>Hours: {day.totalHours.toFixed(2)}</span>
                                                        </div>
                                                    )) : <p className="text-gray-500">No work logged in this period.</p>}
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

export default PermanentPayroll;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\payroll\SubcontractorLedger.jsx
==================================================
// src/components/features/payroll/SubcontractorLedger.jsx (Upgraded with Toasts)

import React, { useState, useEffect, useMemo } from 'react';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import { getEmployees, getProducts, listenToJobCards, addSubcontractorAdHocLog, addSubcontractorTeamLog } from '../../../api/firestore';
import { collection, query, where, orderBy, getDocs } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import { DollarSign, PlusCircle } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const SubcontractorLedger = () => {
    const [subcontractors, setSubcontractors] = useState([]);
    const [allProducts, setAllProducts] = useState([]);
    const [allJobs, setAllJobs] = useState([]);
    const [selectedSubcontractorId, setSelectedSubcontractorId] = useState('');
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');
    const [loading, setLoading] = useState(true);
    const [generating, setGenerating] = useState(false);
    const [results, setResults] = useState(null);

    const [adHocLog, setAdHocLog] = useState({ date: '', description: '', hours: '', rate: '' });
    const [teamLog, setTeamLog] = useState({ date: '', name: '', hours: '', rate: '' });

    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            try {
                const [allEmps, allProds] = await Promise.all([getEmployees(), getProducts()]);
                setSubcontractors(allEmps.filter(e => e.employeeType === 'subcontractor'));
                setAllProducts(allProds);
                const unsubscribe = listenToJobCards(setAllJobs);
                return unsubscribe;
            } catch (err) {
                console.error("Error fetching data for ledger:", err);
            } finally {
                setLoading(false);
            }
        };
        const unsubscribePromise = fetchData();
        return () => { unsubscribePromise.then(unsub => unsub && unsub()); };
    }, []);

    const selectedSubcontractor = useMemo(() => {
        return subcontractors.find(s => s.id === selectedSubcontractorId);
    }, [selectedSubcontractorId, subcontractors]);

    useEffect(() => {
        if (selectedSubcontractor?.paymentModel === 'per_hour') {
            setAdHocLog(prev => ({ ...prev, rate: selectedSubcontractor.rate }));
        } else {
            setAdHocLog(prev => ({ ...prev, rate: '' }));
        }
    }, [selectedSubcontractor]);

    const handleGenerateLedger = async () => {
        if (!selectedSubcontractor || !startDate || !endDate) return;
        setGenerating(true);
        setResults(null);

        const startDateTime = new Date(startDate);
        const endDateTime = new Date(endDate);
        endDateTime.setHours(23, 59, 59, 999);

        const completedJobs = allJobs.filter(job =>
            job.employeeId === selectedSubcontractor.id &&
            job.status === 'Complete' &&
            job.completedAt?.toDate() >= startDateTime &&
            job.completedAt?.toDate() <= endDateTime
        );

        let pieceWorkPay = 0;
        const pieceWorkJobs = completedJobs.map(job => {
            const product = allProducts.find(p => p.id === job.partId);
            let lineTotal = 0;
            if (selectedSubcontractor.paymentModel === 'per_kg' && product?.weight > 0) {
                lineTotal = product.weight * selectedSubcontractor.rate;
            } else if (selectedSubcontractor.paymentModel === 'per_product') {
                lineTotal = selectedSubcontractor.rate;
            }
            pieceWorkPay += lineTotal;
            return { ...job, product, lineTotal };
        }).filter(j => j.lineTotal > 0);

        const adHocQuery = query(collection(db, 'subcontractorAdHocLogs'), where('subcontractorId', '==', selectedSubcontractorId), where('date', '>=', startDate), where('date', '<=', endDate));
        const adHocSnapshot = await getDocs(adHocQuery);
        const adHocLogs = adHocSnapshot.docs.map(d => d.data());
        const adHocPay = adHocLogs.reduce((sum, log) => sum + (Number(log.hours) * Number(log.rate)), 0);

        const teamLogQuery = query(collection(db, 'subcontractorTeamLogs'), where('subcontractorId', '==', selectedSubcontractorId), where('date', '>=', startDate), where('date', '<=', endDate));
        const teamLogSnapshot = await getDocs(teamLogQuery);
        const teamLogs = teamLogSnapshot.docs.map(d => d.data());
        const teamPay = teamLogs.reduce((sum, log) => sum + (Number(log.hours) * Number(log.rate)), 0);

        setResults({ pieceWorkJobs, pieceWorkPay, adHocLogs, adHocPay, teamLogs, teamPay, grandTotal: pieceWorkPay + adHocPay + teamPay });
        setGenerating(false);
    };

    const handleAddAdHocLog = async () => {
        if (!adHocLog.date || !adHocLog.description || !adHocLog.hours || !adHocLog.rate) {
            return toast.error("Please fill all fields for the ad-hoc log, including the rate."); // --- REPLACE ALERT ---
        }
        await addSubcontractorAdHocLog({ ...adHocLog, subcontractorId: selectedSubcontractorId, subcontractorName: selectedSubcontractor.name });
        toast.success("Ad-hoc log added."); // Add success feedback
        setAdHocLog({ date: '', description: '', hours: '', rate: selectedSubcontractor?.paymentModel === 'per_hour' ? selectedSubcontractor.rate : '' });
        handleGenerateLedger(); // Refresh the ledger
    };

    const handleAddTeamLog = async () => {
        if (!teamLog.date || !teamLog.name || !teamLog.hours || !teamLog.rate) {
            return toast.error("Please fill all fields for the team member log."); // --- REPLACE ALERT ---
        }
        await addSubcontractorTeamLog({ ...teamLog, subcontractorId: selectedSubcontractorId, subcontractorName: selectedSubcontractor.name });
        toast.success("Team log added."); // Add success feedback
        setTeamLog({ date: '', name: '', hours: '', rate: '' });
        handleGenerateLedger(); // Refresh the ledger
    };

    return (
        <div className="space-y-6">
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4">Generate Subcontractor Payment Ledger</h3>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4">
                    <Dropdown label="Select Subcontractor" value={selectedSubcontractorId} onChange={e => setSelectedSubcontractorId(e.target.value)} options={subcontractors} placeholder="Choose subcontractor..."/>
                    <Input label="Period Start Date" type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} />
                    <Input label="Period End Date" type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} />
                    <Button onClick={handleGenerateLedger} disabled={generating || !selectedSubcontractorId}>
                        {generating ? 'Generating...' : 'Generate Ledger'}
                    </Button>
                </div>
            </div>

            {results && selectedSubcontractor && (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-green-900/50 border border-green-500/50 p-6 rounded-xl text-center">
                        <p className="text-sm font-medium text-green-300">Total Payment Due to {selectedSubcontractor.name}</p>
                        <p className="text-5xl font-bold text-white font-mono">R {results.grandTotal.toFixed(2)}</p>
                    </div>
                    
                    {selectedSubcontractor.paymentModel !== 'per_hour' && (
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                            <h4 className="font-bold text-white mb-2">Piece-Work Ledger ({selectedSubcontractor.paymentModel})</h4>
                            <table className="w-full text-left text-sm">
                                <thead><tr className="border-b border-gray-600"><th className="p-2">Completed Job</th><th className="p-2 text-right">Weight/Unit</th><th className="p-2 text-right">Rate</th><th className="p-2 text-right">Line Total</th></tr></thead>
                                <tbody>{results.pieceWorkJobs.map(job => (<tr key={job.id}><td className="p-2">{job.partName}</td><td className="p-2 text-right">{job.product?.weight || 1} {selectedSubcontractor.paymentModel === 'per_kg' ? 'kg' : 'unit'}</td><td className="p-2 text-right">R{selectedSubcontractor.rate.toFixed(2)}</td><td className="p-2 text-right font-bold">R{job.lineTotal.toFixed(2)}</td></tr>))}</tbody>
                                <tfoot><tr className="border-t-2 border-gray-600"><td colSpan="3" className="p-2 font-bold text-right">Piece-Work Subtotal</td><td className="p-2 text-right font-bold text-lg text-green-400">R{results.pieceWorkPay.toFixed(2)}</td></tr></tfoot>
                            </table>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 space-y-4">
                            <h4 className="font-bold text-white">Ad-Hoc Hourly Work ({selectedSubcontractor.name})</h4>
                            <div className="grid grid-cols-4 gap-2 items-end">
                                <Input label="Date" type="date" value={adHocLog.date} onChange={e => setAdHocLog({...adHocLog, date: e.target.value})} />
                                <Input label="Description" value={adHocLog.description} onChange={e => setAdHocLog({...adHocLog, description: e.target.value})} />
                                <Input label="Hours" type="number" value={adHocLog.hours} onChange={e => setAdHocLog({...adHocLog, hours: e.target.value})} />
                                <Input label="Rate" type="number" value={adHocLog.rate} placeholder="R/hr" onChange={e => setAdHocLog({...adHocLog, rate: e.target.value})} />
                            </div>
                            <Button onClick={handleAddAdHocLog} className="w-full"><PlusCircle size={16} className="mr-2"/>Log Ad-Hoc Hours</Button>
                            <table className="w-full text-left text-sm">
                                <thead><tr className="border-b border-gray-600"><th className="p-1">Date</th><th className="p-1">Description</th><th className="p-1 text-right">Hours</th><th className="p-1 text-right">Pay</th></tr></thead>
                                <tbody>{results.adHocLogs.map((log, i) => (<tr key={i}><td className="p-1">{log.date}</td><td className="p-1">{log.description}</td><td className="p-1 text-right">{log.hours}</td><td className="p-1 text-right">R{(log.hours * log.rate).toFixed(2)}</td></tr>))}</tbody>
                                <tfoot><tr className="border-t-2 border-gray-600"><td colSpan="3" className="p-1 font-bold text-right">Ad-Hoc Subtotal</td><td className="p-1 text-right font-bold text-lg text-green-400">R{results.adHocPay.toFixed(2)}</td></tr></tfoot>
                            </table>
                        </div>
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 space-y-4">
                            <h4 className="font-bold text-white">Team Hours</h4>
                            <div className="grid grid-cols-4 gap-2 items-end">
                                <Input label="Date" type="date" value={teamLog.date} onChange={e => setTeamLog({...teamLog, date: e.target.value})} />
                                <Input label="Name" value={teamLog.name} onChange={e => setTeamLog({...teamLog, name: e.target.value})} />
                                <Input label="Hours" type="number" value={teamLog.hours} onChange={e => setTeamLog({...teamLog, hours: e.target.value})} />
                                <Input label="Rate" type="number" value={teamLog.rate} onChange={e => setTeamLog({...teamLog, rate: e.target.value})} />
                            </div>
                            <Button onClick={handleAddTeamLog} className="w-full"><PlusCircle size={16} className="mr-2"/>Log Team Hours</Button>
                            <table className="w-full text-left text-sm">
                                <thead><tr className="border-b border-gray-600"><th className="p-1">Date</th><th className="p-1">Name</th><th className="p-1 text-right">Hours</th><th className="p-1 text-right">Pay</th></tr></thead>
                                <tbody>{results.teamLogs.map((log, i) => (<tr key={i}><td className="p-1">{log.date}</td><td className="p-1">{log.name}</td><td className="p-1 text-right">{log.hours}</td><td className="p-1 text-right">R{(log.hours * log.rate).toFixed(2)}</td></tr>))}</tbody>
                                <tfoot><tr className="border-t-2 border-gray-600"><td colSpan="3" className="p-1 font-bold text-right">Team Subtotal</td><td className="p-1 text-right font-bold text-lg text-green-400">R{results.teamPay.toFixed(2)}</td></tr></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default SubcontractorLedger;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\picking\PickingQueue.jsx
==================================================
// src/components/features/picking/PickingQueue.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { listenToPickingLists, markPickingListAsCompleted, getProducts } from '../../../api/firestore';
import Button from '../../ui/Button';
import { CheckCircle, Package, ChevronDown, ChevronRight, User, AlertTriangle } from 'lucide-react';
import toast from 'react-hot-toast';

const PickingListCard = ({ list, onMarkComplete, productsMap }) => {
    const [isExpanded, setIsExpanded] = useState(false);

    return (
        <div className="bg-gray-800 rounded-lg border border-gray-700">
            <div 
                className="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-700/50"
                onClick={() => setIsExpanded(!isExpanded)}
            >
                <div className="flex items-center gap-4">
                    {isExpanded ? <ChevronDown /> : <ChevronRight />}
                    <div>
                        <p className="font-bold text-white text-lg">{list.salesOrderId}</p>
                        <p className="text-sm text-gray-400 flex items-center gap-2">
                            <User size={14} />
                            {list.customerName}
                        </p>
                    </div>
                </div>
                <Button onClick={(e) => { e.stopPropagation(); onMarkComplete(list.id); }} variant="success">
                    <CheckCircle size={16} className="mr-2" />
                    Mark as Picked
                </Button>
            </div>

            {isExpanded && (
                <div className="p-4 border-t border-gray-700">
                    <table className="w-full text-left text-sm">
                        <thead className="border-b border-gray-600">
                            <tr>
                                <th className="p-2 font-semibold text-gray-400">Product to Pick</th>
                                <th className="p-2 font-semibold text-gray-400">Location</th>
                                <th className="p-2 font-semibold text-gray-400 text-center">Current Stock</th>
                                <th className="p-2 font-semibold text-gray-400 text-center">Quantity to Pick</th>
                            </tr>
                        </thead>
                        <tbody>
                            {list.items.map(item => {
                                const productDetails = productsMap.get(item.id);
                                const currentStock = productDetails ? productDetails.currentStock : 0;
                                const hasEnoughStock = currentStock >= item.quantity;

                                return (
                                    <tr key={item.id} className="border-b border-gray-700/50">
                                        <td className="p-3 text-white font-medium">{item.name}</td>
                                        <td className="p-3 text-purple-400 font-mono">
                                            {item.location} / Shelf {item.shelf_number} / Level {item.shelf_level}
                                        </td>
                                        <td className={`p-3 font-mono text-center ${hasEnoughStock ? 'text-gray-300' : 'text-red-400 font-bold'}`}>
                                            {hasEnoughStock ? (
                                                currentStock
                                            ) : (
                                                <span className="flex items-center justify-center gap-2" title="Not enough stock!">
                                                    <AlertTriangle size={16} /> {currentStock}
                                                </span>
                                            )}
                                        </td>
                                        <td className="p-3 text-white font-bold text-lg text-center">{item.quantity}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};


const PickingQueue = () => {
    const [pickingLists, setPickingLists] = useState([]);
    const [products, setProducts] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchAllData = async () => {
            setLoading(true);
            const fetchedProducts = await getProducts();
            setProducts(fetchedProducts);

            const unsubscribe = listenToPickingLists((lists) => {
                setPickingLists(lists);
                setLoading(false);
            });
            return unsubscribe;
        };
        
        const unsubscribePromise = fetchAllData();
        return () => { unsubscribePromise.then(unsub => unsub && unsub()); };
    }, []);
    
    const productsMap = useMemo(() => new Map(products.map(p => [p.id, p])), [products]);

    const handleMarkAsPicked = (listId) => {
        toast((t) => (
            <span>
                Mark this entire order as picked? This will update stock levels.
                <Button variant="primary" size="sm" className="ml-2" onClick={async () => {
                    toast.dismiss(t.id);
                    try {
                        await markPickingListAsCompleted(listId);
                        toast.success("Order marked as picked! Stock levels will update.");
                    } catch (error) {
                        console.error("Error marking list as completed:", error);
                        toast.error("Failed to update picking list.");
                    }
                }}>
                    Confirm
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âœ”ï¸' });
    };

    if (loading) {
        return <p className="text-center text-gray-400">Loading picking queue...</p>;
    }

    if (pickingLists.length === 0) {
        return (
            <div className="text-center py-16 bg-gray-800 rounded-lg">
                <p className="text-gray-500">The picking queue is currently empty.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {pickingLists.map(list => (
                <PickingListCard 
                    key={list.id} 
                    list={list} 
                    onMarkComplete={handleMarkAsPicked} 
                    productsMap={productsMap}
                />
            ))}
        </div>
    );
};

export default PickingQueue;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\portal\CustomerKanban.jsx
==================================================
// src/components/features/portal/CustomerKanban.jsx (NEW FILE)

import React, { useMemo } from 'react';
import { Package, HardHat, CheckSquare, CheckCircle } from 'lucide-react';

const KanbanColumn = ({ title, jobs, icon }) => (
    <div className="bg-gray-800/50 rounded-xl p-4 w-full">
        <h3 className="font-bold text-white mb-4 flex items-center gap-2">
            {icon}
            {title} ({jobs.length})
        </h3>
        <div className="space-y-3">
            {jobs.map(job => (
                <div key={job.id} className="p-3 rounded-lg bg-gray-700 border border-gray-600">
                    <p className="font-semibold text-white text-sm">{job.partName}</p>
                    <p className="text-xs text-gray-400 font-mono">{job.jobId}</p>
                </div>
            ))}
            {jobs.length === 0 && (
                <div className="text-center py-8 text-gray-500 text-sm">
                    No jobs in this stage.
                </div>
            )}
        </div>
    </div>
);

const CustomerKanban = ({ jobs }) => {
    const columns = useMemo(() => {
        const pending = jobs.filter(j => j.status === 'Pending');
        const inProgress = jobs.filter(j => j.status === 'In Progress' || j.status === 'Paused');
        const awaitingQc = jobs.filter(j => j.status === 'Awaiting QC');
        const complete = jobs.filter(j => j.status === 'Complete');
        return { pending, inProgress, awaitingQc, complete };
    }, [jobs]);

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <KanbanColumn title="Pending" jobs={columns.pending} icon={<Package size={20} className="text-yellow-400"/>} />
            <KanbanColumn title="In Progress" jobs={columns.inProgress} icon={<HardHat size={20} className="text-blue-400"/>} />
            <KanbanColumn title="Awaiting QC" jobs={columns.awaitingQc} icon={<CheckSquare size={20} className="text-purple-400"/>} />
            <KanbanColumn title="Complete" jobs={columns.complete} icon={<CheckCircle size={20} className="text-green-400"/>} />
        </div>
    );
};

export default CustomerKanban;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\portal\FeedbackModal.jsx
==================================================
// src/components/features/portal/FeedbackModal.jsx (NEW FILE)

import React, { useState } from 'react';
import Button from '../../ui/Button';
import Textarea from '../../ui/Textarea';
import { X, Star } from 'lucide-react';
import toast from 'react-hot-toast';

const FeedbackModal = ({ order, user, onSubmit, onClose }) => {
    const [rating, setRating] = useState(0);
    const [hoverRating, setHoverRating] = useState(0);
    const [comment, setComment] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleSubmit = async () => {
        if (rating === 0) {
            return toast.error("Please select a star rating.");
        }
        setIsSubmitting(true);
        try {
            await onSubmit({
                rating,
                comment,
                salesOrderId: order.id,
                salesOrderIdentifier: order.salesOrderId,
                customerName: user.companyName || user.email,
                customerId: user.uid,
            });
            toast.success("Thank you for your feedback!");
            onClose();
        } catch (error) {
            console.error("Failed to submit feedback:", error);
            toast.error("Could not submit feedback. Please try again.");
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white">Provide Feedback for {order.salesOrderId}</h3>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>
                <div className="p-6 space-y-6">
                    <div>
                        <p className="text-sm font-medium text-gray-300 mb-2">Overall Quality Rating</p>
                        <div className="flex items-center justify-center space-x-2">
                            {[1, 2, 3, 4, 5].map((star) => (
                                <Star
                                    key={star}
                                    size={40}
                                    className={`cursor-pointer transition-colors ${
                                        (hoverRating || rating) >= star ? 'text-yellow-400' : 'text-gray-600'
                                    }`}
                                    onClick={() => setRating(star)}
                                    onMouseEnter={() => setHoverRating(star)}
                                    onMouseLeave={() => setHoverRating(0)}
                                />
                            ))}
                        </div>
                    </div>
                    <Textarea
                        label="Additional Comments (Optional)"
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="Tell us about your experience with this order..."
                        rows={4}
                    />
                </div>
                <div className="p-4 bg-gray-900/50 flex justify-end gap-2">
                    <Button onClick={onClose} variant="secondary">Cancel</Button>
                    <Button onClick={handleSubmit} variant="primary" disabled={isSubmitting}>
                        {isSubmitting ? 'Submitting...' : 'Submit Feedback'}
                    </Button>
                </div>
            </div>
        </div>
    );
};

export default FeedbackModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\portal\LiveQuoteSidebar.jsx
==================================================
// src/components/features/portal/LiveQuoteSidebar.jsx

import React, { useState, useMemo } from 'react';
import Button from '../../ui/Button';
import { ShoppingCart, Trash2, Percent, FileText } from 'lucide-react';
import { useAuth } from '../../../contexts/AuthContext';
import { submitCustomerOrder } from '../../../api/firestore';
import OrderConfirmationModal from './OrderConfirmationModal';
import toast from 'react-hot-toast';

const LiveQuoteSidebar = ({ cartItems, onRemoveItem, discountPercentage, onOrderSubmit }) => {
    const { user } = useAuth();
    const [isConfirmModalOpen, setConfirmModalOpen] = useState(false);
    
    const totals = useMemo(() => {
        const subtotal = cartItems.reduce((sum, item) => sum + (item.sellingPrice || 0), 0);
        const discountAmount = subtotal * (discountPercentage / 100);
        const total = subtotal - discountAmount;
        return { subtotal, discountAmount, total };
    }, [cartItems, discountPercentage]);

    const handleConfirmOrder = async (poNumber) => {
        const orderPayload = {
            client: {
                uid: user.uid,
                email: user.email,
                companyName: user.companyName,
            },
            items: cartItems.map(item => ({ id: item.id, name: item.name, sellingPrice: item.sellingPrice, quantity: 1 })), // Assuming quantity of 1 for now
            totals: totals,
            poNumber: poNumber,
        };
        
        const promise = submitCustomerOrder(orderPayload);
        
        toast.promise(promise, {
            loading: 'Submitting order...',
            success: () => {
                onOrderSubmit(); // Clear the cart on the parent page
                return "Order submitted successfully! You will be contacted shortly.";
            },
            error: "There was an error submitting your order. Please try again."
        });

        await promise;
    };

    return (
        <>
            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 h-full flex flex-col">
                <h3 className="text-lg font-bold text-white flex items-center gap-2 mb-4">
                    <ShoppingCart size={20} />
                    Your Quote
                </h3>
                <div className="flex-grow overflow-y-auto pr-2 space-y-2">
                    {cartItems.length === 0 ? (
                        <p className="text-sm text-gray-500 text-center pt-10">Your quote is empty. Add parts from the list.</p>
                    ) : (
                        cartItems.map(item => (
                            <div key={item.id} className="flex items-center justify-between bg-gray-700/50 p-2 rounded-md">
                                <span className="text-sm text-gray-200 flex-grow">{item.name}</span>
                                <div className="flex items-center gap-3">
                                    <span className="text-sm font-mono text-gray-300">R {item.sellingPrice.toFixed(2)}</span>
                                    <Button onClick={() => onRemoveItem(item.id)} variant="danger" size="sm" className="p-1 h-6 w-6">
                                        <Trash2 size={12}/>
                                    </Button>
                                </div>
                            </div>
                        ))
                    )}
                </div>
                <div className="border-t border-gray-600 mt-4 pt-4 space-y-2 text-sm">
                    <div className="flex justify-between text-gray-300">
                        <span>Subtotal:</span>
                        <span className="font-mono">R {totals.subtotal.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between text-cyan-400">
                        <span>Your Discount ({discountPercentage}%):</span>
                        <span className="font-mono">- R {totals.discountAmount.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between text-white font-bold text-lg pt-2 border-t border-gray-600/50 mt-2">
                        <span>Total:</span>
                        <span className="font-mono text-green-400">R {totals.total.toFixed(2)}</span>
                    </div>
                </div>
                <Button onClick={() => setConfirmModalOpen(true)} disabled={cartItems.length === 0} className="w-full mt-4">
                    <FileText size={16} className="mr-2"/>
                    Submit Order for Invoicing
                </Button>
            </div>
            {isConfirmModalOpen && (
                <OrderConfirmationModal
                    cartItems={cartItems}
                    totals={totals}
                    onClose={() => setConfirmModalOpen(false)}
                    onConfirm={handleConfirmOrder}
                />
            )}
        </>
    );
};

export default LiveQuoteSidebar;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\portal\OrderConfirmationModal.jsx
==================================================
// src/components/features/portal/OrderConfirmationModal.jsx

import React, { useState } from 'react';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import { X, Send } from 'lucide-react';
import toast from 'react-hot-toast';

const OrderConfirmationModal = ({ cartItems, totals, onClose, onConfirm }) => {
    const [poNumber, setPoNumber] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleConfirm = async () => {
        if (!poNumber.trim()) {
            return toast.error("A Purchase Order (PO) number is required to confirm.");
        }
        setIsSubmitting(true);
        try {
            await onConfirm(poNumber);
            // The success toast is now handled by the parent component (LiveQuoteSidebar)
            onClose();
        } catch (error) {
            // The error toast is also handled by the parent
            console.error("Order submission error:", error);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white">Confirm Your Order</h3>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>
                <div className="p-6 space-y-4">
                    <p className="text-gray-300">Please review your order details and provide your company's Purchase Order number to finalize.</p>
                    <div className="bg-gray-900/50 p-4 rounded-lg">
                        <div className="flex justify-between text-lg text-white">
                            <span>Total Items:</span>
                            <span className="font-bold">{cartItems.length}</span>
                        </div>
                        <div className="flex justify-between text-2xl font-bold text-green-400 mt-2">
                            <span>Final Total:</span>
                            <span className="font-mono">R {totals.total.toFixed(2)}</span>
                        </div>
                    </div>
                    <Input 
                        label="Your Purchase Order (PO) Number"
                        placeholder="Enter PO Number..."
                        value={poNumber}
                        onChange={(e) => setPoNumber(e.target.value)}
                        required
                    />
                </div>
                <div className="p-4 bg-gray-900/50 flex justify-end gap-2">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button variant="primary" onClick={handleConfirm} disabled={isSubmitting || !poNumber.trim()}>
                        <Send size={16} className="mr-2" />
                        {isSubmitting ? 'Submitting...' : 'Confirm & Submit Order'}
                    </Button>
                </div>
            </div>
        </div>
    );
};

export default OrderConfirmationModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\qc\QcQueue.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { listenToJobCards, processQcDecision } from '../../../api/firestore'; // Use the new function
import Button from '../../ui/Button';

const QcQueue = () => {
  const [allJobs, setAllJobs] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = listenToJobCards((fetchedJobs) => {
      setAllJobs(fetchedJobs);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const qcJobs = useMemo(() => {
    return allJobs.filter(job => job.status === 'Awaiting QC');
  }, [allJobs]);

  const handleApprove = async (job) => {
    if (window.confirm(`Are you sure you want to approve this job? This will deduct used items from stock.`)) {
      try {
        await processQcDecision(job, true); // Call with 'true' for approval
        alert('Job approved and stock updated!');
      } catch (err) {
        alert('Failed to process approval.');
        console.error(err);
      }
    }
  };

  const handleReject = async (job) => {
    const reason = prompt(`Please provide a reason for rejecting this job:`);
    if (reason) {
      try {
        await processQcDecision(job, false, reason); // Call with 'false' and a reason for rejection
        alert('Job marked with an issue, and stock has been deducted.');
      } catch (err) {
        alert('Failed to process rejection.');
        console.error(err);
      }
    }
  };

  if (loading) return <p className="text-center text-gray-400">Loading QC queue...</p>;

  return (
    <div className="bg-gray-800 p-2 sm:p-6 rounded-xl border border-gray-700 shadow-lg">
      <div className="overflow-x-auto">
        <table className="w-full text-left">
           <thead>
            <tr className="border-b border-gray-600">
              <th className="p-3 text-sm font-semibold text-gray-400">Job ID</th>
              <th className="p-3 text-sm font-semibold text-gray-400">Part</th>
              <th className="p-3 text-sm font-semibold text-gray-400">Employee</th>
              <th className="p-3 text-sm font-semibold text-gray-400">Actions</th>
            </tr>
          </thead>
          <tbody>
            {(qcJobs || []).map(job => (
              <tr key={job.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                <td className="p-3 text-gray-400 text-xs font-mono">{job.jobId}</td>
                <td className="p-3 text-gray-300">{job.partName}</td>
                <td className="p-3 text-gray-300">{job.employeeName}</td>
                <td className="p-3 flex space-x-2">
                  <Button onClick={() => handleApprove(job)} variant="primary" className="bg-green-600 hover:bg-green-700 py-1 px-3 text-sm">Approve</Button>
                  <Button onClick={() => handleReject(job)} variant="danger" className="py-1 px-3 text-sm">Reject</Button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        {qcJobs.length === 0 && !loading && <p className="text-center p-8 text-gray-400">The QC queue is empty.</p>}
      </div>
    </div>
  );
};

export default QcQueue;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\quotes\AddCustomWorkModal.jsx
==================================================
// src/components/features/quotes/AddCustomWorkModal.jsx (Updated for minutes)

import React, { useState, useMemo, useRef, useEffect } from 'react';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import { X, PlusCircle, Trash2, Search } from 'lucide-react';

const AddCustomWorkModal = ({ onClose, onAdd, calculationData }) => {
    const { inventoryItems, averageBurdenedRate } = calculationData;

    const [description, setDescription] = useState('');
    const [estimatedMinutes, setEstimatedMinutes] = useState(''); // Changed from hours
    const [consumables, setConsumables] = useState([]);

    // State for the consumable search dropdown
    const [consumableSearchTerm, setConsumableSearchTerm] = useState('');
    const [filteredConsumableOptions, setFilteredConsumableOptions] = useState([]);
    const [selectedConsumableItem, setSelectedConsumableItem] = useState(null);
    const [consumableQuantity, setConsumableQuantity] = useState('');
    const consumableSearchRef = useRef(null);
    
    useEffect(() => {
        if (consumableSearchTerm.length > 0) {
            const lowerCaseSearchTerm = consumableSearchTerm.toLowerCase();
            const filtered = inventoryItems.filter(item =>
                item.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                (item.itemCode && item.itemCode.toLowerCase().includes(lowerCaseSearchTerm))
            ).slice(0, 10);
            setFilteredConsumableOptions(filtered);
        } else {
            setFilteredConsumableOptions([]);
        }
    }, [consumableSearchTerm, inventoryItems]);

    const selectConsumableFromSearch = (item) => {
        setSelectedConsumableItem(item);
        setConsumableSearchTerm(item.name);
        setFilteredConsumableOptions([]);
    };

    const addConsumableToList = () => {
        if (!selectedConsumableItem || !consumableQuantity || parseFloat(consumableQuantity) <= 0) return;
        setConsumables([...consumables, { ...selectedConsumableItem, quantity: parseFloat(consumableQuantity) }]);
        setSelectedConsumableItem(null);
        setConsumableSearchTerm('');
        setConsumableQuantity('');
    };

    const removeConsumable = (id) => {
        setConsumables(consumables.filter(c => c.id !== id));
    };

    const calculatedCost = useMemo(() => {
        const materialCost = consumables.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        // UPDATED CALCULATION: Divide minutes by 60 to get hours for rate calculation
        const laborCost = ((parseFloat(estimatedMinutes) || 0) / 60) * averageBurdenedRate;
        return materialCost + laborCost;
    }, [consumables, estimatedMinutes, averageBurdenedRate]);

    const handleAddItemToQuote = () => {
        if (!description) return alert("Please provide a description for this custom work.");
        if (calculatedCost <= 0) return alert("The estimated cost must be greater than zero.");
        
        onAdd({
            description: description,
            cost: calculatedCost,
        });
        onClose();
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold text-white">Add Custom Work to Quote</h2>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>

                <div className="p-6 overflow-y-auto space-y-4">
                    <Input label="Line Item Description" placeholder="e.g., Repair and reinforce customer bracket" value={description} onChange={e => setDescription(e.target.value)} />
                    {/* UPDATED LABEL */}
                    <Input label="Estimated Labor (Minutes)" type="number" placeholder="e.g., 90" value={estimatedMinutes} onChange={e => setEstimatedMinutes(e.target.value)} />

                    {/* Consumables Section */}
                    <div>
                        <h4 className="font-semibold text-white mb-2">Materials Needed</h4>
                        <div className="p-4 bg-gray-800/50 rounded-lg space-y-3">
                            <div className="flex items-end gap-2" ref={consumableSearchRef}>
                                <div className="flex-grow relative">
                                    <Input label="Search Inventory" value={consumableSearchTerm} onChange={(e) => { setConsumableSearchTerm(e.target.value); setSelectedConsumableItem(null); }} placeholder="Search for a material..." />
                                    <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 mt-3" size={20} />
                                    {consumableSearchTerm.length > 0 && filteredConsumableOptions.length > 0 && (
                                        <ul className="absolute z-20 bg-gray-700 border border-gray-600 rounded-md w-full mt-1 max-h-48 overflow-y-auto shadow-lg">
                                            {filteredConsumableOptions.map(item => (
                                                <li key={item.id} className="p-2 text-sm text-gray-200 hover:bg-blue-600 cursor-pointer" onClick={() => selectConsumableFromSearch(item)}>{item.name}</li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                                <div className="w-24"><Input label="Quantity" type="number" value={consumableQuantity} onChange={e => setConsumableQuantity(e.target.value)} /></div>
                                <Button type="button" onClick={addConsumableToList} disabled={!selectedConsumableItem}>Add</Button>
                            </div>
                            <ul className="space-y-2 pt-3 border-t border-gray-700">
                                {consumables.map(c => (
                                    <li key={c.id} className="flex justify-between items-center bg-gray-700 p-2 rounded text-sm">
                                        <span>{c.name} : {c.quantity} {c.unit}</span>
                                        <Button type="button" onClick={() => removeConsumable(c.id)} variant="danger" className="py-0.5 px-2 text-xs">X</Button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                </div>

                <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-between items-center">
                    <div>
                        <p className="text-sm text-gray-400">Calculated Item Cost</p>
                        <p className="text-2xl font-bold text-white font-mono">R {calculatedCost.toFixed(2)}</p>
                    </div>
                    <Button onClick={handleAddItemToQuote} variant="primary">Add to Quote</Button>
                </div>
            </div>
        </div>
    );
};

export default AddCustomWorkModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\quotes\AddPurchasedItemModal.jsx
==================================================
// src/components/features/quotes/AddPurchasedItemModal.jsx (New File)

import React, { useState } from 'react';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import { X, ShoppingBag } from 'lucide-react';

const AddPurchasedItemModal = ({ onClose, onAdd }) => {
    const [description, setDescription] = useState('');
    const [estimatedCost, setEstimatedCost] = useState('');
    const [quantity, setQuantity] = useState(1);

    const handleAddItemToQuote = () => {
        if (!description || !estimatedCost || !quantity) {
            return alert("Please provide a description, estimated cost, and quantity.");
        }
        if (parseFloat(estimatedCost) <= 0 || parseInt(quantity, 10) <= 0) {
            return alert("Cost and quantity must be greater than zero.");
        }

        // Add the item to the quote's line items
        // We add 'isPurchasedItem: true' to identify it later
        onAdd({
            description,
            cost: parseFloat(estimatedCost) * parseInt(quantity, 10), // The total cost for the quantity
            isPurchasedItem: true,
            quantity: parseInt(quantity, 10),
            unitCost: parseFloat(estimatedCost)
        });

        onClose();
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-lg max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <ShoppingBag /> Add Purchased Item to Quote
                    </h2>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>

                <div className="p-6 overflow-y-auto space-y-4">
                    <Input 
                        label="Item Description" 
                        placeholder="e.g., 2x Hella Spotlights" 
                        value={description} 
                        onChange={e => setDescription(e.target.value)} 
                    />
                    <div className="grid grid-cols-2 gap-4">
                        <Input 
                            label="Estimated Cost (per item)" 
                            type="number" 
                            placeholder="e.g., 1500" 
                            value={estimatedCost} 
                            onChange={e => setEstimatedCost(e.target.value)} 
                        />
                        <Input 
                            label="Quantity" 
                            type="number" 
                            placeholder="e.g., 1" 
                            value={quantity} 
                            onChange={e => setQuantity(e.target.value)} 
                        />
                    </div>
                     <p className="text-xs text-gray-400">
                        This is for items you will buy specifically for this job. The cost you enter here is an estimate for the quote. You will confirm the actual price later.
                    </p>
                </div>

                <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end">
                    <Button onClick={handleAddItemToQuote} variant="primary">Add to Quote</Button>
                </div>
            </div>
        </div>
    );
};

export default AddPurchasedItemModal;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\quotes\QuoteCreator.jsx
==================================================
// src/components/features/quotes/QuoteCreator.jsx (FIXED: Missing export)

import React, { useState, useMemo } from 'react';
import { addQuote } from '../../../api/firestore';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import Dropdown from '../../ui/Dropdown';
import { X, PlusCircle, Trash2, DollarSign, Percent, FileText, Package, Wrench, ShoppingBag } from 'lucide-react';
import AddCustomWorkModal from './AddCustomWorkModal';
import AddPurchasedItemModal from './AddPurchasedItemModal';
import toast from 'react-hot-toast';

const QuoteCreator = ({ onClose, calculationData }) => {
    const { products, allRecipes, inventoryItems, averageBurdenedRate } = calculationData;

    const [customerName, setCustomerName] = useState('');
    const [customerEmail, setCustomerEmail] = useState('');
    const [lineItems, setLineItems] = useState([]);
    const [margin, setMargin] = useState('40');
    
    const [isCustomWorkModalOpen, setCustomWorkModalOpen] = useState(false);
    const [isPurchasedItemModalOpen, setPurchasedItemModalOpen] = useState(false);

    const [catalogProductId, setCatalogProductId] = useState('');

    const handleAddLineItem = (item) => {
        const newItem = { ...item, id: Date.now() };
        if (item.isCustomWork) {
            newItem.isCustomWork = true;
        } else if (item.isPurchasedItem) {
            newItem.isPurchasedItem = true;
        } else {
            newItem.isCatalogItem = true;
        }
        setLineItems(prevItems => [...prevItems, newItem]);
    };

    const handleAddCatalogItem = () => {
        if (!catalogProductId) return;
        const product = products.find(p => p.id === catalogProductId);
        if (!product) return toast.error("Selected product not found.");
        const productRecipes = allRecipes.filter(r => r.productId === product.id);
        if (productRecipes.length === 0) return toast.error("This product has no recipes defined. Cannot calculate cost.");

        const inventoryMap = new Map(inventoryItems.map(item => [item.id, item]));
        let totalMaterialCost = 0;
        let totalLaborCost = 0;

        productRecipes.forEach(recipe => {
            totalMaterialCost += (recipe.consumables || []).reduce((sum, consumable) => {
                const inventoryItem = inventoryMap.get(consumable.itemId);
                return sum + ((inventoryItem?.price || 0) * (consumable.quantity || 0));
            }, 0);
            totalLaborCost += (recipe.estimatedTime || 0) / 60 * averageBurdenedRate;
        });
        
        handleAddLineItem({ description: product.name, cost: totalMaterialCost + totalLaborCost, productId: product.id });
        setCatalogProductId('');
    };

    const handleRemoveLineItem = (id) => {
        setLineItems(lineItems.filter(item => item.id !== id));
    };

    const totals = useMemo(() => {
        const subtotal = lineItems.reduce((sum, item) => sum + item.cost, 0);
        const marginDecimal = parseFloat(margin) / 100;
        const total = (marginDecimal < 1 && marginDecimal >= 0) ? subtotal / (1 - marginDecimal) : subtotal;
        const profit = total - subtotal;
        return { subtotal, total, profit };
    }, [lineItems, margin]);

    const handleSaveQuote = async () => {
        if (!customerName) return toast.error("Please enter a customer name.");
        if (lineItems.length === 0) return toast.error("Please add at least one line item.");
        
        const quoteData = { 
            customerName, 
            customerEmail, 
            lineItems: lineItems.map(({ id, ...rest }) => rest), 
            subtotal: totals.subtotal, 
            margin: parseFloat(margin), 
            total: totals.total, 
            quoteId: `Q-${Date.now()}` 
        };

        try {
            await addQuote(quoteData);
            toast.success(`Quote ${quoteData.quoteId} saved successfully!`);
            onClose();
        } catch (error) {
            console.error("Error saving quote:", error);
            toast.error("Failed to save quote. See console for details.");
        }
    };

    return (
        <>
            <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-4xl max-h-[90vh] flex flex-col">
                    <div className="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2"><FileText /> Create New Sales Quote</h2>
                        <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                    </div>

                    <div className="p-6 overflow-y-auto space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <Input label="Customer Name" placeholder="e.g., John Doe" value={customerName} onChange={e => setCustomerName(e.target.value)} />
                            <Input label="Customer Email" type="email" placeholder="e.g., john.doe@example.com" value={customerEmail} onChange={e => setCustomerEmail(e.target.value)} />
                        </div>

                        <div className="space-y-3">
                            <h3 className="font-semibold text-white">Quote Line Items</h3>
                            <div className="space-y-2 max-h-48 overflow-y-auto pr-2">
                                {lineItems.map((item) => (
                                    <div key={item.id} className="flex items-center gap-2 bg-gray-700/50 p-2 rounded-md">
                                        <p className="flex-grow text-gray-200">{item.description}</p>
                                        <p className="font-mono text-gray-300" title="Estimated True Cost">R {item.cost.toFixed(2)}</p>
                                        <Button onClick={() => handleRemoveLineItem(item.id)} variant="danger" className="p-1 h-7 w-7"><Trash2 size={14}/></Button>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="flex flex-wrap items-end gap-2 p-4 border-t border-gray-700 bg-gray-900/50 rounded-lg">
                                <div className="flex-grow">
                                    <Dropdown label="Add from Product Catalog" value={catalogProductId} onChange={e => setCatalogProductId(e.target.value)} options={products} placeholder="Select a product..."/>
                                </div>
                                <Button onClick={handleAddCatalogItem} variant="secondary"><Package size={16} className="mr-2"/>Add Product</Button>
                                <div className="border-l border-gray-600 h-10 mx-2"></div>
                                <Button onClick={() => setCustomWorkModalOpen(true)} variant="secondary"><Wrench size={16} className="mr-2"/>Add Custom Work</Button>
                                <Button onClick={() => setPurchasedItemModalOpen(true)} variant="secondary"><ShoppingBag size={16} className="mr-2"/>Add Purchased Item</Button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 pt-4 border-t border-gray-600">
                            <div className="bg-gray-900/50 p-4 rounded-lg">
                                <p className="text-sm text-gray-400 flex items-center gap-1"><DollarSign size={14}/> Subtotal (Cost)</p>
                                <p className="text-2xl font-bold font-mono text-white">R {totals.subtotal.toFixed(2)}</p>
                            </div>
                            <div className="bg-gray-900/50 p-4 rounded-lg flex flex-col justify-center">
                                <Input label="Profit Margin (%)" type="number" value={margin} onChange={e => setMargin(e.target.value)} />
                            </div>
                            <div className="bg-green-900/50 p-4 rounded-lg md:col-span-2">
                                <p className="text-sm text-green-300 flex items-center gap-1"><DollarSign size={14}/> Final Quoted Price</p>
                                <p className="text-4xl font-bold font-mono text-white">R {totals.total.toFixed(2)}</p>
                                <p className="text-xs text-gray-400 mt-1">Projected Profit: R {totals.profit.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end gap-2">
                        <Button onClick={onClose} variant="secondary">Cancel</Button>
                        <Button onClick={handleSaveQuote} variant="primary">Save Quote</Button>
                    </div>
                </div>
            </div>
            
            {isCustomWorkModalOpen && (
                <AddCustomWorkModal 
                    onClose={() => setCustomWorkModalOpen(false)}
                    onAdd={(item) => handleAddLineItem({ ...item, isCustomWork: true })}
                    calculationData={calculationData}
                />
            )}

            {isPurchasedItemModalOpen && (
                <AddPurchasedItemModal 
                    onClose={() => setPurchasedItemModalOpen(false)}
                    onAdd={(item) => handleAddLineItem({ ...item, isPurchasedItem: true })}
                />
            )}
        </>
    );
};

export default QuoteCreator; // --- THIS LINE WAS MISSING ---


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\recipes\ConsumableEditor.jsx
==================================================
// src/components/features/recipes/ConsumableEditor.jsx (New Reusable Component)

import React, { useState, useEffect, useRef } from 'react';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { Search } from 'lucide-react';

const ConsumableEditor = ({ allConsumables, selectedConsumables, onAdd, onRemove }) => {
    // State for the component's internal UI
    const [consumableType, setConsumableType] = useState('fixed');

    // State for the "Fixed Quantity" mode
    const [fixedSearchTerm, setFixedSearchTerm] = useState('');
    const [fixedQty, setFixedQty] = useState('');
    const [filteredFixedOptions, setFilteredFixedOptions] = useState([]);
    const [selectedFixedItemDetails, setSelectedFixedItemDetails] = useState(null);

    // State for the "Dimensional Cuts" mode
    const [dimSearchTerm, setDimSearchTerm] = useState('');
    const [cuts, setCuts] = useState([]);
    const [cutRule, setCutRule] = useState({ dimensions: '', notes: '' });
    const [filteredDimOptions, setFilteredDimOptions] = useState([]);
    const [selectedDimItemDetails, setSelectedDimItemDetails] = useState(null);

    // Refs to handle clicking outside the search results
    const searchRefFixed = useRef(null);
    const searchRefDim = useRef(null);

    // Effect for filtering fixed consumables based on search term
    useEffect(() => {
        if (fixedSearchTerm.length > 0) {
            const lowerCaseSearchTerm = fixedSearchTerm.toLowerCase();
            const filtered = allConsumables.filter(item =>
                item.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                (item.itemCode && item.itemCode.toLowerCase().includes(lowerCaseSearchTerm))
            ).slice(0, 10);
            setFilteredFixedOptions(filtered);
        } else {
            setFilteredFixedOptions([]);
        }
    }, [fixedSearchTerm, allConsumables]);

    // Effect for filtering dimensional consumables based on search term
    useEffect(() => {
        if (dimSearchTerm.length > 0) {
            const lowerCaseSearchTerm = dimSearchTerm.toLowerCase();
            const filtered = allConsumables.filter(item =>
                (item.category === 'Raw Material' || item.name.toLowerCase().includes('mat')) &&
                (item.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                (item.itemCode && item.itemCode.toLowerCase().includes(lowerCaseSearchTerm)))
            ).slice(0, 10);
            setFilteredDimOptions(filtered);
        } else {
            setFilteredDimOptions([]);
        }
    }, [dimSearchTerm, allConsumables]);
    
    // Effect to close search results when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (searchRefFixed.current && !searchRefFixed.current.contains(event.target)) setFilteredFixedOptions([]);
            if (searchRefDim.current && !searchRefDim.current.contains(event.target)) setFilteredDimOptions([]);
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const handleAddConsumable = () => {
        let newConsumable;
        let itemToAddDetails;

        if (consumableType === 'fixed') {
            if (!selectedFixedItemDetails || !fixedQty || parseFloat(fixedQty) <= 0) return alert("Please select an item and enter a valid quantity.");
            itemToAddDetails = selectedFixedItemDetails;
            newConsumable = { type: 'fixed', itemId: itemToAddDetails.id, quantity: Number(fixedQty) };
        } else if (consumableType === 'dimensional') {
            if (!selectedDimItemDetails || cuts.length === 0) return alert("Please select a material and add at least one cutting instruction.");
            itemToAddDetails = selectedDimItemDetails;
            newConsumable = { type: 'dimensional', itemId: itemToAddDetails.id, cuts };
        } else {
            return;
        }

        // Add full item details to the consumable object before passing it up
        const consumableWithDetails = {
            ...newConsumable,
            name: itemToAddDetails.name,
            unit: itemToAddDetails.unit || 'units',
            price: itemToAddDetails.price || 0,
            itemCode: itemToAddDetails.itemCode || '',
            category: itemToAddDetails.category || '',
            requiresCatalyst: itemToAddDetails.requiresCatalyst || false,
        };

        if (!selectedConsumables.find(c => c.itemId === consumableWithDetails.itemId)) {
            onAdd(consumableWithDetails);
            // Reset all form fields
            setFixedSearchTerm('');
            setFixedQty('');
            setSelectedFixedItemDetails(null);
            setDimSearchTerm('');
            setCuts([]);
            setCutRule({ dimensions: '', notes: '' });
            setSelectedDimItemDetails(null);
        } else {
            alert("This consumable has already been added.");
        }
    };

    return (
        <div>
            <h5 className="font-semibold mb-2 text-gray-200">Required Consumables</h5>
            <div className="p-4 bg-gray-900/50 rounded-lg space-y-4">
                <div className="flex gap-2 bg-gray-800 p-1 rounded-md">
                    <button type="button" onClick={() => setConsumableType('fixed')} className={`flex-1 p-2 text-sm rounded transition-colors ${consumableType === 'fixed' ? 'bg-blue-600 text-white' : 'hover:bg-blue-500/20'}`}>Fixed Quantity</button>
                    <button type="button" onClick={() => setConsumableType('dimensional')} className={`flex-1 p-2 text-sm rounded transition-colors ${consumableType === 'dimensional' ? 'bg-blue-600 text-white' : 'hover:bg-blue-500/20'}`}>Dimensional Cuts</button>
                </div>
                
                {consumableType === 'fixed' && (
                    <div className="flex items-end gap-2 animate-fade-in" ref={searchRefFixed}>
                        <div className="flex-grow relative">
                            <Input
                                label="Item"
                                value={fixedSearchTerm}
                                onChange={e => { setFixedSearchTerm(e.target.value); setSelectedFixedItemDetails(null); }}
                                placeholder="Search by name or code..."
                            />
                            <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                            {filteredFixedOptions.length > 0 && (
                                <ul className="absolute z-10 bg-gray-700 border border-gray-600 rounded-md w-full mt-1 max-h-48 overflow-y-auto shadow-lg">
                                     {filteredFixedOptions.map(item => (
                                        <li key={item.id} className="p-2 text-sm text-gray-200 hover:bg-blue-600 hover:text-white cursor-pointer" onClick={() => { setSelectedFixedItemDetails(item); setFixedSearchTerm(item.name); setFilteredFixedOptions([]); }}>
                                            {item.name} ({item.itemCode || 'N/A'})
                                        </li>
                                    ))}
                                 </ul>
                            )}
                        </div>
                        <div className="w-24">
                             <Input label="Qty" type="number" value={fixedQty} onChange={e => setFixedQty(e.target.value)} placeholder="e.g., 5"/>
                        </div>
                        <Button type="button" onClick={handleAddConsumable} disabled={!selectedFixedItemDetails || parseFloat(fixedQty) <= 0 || isNaN(parseFloat(fixedQty))}>Add</Button>
                    </div>
                )}
                
                {consumableType === 'dimensional' && (
                    <div className="space-y-3 animate-fade-in" ref={searchRefDim}>
                         <div className="flex-grow relative">
                             <Input label="Material to Cut" value={dimSearchTerm} onChange={e => { setDimSearchTerm(e.target.value); setSelectedDimItemDetails(null); }} placeholder="Search by name or code..."/>
                             <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                            {filteredDimOptions.length > 0 && (
                                <ul className="absolute z-10 bg-gray-700 border border-gray-600 rounded-md w-full mt-1 max-h-48 overflow-y-auto shadow-lg">
                                    {filteredDimOptions.map(item => (<li key={item.id} className="p-2 text-sm text-gray-200 hover:bg-blue-600 hover:text-white cursor-pointer" onClick={() => { setSelectedDimItemDetails(item); setDimSearchTerm(item.name); setFilteredDimOptions([]); }}>{item.name} ({item.itemCode || 'N/A'})</li>))}
                                 </ul>
                            )}
                        </div>
                        <div className="p-2 border border-gray-700 rounded-md">
                             <p className="text-xs text-gray-400 mb-2">Cutting Instructions</p>
                            <div className="flex items-end gap-2"><Input label="Dimensions (e.g., 120cm x 80cm)" value={cutRule.dimensions} onChange={e => setCutRule({...cutRule, dimensions: e.target.value})} /><Input label="Notes" value={cutRule.notes} onChange={e => setCutRule({...cutRule, notes: e.target.value})} /><Button type="button" onClick={() => { if(cutRule.dimensions) { setCuts([...cuts, cutRule]); setCutRule({ dimensions: '', notes: '' }); }}}>Add Cut</Button></div>
                            <ul className="text-xs mt-2 space-y-1">{cuts.map((c, i) => <li key={i}>{c.dimensions} ({c.notes})</li>)}</ul>
                        </div>
                         <Button type="button" onClick={handleAddConsumable} className="w-full" disabled={!selectedDimItemDetails || cuts.length === 0}>Add Dimensional Consumable</Button>
                    </div>
                )}
                
                <h6 className="text-sm font-bold pt-2 border-t border-gray-700 text-gray-200">Recipe Consumables</h6>
                <ul className="space-y-2 max-h-40 overflow-y-auto">
                    {selectedConsumables.map((c, i) => (
                         <li key={c.itemId || i} className="flex justify-between items-center bg-gray-700 p-2 rounded text-sm text-gray-200">
                            <div>
                                <p className="font-semibold">{c.name}</p>
                                {c.quantity && <span>: {c.quantity.toFixed(3)} {c.unit}</span>}
                                {c.notes && <span className="text-xs italic text-gray-500 ml-1">{c.notes}</span>}
                                {c.cuts && (<ul className="list-square list-inside ml-4 mt-1">{c.cuts.map((cut, j) => <li key={j}>{cut.dimensions} <span className="text-xs italic text-gray-500">{cut.notes}</span></li>)}</ul>)}
                            </div>
                            <Button type="button" onClick={() => onRemove(c.itemId)} variant="danger" className="py-0.5 px-2 text-xs">X</Button>
                        </li>
                    ))}
                     {selectedConsumables.length === 0 && <p className="text-xs text-center text-gray-500">No consumables added.</p>}
                </ul>
            </div>
        </div>
    );
};

export default ConsumableEditor;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\scanner\JobCardScanner.jsx
==================================================
// src/components/features/scanner/JobCardScanner.jsx

import React, { useState, useEffect, useRef } from 'react';
import { getJobByJobId, logScanEvent, getDepartments, getEmployees, updateDocument } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import { ShieldAlert, QrCode, X, User, CheckCircle, PauseCircle, PlayCircle } from 'lucide-react';
import toast from 'react-hot-toast';
import QrScannerModal from './QrScannerModal';

const JobCardScanner = () => {
    const [jobData, setJobData] = useState(null);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isScannerOpen, setIsScannerOpen] = useState(false);
    const [loading, setLoading] = useState(false);
    const [departments, setDepartments] = useState([]);
    const [employees, setEmployees] = useState([]);
    const [selectedDept, setSelectedDept] = useState('');
    const [selectedEmp, setSelectedEmp] = useState('');
    const wakeLockRef = useRef(null);
    const timeoutRef = useRef(null);

    useEffect(() => {
        const fetchInitialData = async () => {
            const [depts, emps] = await Promise.all([getDepartments(), getEmployees()]);
            setDepartments(depts);
            setEmployees(emps);
        };
        fetchInitialData();
    }, []);

    const acquireWakeLock = async () => {
        if ('wakeLock' in navigator) {
            try {
                wakeLockRef.current = await navigator.wakeLock.request('screen');
                timeoutRef.current = setTimeout(() => {
                    if (wakeLockRef.current) {
                        wakeLockRef.current.release();
                        wakeLockRef.current = null;
                    }
                }, 300000); // 5 minutes
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }
    };

    const releaseWakeLock = () => {
        if (wakeLockRef.current) {
            wakeLockRef.current.release();
            wakeLockRef.current = null;
            clearTimeout(timeoutRef.current);
        }
    };

    const handleFindJob = async (scannedId) => {
        if (!scannedId.trim()) return;

        setLoading(true);
        try {
            const job = await getJobByJobId(scannedId.trim());
            setJobData(job);
            setIsModalOpen(true);
            await acquireWakeLock();
        } catch (error) {
            toast.error(error.message);
        } finally {
            setLoading(false);
        }
    };

    const handleScanSuccess = (decodedText) => {
        setIsScannerOpen(false);
        handleFindJob(decodedText);
    };

    const handleCloseModal = () => {
        setIsModalOpen(false);
        setJobData(null);
        setSelectedDept('');
        setSelectedEmp('');
        releaseWakeLock();
    };

    const handleAssignment = async () => {
        if (!selectedEmp) return toast.error("Please select an employee.");
        const employee = employees.find(e => e.id === selectedEmp);
        if (!employee) return toast.error("Selected employee not found.");

        try {
            // Direct document update is acceptable for assignment as it's a manager-level task
            await updateDocument('createdJobCards', jobData.id, {
                employeeId: employee.id,
                employeeName: employee.name
            });
            toast.success(`Job assigned to ${employee.name}`);
            const updatedJob = await getJobByJobId(jobData.jobId);
            setJobData(updatedJob);
        } catch (error) {
            toast.error("Failed to assign job.");
        }
    };

    // --- UPDATED: This now calls logScanEvent instead of updateJobStatus ---
    const handleStatusUpdate = async (newStatus) => {
        if (!jobData.employeeId || jobData.employeeId === 'unassigned') {
            return toast.error("Please assign an employee before starting the job.");
        }
        
        const promise = logScanEvent(jobData, newStatus);
        
        toast.promise(promise, {
            loading: 'Logging event...',
            success: `Event logged for status "${newStatus}"!`,
            error: 'Failed to log event.',
        });

        await promise;
        handleCloseModal();
    };
    
    // --- UPDATED: This now calls logScanEvent for halting a job ---
    const handleFlagIssue = () => {
        if (!jobData) return;
        toast((t) => (
            <div className="flex flex-col gap-2 p-2">
                <span className="font-bold text-white">Halt Job: {jobData.partName}</span>
                <p className="text-sm text-gray-300">Please provide a reason for halting this job:</p>
                <Input
                  id="halt-reason-input"
                  placeholder="e.g., material defect, tool problem..."
                  autoFocus
                />
                <div className="flex gap-2 mt-2">
                    <Button variant="danger" size="sm" onClick={() => {
                        const reason = document.getElementById('halt-reason-input').value;
                        if (reason && reason.trim()) {
                            logScanEvent(jobData, 'Halted - Issue', { haltReason: reason.trim() })
                                .then(() => {
                                    toast.success(`Halt event logged. Management will be notified.`);
                                    handleCloseModal();
                                })
                                .catch(err => toast.error("Failed to log halt event."));
                            toast.dismiss(t.id);
                        } else {
                            toast.error("A reason is required to halt a job.");
                        }
                    }}>
                        Confirm Halt
                    </Button>
                    <Button variant="secondary" size="sm" onClick={() => toast.dismiss(t.id)}>
                        Cancel
                    </Button>
                </div>
            </div>
        ), { duration: 15000 });
    };

    const filteredEmployees = employees.filter(e => e.departmentId === selectedDept);

    return (
        <>
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-2xl mx-auto text-center">
                <h3 className="text-2xl font-bold text-white mb-4">Job Card Scanner</h3>
                <p className="text-gray-400 mb-6">Scan a job card's QR code to begin.</p>
                <Button 
                    variant="primary" 
                    className="w-full max-w-xs mx-auto py-4 text-lg"
                    onClick={() => setIsScannerOpen(true)}
                >
                    <QrCode size={24} className="mr-2"/>
                    Scan Job Card
                </Button>
            </div>

            {isModalOpen && jobData && (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <h3 className="text-xl font-bold text-white">{jobData.partName}</h3>
                            <Button onClick={handleCloseModal} variant="secondary" className="p-2"><X size={20}/></Button>
                        </div>

                        <div className="p-6 space-y-6">
                            <div className="text-center">
                                <p className="text-sm text-gray-400">Current Status</p>
                                <p className="text-lg font-bold text-yellow-300">{jobData.status}</p>
                            </div>
                            
                            <div className="bg-gray-900/50 p-4 rounded-lg space-y-4">
                                <div className="flex items-center gap-3">
                                    <User size={20} className="text-gray-400"/>
                                    <div>
                                        <p className="text-sm text-gray-400">Assigned To</p>
                                        <p className="font-semibold text-white">{jobData.employeeName || 'Unassigned'}</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 items-end">
                                    <Dropdown label="Department" options={departments} value={selectedDept} onChange={e => setSelectedDept(e.target.value)} placeholder="Select Dept..."/>
                                    <Dropdown label="Employee" options={filteredEmployees} value={selectedEmp} onChange={e => setSelectedEmp(e.target.value)} placeholder="Select Employee..." disabled={!selectedDept}/>
                                </div>
                                <Button onClick={handleAssignment} className="w-full" disabled={!selectedEmp}>Assign / Re-assign</Button>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                <Button onClick={() => handleStatusUpdate('In Progress')} disabled={!jobData.employeeId || jobData.employeeId === 'unassigned' || jobData.status === 'In Progress'} className="flex-col h-20"><PlayCircle/><span className="mt-1 text-xs">Start</span></Button>
                                <Button onClick={() => handleStatusUpdate('Paused')} variant="secondary" className="flex-col h-20"><PauseCircle/><span className="mt-1 text-xs">Pause</span></Button>
                                <Button onClick={() => handleStatusUpdate('Awaiting QC')} variant="success" className="flex-col h-20"><CheckCircle/><span className="mt-1 text-xs">Complete</span></Button>
                                <Button onClick={handleFlagIssue} variant="danger" className="flex-col h-20"><ShieldAlert/><span className="mt-1 text-xs">Halt Job</span></Button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {isScannerOpen && (
                <QrScannerModal 
                    onClose={() => setIsScannerOpen(false)}
                    onScanSuccess={handleScanSuccess}
                />
            )}
        </>
    );
};

export default JobCardScanner;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\scanner\QrScannerModal.jsx
==================================================
// src/components/features/scanner/QrScannerModal.jsx (New File)

import React, { useEffect, useRef } from 'react';
import { X } from 'lucide-react';
import Button from '../../ui/Button';
import toast from 'react-hot-toast';

const QrScannerModal = ({ onClose, onScanSuccess }) => {
    const scannerRef = useRef(null);
    const html5QrCodeRef = useRef(null);

    useEffect(() => {
        const scriptId = 'html5-qrcode-script';
        
        // Function to initialize the scanner
        const setupScanner = () => {
            if (window.Html5Qrcode && scannerRef.current) {
                const html5QrCode = new window.Html5Qrcode(scannerRef.current.id);
                html5QrCodeRef.current = html5QrCode;

                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    toast.success(`Scanned: ${decodedText}`);
                    onScanSuccess(decodedText);
                    if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) {
                        html5QrCodeRef.current.stop().catch(err => console.error("Failed to stop scanner:", err));
                    }
                    onClose();
                };

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                    .catch(err => {
                        if (err.name === "NotReadableError") {
                            toast.error("Camera is busy or blocked. Please ensure no other app is using it and check browser permissions.");
                        } else {
                            toast.error("Failed to start camera. Please ensure permissions are granted.");
                        }
                        console.error("Camera start error:", err);
                        onClose();
                    });
            }
        };

        // Load the script if it doesn't exist
        if (!document.getElementById(scriptId)) {
            const script = document.createElement('script');
            script.id = scriptId;
            script.src = "https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js";
            script.async = true;
            script.onload = () => {
                console.log("QR Code scanner script loaded.");
                setupScanner();
            };
            document.body.appendChild(script);
        } else {
            setupScanner();
        }

        // Cleanup function to stop the scanner when the component unmounts
        return () => {
            if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) {
                html5QrCodeRef.current.stop()
                    .then(() => console.log("QR Code scanner stopped."))
                    .catch(err => console.error("Error stopping scanner on unmount:", err));
            }
        };
    }, [onClose, onScanSuccess]);

    return (
        <div 
            onClick={onClose} 
            className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"
        >
            <div 
                onClick={(e) => e.stopPropagation()} 
                className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-md"
            >
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-lg font-bold text-white">Scan QR Code</h3>
                    <Button onClick={onClose} variant="secondary" className="p-2">
                        <X size={20} />
                    </Button>
                </div>
                <div className="p-4">
                    <div id="qr-reader" ref={scannerRef} className="w-full"></div>
                </div>
            </div>
        </div>
    );
};

export default QrScannerModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\scanner\Scanner.jsx
==================================================
// src/components/features/scanner/Scanner.jsx (Upgraded with Camera Scanning)

import React, { useState } from 'react';
import { getJobByJobId, updateJobStatus } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { ShieldAlert, QrCode } from 'lucide-react'; // --- IMPORT QrCode ICON ---
import toast from 'react-hot-toast';
import QrScannerModal from './QrScannerModal'; // --- IMPORT THE NEW MODAL ---

const Scanner = () => {
  const [jobIdInput, setJobIdInput] = useState('');
  const [foundJob, setFoundJob] = useState(null);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [isScannerOpen, setIsScannerOpen] = useState(false); // --- STATE FOR MODAL ---

  const handleFindJob = async (e) => {
    e.preventDefault();
    if (!jobIdInput.trim()) return;
    
    setLoading(true);
    setError('');
    setFoundJob(null);

    try {
      const job = await getJobByJobId(jobIdInput);
      setFoundJob(job);
      toast.success(`Found job: ${job.partName}`);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleUpdateStatus = async (newStatus) => {
    if (!foundJob) return;
    try {
      await updateJobStatus(foundJob.id, newStatus);
      toast.success(`Job status updated to "${newStatus}"!`);
      setFoundJob(null);
      setJobIdInput('');
      setError('');
    } catch (err) {
      setError("Failed to update status. Please try again.");
      console.error(err);
    }
  };
  
  const handleFlagIssue = async () => {
    if (!foundJob) return;

    toast((t) => (
      <div className="flex flex-col gap-2">
        <span>Please provide a reason for halting this job:</span>
        <input
          id="halt-reason-input"
          type="text"
          className="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
          placeholder="e.g., material defect..."
        />
        <div className="flex gap-2">
            <Button variant="danger" size="sm" onClick={() => {
                const reason = document.getElementById('halt-reason-input').value;
                if (reason && reason.trim()) {
                    updateJobStatus(foundJob.id, 'Halted - Issue', { haltReason: reason.trim() })
                        .then(() => {
                            toast.success(`Job ${foundJob.jobId} halted. Management notified.`);
                            setFoundJob(null);
                            setJobIdInput('');
                            setError('');
                        })
                        .catch(err => {
                            setError("Failed to halt job. Please try again.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                } else {
                    toast.error("A reason is required to halt a job.");
                }
            }}>
                Halt Job
            </Button>
            <Button variant="secondary" size="sm" onClick={() => toast.dismiss(t.id)}>
                Cancel
            </Button>
        </div>
      </div>
    ));
  };

  // --- HANDLER FOR SUCCESSFUL SCAN ---
  const handleScanSuccess = (decodedText) => {
    setJobIdInput(decodedText);
    setIsScannerOpen(false);
  };

  return (
    <>
      <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-2xl mx-auto">
        <form onSubmit={handleFindJob} className="flex items-center space-x-2">
          <div className="relative flex-grow">
            <Input
              name="jobId"
              value={jobIdInput}
              onChange={(e) => setJobIdInput(e.target.value)}
              placeholder="Scan or type Job ID..."
              className="pl-10"
            />
            <QrCode className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
          </div>
          {/* --- BUTTON TO OPEN SCANNER MODAL --- */}
          <Button type="button" variant="secondary" onClick={() => setIsScannerOpen(true)}>
            Scan
          </Button>
          <Button type="submit" variant="primary" disabled={loading}>
            {loading ? 'Finding...' : 'Find Job'}
          </Button>
        </form>

        {error && <p className="mt-4 text-center text-red-400">{error}</p>}

        {foundJob && (
          <div className="mt-6 border-t border-gray-700 pt-6">
            <h3 className="text-xl font-bold text-white">{foundJob.partName}</h3>
            <p className="text-gray-400">Assigned to: {foundJob.employeeName}</p>
            <p className="text-gray-400">Current Status: <span className="font-semibold text-yellow-300">{foundJob.status}</span></p>

            <div className="mt-6 grid grid-cols-2 gap-4">
              <Button onClick={() => handleUpdateStatus('In Progress')}>Start / Resume</Button>
              <Button onClick={() => handleUpdateStatus('Paused')} variant="secondary">Pause</Button>
              <Button onClick={() => handleUpdateStatus('Awaiting QC')} >Complete Job</Button>
              
              <Button onClick={handleFlagIssue} variant="danger">
                <ShieldAlert size={16} className="mr-2" />
                Flag Issue
              </Button>
            </div>
          </div>
        )}
      </div>

      {/* --- RENDER THE MODAL CONDITIONALLY --- */}
      {isScannerOpen && (
        <QrScannerModal 
          onClose={() => setIsScannerOpen(false)}
          onScanSuccess={handleScanSuccess}
        />
      )}
    </>
  );
};

export default Scanner;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\scanner\StockTakeScanner.jsx
==================================================
// src/components/features/scanner/StockTakeScanner.jsx (Upgraded with Camera Scanning)

import React, { useState, useEffect, useRef } from 'react';
import { findInventoryItemByItemCode, updateStockByWeight } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { QrCode, Weight, Check, X } from 'lucide-react';
import toast from 'react-hot-toast';
import QrScannerModal from './QrScannerModal'; // --- IMPORT THE SCANNER MODAL ---

const StockTakeScanner = () => {
    const [scanInput, setScanInput] = useState('');
    const [scannedItem, setScannedItem] = useState(null);
    const [weightInput, setWeightInput] = useState('');
    const [loading, setLoading] = useState(false);
    const [stage, setStage] = useState('scan_item'); // Stages: scan_item, enter_weight, confirm_scan
    const [isScannerOpen, setIsScannerOpen] = useState(false); // --- STATE FOR MODAL ---
    const weightInputRef = useRef(null);
    const scanInputRef = useRef(null);

    useEffect(() => {
        if (stage === 'enter_weight' && weightInputRef.current) {
            weightInputRef.current.focus();
        } else if (stage !== 'enter_weight' && scanInputRef.current) {
            scanInputRef.current.focus();
        }
    }, [stage]);

    const resetState = () => {
        setScanInput('');
        setScannedItem(null);
        setWeightInput('');
        setLoading(false);
        setStage('scan_item');
    };

    const handleInitialScan = async (e) => {
        e.preventDefault();
        if (!scanInput.trim()) return;
        setLoading(true);

        try {
            const item = await findInventoryItemByItemCode(scanInput.trim());
            if (item.stockTakeMethod !== 'weight') {
                throw new Error(`Item "${item.name}" is not configured for weight-based stock-taking.`);
            }
            setScannedItem(item);
            setStage('enter_weight');
            toast.success(`Found: ${item.name}`);
        } catch (error) {
            toast.error(error.message);
            resetState();
        } finally {
            setLoading(false);
        }
    };

    const handleWeightSubmit = (e) => {
        e.preventDefault();
        if (isNaN(parseFloat(weightInput))) {
            return toast.error("Please enter a valid weight.");
        }
        setStage('confirm_scan');
        setScanInput('');
        toast('Please re-scan the item QR code to confirm.', { icon: 'â„¹ï¸' });
    };

    const handleConfirmationScan = async (e) => {
        e.preventDefault();
        if (scanInput.trim() !== scannedItem.itemCode) {
            toast.error("Confirmation scan does not match the original item. Please try again.");
            return;
        }
        setLoading(true);
        try {
            const { newQuantity } = await updateStockByWeight(scannedItem.id, scannedItem.category, weightInput);
            toast.success(`Stock for "${scannedItem.name}" updated to ${newQuantity} units.`);
            resetState();
        } catch (error) {
            toast.error(error.message);
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    // --- HANDLER FOR SUCCESSFUL SCAN ---
    const handleScanSuccess = (decodedText) => {
        setScanInput(decodedText);
        setIsScannerOpen(false);
        // Automatically submit the form after a successful scan
        // We add a small delay to allow the state to update before submitting
        setTimeout(() => {
            if (scanInputRef.current) {
                scanInputRef.current.form.requestSubmit();
            }
        }, 100);
    };

    return (
        <>
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-2xl mx-auto">
                {stage === 'scan_item' && (
                    <form onSubmit={handleInitialScan} className="space-y-4">
                        <h3 className="text-xl font-bold text-white text-center">Scan Item QR Code</h3>
                        <div className="flex items-center gap-2">
                            <div className="relative flex-grow">
                                <Input
                                    ref={scanInputRef}
                                    value={scanInput}
                                    onChange={(e) => setScanInput(e.target.value)}
                                    placeholder="Scan item to begin..."
                                    autoFocus
                                    className="pl-10"
                                />
                                <QrCode className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                            </div>
                            <Button type="button" variant="secondary" onClick={() => setIsScannerOpen(true)}>
                                Scan
                            </Button>
                        </div>
                        <Button type="submit" variant="primary" className="w-full" disabled={loading}>
                            {loading ? 'Searching...' : 'Find Item'}
                        </Button>
                    </form>
                )}

                {stage === 'enter_weight' && scannedItem && (
                    <form onSubmit={handleWeightSubmit} className="space-y-4 animate-fade-in">
                        <h3 className="text-xl font-bold text-white text-center">Enter Weight for:</h3>
                        <p className="text-2xl font-semibold text-blue-400 text-center">{scannedItem.name}</p>
                        <div className="flex items-center gap-4">
                            <Weight size={40} className="text-gray-400"/>
                            <Input
                                ref={weightInputRef}
                                type="number"
                                step="any"
                                value={weightInput}
                                onChange={(e) => setWeightInput(e.target.value)}
                                placeholder="Enter gross weight (e.g., 1500.5)"
                                autoFocus
                            />
                        </div>
                        <div className="flex gap-4">
                            <Button type="button" variant="secondary" onClick={resetState} className="w-full">
                                <X size={18} className="mr-2"/>Cancel
                            </Button>
                            <Button type="submit" variant="primary" className="w-full">
                                <Check size={18} className="mr-2"/>Confirm Weight
                            </Button>
                        </div>
                    </form>
                )}

                {stage === 'confirm_scan' && scannedItem && (
                     <form onSubmit={handleConfirmationScan} className="space-y-4 animate-fade-in">
                        <h3 className="text-xl font-bold text-white text-center">Confirm Update for:</h3>
                        <p className="text-2xl font-semibold text-blue-400 text-center">{scannedItem.name}</p>
                        <p className="text-lg text-white text-center">Weight Entered: <span className="font-bold">{weightInput}g</span></p>
                        <div className="flex items-center gap-2">
                            <div className="relative flex-grow">
                                <Input
                                    ref={scanInputRef}
                                    value={scanInput}
                                    onChange={(e) => setScanInput(e.target.value)}
                                    placeholder="Re-scan QR code to save..."
                                    autoFocus
                                    className="pl-10"
                                />
                                <QrCode className="absolute left-3 top-1/2 -translate-y-1/2 text-green-400" size={20} />
                            </div>
                            <Button type="button" variant="secondary" onClick={() => setIsScannerOpen(true)}>
                                Scan
                            </Button>
                        </div>
                        <div className="flex gap-4">
                            <Button type="button" variant="secondary" onClick={resetState} className="w-full">
                                <X size={18} className="mr-2"/>Cancel
                            </Button>
                            <Button type="submit" variant="primary" className="w-full" disabled={loading}>
                                {loading ? 'Saving...' : 'Save Stock Count'}
                            </Button>
                        </div>
                    </form>
                )}
            </div>

            {isScannerOpen && (
                <QrScannerModal 
                    onClose={() => setIsScannerOpen(false)}
                    onScanSuccess={handleScanSuccess}
                />
            )}
        </>
    );
};

export default StockTakeScanner;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\CampaignManager.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { getCampaigns, addCampaign, updateCampaign, deleteCampaign } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { DollarSign, Trash2, Edit, PlusCircle, Users } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const CampaignManager = () => {
    const [campaigns, setCampaigns] = useState([]);
    const [loading, setLoading] = useState(true);
    const [editingCampaign, setEditingCampaign] = useState(null);

    const initialFormState = {
        name: '',
        platform: '',
        budget: '',
        startDate: '',
        endDate: '',
        leadsGenerated: '',
    };
    const [formData, setFormData] = useState(initialFormState);

    const fetchCampaigns = async () => {
        setLoading(true);
        try {
            const fetchedCampaigns = await getCampaigns();
            setCampaigns(fetchedCampaigns);
        } catch (error) {
            console.error("Error fetching campaigns:", error);
            toast.error("Could not load campaign data."); // --- REPLACE ALERT ---
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchCampaigns();
    }, []);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleEditClick = (campaign) => {
        setEditingCampaign(campaign);
        setFormData({
            name: campaign.name,
            platform: campaign.platform,
            budget: campaign.budget,
            startDate: campaign.startDate?.toDate ? campaign.startDate.toDate().toISOString().split('T')[0] : '',
            endDate: campaign.endDate?.toDate ? campaign.endDate.toDate().toISOString().split('T')[0] : '',
            leadsGenerated: campaign.leadsGenerated || 0,
        });
    };

    const handleCancelEdit = () => {
        setEditingCampaign(null);
        setFormData(initialFormState);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.name || !formData.platform || !formData.budget || !formData.startDate) {
            toast.error("Please fill in name, platform, budget, and start date."); // --- REPLACE ALERT ---
            return;
        }

        const dataToSave = {
            name: formData.name,
            platform: formData.platform,
            budget: parseFloat(formData.budget),
            startDate: new Date(formData.startDate),
            endDate: formData.endDate ? new Date(formData.endDate) : null,
            leadsGenerated: Number(formData.leadsGenerated) || 0,
        };

        try {
            if (editingCampaign) {
                await updateCampaign(editingCampaign.id, dataToSave);
                toast.success("Campaign updated successfully!"); // --- REPLACE ALERT ---
            } else {
                await addCampaign(dataToSave);
                toast.success("Campaign added successfully!"); // --- REPLACE ALERT ---
            }
            handleCancelEdit();
            fetchCampaigns();
        } catch (error) {
            console.error("Error saving campaign:", error);
            toast.error("Failed to save campaign."); // --- REPLACE ALERT ---
        }
    };

    const handleDeleteClick = (campaignId) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Are you sure you want to delete this campaign?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteCampaign(campaignId)
                        .then(() => {
                            toast.success("Campaign deleted.");
                            fetchCampaigns();
                        })
                        .catch(err => {
                            console.error("Error deleting campaign:", err);
                            toast.error("Failed to delete campaign.");
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), {
            icon: 'âš ï¸',
        });
    };

    const formatDate = (timestamp) => {
        if (!timestamp?.toDate) return 'N/A';
        return timestamp.toDate().toLocaleDateString('en-ZA');
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Marketing Campaigns</h3>
            
            <form onSubmit={handleSubmit} className="p-4 mb-6 bg-gray-900/50 rounded-lg space-y-4">
                <h4 className="text-lg font-semibold text-white">{editingCampaign ? 'Edit Campaign' : 'Add New Campaign'}</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <Input label="Campaign Name" name="name" value={formData.name} onChange={handleInputChange} placeholder="e.g., Winter Sale 2025" />
                    <Input label="Platform" name="platform" value={formData.platform} onChange={handleInputChange} placeholder="e.g., Facebook, Google Ads" />
                    <Input label="Budget (R)" name="budget" type="number" value={formData.budget} onChange={handleInputChange} placeholder="e.g., 5000" />
                    <Input label="Leads Generated" name="leadsGenerated" type="number" value={formData.leadsGenerated} onChange={handleInputChange} placeholder="e.g., 25" />
                    <Input label="Start Date" name="startDate" type="date" value={formData.startDate} onChange={handleInputChange} />
                    <Input label="End Date (Optional)" name="endDate" type="date" value={formData.endDate} onChange={handleInputChange} />
                </div>
                <div className="flex justify-end gap-2">
                    {editingCampaign && <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>}
                    <Button type="submit" variant="primary">
                        {editingCampaign ? <><Edit size={16} className="mr-2"/>Save Changes</> : <><PlusCircle size={16} className="mr-2"/>Add Campaign</>}
                    </Button>
                </div>
            </form>

            <div className="space-y-3">
                {loading ? <p className="text-gray-400">Loading...</p> :
                    campaigns.map(campaign => (
                        <div key={campaign.id} className="bg-gray-700 p-4 rounded-lg flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <p className="font-bold text-white">{campaign.name}</p>
                                <p className="text-sm text-gray-400">{campaign.platform}</p>
                            </div>
                            <div className="flex items-center gap-6">
                                <div className="text-center">
                                    <p className="text-xs text-gray-400">Leads</p>
                                    <p className="font-semibold text-blue-400">{campaign.leadsGenerated || 0}</p>
                                </div>
                                <div className="text-center">
                                    <p className="text-xs text-gray-400">Budget</p>
                                    <p className="font-semibold text-green-400">R{campaign.budget.toFixed(2)}</p>
                                </div>
                                <div className="text-center">
                                    <p className="text-xs text-gray-400">Date</p>
                                    <p className="text-sm text-gray-300">{formatDate(campaign.startDate)} - {formatDate(campaign.endDate)}</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <Button onClick={() => handleEditClick(campaign)} variant="secondary" size="sm" className="p-2"><Edit size={16}/></Button>
                                <Button onClick={() => handleDeleteClick(campaign.id)} variant="danger" size="sm" className="p-2"><Trash2 size={16}/></Button>
                            </div>
                        </div>
                    ))
                }
            </div>
        </div>
    );
};

export default CampaignManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\DepartmentsManager.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { getDepartments, addDepartment, deleteDepartment, updateDocument } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const DepartmentsManager = () => {
    const [departments, setDepartments] = useState([]);
    const [newDepartmentName, setNewDepartmentName] = useState('');
    const [loading, setLoading] = useState(true);
    const [editingDeptId, setEditingDeptId] = useState(null);

    const fetchDepartments = async () => {
        setLoading(true);
        const depts = await getDepartments();
        setDepartments(depts);
        setLoading(false);
    };

    useEffect(() => {
        fetchDepartments();
    }, []);

    const handleAddOrUpdate = async (e) => {
        e.preventDefault();
        if (!newDepartmentName.trim()) return;

        try {
            if (editingDeptId) {
                await updateDocument('departments', editingDeptId, { name: newDepartmentName });
                toast.success("Department updated successfully!"); // --- REPLACE ALERT ---
            } else {
                await addDepartment(newDepartmentName);
                toast.success("Department added successfully!"); // --- REPLACE ALERT ---
            }
            setNewDepartmentName('');
            setEditingDeptId(null);
            fetchDepartments();
        } catch (error) {
            console.error("Error saving department:", error);
            toast.error(`Failed to ${editingDeptId ? 'update' : 'add'} department.`); // --- REPLACE ALERT ---
        }
    };

    const handleEdit = (dept) => {
        setNewDepartmentName(dept.name);
        setEditingDeptId(dept.id);
    };

    const handleCancelEdit = () => {
        setNewDepartmentName('');
        setEditingDeptId(null);
    };

    const handleDelete = (id) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Are you sure you want to delete this department?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteDepartment(id)
                        .then(() => {
                            toast.success("Department deleted.");
                            fetchDepartments();
                        })
                        .catch(err => {
                            toast.error("Failed to delete department.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), {
            icon: 'âš ï¸',
        });
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Departments</h3>
            <form onSubmit={handleAddOrUpdate} className="flex items-center space-x-4 mb-6">
                <Input
                    name="departmentName"
                    value={newDepartmentName}
                    onChange={(e) => setNewDepartmentName(e.target.value)}
                    placeholder={editingDeptId ? "Edit department name..." : "New department name..."}
                    className="flex-grow"
                />
                {editingDeptId && (
                    <Button type="button" variant="secondary" onClick={handleCancelEdit}>
                        Cancel
                    </Button>
                )}
                <Button type="submit" variant="primary">
                    {editingDeptId ? "Update Department" : "Add Department"}
                </Button>
            </form>
            <div className="space-y-3">
                {loading ? (
                    <p>Loading departments...</p>
                ) : (
                    (departments || []).map(dept => (
                        <div key={dept.id} className="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <p className="text-gray-200">{dept.name}</p>
                            <div className="flex space-x-2">
                                <Button onClick={() => handleEdit(dept)} variant="secondary" className="py-1 px-3 text-xs">
                                    Edit
                                </Button>
                                <Button onClick={() => handleDelete(dept.id)} variant="danger" className="py-1 px-3 text-xs">
                                    Delete
                                </Button>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

export default DepartmentsManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\EmployeeSkillsModal.jsx
==================================================
// src/components/features/settings/EmployeeSkillsModal.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { getSkills, getEmployeeSkills, updateEmployeeSkillsAndLogHistory, getSkillHistoryForEmployee } from '../../../api/firestore';
import Button from '../../ui/Button';
import { X } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const EmployeeSkillsModal = ({ employee, onClose }) => {
    const [allSkills, setAllSkills] = useState([]);
    const [employeeSkills, setEmployeeSkills] = useState({});
    const [skillHistory, setSkillHistory] = useState([]);
    const [loading, setLoading] = useState(true);

    const getProficiencyLabel = (level) => {
        switch (level) {
            case 0: return 'Not Acquired';
            case 1: return 'Beginner';
            case 2: return 'Basic';
            case 3: return 'Intermediate';
            case 4: return 'Advanced';
            case 5: return 'Expert';
            default: return 'N/A';
        }
    };

    const fetchAllData = async () => {
        setLoading(true);
        try {
            const [fetchedSkills, currentSkills, fetchedHistory] = await Promise.all([
                getSkills(),
                getEmployeeSkills(employee.id),
                getSkillHistoryForEmployee(employee.id)
            ]);
            setAllSkills(fetchedSkills);
            setEmployeeSkills(currentSkills || {});
            setSkillHistory(fetchedHistory.sort((a,b) => b.assessmentDate.toDate() - a.assessmentDate.toDate()));
        } catch (error) {
            console.error("Error fetching skills data:", error);
            toast.error("Failed to load skills data for this employee."); // --- REPLACE ALERT ---
        }
        setLoading(false);
    };

    useEffect(() => {
        if (employee) {
            fetchAllData();
        }
    }, [employee]);

    const handleProficiencyChange = (skillId, newProficiencyValue) => {
        setEmployeeSkills(prevSkills => {
            const updatedSkills = { ...prevSkills };
            const numericValue = Number(newProficiencyValue);

            if (numericValue === 0) {
                delete updatedSkills[skillId];
            } else {
                updatedSkills[skillId] = numericValue;
            }
            return updatedSkills;
        });
    };

    const handleSaveChanges = async () => {
        try {
            await updateEmployeeSkillsAndLogHistory(employee, employeeSkills, allSkills);
            toast.success(`Successfully updated skills for ${employee.name}.`); // --- REPLACE ALERT ---
            onClose();
        } catch (error) {
            console.error("Error saving employee skills:", error);
            toast.error("Failed to save skills. Please try again."); // --- REPLACE ALERT ---
        }
    };

    return (
        <div
            className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center"
            onClick={onClose}
        >
            <div
                className="bg-gray-800 w-full max-w-lg rounded-xl shadow-lg border border-gray-700 flex flex-col"
                onClick={e => e.stopPropagation()}
            >
                <div className="flex justify-between items-center p-4 border-b border-gray-600">
                    <h3 className="text-xl font-bold text-white">Manage Skills for {employee.name}</h3>
                    <Button onClick={onClose} variant="secondary" className="p-2">
                        <X size={24} />
                    </Button>
                </div>

                <div className="p-6 space-y-6 overflow-y-auto max-h-[60vh]">
                    {loading ? (
                        <p className="text-gray-300">Loading skills...</p>
                    ) : (
                        <>
                            <div>
                                <h4 className="text-lg font-semibold text-white mb-3">Current Skill Ratings (0-5)</h4>
                                <p className="text-sm text-gray-400 mb-4">
                                    Rate proficiency from 0 (Not Acquired) to 5 (Expert).
                                    Skills rated 0 will not be saved.
                                </p>
                                <div className="space-y-4">
                                    {allSkills.map(skill => (
                                        <div key={skill.id} className="grid grid-cols-2 items-center gap-4">
                                            <label className="text-gray-200" htmlFor={`skill-${skill.id}`}>{skill.name}</label>
                                            <div>
                                                <input
                                                    id={`skill-${skill.id}`}
                                                    type="range"
                                                    min="0"
                                                    max="5"
                                                    step="1"
                                                    value={employeeSkills[skill.id] || 0}
                                                    onChange={(e) => handleProficiencyChange(skill.id, e.target.value)}
                                                    className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg accent-blue-600"
                                                />
                                                <p className="text-center text-sm text-gray-400 mt-1">
                                                    {getProficiencyLabel(employeeSkills[skill.id] || 0)}
                                                </p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="mt-6 border-t border-gray-700 pt-6">
                                <h4 className="text-lg font-semibold text-white mb-3">Skill Assessment History</h4>
                                {skillHistory.length > 0 ? (
                                    <ul className="space-y-2">
                                        {skillHistory.map(record => (
                                            <li key={record.id} className="bg-gray-700/50 p-3 rounded-lg text-sm flex justify-between items-center">
                                                <div>
                                                    <p className="font-semibold text-white">{record.skillName}: {getProficiencyLabel(record.proficiency)}</p>
                                                    <p className="text-gray-400 text-xs">
                                                        Assessed: {record.assessmentDate ? new Date(record.assessmentDate.toDate()).toLocaleDateString('en-ZA') : 'N/A'}
                                                    </p>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-gray-400 text-sm">No skill assessment history for this employee.</p>
                                )}
                            </div>
                        </>
                    )}
                </div>

                <div className="flex justify-end items-center p-4 border-t border-gray-600 bg-gray-800/50 rounded-b-xl">
                    <Button onClick={onClose} variant="secondary" className="mr-2">Cancel</Button>
                    <Button onClick={handleSaveChanges} variant="primary">Save Changes</Button>
                </div>
            </div>
        </div>
    );
};

export default EmployeeSkillsModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\EmployeesManager.jsx
==================================================
// src/components/features/settings/EmployeesManager.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { getEmployees, addEmployee, deleteEmployee, getDepartments, updateDocument } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import { Award } from 'lucide-react';
import EmployeeSkillsModal from './EmployeeSkillsModal';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const EmployeesManager = () => {
    const [employees, setEmployees] = useState([]);
    const [departments, setDepartments] = useState([]);
    const [loading, setLoading] = useState(true);
    const [editingEmployeeId, setEditingEmployeeId] = useState(null);
    const [isSkillsModalOpen, setIsSkillsModalOpen] = useState(false);
    const [selectedEmployee, setSelectedEmployee] = useState(null);

    const initialFormState = {
        name: '',
        departmentId: '',
        employeeType: 'permanent',
        hourlyRate: '',
        paymentModel: 'per_kg',
        rate: '',
    };
    const [newEmployee, setNewEmployee] = useState(initialFormState);

    const fetchData = async () => {
        setLoading(true);
        const [fetchedEmployees, fetchedDepartments] = await Promise.all([
            getEmployees(),
            getDepartments()
        ]);
        setEmployees(fetchedEmployees);
        setDepartments(fetchedDepartments);
        setLoading(false);
    };

    useEffect(() => { fetchData(); }, []);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setNewEmployee(prev => ({ ...prev, [name]: value }));
    };

    const handleAddOrUpdate = async (e) => {
        e.preventDefault();
        if (!newEmployee.name.trim() || !newEmployee.departmentId) {
            toast.error("Please enter a name and select a department."); // --- REPLACE ALERT ---
            return;
        }

        try {
            const dataToSave = { 
                name: newEmployee.name,
                departmentId: newEmployee.departmentId,
                employeeType: newEmployee.employeeType,
                hourlyRate: newEmployee.employeeType === 'permanent' ? (Number(newEmployee.hourlyRate) || 0) : 0,
                paymentModel: newEmployee.employeeType === 'subcontractor' ? newEmployee.paymentModel : null,
                rate: newEmployee.employeeType === 'subcontractor' ? (Number(newEmployee.rate) || 0) : 0,
            };

            if (editingEmployeeId) {
                await updateDocument('employees', editingEmployeeId, dataToSave);
                toast.success("Employee updated successfully!"); // --- REPLACE ALERT ---
            } else {
                await addEmployee(dataToSave);
                toast.success("Employee added successfully!"); // --- REPLACE ALERT ---
            }
            setNewEmployee(initialFormState);
            setEditingEmployeeId(null);
            fetchData();
        } catch (error) {
            console.error("Error saving employee:", error);
            toast.error(`Failed to ${editingEmployeeId ? 'update' : 'add'} employee.`); // --- REPLACE ALERT ---
        }
    };

    const handleEdit = (employee) => {
        setEditingEmployeeId(employee.id);
        setNewEmployee({
            name: employee.name || '',
            departmentId: employee.departmentId || '',
            employeeType: employee.employeeType || 'permanent',
            hourlyRate: employee.hourlyRate || '',
            paymentModel: employee.paymentModel || 'per_kg',
            rate: employee.rate || '',
        });
    };

    const handleCancelEdit = () => {
        setNewEmployee(initialFormState);
        setEditingEmployeeId(null);
    };

    const handleDelete = (id) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Are you sure?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteEmployee(id)
                        .then(() => {
                            toast.success("Employee deleted.");
                            fetchData();
                        })
                        .catch(err => {
                            toast.error("Failed to delete employee.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), {
            icon: 'âš ï¸',
        });
    };

    const handleManageSkillsClick = (employee) => {
        setSelectedEmployee(employee);
        setIsSkillsModalOpen(true);
    };

    const getDepartmentName = (deptId) => departments.find(d => d.id === deptId)?.name || 'Unknown';

    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Employees & Subcontractors</h3>
            <form onSubmit={handleAddOrUpdate} className="space-y-4 items-end mb-6 p-4 bg-gray-900/50 rounded-lg">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Input label="Name" name="name" value={newEmployee.name} onChange={handleInputChange} placeholder={editingEmployeeId ? "Edit name..." : "New name..."} />
                    <Dropdown label="Department" name="departmentId" value={newEmployee.departmentId} onChange={handleInputChange} options={departments || []} placeholder="Select department..." />
                    <Dropdown label="Employee Type" name="employeeType" value={newEmployee.employeeType} onChange={handleInputChange} options={[{id: 'permanent', name: 'Permanent'}, {id: 'subcontractor', name: 'Subcontractor'}]} />
                </div>
                
                {newEmployee.employeeType === 'permanent' && (
                    <div className="animate-fade-in">
                        <Input label="Hourly Rate (R)" name="hourlyRate" type="number" value={newEmployee.hourlyRate} onChange={handleInputChange} placeholder="e.g., 150.50" />
                    </div>
                )}

                {newEmployee.employeeType === 'subcontractor' && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">
                        <Dropdown label="Payment Model" name="paymentModel" value={newEmployee.paymentModel} onChange={handleInputChange} options={[{id: 'per_kg', name: 'Per Kilogram (kg)'}, {id: 'per_hour', name: 'Per Hour'}, {id: 'per_product', name: 'Per Product'}]} />
                        <Input label="Rate (R)" name="rate" type="number" value={newEmployee.rate} onChange={handleInputChange} placeholder="e.g., 40 for per_kg" />
                    </div>
                )}

                <div className="flex items-center gap-2 pt-4">
                    {editingEmployeeId && (
                        <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>
                    )}
                    <Button type="submit" variant="primary" className="flex-grow">
                        {editingEmployeeId ? "Update" : "Add"}
                    </Button>
                </div>
            </form>

            <div className="space-y-3">
                {loading ? <p className="text-gray-400">Loading...</p> : (employees || []).map(emp => (
                    <div key={emp.id} className="flex items-center justify-between bg-gray-900/50 p-3 rounded-md">
                        <div>
                            <p className="text-gray-200">
                                {emp.name} - <span className="text-gray-400 text-sm">{getDepartmentName(emp.departmentId)}</span>
                                {emp.employeeType === 'permanent' && <span className="text-blue-400 font-mono text-sm ml-4">R{(emp.hourlyRate || 0).toFixed(2)}/hr</span>}
                                {emp.employeeType === 'subcontractor' && <span className="text-purple-400 font-mono text-sm ml-4">Subcontractor ({emp.paymentModel})</span>}
                            </p>
                        </div>
                        <div className="flex items-center gap-2">
                            <Button onClick={() => handleManageSkillsClick(emp)} variant="secondary" size="sm"><Award size={16} className="mr-1" /> Manage Skills</Button>
                            <Button onClick={() => handleEdit(emp)} variant="secondary" size="sm">Edit</Button>
                            <Button onClick={() => handleDelete(emp.id)} variant="danger" size="sm">Delete</Button>
                        </div>
                    </div>
                ))}
            </div>

            {isSkillsModalOpen && selectedEmployee && (
                <EmployeeSkillsModal employee={selectedEmployee} onClose={() => setIsSkillsModalOpen(false)} />
            )}
        </div>
    );
};

export default EmployeesManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\FinancialSettings.jsx
==================================================
// src/components/features/settings/FinancialSettings.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { collection, doc, setDoc, onSnapshot, deleteDoc } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { PlusCircle, Trash2, Edit } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const FinancialSettings = () => {
    const [historicalData, setHistoricalData] = useState([]);
    const [loading, setLoading] = useState(true);
    const [editingId, setEditingId] = useState(null);
    const [newData, setNewData] = useState({ year: '', month: '', totalSales: '', totalCOGS: '' });

    useEffect(() => {
        const historicalSalesCol = collection(db, 'historicalSales');
        const unsubscribe = onSnapshot(historicalSalesCol, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.month - a.month;
            });
            setHistoricalData(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setNewData(prev => ({ ...prev, [name]: value }));
    };

    const handleSaveData = async (e) => {
        e.preventDefault();
        const { year, month, totalSales, totalCOGS } = newData;

        if (!year || !month || !totalSales || !totalCOGS || month < 1 || month > 12) {
            toast.error("Please enter valid data for all fields (Month must be 1-12)."); // --- REPLACE ALERT ---
            return;
        }

        const docId = editingId || `${year}-${String(month).padStart(2, '0')}`;
        const sales = parseFloat(totalSales);
        const cogs = parseFloat(totalCOGS);

        const dataToSave = {
            year: parseInt(year, 10),
            month: parseInt(month, 10),
            totalSales: sales,
            totalCOGS: cogs,
            grossProfit: sales - cogs,
        };

        try {
            const docRef = doc(db, 'historicalSales', docId);
            await setDoc(docRef, dataToSave, { merge: true });
            toast.success(`Financial data for ${docId} has been saved.`); // --- REPLACE ALERT ---
            handleCancelEdit();
        } catch (error) {
            console.error("Error saving historical data:", error);
            toast.error("Failed to save data."); // --- REPLACE ALERT ---
        }
    };
    
    const handleEditClick = (data) => {
        setEditingId(data.id);
        setNewData({
            year: data.year,
            month: data.month,
            totalSales: data.totalSales,
            totalCOGS: data.totalCOGS,
        });
    };

    const handleCancelEdit = () => {
        setEditingId(null);
        setNewData({ year: '', month: '', totalSales: '', totalCOGS: '' });
    };

    const handleDelete = (docId) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Delete financial data for {docId}?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteDoc(doc(db, 'historicalSales', docId))
                        .then(() => toast.success('Data deleted successfully.'))
                        .catch(err => {
                            toast.error("Failed to delete data.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), {
            icon: 'âš ï¸',
        });
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Historical Financial Data</h3>
            <p className="text-sm text-gray-400 mb-6">
                Enter your actual historical Sales and Cost of Goods Sold (COGS) for each month. This provides the most accurate data for all financial planning tools.
            </p>
            
            <form onSubmit={handleSaveData} className="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mb-6 p-4 bg-gray-900/50 rounded-lg">
                <Input label="Year" name="year" type="number" value={newData.year} onChange={handleInputChange} placeholder="e.g., 2023" disabled={!!editingId} />
                <Input label="Month" name="month" type="number" value={newData.month} onChange={handleInputChange} placeholder="e.g., 1 for Jan" disabled={!!editingId} />
                <Input label="Total Sales (R)" name="totalSales" type="number" value={newData.totalSales} onChange={handleInputChange} placeholder="e.g., 300000" />
                <Input label="Total COGS (R)" name="totalCOGS" type="number" value={newData.totalCOGS} onChange={handleInputChange} placeholder="e.g., 90000" />
                <div className="flex gap-2">
                    {editingId && <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>}
                    <Button type="submit" variant="primary" className="flex-grow">
                        {editingId ? 'Update' : <><PlusCircle size={16} className="mr-2"/> Save</>}
                    </Button>
                </div>
            </form>

            <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                {loading ? <p>Loading data...</p> : (
                    historicalData.map(data => (
                        <div key={data.id} className="grid grid-cols-5 gap-4 items-center bg-gray-700 p-3 rounded-lg text-sm">
                            <p className="font-bold text-white">{data.id}</p>
                            <p className="text-gray-300">Sales: <span className="font-mono">R{data.totalSales.toFixed(2)}</span></p>
                            <p className="text-gray-300">COGS: <span className="font-mono">R{data.totalCOGS.toFixed(2)}</span></p>
                            <div className="col-span-2 flex justify-end gap-2">
                                <Button onClick={() => handleEditClick(data)} variant="secondary" size="sm" className="p-2">
                                    <Edit size={16}/>
                                </Button>
                                <Button onClick={() => handleDelete(data.id)} variant="danger" size="sm" className="p-2">
                                    <Trash2 size={16}/>
                                </Button>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

export default FinancialSettings;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\InventoryManager.jsx
==================================================
// src/components/features/settings/InventoryManager.jsx (UNIFIED)
// This single component now manages all inventory categories (Products, Components, etc.)
// It replaces the four separate manager components.

import React, { useState, useEffect, useMemo } from 'react';
import {
    getAllInventoryItems,
    addInventoryItem,
    updateInventoryItem,
    deleteInventoryItem,
    getSuppliers,
    getSkills,
    getProductCategories,
} from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import { Search, Package, Factory, Wrench, Beaker, Save, PlusCircle, Trash2 } from 'lucide-react';
import toast from 'react-hot-toast';

// Reusable component for the category tabs
const CategoryTab = ({ label, icon, isActive, onClick }) => (
    <button onClick={onClick} className={`flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-md transition-colors ${isActive ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>
        {icon}
        {label}
    </button>
);

const InventoryManager = () => {
    const [allItems, setAllItems] = useState([]);
    const [suppliers, setSuppliers] = useState([]);
    const [skills, setSkills] = useState([]);
    const [productCategories, setProductCategories] = useState([]); // For the 'Product' form
    const [loading, setLoading] = useState(true);
    
    const [activeCategory, setActiveCategory] = useState('Product');
    const [searchTerm, setSearchTerm] = useState('');
    const [editingItemId, setEditingItemId] = useState(null);

    const initialFormState = {
        name: '', partNumber: '', sellingPrice: '', categoryId: '', currentStock: '', reorderLevel: '', standardStockLevel: '', unit: '', price: ''
    };
    const [formData, setFormData] = useState(initialFormState);

    const fetchData = async () => {
        setLoading(true);
        try {
            const [items, supps, skls, prodCats] = await Promise.all([
                getAllInventoryItems(),
                getSuppliers(),
                getSkills(),
                getProductCategories()
            ]);
            setAllItems(items);
            setSuppliers(supps);
            setSkills(skls);
            setProductCategories(prodCats);
        } catch (error) {
            console.error("Error fetching inventory data:", error);
            toast.error("Failed to load inventory data.");
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleCategoryChange = (category) => {
        setActiveCategory(category);
        setSearchTerm('');
        setEditingItemId(null);
        setFormData(initialFormState);
    };

    const handleEdit = (item) => {
        setEditingItemId(item.id);
        setFormData({ ...initialFormState, ...item });
    };

    const handleCancelEdit = () => {
        setEditingItemId(null);
        setFormData(initialFormState);
    };

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.name.trim()) return toast.error("Item name is required.");

        const dataToSave = {
            ...formData,
            category: activeCategory, // Set the category based on the active tab
            price: parseFloat(formData.price) || 0,
            sellingPrice: parseFloat(formData.sellingPrice) || 0,
            currentStock: Number(formData.currentStock) || 0,
            reorderLevel: Number(formData.reorderLevel) || 0,
            standardStockLevel: Number(formData.standardStockLevel) || 0,
        };

        try {
            if (editingItemId) {
                await updateInventoryItem(editingItemId, dataToSave);
                toast.success(`${activeCategory} updated successfully!`);
            } else {
                await addInventoryItem(dataToSave);
                toast.success(`${activeCategory} added successfully!`);
            }
            handleCancelEdit();
            fetchData();
        } catch (error) {
            console.error(`Error saving ${activeCategory}:`, error);
            toast.error(`Failed to save ${activeCategory}. ${error.message}`);
        }
    };

    const handleDelete = (itemId) => {
        toast((t) => (
            <span>
                Delete this item permanently?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteInventoryItem(itemId)
                        .then(() => {
                            toast.success("Item deleted.");
                            fetchData();
                            handleCancelEdit();
                        })
                        .catch(err => toast.error("Failed to delete item."));
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const displayedItems = useMemo(() => {
        return allItems.filter(item => {
            const categoryMatch = item.category === activeCategory;
            const searchMatch = !searchTerm || 
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (item.partNumber && item.partNumber.toLowerCase().includes(searchTerm.toLowerCase()));
            return categoryMatch && searchMatch;
        });
    }, [allItems, activeCategory, searchTerm]);

    const renderFormFields = () => {
        // Common fields for all categories
        const commonFields = (
            <>
                <Input label="Item Name" name="name" value={formData.name} onChange={handleInputChange} required />
                <Input label="Item Code / Part Number" name="partNumber" value={formData.partNumber} onChange={handleInputChange} />
                <Input label="Default Cost Price (R)" name="price" type="number" value={formData.price} onChange={handleInputChange} />
                <Input label="Unit of Measure" name="unit" value={formData.unit} onChange={handleInputChange} placeholder="e.g., each, kg, box"/>
                <Input label="Current Stock" name="currentStock" type="number" value={formData.currentStock} onChange={handleInputChange} />
                <Input label="Re-order Level" name="reorderLevel" type="number" value={formData.reorderLevel} onChange={handleInputChange} />
                <Input label="Standard Stock Level" name="standardStockLevel" type="number" value={formData.standardStockLevel} onChange={handleInputChange} />
            </>
        );

        if (activeCategory === 'Product') {
            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {commonFields}
                    <Dropdown label="Product Category" name="categoryId" value={formData.categoryId} onChange={handleInputChange} options={productCategories} placeholder="Select category..." />
                    <Input label="Selling Price (R)" name="sellingPrice" type="number" value={formData.sellingPrice} onChange={handleInputChange} />
                </div>
            );
        }
        
        // Form for Component, Raw Material, Workshop Supply
        return (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {commonFields}
            </div>
        );
    };

    return (
        <div className="space-y-6">
            <div className="flex flex-wrap items-center gap-2 p-2 bg-gray-900/50 rounded-lg">
                <CategoryTab label="Products" icon={<Factory size={16}/>} isActive={activeCategory === 'Product'} onClick={() => handleCategoryChange('Product')} />
                <CategoryTab label="Components" icon={<Wrench size={16}/>} isActive={activeCategory === 'Component'} onClick={() => handleCategoryChange('Component')} />
                <CategoryTab label="Raw Materials" icon={<Beaker size={16}/>} isActive={activeCategory === 'Raw Material'} onClick={() => handleCategoryChange('Raw Material')} />
                <CategoryTab label="Workshop Supplies" icon={<Package size={16}/>} isActive={activeCategory === 'Workshop Supply'} onClick={() => handleCategoryChange('Workshop Supply')} />
            </div>

            <form onSubmit={handleSubmit} className="bg-gray-800 p-4 rounded-lg space-y-4">
                <h3 className="text-lg font-bold text-white">{editingItemId ? `Editing ${activeCategory}` : `Add New ${activeCategory}`}</h3>
                {renderFormFields()}
                <div className="flex justify-end gap-2">
                    {editingItemId && <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>}
                    <Button type="submit" variant="primary">{editingItemId ? <><Save size={16} className="mr-2"/> Update Item</> : <><PlusCircle size={16} className="mr-2"/> Add Item</>}</Button>
                </div>
            </form>

            <div className="bg-gray-800 p-4 rounded-lg">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold text-white">Existing {activeCategory}s</h3>
                    <div className="relative w-full sm:w-1/3">
                        <Input type="text" placeholder="Search items..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="pl-10" />
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr>
                                <th className="p-2">Name</th>
                                <th className="p-2">Part Number</th>
                                <th className="p-2">In Stock</th>
                                <th className="p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {loading ? (
                                <tr><td colSpan="4" className="text-center p-4">Loading...</td></tr>
                            ) : displayedItems.map(item => (
                                <tr key={item.id} className="border-b border-gray-700">
                                    <td className="p-2 text-white font-medium">{item.name}</td>
                                    <td className="p-2">{item.partNumber || 'N/A'}</td>
                                    <td className="p-2">{item.currentStock}</td>
                                    <td className="p-2 flex gap-2">
                                        <Button onClick={() => handleEdit(item)} size="sm">Edit</Button>
                                        <Button onClick={() => handleDelete(item.id)} variant="danger" size="sm">Delete</Button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

export default InventoryManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\KaizenManager.jsx
==================================================
// src/components/features/settings/KaizenManager.jsx (NEW FILE)
// This component provides a management interface for reviewing and actioning
// continuous improvement suggestions submitted by employees.

import React, { useState, useEffect } from 'react';
import { collection, onSnapshot, query, orderBy, doc, updateDoc } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import { Lightbulb, Check, X, Archive } from 'lucide-react';
import toast from 'react-hot-toast';

const StatusBadge = ({ status }) => {
    const statusConfig = {
        'new': { label: 'New', color: 'bg-blue-500/20 text-blue-300' },
        'reviewing': { label: 'Under Review', color: 'bg-yellow-500/20 text-yellow-300' },
        'approved': { label: 'Approved', color: 'bg-purple-500/20 text-purple-300' },
        'implemented': { label: 'Implemented', color: 'bg-green-500/20 text-green-300' },
        'rejected': { label: 'Rejected', color: 'bg-red-500/20 text-red-400' },
    };
    const config = statusConfig[status] || { label: 'Unknown', color: 'bg-gray-500/20 text-gray-300' };
    return <span className={`px-3 py-1 text-xs font-semibold rounded-full ${config.color}`}>{config.label}</span>;
};

const KaizenManager = () => {
    const [suggestions, setSuggestions] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filter, setFilter] = useState('active'); // 'active' or 'archived'

    useEffect(() => {
        const q = query(collection(db, 'kaizenSuggestions'), orderBy('createdAt', 'desc'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedSuggestions = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setSuggestions(fetchedSuggestions);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    const handleStatusChange = async (id, newStatus) => {
        const suggestionRef = doc(db, 'kaizenSuggestions', id);
        try {
            await updateDoc(suggestionRef, { status: newStatus });
            toast.success(`Suggestion status updated to "${newStatus}".`);
        } catch (error) {
            console.error("Error updating suggestion status:", error);
            toast.error("Failed to update status.");
        }
    };

    const filteredSuggestions = suggestions.filter(s => {
        if (filter === 'active') {
            return s.status !== 'implemented' && s.status !== 'rejected';
        }
        return s.status === 'implemented' || s.status === 'rejected';
    });

    if (loading) {
        return <p className="text-center text-gray-400">Loading Kaizen suggestions...</p>;
    }

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold text-white flex items-center gap-2">
                    <Lightbulb className="text-yellow-400" />
                    Continuous Improvement (Kaizen)
                </h3>
                <div className="flex gap-2 p-1 bg-gray-900/50 rounded-lg">
                    <Button
                        size="sm"
                        variant={filter === 'active' ? 'primary' : 'secondary'}
                        onClick={() => setFilter('active')}
                    >
                        Active Suggestions
                    </Button>
                    <Button
                        size="sm"
                        variant={filter === 'archived' ? 'primary' : 'secondary'}
                        onClick={() => setFilter('archived')}
                    >
                        Archived
                    </Button>
                </div>
            </div>

            <div className="space-y-4">
                {filteredSuggestions.length === 0 ? (
                    <p className="text-center text-gray-500 py-8">No {filter} suggestions found.</p>
                ) : (
                    filteredSuggestions.map(suggestion => (
                        <div key={suggestion.id} className="bg-gray-900/50 p-4 rounded-lg">
                            <div className="flex justify-between items-start gap-4">
                                <div className="flex-grow">
                                    <p className="text-sm text-gray-400">
                                        Suggestion for: <span className="font-semibold text-gray-300">{suggestion.partName}</span> ({suggestion.jobIdentifier})
                                    </p>
                                    <p className="text-white my-2 italic">"{suggestion.suggestionText}"</p>
                                    <p className="text-xs text-gray-500">
                                        Submitted by: {suggestion.submittedBy} on {suggestion.createdAt?.toDate().toLocaleDateString()}
                                    </p>
                                </div>
                                <div className="flex flex-col items-end gap-2 w-48">
                                    <StatusBadge status={suggestion.status} />
                                    <Dropdown
                                        value={suggestion.status}
                                        onChange={(e) => handleStatusChange(suggestion.id, e.target.value)}
                                        options={[
                                            { id: 'new', name: 'New' },
                                            { id: 'reviewing', name: 'Under Review' },
                                            { id: 'approved', name: 'Approved' },
                                            { id: 'implemented', name: 'Implemented' },
                                            { id: 'rejected', name: 'Rejected' },
                                        ]}
                                    />
                                </div>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

export default KaizenManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\LearningPathManager.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { 
    getLearningPaths, 
    addLearningPath, 
    updateLearningPath, 
    deleteLearningPath, 
    getSkills 
} from '../../../api/firestore';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import { Book, PlusCircle, Trash2 } from 'lucide-react';
import toast from 'react-hot-toast';

const LearningPathManager = () => {
    const [paths, setPaths] = useState([]);
    const [allSkills, setAllSkills] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedPath, setSelectedPath] = useState(null);
    const [newPathName, setNewPathName] = useState('');

    const fetchData = async () => {
        setLoading(true);
        try {
            const [fetchedPaths, fetchedSkills] = await Promise.all([
                getLearningPaths(),
                getSkills()
            ]);
            setPaths(fetchedPaths);
            setAllSkills(fetchedSkills);
        } catch (error) {
            console.error("Error fetching learning path data:", error);
            toast.error("Could not load learning path data.");
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleAddPath = async (e) => {
        e.preventDefault();
        if (!newPathName.trim()) return;
        await addLearningPath({ name: newPathName });
        toast.success("Learning Path created.");
        setNewPathName('');
        fetchData();
    };
    
    const handleDeletePath = async (pathId) => {
        toast((t) => (
            <span>
                Delete this Learning Path?
                <Button variant="danger" size="sm" className="ml-2" onClick={async () => {
                    await deleteLearningPath(pathId);
                    toast.success("Learning Path deleted.");
                    setSelectedPath(null);
                    fetchData();
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const handleToggleSkillInPath = async (skillId) => {
        if (!selectedPath) return;

        const currentSkillIds = selectedPath.skillIds || [];
        const updatedSkillIds = currentSkillIds.includes(skillId)
            ? currentSkillIds.filter(id => id !== skillId)
            : [...currentSkillIds, skillId];
        
        try {
            await updateLearningPath(selectedPath.id, { skillIds: updatedSkillIds });
            const updatedPath = { ...selectedPath, skillIds: updatedSkillIds };
            setSelectedPath(updatedPath);
            // Also update the main paths list for immediate UI feedback
            setPaths(prevPaths => prevPaths.map(p => p.id === updatedPath.id ? updatedPath : p));
            toast.success("Path updated.");
        } catch (error) {
            toast.error("Failed to update path.");
        }
    };

    const availableSkills = useMemo(() => {
        if (!selectedPath) return allSkills;
        const pathSkillIds = new Set(selectedPath.skillIds || []);
        return allSkills.filter(skill => !pathSkillIds.has(skill.id));
    }, [allSkills, selectedPath]);

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-6">Manage Learning Paths</h3>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* Left Column: List and Add Form */}
                <div className="lg:col-span-1 space-y-6">
                    <div>
                        <h4 className="font-bold text-lg text-white mb-2">Existing Paths</h4>
                        <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                            {paths.map(path => (
                                <div 
                                    key={path.id}
                                    onClick={() => setSelectedPath(path)}
                                    className={`p-3 rounded-md cursor-pointer transition-colors ${selectedPath?.id === path.id ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}
                                >
                                    <p className="font-semibold">{path.name}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <form onSubmit={handleAddPath} className="space-y-3 border-t border-gray-700 pt-6">
                        <h4 className="font-bold text-lg text-white">Add New Path</h4>
                        <Input label="Path Name" value={newPathName} onChange={e => setNewPathName(e.target.value)} placeholder="e.g., Team Leader Track"/>
                        <Button type="submit" variant="primary" className="w-full">Create Path</Button>
                    </form>
                </div>

                {/* Right Column: Editor */}
                <div className="lg:col-span-2">
                    {selectedPath ? (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center">
                                <h4 className="text-xl font-bold text-blue-400">{selectedPath.name}</h4>
                                <Button onClick={() => handleDeletePath(selectedPath.id)} variant="danger" size="sm"><Trash2 size={14} className="mr-1"/>Delete Path</Button>
                            </div>
                            
                            {/* Skills in Path */}
                            <div>
                                <h5 className="font-semibold text-white mb-2">Skills in this Path</h5>
                                <div className="space-y-2">
                                    {(selectedPath.skillIds || []).map(skillId => {
                                        const skill = allSkills.find(s => s.id === skillId);
                                        return (
                                            <div key={skillId} className="flex items-center justify-between bg-gray-700/50 p-2 rounded-md">
                                                <p className="text-gray-200">{skill?.name || 'Unknown Skill'}</p>
                                                <Button onClick={() => handleToggleSkillInPath(skillId)} variant="danger" size="sm" className="p-1 h-7 w-7"><Trash2 size={14}/></Button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Add Skills to Path */}
                            <div>
                                <h5 className="font-semibold text-white mb-2 pt-4 border-t border-gray-700">Add Skills</h5>
                                <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                    {availableSkills.map(skill => (
                                         <div key={skill.id} className="flex items-center justify-between bg-gray-900/50 p-2 rounded-md">
                                            <p className="text-gray-300">{skill.name}</p>
                                            <Button onClick={() => handleToggleSkillInPath(skill.id)} variant="secondary" size="sm" className="p-1 h-7 w-7"><PlusCircle size={14}/></Button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex items-center justify-center h-full bg-gray-900/50 p-6 rounded-xl border-2 border-dashed border-gray-700 text-gray-500">
                           <p>Select a Learning Path to manage its skills.</p>
                       </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default LearningPathManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\MasterProductManager.jsx
==================================================
// src/components/features/settings/MasterProductManager.jsx (New File)

import React, { useState, useEffect, useMemo } from 'react';
import { 
    getMasterProducts, addMasterProduct, deleteMasterProduct, updateMasterProduct,
    getLinkedRecipesForMasterProduct, linkRecipeToMasterProduct, unlinkRecipeFromMasterProduct,
    getParts, getDepartments 
} from '../../../api/firestore';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import Dropdown from '../../ui/Dropdown';
import { Trash2, Link as LinkIcon, X } from 'lucide-react';

const MasterProductManager = () => {
    // State for data from Firestore
    const [masterProducts, setMasterProducts] = useState([]);
    const [parts, setParts] = useState([]);
    const [departments, setDepartments] = useState([]);
    const [linkedRecipes, setLinkedRecipes] = useState([]);
    const [loading, setLoading] = useState(true);

    // State for UI control
    const [selectedProductId, setSelectedProductId] = useState(null);
    const [newProductName, setNewProductName] = useState('');
    const [newProductDescription, setNewProductDescription] = useState('');

    // State for linking form
    const [partToLinkId, setPartToLinkId] = useState('');
    const [departmentToLinkId, setDepartmentToLinkId] = useState('');

    // Fetch initial data
    const fetchData = async () => {
        setLoading(true);
        const [products, fetchedParts, fetchedDepartments] = await Promise.all([
            getMasterProducts(),
            getParts(),
            getDepartments()
        ]);
        setMasterProducts(products);
        setParts(fetchedParts);
        setDepartments(fetchedDepartments);
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, []);

    // Fetch linked recipes whenever a master product is selected
    useEffect(() => {
        if (selectedProductId) {
            const fetchLinks = async () => {
                const links = await getLinkedRecipesForMasterProduct(selectedProductId);
                setLinkedRecipes(links);
            };
            fetchLinks();
        } else {
            setLinkedRecipes([]);
        }
    }, [selectedProductId]);

    const selectedMasterProduct = useMemo(() => {
        return masterProducts.find(p => p.id === selectedProductId);
    }, [selectedProductId, masterProducts]);

    // Handlers
    const handleAddMasterProduct = async (e) => {
        e.preventDefault();
        if (!newProductName.trim()) return alert('Product name is required.');
        await addMasterProduct({ name: newProductName, description: newProductDescription });
        setNewProductName('');
        setNewProductDescription('');
        fetchData();
    };

    const handleDeleteMasterProduct = async (productId) => {
        if (window.confirm("Are you sure you want to delete this master product and all its links? This cannot be undone.")) {
            await deleteMasterProduct(productId);
            setSelectedProductId(null);
            fetchData();
        }
    };

    const handleLinkRecipe = async (e) => {
        e.preventDefault();
        if (!partToLinkId || !departmentToLinkId) return alert('Please select a part and a department.');
        
        const partName = parts.find(p => p.id === partToLinkId)?.name || 'Unknown Part';
        const departmentName = departments.find(d => d.id === departmentToLinkId)?.name || 'Unknown Dept';
        const jobStepDetailId = `${partToLinkId}_${departmentToLinkId}`;

        await linkRecipeToMasterProduct({
            masterProductId: selectedProductId,
            jobStepDetailId,
            partId: partToLinkId,
            departmentId: departmentToLinkId,
            partName,
            departmentName
        });
        
        const links = await getLinkedRecipesForMasterProduct(selectedProductId);
        setLinkedRecipes(links);
        setPartToLinkId('');
        setDepartmentToLinkId('');
    };

    const handleUnlinkRecipe = async (linkId) => {
        await unlinkRecipeFromMasterProduct(linkId);
        const links = await getLinkedRecipesForMasterProduct(selectedProductId);
        setLinkedRecipes(links);
    };

    if (loading) return <p className="text-gray-400">Loading Master Product Manager...</p>;

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-2xl font-bold text-white mb-6">Master Product Manager</h3>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* Left Column: List and Add Form */}
                <div className="lg:col-span-1 space-y-6">
                    <div>
                        <h4 className="font-bold text-lg text-white mb-2">Master Product List</h4>
                        <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                            {masterProducts.map(product => (
                                <div 
                                    key={product.id}
                                    onClick={() => setSelectedProductId(product.id)}
                                    className={`p-3 rounded-md cursor-pointer transition-colors ${selectedProductId === product.id ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}
                                >
                                    <p className="font-semibold">{product.name}</p>
                                    <p className="text-xs opacity-70">{product.description}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <form onSubmit={handleAddMasterProduct} className="space-y-4 border-t border-gray-700 pt-6">
                        <h4 className="font-bold text-lg text-white">Add New Master Product</h4>
                        <Input label="Product Name" value={newProductName} onChange={e => setNewProductName(e.target.value)} placeholder="e.g., Volvo Cab Extender"/>
                        <Input label="Description" value={newProductDescription} onChange={e => setNewProductDescription(e.target.value)} placeholder="A brief description"/>
                        <Button type="submit" variant="primary" className="w-full">Create Product</Button>
                    </form>
                </div>

                {/* Right Column: Editor */}
                <div className="lg:col-span-2">
                    {selectedMasterProduct ? (
                        <div className="space-y-6">
                            <div>
                                <h4 className="text-xl font-bold text-blue-400">{selectedMasterProduct.name}</h4>
                                <p className="text-gray-400">{selectedMasterProduct.description}</p>
                            </div>

                            {/* Linked Recipes List */}
                            <div className="space-y-3">
                                <h5 className="font-semibold text-white">Linked Recipes ({linkedRecipes.length})</h5>
                                {linkedRecipes.length > 0 ? (
                                    linkedRecipes.map(link => (
                                        <div key={link.id} className="flex items-center justify-between bg-gray-700/50 p-3 rounded-lg">
                                            <div>
                                                <p className="font-semibold text-gray-200">{link.partName}</p>
                                                <p className="text-xs text-gray-400">{link.departmentName} Department</p>
                                            </div>
                                            <Button onClick={() => handleUnlinkRecipe(link.id)} variant="danger" size="sm" className="p-2">
                                                <X size={16}/>
                                            </Button>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-sm text-gray-500">No recipes linked yet.</p>
                                )}
                            </div>

                            {/* Link New Recipe Form */}
                            <form onSubmit={handleLinkRecipe} className="space-y-3 border-t border-gray-700 pt-6">
                                <h5 className="font-semibold text-white">Link New Recipe</h5>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <Dropdown label="Select Part" value={partToLinkId} onChange={e => setPartToLinkId(e.target.value)} options={parts} placeholder="Choose a part..."/>
                                    <Dropdown label="Select Department" value={departmentToLinkId} onChange={e => setDepartmentToLinkId(e.target.value)} options={departments} placeholder="Choose a department..."/>
                                </div>
                                <Button type="submit" variant="secondary" className="w-full"><LinkIcon size={16} className="mr-2"/>Link Recipe to Master Product</Button>
                            </form>

                             <div className="text-right border-t border-gray-700 pt-6">
                                <Button onClick={() => handleDeleteMasterProduct(selectedProductId)} variant="danger">
                                    <Trash2 size={16} className="mr-2"/> Delete Master Product
                                </Button>
                            </div>
                        </div>
                    ) : (
                        <div className="flex items-center justify-center h-full bg-gray-900/50 p-6 rounded-xl border-2 border-dashed border-gray-700 text-gray-500">
                           <p>Select a Master Product from the list on the left to manage its recipes.</p>
                       </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default MasterProductManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\OverheadsManager.jsx
==================================================
// src/components/features/settings/OverheadsManager.jsx (Upgraded with Toasts)

import React, { useState, useEffect, useMemo } from 'react';
import { 
    getOverheadCategories, addOverheadCategory, updateOverheadCategory, deleteOverheadCategory,
    getOverheadExpenses, addOverheadExpense, updateOverheadExpense, deleteOverheadExpense 
} from '../../../api/firestore'; 
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import { ChevronDown, ChevronRight, FilePlus, Building, Users, TrendingUp, HelpCircle } from 'lucide-react'; 
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const ExpenseTypeBadge = ({ type }) => {
    const config = {
        'Fixed Operational': { color: 'bg-blue-500', icon: <Building size={12} />, title: 'Fixed Operational Cost' },
        'Team & Training': { color: 'bg-purple-500', icon: <Users size={12} />, title: 'Team & Training Cost' },
        'Growth & Marketing': { color: 'bg-green-500', icon: <TrendingUp size={12} />, title: 'Growth & Marketing Investment' },
        'Discretionary/Reviewable': { color: 'bg-yellow-500', icon: <HelpCircle size={12} />, title: 'Discretionary/Reviewable Cost' }
    };
    const { color = 'bg-gray-500', icon = null, title = 'Uncategorized' } = config[type] || {};
    return (
        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-white ${color}`} title={title}>
            {icon}
        </span>
    );
};

const OverheadsManager = () => {
    const [overheadCategories, setOverheadCategories] = useState([]);
    const [allExpenses, setAllExpenses] = useState({});
    const [newCategoryName, setNewCategoryName] = useState('');
    const [editingCategoryId, setEditingCategoryId] = useState(null);
    const [selectedCategoryId, setSelectedCategoryId] = useState(null);
    const [newExpense, setNewExpense] = useState({ name: '', amount: '', expenseType: 'Fixed Operational' });
    const [editingExpenseId, setEditingExpenseId] = useState(null);
    const [loading, setLoading] = useState(true);

    const fetchAllData = async () => {
        setLoading(true);
        try {
            const fetchedCategories = await getOverheadCategories();
            setOverheadCategories(fetchedCategories);

            const expensesMap = {};
            const expensePromises = fetchedCategories.map(async (cat) => {
                const expenses = await getOverheadExpenses(cat.id);
                expensesMap[cat.id] = expenses;
            });
            await Promise.all(expensePromises);
            setAllExpenses(expensesMap);

        } catch (error) {
            console.error("Error fetching overhead data:", error);
            toast.error("Failed to load overhead data."); // --- REPLACE ALERT ---
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchAllData();
    }, []);

    const categoryTotals = useMemo(() => {
        const totals = {};
        for (const catId in allExpenses) {
            totals[catId] = allExpenses[catId].reduce((sum, exp) => sum + (exp.amount || 0), 0);
        }
        return totals;
    }, [allExpenses]);

    const totalsByType = useMemo(() => {
        const totals = {
            'Fixed Operational': 0,
            'Team & Training': 0,
            'Growth & Marketing': 0,
            'Discretionary/Reviewable': 0,
        };
        Object.values(allExpenses).flat().forEach(expense => {
            if (totals[expense.expenseType] !== undefined) {
                totals[expense.expenseType] += expense.amount || 0;
            }
        });
        return totals;
    }, [allExpenses]);

    const grandTotal = useMemo(() => {
        return Object.values(categoryTotals).reduce((sum, total) => sum + total, 0);
    }, [categoryTotals]);

    const handleAddOrUpdateCategory = async (e) => {
        e.preventDefault();
        if (!newCategoryName.trim()) return;
        try {
            const dataToSave = { name: newCategoryName.trim() };
            if (editingCategoryId) {
                await updateOverheadCategory(editingCategoryId, dataToSave);
                toast.success("Category updated.");
            } else {
                await addOverheadCategory(dataToSave);
                toast.success("Category added.");
            }
            setNewCategoryName('');
            setEditingCategoryId(null);
            fetchAllData(); 
        } catch (error) {
            toast.error(`Failed to save category.`); // --- REPLACE ALERT ---
        }
    };

    const handleAddOrUpdateExpense = async (e) => {
        e.preventDefault();
        if (!selectedCategoryId || !newExpense.name.trim() || newExpense.amount === '' || parseFloat(newExpense.amount) < 0) {
            toast.error("Please enter a valid expense name, amount, and select an expense type."); // --- REPLACE ALERT ---
            return;
        }
        try {
            const dataToSave = {
                name: newExpense.name.trim(),
                amount: parseFloat(newExpense.amount),
                expenseType: newExpense.expenseType,
            };
            if (editingExpenseId) {
                await updateOverheadExpense(selectedCategoryId, editingExpenseId, dataToSave);
                toast.success("Expense updated.");
            } else {
                await addOverheadExpense(selectedCategoryId, dataToSave);
                toast.success("Expense added.");
            }
            setNewExpense({ name: '', amount: '', expenseType: 'Fixed Operational' });
            setEditingExpenseId(null);
            fetchAllData();
        } catch (error) {
            toast.error(`Failed to save expense.`); // --- REPLACE ALERT ---
        }
    };

    const handleDeleteCategory = (categoryId) => {
        toast((t) => (
            <span>
                Delete category and ALL expenses?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteOverheadCategory(categoryId)
                        .then(() => {
                            toast.success("Category deleted.");
                            fetchAllData();
                            if (selectedCategoryId === categoryId) setSelectedCategoryId(null);
                        })
                        .catch(err => toast.error("Failed to delete category."));
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const handleDeleteExpense = (expenseId) => {
        toast((t) => (
            <span>
                Delete this expense?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteOverheadExpense(selectedCategoryId, expenseId)
                        .then(() => {
                            toast.success("Expense deleted.");
                            fetchAllData();
                        })
                        .catch(err => toast.error("Failed to delete expense."));
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const handleEditExpense = (expense) => { setNewExpense({ name: expense.name, amount: expense.amount || '', expenseType: expense.expenseType || 'Fixed Operational' }); setEditingExpenseId(expense.id); };
    const handleCancelEditExpense = () => { setNewExpense({ name: '', amount: '', expenseType: 'Fixed Operational' }); setEditingExpenseId(null); };
    const handleEditCategory = (category) => { setNewCategoryName(category.name); setEditingCategoryId(category.id); };
    const handleCancelEditCategory = () => { setNewCategoryName(''); setEditingCategoryId(null); };
    const handleSelectCategory = (categoryId) => { setSelectedCategoryId(prev => prev === categoryId ? null : categoryId); handleCancelEditExpense();};
    const handleExpenseInputChange = (e) => { const { name, value } = e.target; setNewExpense(prev => ({ ...prev, [name]: value }));};

    const expenseTypeOptions = [
        { id: 'Fixed Operational', name: 'Fixed Operational' },
        { id: 'Team & Training', name: 'Team & Training' },
        { id: 'Growth & Marketing', name: 'Growth & Marketing' },
        { id: 'Discretionary/Reviewable', name: 'Discretionary/Reviewable' },
    ];

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <div className="flex justify-between items-start mb-4">
                 <h3 className="text-xl font-bold text-white flex items-center"><FilePlus size={22} className="mr-2 text-blue-400"/> Manage Overheads & Fixed Costs</h3>
                 <div className="text-right">
                    <p className="text-sm text-gray-400">Grand Total</p>
                    <p className="text-2xl font-bold text-green-400 font-mono">R {grandTotal.toLocaleString('en-ZA', {minimumFractionDigits: 2})}</p>
                    <div className="flex gap-4 mt-2 justify-end text-xs">
                        {Object.entries(totalsByType).map(([type, total]) => (
                            <div key={type} className="flex items-center gap-2">
                                <ExpenseTypeBadge type={type} />
                                <span className="text-gray-400">R {total.toLocaleString('en-ZA')}</span>
                            </div>
                        ))}
                    </div>
                 </div>
            </div>

            <form onSubmit={handleAddOrUpdateCategory} className="flex items-center space-x-4 mb-6 p-4 bg-gray-900/50 rounded-lg">
                <Input label="Category Name" name="categoryName" value={newCategoryName} onChange={(e) => setNewCategoryName(e.target.value)} placeholder={editingCategoryId ? "Edit category name..." : "New category name (e.g., Rent & Utilities)"} className="flex-grow"/>
                {editingCategoryId && (<Button type="button" variant="secondary" onClick={handleCancelEditCategory}>Cancel</Button>)}
                <Button type="submit" variant="primary">{editingCategoryId ? "Update Category" : "Add Category"}</Button>
            </form>

            <div className="space-y-3">
                {loading ? <p>Loading categories...</p> : (overheadCategories || []).length === 0 ? <p className="text-center p-4 text-gray-500">No overhead categories added yet.</p> :
                    (overheadCategories || []).map(category => (
                        <div key={category.id} className="bg-gray-700 p-3 rounded-lg">
                            <div className="flex items-center justify-between">
                                <button onClick={() => handleSelectCategory(category.id)} className="flex-grow text-left text-gray-200 font-semibold flex items-center py-1">
                                    {selectedCategoryId === category.id ? <ChevronDown size={18} className="mr-2"/> : <ChevronRight size={18} className="mr-2"/>}
                                    {category.name}
                                </button>
                                <span className="font-mono text-gray-300 mr-4">R {categoryTotals[category.id]?.toLocaleString('en-ZA', {minimumFractionDigits: 2}) || '0.00'}</span>
                                <div className="flex space-x-2">
                                    <Button onClick={() => handleEditCategory(category)} variant="secondary" className="py-1 px-3 text-xs">Edit</Button>
                                    <Button onClick={() => handleDeleteCategory(category.id)} variant="danger" className="py-1 px-3 text-xs">Delete</Button>
                                </div>
                            </div>

                            {selectedCategoryId === category.id && (
                                <div className="mt-4 p-4 bg-gray-800 rounded-lg animate-fade-in border border-gray-700">
                                    <form onSubmit={handleAddOrUpdateExpense} className="grid grid-cols-1 md:grid-cols-4 gap-3 items-end mb-4">
                                        <Input label="Expense Name" name="name" value={newExpense.name} onChange={handleExpenseInputChange} placeholder={editingExpenseId ? "Edit name..." : "e.g., Ranos Rent"}/>
                                        <Input label="Amount (R)" name="amount" type="number" value={newExpense.amount} onChange={handleExpenseInputChange} placeholder="e.g., 2000.00"/>
                                        <Dropdown label="Expense Type" name="expenseType" value={newExpense.expenseType} onChange={handleExpenseInputChange} options={expenseTypeOptions} />
                                        <div className="flex gap-2">
                                            {editingExpenseId && (<Button type="button" variant="secondary" onClick={handleCancelEditExpense}>Cancel</Button>)}
                                            <Button type="submit" variant="primary" className="flex-grow">{editingExpenseId ? "Update" : "Add"}</Button>
                                        </div>
                                    </form>

                                    <div className="space-y-2 max-h-48 overflow-y-auto mt-4 pt-4 border-t border-gray-700">
                                        {(allExpenses[category.id] || []).length === 0 ? <p className="text-gray-400 text-sm">No expenses in this category yet.</p> :
                                            (allExpenses[category.id] || []).map(expense => (
                                                <div key={expense.id} className="flex items-center justify-between bg-gray-700 p-2 rounded-md text-sm">
                                                    <div className="flex items-center gap-3">
                                                        <ExpenseTypeBadge type={expense.expenseType} />
                                                        <p className="text-gray-200">{expense.name}</p>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        <p className="text-gray-300 font-mono">R {(expense.amount || 0).toFixed(2)}</p>
                                                        <div className="flex space-x-2">
                                                            <Button onClick={() => handleEditExpense(expense)} variant="secondary" className="py-0.5 px-2 text-xs">Edit</Button>
                                                            <Button onClick={() => handleDeleteExpense(expense.id)} variant="danger" className="py-0.5 px-2 text-xs">Del</Button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            )}
                        </div>
                    ))
                }
            </div>
        </div>
    );
};

export default OverheadsManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\ReworkReasonsManager.jsx
==================================================
// src/components/features/settings/ReworkReasonsManager.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { collection, getDocs, addDoc, deleteDoc, doc, updateDoc, query, orderBy } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { Trash2, Edit, PlusCircle } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const ReworkReasonsManager = () => {
    const [reasons, setReasons] = useState([]);
    const [loading, setLoading] = useState(true);
    const [editingId, setEditingId] = useState(null);
    const [reasonName, setReasonName] = useState('');

    const reasonsCollection = collection(db, 'reworkReasons');

    const fetchData = async () => {
        setLoading(true);
        const q = query(reasonsCollection, orderBy('name'));
        const snapshot = await getDocs(q);
        setReasons(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleAddOrUpdate = async (e) => {
        e.preventDefault();
        if (!reasonName.trim()) return;

        try {
            if (editingId) {
                await updateDoc(doc(db, 'reworkReasons', editingId), { name: reasonName.trim() });
                toast.success("Reason updated.");
            } else {
                await addDoc(reasonsCollection, { name: reasonName.trim() });
                toast.success("Reason added.");
            }
            setReasonName('');
            setEditingId(null);
            fetchData();
        } catch (error) {
            console.error("Error saving rework reason:", error);
            toast.error("Failed to save rework reason."); // --- REPLACE ALERT ---
        }
    };

    const handleEdit = (reason) => {
        setEditingId(reason.id);
        setReasonName(reason.name);
    };

    const handleDelete = (id) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Delete this reason?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteDoc(doc(db, 'reworkReasons', id))
                        .then(() => {
                            toast.success("Reason deleted.");
                            fetchData();
                        })
                        .catch(err => {
                            toast.error("Failed to delete reason.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Rework Reasons</h3>
            <p className="text-sm text-gray-400 mb-4">Define the standard failure modes for Quality Control checks. This will power your rework analysis dashboards.</p>
            <form onSubmit={handleAddOrUpdate} className="flex items-center space-x-4 mb-6">
                <Input
                    name="reasonName"
                    value={reasonName}
                    onChange={(e) => setReasonName(e.target.value)}
                    placeholder={editingId ? "Edit reason..." : "New reason (e.g., Poor Surface Finish)"}
                    className="flex-grow"
                />
                {editingId && (<Button type="button" variant="secondary" onClick={() => { setEditingId(null); setReasonName(''); }}>Cancel</Button>)}
                <Button type="submit" variant="primary">
                    {editingId ? <><Edit size={16} className="mr-2"/>Update</> : <><PlusCircle size={16} className="mr-2"/>Add Reason</>}
                </Button>
            </form>
            <div className="space-y-3">
                {loading ? <p>Loading...</p> : reasons.map(reason => (
                    <div key={reason.id} className="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                        <p className="text-gray-200">{reason.name}</p>
                        <div className="flex space-x-2">
                            <Button onClick={() => handleEdit(reason)} variant="secondary" size="sm" className="py-1 px-2 text-xs">Edit</Button>
                            <Button onClick={() => handleDelete(reason.id)} variant="danger" size="sm" className="py-1 px-2 text-xs">Delete</Button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default ReworkReasonsManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\RoleManager.jsx
==================================================
// src/components/features/settings/RoleManager.jsx

import React, { useState, useEffect } from 'react';
import { collection, getDocs, doc, setDoc, deleteDoc } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { Shield, Lock, Unlock, PlusCircle, Trash2 } from 'lucide-react';
import toast from 'react-hot-toast';

const ALL_PERMISSIONS = [
    { id: 'dashboard', label: 'Dashboard' },
    { id: 'quotes', label: 'Sales Quotes' },
    { id: 'marketing', label: 'Marketing Dashboard' },
    { id: 'orders', label: 'Sales Orders' },
    { id: 'purchasing', label: 'Purchasing Hub' },
    { id: 'stockTake', label: 'Stock Take' },
    { id: 'tracking', label: 'Live Tracking' },
    { id: 'scanner', label: 'Scanner' },
    { id: 'calendar', label: 'Calendar' },
    { id: 'kanban', label: 'Kanban Board' },
    { id: 'floorplan', label: 'Floor Plan' }, // --- NEW PERMISSION ---
    { id: 'picking', label: 'Picking Queue' },
    { id: 'jobCreator', label: 'Job Creator' },
    { id: 'qc', label: 'Quality Control' },
    { id: 'issues', label: 'Issues & Halts' },
    { id: 'adjustment', label: 'Job Card Adjustment' },
    { id: 'performance', label: 'Performance BI' },
    { id: 'profitability', label: 'Profitability BI' },
    { id: 'valuation', label: 'Valuation BI' },
    { id: 'assets', label: 'Asset Intelligence' },
    { id: 'settings', label: 'Settings' },
    { id: 'hideSidebar', label: 'Hide Sidebar (Tablet UI)' },
    { id: 'access_portal', label: 'Access Customer Portal' },
    { id: 'multiStage', label: 'Multi-Stage Wizard' },
    { id: 'jobHistory', label: 'Job History' },
    { id: 'reworkQueue', label: 'Rework Queue' },
    { id: 'stockAdjust', label: 'Stock Adjustment' },
    { id: 'jobReprint', label: 'Reprint Jobs' },
];

const RoleManager = () => {
    const [roles, setRoles] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedRole, setSelectedRole] = useState(null);
    const [newRoleName, setNewRoleName] = useState('');

    const fetchRoles = async () => {
        setLoading(true);
        const rolesCollectionRef = collection(db, 'roles');
        const snapshot = await getDocs(rolesCollectionRef);
        const fetchedRoles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const managerRoleExists = fetchedRoles.some(role => role.name === 'Manager');
        if (!managerRoleExists) {
            try {
                const fullPermissions = ALL_PERMISSIONS.reduce((acc, permission) => {
                    acc[permission.id] = true;
                    return acc;
                }, {});
                const managerRoleRef = doc(db, 'roles', 'Manager');
                await setDoc(managerRoleRef, {
                    name: 'Manager',
                    permissions: fullPermissions
                });
                fetchedRoles.push({ id: 'Manager', name: 'Manager', permissions: fullPermissions });
                toast.success("Default 'Manager' role created.");
            } catch (error) {
                console.error("Error creating default Manager role:", error);
                toast.error("Could not create default Manager role.");
            }
        }

        setRoles(fetchedRoles);
        setLoading(false);
    };

    useEffect(() => {
        fetchRoles();
    }, []);

    const handleSelectRole = (role) => {
        setSelectedRole({ ...role, permissions: role.permissions || {} });
    };

    const handlePermissionChange = (permissionId, value) => {
        setSelectedRole(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [permissionId]: value
            }
        }));
    };

    const handleSaveRole = async () => {
        if (!selectedRole) return;
        const roleRef = doc(db, 'roles', selectedRole.id);
        try {
            await setDoc(roleRef, { name: selectedRole.name, permissions: selectedRole.permissions }, { merge: true });
            toast.success(`Role "${selectedRole.name}" updated successfully!`);
            fetchRoles();
        } catch (error) {
            toast.error("Failed to update role.");
            console.error("Error updating role:", error);
        }
    };

    const handleAddNewRole = async () => {
        if (!newRoleName.trim()) return toast.error("Role name cannot be empty.");
        
        const roleId = newRoleName.trim();
        const roleRef = doc(db, 'roles', roleId);

        try {
            await setDoc(roleRef, {
                name: roleId,
                permissions: {}
            });
            toast.success(`Role "${roleId}" created.`);
            setNewRoleName('');
            fetchRoles();
        } catch (error) {
            toast.error("Failed to create role.");
            console.error("Error creating role:", error);
        }
    };

    const handleDeleteRole = (roleId, roleName) => {
        if (roleName === 'Manager') {
            return toast.error("The 'Manager' role cannot be deleted.");
        }
        toast((t) => (
            <span>
                Delete role "{roleName}"? This cannot be undone.
                <Button
                    variant="danger"
                    size="sm"
                    className="ml-2"
                    onClick={() => {
                        deleteDoc(doc(db, 'roles', roleId))
                            .then(() => {
                                toast.success("Role deleted.");
                                fetchRoles();
                                setSelectedRole(null);
                            })
                            .catch(err => toast.error("Failed to delete role."));
                        toast.dismiss(t.id);
                    }}
                >
                    Delete
                </Button>
                <Button
                    variant="secondary"
                    size="sm"
                    className="ml-2"
                    onClick={() => toast.dismiss(t.id)}
                >
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-2xl font-bold text-white mb-6">Role & Permission Management</h3>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div className="lg:col-span-1 space-y-6">
                    <div>
                        <h4 className="font-bold text-lg text-white mb-2">System Roles</h4>
                        <div className="space-y-2">
                            {loading ? <p className="text-gray-400">Loading roles...</p> :
                                roles.map(role => (
                                    <div 
                                        key={role.id}
                                        onClick={() => handleSelectRole(role)}
                                        className={`p-3 rounded-md cursor-pointer transition-colors flex justify-between items-center ${selectedRole?.id === role.id ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}
                                        >
                                        <span className="font-semibold">{role.name}</span>
                                        {role.name !== 'Manager' && (
                                            <Button variant="icon" size="sm" className="text-red-400 hover:text-red-300 p-1" onClick={(e) => { e.stopPropagation(); handleDeleteRole(role.id, role.name); }}>
                                                <Trash2 size={16}/>
                                            </Button>
                                        )}
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                    <div className="space-y-3 border-t border-gray-700 pt-6">
                        <h4 className="font-bold text-lg text-white">Add New Role</h4>
                        <div className="flex gap-2">
                            <Input placeholder="e.g., Floor Staff" value={newRoleName} onChange={e => setNewRoleName(e.target.value)} />
                            <Button onClick={handleAddNewRole}><PlusCircle size={16} /></Button>
                        </div>
                    </div>
                </div>

                <div className="lg:col-span-2">
                    {!selectedRole ? (
                        <div className="flex items-center justify-center h-full bg-gray-900/50 p-6 rounded-xl border-2 border-dashed border-gray-700 text-gray-500">
                            <p>Select a role from the list to manage its permissions.</p>
                       </div>
                    ) : (
                        <div className="bg-gray-900/50 p-6 rounded-xl">
                            <h4 className="text-xl font-bold text-blue-400 mb-4">Editing Permissions for: {selectedRole.name}</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-3">
                                {ALL_PERMISSIONS.map(permission => (
                                    <div key={permission.id} className="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                                        <label htmlFor={permission.id} className="text-gray-200">{permission.label}</label>
                                        <button 
                                            id={permission.id}
                                            onClick={() => handlePermissionChange(permission.id, !selectedRole.permissions[permission.id])}
                                            className={`p-2 rounded-full transition-colors ${selectedRole.permissions[permission.id] ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}
                                        >
                                            {selectedRole.permissions[permission.id] ? <Unlock size={16} /> : <Lock size={16} />}
                                        </button>
                                    </div>
                                ))}
                            </div>
                             <div className="text-right border-t border-gray-700 pt-4 mt-4">
                                <Button onClick={handleSaveRole} variant="primary">Save Changes for "{selectedRole.name}"</Button>
                            </div>
                       </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default RoleManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\RoutineTasksManager.jsx
==================================================
// src/components/features/settings/RoutineTasksManager.jsx (NEW FILE)

import React, { useState, useEffect } from 'react';
import { getRoutineTasks, addRoutineTask, updateRoutineTask, deleteRoutineTask } from '../../../api/firestore';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import Dropdown from '../../ui/Dropdown';
import Textarea from '../../ui/Textarea';
import { PlusCircle, Edit, Trash2 } from 'lucide-react';
import toast from 'react-hot-toast';

const RoutineTasksManager = () => {
    const [tasks, setTasks] = useState([]);
    const [loading, setLoading] = useState(true);
    const [editingId, setEditingId] = useState(null);
    const [formData, setFormData] = useState({
        name: '',
        description: '',
        schedule: 'daily',
        timeOfDay: '16:45',
    });

    const scheduleOptions = [
        { id: 'daily', name: 'Daily' },
        { id: 'weekly_monday', name: 'Weekly (Monday)' },
        { id: 'weekly_tuesday', name: 'Weekly (Tuesday)' },
        { id: 'weekly_wednesday', name: 'Weekly (Wednesday)' },
        { id: 'weekly_thursday', name: 'Weekly (Thursday)' },
        { id: 'weekly_friday', name: 'Weekly (Friday)' },
    ];

    const fetchData = async () => {
        setLoading(true);
        try {
            const fetchedTasks = await getRoutineTasks();
            setTasks(fetchedTasks);
        } catch (error) {
            console.error("Error fetching routine tasks:", error);
            toast.error("Could not load routine tasks.");
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleCancelEdit = () => {
        setEditingId(null);
        setFormData({ name: '', description: '', schedule: 'daily', timeOfDay: '16:45' });
    };

    const handleEditClick = (task) => {
        setEditingId(task.id);
        setFormData({
            name: task.name,
            description: task.description,
            schedule: task.schedule,
            timeOfDay: task.timeOfDay,
        });
    };

    const handleDelete = (taskId) => {
        toast((t) => (
            <span>
                Delete this routine task?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteRoutineTask(taskId)
                        .then(() => {
                            toast.success("Task deleted.");
                            fetchData();
                        })
                        .catch(err => toast.error("Failed to delete task."));
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.name.trim() || !formData.timeOfDay) {
            return toast.error("Please provide a task name and a time of day.");
        }

        try {
            if (editingId) {
                await updateRoutineTask(editingId, formData);
                toast.success("Routine task updated successfully!");
            } else {
                await addRoutineTask(formData);
                toast.success("Routine task added successfully!");
            }
            handleCancelEdit();
            fetchData();
        } catch (error) {
            console.error("Error saving routine task:", error);
            toast.error("Failed to save routine task.");
        }
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Routine Tasks</h3>
            <p className="text-sm text-gray-400 mb-4">
                Create recurring daily or weekly tasks like cleanup or maintenance. These will appear on the main dashboard at the scheduled time.
            </p>
            
            <form onSubmit={handleSubmit} className="p-4 mb-6 bg-gray-900/50 rounded-lg space-y-4">
                <h4 className="text-lg font-semibold text-white">{editingId ? 'Edit Task' : 'Add New Task'}</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Input label="Task Name" name="name" value={formData.name} onChange={handleInputChange} placeholder="e.g., End of Day Cleanup" />
                    <Dropdown label="Schedule" name="schedule" value={formData.schedule} onChange={handleInputChange} options={scheduleOptions} />
                    <Input label="Time of Day" name="timeOfDay" type="time" value={formData.timeOfDay} onChange={handleInputChange} />
                </div>
                <Textarea label="Description / Checklist (one item per line)" name="description" value={formData.description} onChange={handleInputChange} placeholder="Sweep workshop floor&#10;Empty all bins" rows={3}/>
                <div className="flex justify-end gap-2">
                    {editingId && <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>}
                    <Button type="submit" variant="primary">
                        {editingId ? <><Edit size={16} className="mr-2"/>Save Changes</> : <><PlusCircle size={16} className="mr-2"/>Add Task</>}
                    </Button>
                </div>
            </form>

            <div className="space-y-3">
                <h4 className="text-lg font-semibold text-white">Scheduled Tasks</h4>
                {loading ? <p className="text-gray-400">Loading...</p> :
                    tasks.map(task => (
                        <div key={task.id} className="bg-gray-700 p-4 rounded-lg flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <p className="font-bold text-white">{task.name}</p>
                                <p className="text-sm text-gray-400">
                                    {scheduleOptions.find(s => s.id === task.schedule)?.name} at {task.timeOfDay}
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <Button onClick={() => handleEditClick(task)} variant="secondary" size="sm" className="p-2"><Edit size={16}/></Button>
                                <Button onClick={() => handleDelete(task.id)} variant="danger" size="sm" className="p-2"><Trash2 size={16}/></Button>
                            </div>
                        </div>
                    ))
                }
                 {tasks.length === 0 && !loading && <p className="text-center text-gray-500 py-4">No routine tasks have been created yet.</p>}
            </div>
        </div>
    );
};

export default RoutineTasksManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\SkillsManager.jsx
==================================================
// src/components/features/settings/SkillsManager.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { getSkills, addSkill, deleteSkill, updateSkill } from '../../../api/firestore'; 
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { Edit, Trash2, Check, X } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const SkillsManager = () => {
    const [skills, setSkills] = useState([]);
    const [newSkillName, setNewSkillName] = useState('');
    const [loading, setLoading] = useState(true);
    const [editingSkillId, setEditingSkillId] = useState(null);
    const [editingSkillName, setEditingSkillName] = useState('');

    const fetchSkills = async () => {
        setLoading(true);
        try {
            const fetchedSkills = await getSkills();
            setSkills(fetchedSkills);
        } catch (error) {
            console.error("Error fetching skills:", error);
            toast.error("Could not fetch skills."); // --- REPLACE ALERT ---
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchSkills();
    }, []);

    const handleAddSkill = async (e) => {
        e.preventDefault();
        if (!newSkillName.trim()) return;
        try {
            await addSkill(newSkillName.trim());
            toast.success("Skill added.");
            setNewSkillName('');
            await fetchSkills();
        } catch (error) {
            console.error("Error adding skill:", error);
            toast.error("Failed to add skill."); // --- REPLACE ALERT ---
        }
    };

    const handleDeleteSkill = (skillId) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Are you sure you want to delete this skill?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteSkill(skillId)
                        .then(() => {
                            toast.success("Skill deleted.");
                            fetchSkills();
                        })
                        .catch(err => {
                            toast.error("Failed to delete skill.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const handleEditClick = (skill) => {
        setEditingSkillId(skill.id);
        setEditingSkillName(skill.name);
    };

    const handleCancelEdit = () => {
        setEditingSkillId(null);
        setEditingSkillName('');
    };

    const handleUpdateSkill = async (skillId) => {
        if (!editingSkillName.trim()) return;
        try {
            await updateSkill(skillId, { name: editingSkillName.trim() });
            toast.success("Skill updated.");
            setEditingSkillId(null);
            setEditingSkillName('');
            await fetchSkills();
        } catch (error) {
            console.error("Error updating skill:", error);
            toast.error("Failed to update skill."); // --- REPLACE ALERT ---
        }
    };

    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Skills</h3>
            <form onSubmit={handleAddSkill} className="flex items-center gap-4 mb-6">
                <Input
                    type="text"
                    value={newSkillName}
                    onChange={(e) => setNewSkillName(e.target.value)}
                    placeholder="New skill name..."
                    className="flex-grow"
                />
                <Button type="submit" variant="primary">Add Skill</Button>
            </form>

            <div className="space-y-3">
                {loading ? (
                    <p className="text-gray-400">Loading skills...</p>
                ) : (
                    skills.map((skill) => (
                        <div key={skill.id} className="flex items-center justify-between bg-gray-900/50 p-3 rounded-md">
                            {editingSkillId === skill.id ? (
                                <Input
                                    type="text"
                                    value={editingSkillName}
                                    onChange={(e) => setEditingSkillName(e.target.value)}
                                    className="flex-grow mr-2"
                                />
                            ) : (
                                <p className="text-gray-200">{skill.name}</p>
                            )}
                            <div className="flex items-center gap-2">
                                {editingSkillId === skill.id ? (
                                    <>
                                        <Button onClick={() => handleUpdateSkill(skill.id)} variant="icon" className="text-green-500 hover:text-green-400">
                                            <Check size={18} />
                                        </Button>
                                        <Button onClick={handleCancelEdit} variant="icon" className="text-red-500 hover:text-red-400">
                                            <X size={18} />
                                        </Button>
                                    </>
                                ) : (
                                    <>
                                        <Button onClick={() => handleEditClick(skill)} variant="secondary" size="sm">
                                            <Edit size={16} className="mr-1" /> Edit
                                        </Button>
                                        <Button onClick={() => handleDeleteSkill(skill.id)} variant="danger" size="sm">
                                            <Trash2 size={16} className="mr-1" /> Delete
                                        </Button>
                                    </>
                                )}
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

export default SkillsManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\SuppliersManager.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { getSuppliers, addSupplier, deleteSupplier, updateSupplier } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const SuppliersManager = () => {
  const [suppliers, setSuppliers] = useState([]);
  const [newSupplier, setNewSupplier] = useState({ name: '', email: '', estimatedEtaDays: '', minOrderAmount: '' });
  const [loading, setLoading] = useState(true);
  const [editingSupplierId, setEditingSupplierId] = useState(null);

  const fetchSuppliers = async () => {
    setLoading(true);
    const fetchedSuppliers = await getSuppliers();
    setSuppliers(fetchedSuppliers);
    setLoading(false);
  };

  useEffect(() => {
    fetchSuppliers();
  }, []);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setNewSupplier(prevState => ({ ...prevState, [name]: value }));
  };

  const handleAddOrUpdate = async (e) => {
    e.preventDefault();
    if (!newSupplier.name.trim()) {
      toast.error("Supplier name is required."); // --- REPLACE ALERT ---
      return;
    }
    try {
      const dataToSave = {
        ...newSupplier,
        estimatedEtaDays: parseInt(newSupplier.estimatedEtaDays, 10) || 0,
        minOrderAmount: parseFloat(newSupplier.minOrderAmount) || 0,
      };

      if (editingSupplierId) {
        await updateSupplier(editingSupplierId, dataToSave); 
        toast.success("Supplier updated successfully!"); // --- REPLACE ALERT ---
      } else {
        await addSupplier(dataToSave);
        toast.success("Supplier added successfully!"); // --- REPLACE ALERT ---
      }
      setNewSupplier({ name: '', email: '', estimatedEtaDays: '', minOrderAmount: '' });
      setEditingSupplierId(null);
      fetchSuppliers();
    } catch (error) {
      console.error("Error saving supplier:", error);
      toast.error(`Failed to ${editingSupplierId ? 'update' : 'add'} supplier.`); // --- REPLACE ALERT ---
    }
  };

  const handleEdit = (supplier) => {
    setNewSupplier({
        name: supplier.name,
        email: supplier.email || '',
        estimatedEtaDays: supplier.estimatedEtaDays || '',
        minOrderAmount: supplier.minOrderAmount || ''
    });
    setEditingSupplierId(supplier.id);
  };

  const handleCancelEdit = () => {
    setNewSupplier({ name: '', email: '', estimatedEtaDays: '', minOrderAmount: '' });
    setEditingSupplierId(null);
  };

  const handleDelete = (id) => {
    // --- REPLACE window.confirm ---
    toast((t) => (
        <span>
            Are you sure you want to delete this supplier?
            <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                deleteSupplier(id)
                    .then(() => {
                        toast.success("Supplier deleted.");
                        fetchSuppliers();
                    })
                    .catch(err => {
                        toast.error("Failed to delete supplier.");
                        console.error(err);
                    });
                toast.dismiss(t.id);
            }}>
                Delete
            </Button>
            <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                Cancel
            </Button>
        </span>
    ), { icon: 'âš ï¸' });
  };

  return (
    <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
      <h3 className="text-xl font-bold text-white mb-4">Manage Suppliers</h3>
      <form onSubmit={handleAddOrUpdate} className="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mb-6">
        <Input label="Supplier Name" name="name" value={newSupplier.name} onChange={handleInputChange} placeholder={editingSupplierId ? "Edit supplier name..." : "e.g., Bolt & Nut Centre"} />
        <Input label="Email Address" name="email" type="email" value={newSupplier.email} onChange={handleInputChange} placeholder={editingSupplierId ? "Edit email..." : "e.g., sales@bolts.co.za"} />
        <Input label="ETA (in days)" name="estimatedEtaDays" type="number" value={newSupplier.estimatedEtaDays} onChange={handleInputChange} placeholder={editingSupplierId ? "Edit ETA..." : "e.g., 3"} />
        <Input label="Min. Order (R)" name="minOrderAmount" type="number" value={newSupplier.minOrderAmount} onChange={handleInputChange} placeholder={editingSupplierId ? "Edit min order..." : "e.g., 500"} />
        <div className="flex gap-2">
            {editingSupplierId && (
                <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>
            )}
            <Button type="submit" variant="primary" className="flex-grow">
                {editingSupplierId ? "Update" : "Add"}
            </Button>
        </div>
      </form>

      <div className="hidden md:grid grid-cols-5 gap-4 px-3 py-2 text-sm font-semibold text-gray-400 border-b border-gray-700">
        <div className="col-span-2">Supplier Name</div>
        <div>Email</div>
        <div>Lead Time</div>
        <div className="text-right">Min. Order</div>
      </div>
      <div className="space-y-3 mt-2">
        {loading ? <p>Loading...</p> : (suppliers || []).map(sup => (
          <div key={sup.id} className="grid grid-cols-1 md:grid-cols-5 gap-4 items-center bg-gray-700 p-3 rounded-lg">
            <p className="text-gray-200 font-semibold col-span-2">{sup.name}</p>
            <p className="text-gray-400">{sup.email}</p>
            <p className="text-gray-400">{sup.estimatedEtaDays} days</p>
            <p className="text-gray-400 text-right">R {(sup.minOrderAmount || 0).toFixed(2)}</p>
            <div className="md:col-start-6 text-right flex space-x-2 justify-end">
                <Button onClick={() => handleEdit(sup)} variant="secondary" className="py-1 px-3 text-xs">Edit</Button>
                <Button onClick={() => handleDelete(sup.id)} variant="danger" className="py-1 px-3 text-xs">Delete</Button>
            </div>
          </div>
        ))}
         {(suppliers.length === 0 && !loading && <p className="text-center p-4 text-gray-500">No suppliers added yet.</p>)}
      </div>
    </div>
  );
};

export default SuppliersManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\ToolAccessoriesManager.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { getTools, getToolAccessories, addToolAccessory, deleteToolAccessory, updateDocument } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const ToolAccessoriesManager = () => {
    const [tools, setTools] = useState([]);
    const [accessories, setAccessories] = useState([]);
    const [newAccessoryName, setNewAccessoryName] = useState('');
    const [selectedToolId, setSelectedToolId] = useState('');
    const [loading, setLoading] = useState(true);
    const [editingAccessoryId, setEditingAccessoryId] = useState(null);

    const fetchData = async () => {
        setLoading(true);
        const [fetchedTools, fetchedAccessories] = await Promise.all([getTools(), getToolAccessories()]);
        setTools(fetchedTools);
        setAccessories(fetchedAccessories);
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleAddOrUpdate = async (e) => {
        e.preventDefault();
        if (!newAccessoryName.trim() || !selectedToolId) {
            toast.error("Please select a parent tool and enter an accessory name."); // --- REPLACE ALERT ---
            return;
        }
        try {
            const dataToSave = { name: newAccessoryName, toolId: selectedToolId };

            if (editingAccessoryId) {
                await updateDocument('toolAccessories', editingAccessoryId, dataToSave);
                toast.success("Accessory updated successfully!"); // --- REPLACE ALERT ---
            } else {
                await addToolAccessory(dataToSave);
                toast.success("Accessory added successfully!"); // --- REPLACE ALERT ---
            }
            setNewAccessoryName('');
            setSelectedToolId('');
            setEditingAccessoryId(null);
            fetchData();
        } catch (error) {
            console.error("Error saving accessory:", error);
            toast.error(`Failed to ${editingAccessoryId ? 'update' : 'add'} accessory.`); // --- REPLACE ALERT ---
        }
    };

    const handleEdit = (accessory) => {
        setNewAccessoryName(accessory.name);
        setSelectedToolId(accessory.toolId);
        setEditingAccessoryId(accessory.id);
    };

    const handleCancelEdit = () => {
        setNewAccessoryName('');
        setSelectedToolId('');
        setEditingAccessoryId(null);
    };

    const handleDelete = (id) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Are you sure you want to delete this accessory?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteToolAccessory(id)
                        .then(() => {
                            toast.success("Accessory deleted.");
                            fetchData();
                        })
                        .catch(err => {
                            toast.error("Failed to delete accessory.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };
    
    const groupedAccessories = useMemo(() => {
        const groups = {};
        accessories.forEach(acc => {
            if (!groups[acc.toolId]) {
                const tool = tools.find(t => t.id === acc.toolId);
                groups[acc.toolId] = { toolName: tool ? tool.name : 'Unknown Tool', items: [] };
            }
            groups[acc.toolId].items.push(acc);
        });
        return Object.values(groups);
    }, [accessories, tools]);

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Tool Accessories</h3>
            <form onSubmit={handleAddOrUpdate} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                <Dropdown
                    label="Parent Tool"
                    name="toolId"
                    value={selectedToolId}
                    onChange={(e) => setSelectedToolId(e.target.value)}
                    options={tools}
                    placeholder="Select a tool..."
                />
                <Input
                    label="Accessory Name"
                    name="accessoryName"
                    value={newAccessoryName}
                    onChange={(e) => setNewAccessoryName(e.target.value)}
                    placeholder={editingAccessoryId ? "Edit accessory name..." : "New accessory name..."}
                />
                <div className="flex gap-2">
                    {editingAccessoryId && (
                        <Button type="button" variant="secondary" onClick={handleCancelEdit}>
                            Cancel
                        </Button>
                    )}
                    <Button type="submit" variant="primary" className="flex-grow">
                        {editingAccessoryId ? "Update" : "Add"}
                    </Button>
                </div>
            </form>
            <div className="space-y-4 mt-6">
                {loading ? (
                    <p>Loading...</p>
                ) : (groupedAccessories.map(group => (
                    <div key={group.toolName}>
                        <h4 className="font-semibold text-blue-400 border-b border-gray-700 pb-1 mb-2">{group.toolName} Accessories</h4>
                        <ul className="space-y-2">
                            {group.items.map(item => (
                                <li key={item.id} className="flex items-center justify-between bg-gray-700 p-3 rounded-lg text-sm">
                                    <p className="text-gray-200">{item.name}</p>
                                    <div className="flex space-x-2">
                                        <Button onClick={() => handleEdit(item)} variant="secondary" className="py-0.5 px-2 text-xs">
                                            Edit
                                        </Button>
                                        <Button onClick={() => handleDelete(item.id)} variant="danger" className="py-0.5 px-2 text-xs">
                                            Delete
                                        </Button>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    </div>
                )))}
            </div>
        </div>
    );
};

export default ToolAccessoriesManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\ToolsManager.jsx
==================================================
// src/components/features/settings/ToolsManager.jsx

import React, { useState, useEffect } from 'react';
import { getTools, addTool, deleteTool, updateDocument, getSkills } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { Wrench, PlusCircle, Save, DollarSign, Clock } from 'lucide-react'; // --- CORRECTED: Removed 'Tool' icon ---
import toast from 'react-hot-toast';

const ToolsManager = () => {
    const [tools, setTools] = useState([]);
    const [allSkills, setAllSkills] = useState([]);
    const [loading, setLoading] = useState(true);
    
    const initialFormState = {
        name: '',
        hourlyRate: '', 
        capacityMinutesPerDay: '',
        maintenanceIntervalHours: '',
        associatedSkills: [],
    };
    const [formData, setFormData] = useState(initialFormState);
    const [editingToolId, setEditingToolId] = useState(null);

    const getProficiencyLabel = (level) => {
        switch (level) {
            case 0: return 'Not Applicable / No Minimum';
            case 1: return 'Beginner (1)';
            case 2: return 'Basic (2)';
            case 3: return 'Intermediate (3)';
            case 4: return 'Advanced (4)';
            case 5: return 'Expert (5)';
            default: return 'N/A';
        }
    };
    
    const fetchData = async () => {
        setLoading(true);
        try {
            const [fetchedTools, fetchedSkills] = await Promise.all([getTools(), getSkills()]);
            setTools(fetchedTools);
            setAllSkills(fetchedSkills);
        } catch (error) {
            console.error("Error fetching data for Tools Manager:", error);
            toast.error("Failed to load tools or skills.");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleToggleSkillAssociation = (skillId, isChecked) => {
        setFormData(prev => {
            const existingSkills = prev.associatedSkills || [];
            if (isChecked) {
                return { ...prev, associatedSkills: [...existingSkills, { skillId, defaultMinimumProficiency: 0, importanceWeight: 0 }] };
            } else {
                return { ...prev, associatedSkills: existingSkills.filter(s => s.skillId !== skillId) };
            }
        });
    };

    const handleAssociatedSkillChange = (skillId, field, value) => {
        setFormData(prev => ({
            ...prev,
            associatedSkills: prev.associatedSkills.map(skill =>
                skill.skillId === skillId ? { ...skill, [field]: Number(value) } : skill
            )
        }));
    };

    const resetForm = () => {
        setFormData(initialFormState);
        setEditingToolId(null);
    };

    const handleAddOrUpdate = async (e) => {
        e.preventDefault();
        if (!formData.name.trim()) {
            toast.error("Tool name is required.");
            return;
        }
        try {
            const filteredAssociatedSkills = (formData.associatedSkills || []).filter(s =>
                s.defaultMinimumProficiency > 0 || s.importanceWeight > 0
            );
            const toolDataToSave = {
                name: formData.name.trim(),
                hourlyRate: Number(formData.hourlyRate) || 0,
                capacityMinutesPerDay: Number(formData.capacityMinutesPerDay) || 0,
                maintenanceIntervalHours: Number(formData.maintenanceIntervalHours) || 0,
                associatedSkills: filteredAssociatedSkills,
            };
            
            if (editingToolId) {
                await updateDocument('tools', editingToolId, toolDataToSave);
                toast.success("Tool updated successfully!");
            } else {
                await addTool(toolDataToSave);
                toast.success("Tool added successfully!");
            }
            resetForm();
            fetchData();
        } catch (error) {
            console.error("Error saving tool:", error);
            toast.error(`Failed to ${editingToolId ? 'update' : 'add'} tool.`);
        }
    };

    const handleEdit = (tool) => {
        setEditingToolId(tool.id);
        setFormData({
            name: tool.name,
            hourlyRate: tool.hourlyRate || '',
            capacityMinutesPerDay: tool.capacityMinutesPerDay || '',
            maintenanceIntervalHours: tool.maintenanceIntervalHours || '',
            associatedSkills: tool.associatedSkills || [],
        });
    };
    
    const handleDelete = (id) => {
        toast((t) => (
            <span>
                Are you sure you want to delete this tool?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteTool(id)
                        .then(() => {
                            toast.success("Tool deleted.");
                            fetchData();
                        })
                        .catch(err => {
                            toast.error("Failed to delete tool.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Tools, Machine Rates & Capacity</h3>
            <form onSubmit={handleAddOrUpdate} className="space-y-4 mb-6 p-4 bg-gray-900/50 rounded-lg">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="md:col-span-2">
                        <Input
                            label="Tool Name"
                            name="name"
                            value={formData.name}
                            onChange={handleInputChange}
                            placeholder={editingToolId ? "Edit tool name..." : "New tool name..."}
                        />
                    </div>
                    <div>
                        <Input
                            label="Hourly Rate (R)"
                            name="hourlyRate"
                            type="number"
                            value={formData.hourlyRate}
                            onChange={handleInputChange}
                            placeholder="e.g., 25.50"
                        />
                    </div>
                    <div>
                        <Input
                            label="Capacity (minutes/day)"
                            name="capacityMinutesPerDay"
                            type="number"
                            value={formData.capacityMinutesPerDay}
                            onChange={handleInputChange}
                            placeholder="e.g., 450 for 8hr day"
                        />
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="md:col-span-2">
                        <Input
                            label="Maintenance Interval (hours)"
                            name="maintenanceIntervalHours"
                            type="number"
                            value={formData.maintenanceIntervalHours}
                            onChange={handleInputChange}
                            placeholder="e.g., 200"
                        />
                    </div>
                </div>


                {formData.name.trim() && (
                    <div className="border-t border-gray-700 pt-4 mt-4">
                         <h4 className="text-lg font-semibold text-white mb-3">Associated Skills for "{formData.name}"</h4>
                         <div className="space-y-4 max-h-60 overflow-y-auto pr-2">
                            {allSkills.map(skill => {
                                const currentAssociatedSkill = formData.associatedSkills?.find(s => s.skillId === skill.id);
                                const isIncluded = !!currentAssociatedSkill;

                                return (
                                    <div key={skill.id} className="bg-gray-800 p-3 rounded-lg border border-gray-700">
                                        <div className="flex items-center gap-3 mb-2">
                                            <input
                                                type="checkbox"
                                                checked={isIncluded}
                                                onChange={(e) => handleToggleSkillAssociation(skill.id, e.target.checked)}
                                                className="h-4 w-4 rounded bg-gray-700 text-blue-600 focus:ring-blue-500"
                                            />
                                            <label className="font-bold text-white flex-grow">{skill.name}</label>
                                        </div>

                                        {isIncluded && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-400 mb-1">Default Min. Proficiency (0-5)</label>
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="5"
                                                        step="1"
                                                        value={currentAssociatedSkill.defaultMinimumProficiency || 0}
                                                        onChange={(e) => handleAssociatedSkillChange(skill.id, 'defaultMinimumProficiency', e.target.value)}
                                                        className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg accent-blue-600"
                                                    />
                                                    <p className="text-center text-sm text-gray-400 mt-1">
                                                        {getProficiencyLabel(currentAssociatedSkill.defaultMinimumProficiency || 0)}
                                                    </p>
                                                </div>
                                                <div>
                                                    <Input
                                                        label="Importance Weight (0-10)"
                                                        type="number"
                                                        min="0"
                                                        max="10"
                                                        value={currentAssociatedSkill.importanceWeight || 0}
                                                        onChange={(e) => handleAssociatedSkillChange(skill.id, 'importanceWeight', e.target.value)}
                                                        placeholder="e.g., 5"
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
                
                <div className="flex justify-end gap-2 pt-4 border-t border-gray-700">
                    {editingToolId && <Button type="button" variant="secondary" onClick={resetForm}>Cancel</Button>}
                    <Button type="submit" variant="primary">
                        {editingToolId ? <><Save size={16} className="mr-2"/> Update Tool</> : <><PlusCircle size={16} className="mr-2"/> Add Tool</>}
                    </Button>
                </div>
            </form>

            <div className="space-y-3">
                {loading ? <p>Loading tools...</p> : (tools || []).map(tool => (
                    <div key={tool.id} className="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                        <p className="text-gray-200 flex items-center gap-3">
                            <Wrench size={18} className="text-gray-400"/> 
                            {tool.name}
                        </p>
                        <div className="flex items-center gap-4">
                             {tool.capacityMinutesPerDay > 0 && (
                                <span className="text-xs flex items-center gap-1 bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded-full" title="Daily Capacity">
                                    <Clock size={12}/>
                                    {`${tool.capacityMinutesPerDay} min/day`}
                                </span>
                            )}
                            {tool.hourlyRate > 0 && (
                                <span className="text-xs flex items-center gap-1 bg-yellow-500/20 text-yellow-300 px-2 py-0.5 rounded-full" title="Operating Cost">
                                    <DollarSign size={12}/>
                                    {`R${tool.hourlyRate.toFixed(2)}/hr`}
                                </span>
                            )}
                            {tool.maintenanceIntervalHours > 0 && (
                                <span className="text-xs flex items-center gap-1 bg-teal-500/20 text-teal-300 px-2 py-0.5 rounded-full" title="Maintenance Interval">
                                    {/* --- CORRECTED: Use Wrench icon --- */}
                                    <Wrench size={12}/>
                                    {`${tool.maintenanceIntervalHours} hrs`}
                                </span>
                            )}
                            <div className="flex space-x-2">
                                <Button onClick={() => handleEdit(tool)} variant="secondary" className="py-1 px-3 text-xs">Manage</Button>
                                <Button onClick={() => handleDelete(tool.id)} variant="danger" className="py-1 px-3 text-xs">Delete</Button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default ToolsManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\settings\TrainingManager.jsx
==================================================
// src/components/features/settings/TrainingManager.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import {
    getSkills,
    getTrainingResources,
    addTrainingResource,
    updateTrainingResource,
    deleteTrainingResource
} from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import { PlusCircle, Trash2, Edit } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const TrainingManager = () => {
    const [resources, setResources] = useState([]);
    const [skills, setSkills] = useState([]);
    const [loading, setLoading] = useState(true);
    const [editingId, setEditingId] = useState(null);
    const [formData, setFormData] = useState({
        skillId: '',
        resourceName: '',
        type: 'Video',
        url: ''
    });

    const resourceTypes = [
        { id: 'Video', name: 'Video' },
        { id: 'Document', name: 'Document' },
        { id: 'External Link', name: 'External Link' }
    ];

    const fetchData = async () => {
        setLoading(true);
        try {
            const [fetchedResources, fetchedSkills] = await Promise.all([
                getTrainingResources(),
                getSkills()
            ]);
            setResources(fetchedResources);
            setSkills(fetchedSkills);
        } catch (error) {
            console.error("Error fetching training data:", error);
            toast.error("Could not load training data."); // --- REPLACE ALERT ---
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleCancelEdit = () => {
        setEditingId(null);
        setFormData({ skillId: '', resourceName: '', type: 'Video', url: '' });
    };

    const handleEditClick = (resource) => {
        setEditingId(resource.id);
        setFormData({
            skillId: resource.skillId,
            resourceName: resource.resourceName,
            type: resource.type,
            url: resource.url
        });
    };

    const handleDelete = (resourceId) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Are you sure you want to delete this resource?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    deleteTrainingResource(resourceId)
                        .then(() => {
                            toast.success("Resource deleted.");
                            fetchData();
                        })
                        .catch(err => {
                            toast.error("Failed to delete resource.");
                            console.error(err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.skillId || !formData.resourceName.trim() || !formData.url.trim()) {
            return toast.error("Please select a skill and fill in the resource name and URL."); // --- REPLACE ALERT ---
        }

        try {
            if (editingId) {
                await updateTrainingResource(editingId, formData);
                toast.success("Resource updated successfully!"); // --- REPLACE ALERT ---
            } else {
                await addTrainingResource(formData);
                toast.success("Resource added successfully!"); // --- REPLACE ALERT ---
            }
            handleCancelEdit();
            fetchData();
        } catch (error) {
            console.error("Error saving resource:", error);
            toast.error("Failed to save training resource."); // --- REPLACE ALERT ---
        }
    };

    const getSkillName = (skillId) => {
        return skills.find(s => s.id === skillId)?.name || 'Unknown Skill';
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Manage Training Resources</h3>
            
            <form onSubmit={handleSubmit} className="p-4 mb-6 bg-gray-900/50 rounded-lg space-y-4">
                <h4 className="text-lg font-semibold text-white">{editingId ? 'Edit Resource' : 'Add New Resource'}</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <Dropdown label="Associated Skill" name="skillId" value={formData.skillId} onChange={handleInputChange} options={skills} placeholder="Select skill..." required/>
                    <Input label="Resource Name" name="resourceName" value={formData.resourceName} onChange={handleInputChange} placeholder="e.g., Advanced TIG Welding" required/>
                    <Input label="URL" name="url" value={formData.url} onChange={handleInputChange} placeholder="https://..." required/>
                    <Dropdown label="Type" name="type" value={formData.type} onChange={handleInputChange} options={resourceTypes} />
                </div>
                <div className="flex justify-end gap-2">
                    {editingId && <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>}
                    <Button type="submit" variant="primary">
                        {editingId ? <><Edit size={16} className="mr-2"/>Save Changes</> : <><PlusCircle size={16} className="mr-2"/>Add Resource</>}
                    </Button>
                </div>
            </form>

            <div className="space-y-3">
                {loading ? <p className="text-gray-400">Loading...</p> :
                    resources.map(resource => (
                        <div key={resource.id} className="bg-gray-700 p-4 rounded-lg flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <p className="font-bold text-white">{resource.resourceName}</p>
                                <p className="text-sm text-purple-400 font-semibold">{getSkillName(resource.skillId)}</p>
                                <a href={resource.url} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-400 hover:underline break-all">{resource.url}</a>
                            </div>
                            <div className="flex gap-2">
                                <Button onClick={() => handleEditClick(resource)} variant="secondary" size="sm" className="p-2"><Edit size={16}/></Button>
                                <Button onClick={() => handleDelete(resource.id)} variant="danger" size="sm" className="p-2"><Trash2 size={16}/></Button>
                            </div>
                        </div>
                    ))
                }
            </div>
        </div>
    );
};

export default TrainingManager;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\sidebar\CalculatorApplet.jsx
==================================================
import React, { useState } from 'react';

// Reusable button component for our calculator
const CalcButton = ({ onClick, children, className = '' }) => (
  <button 
    onClick={() => onClick(children)}
    className={`bg-gray-600 hover:bg-gray-500 text-white font-bold py-4 rounded-lg text-xl transition-colors ${className}`}
  >
    {children}
  </button>
);

const CalculatorApplet = () => {
  const [display, setDisplay] = useState('0');
  const [firstOperand, setFirstOperand] = useState(null);
  const [operator, setOperator] = useState(null);
  const [waitingForSecondOperand, setWaitingForSecondOperand] = useState(false);

  const handleDigitClick = (digit) => {
    if (waitingForSecondOperand) {
      setDisplay(String(digit));
      setWaitingForSecondOperand(false);
    } else {
      setDisplay(display === '0' ? String(digit) : display + digit);
    }
  };

  const handleDecimalClick = () => {
    if (!display.includes('.')) {
      setDisplay(display + '.');
    }
  };

  const handleOperatorClick = (nextOperator) => {
    const inputValue = parseFloat(display);

    if (operator && !waitingForSecondOperand) {
      const result = calculate(firstOperand, inputValue, operator);
      setDisplay(String(result));
      setFirstOperand(result);
    } else {
      setFirstOperand(inputValue);
    }

    setWaitingForSecondOperand(true);
    setOperator(nextOperator);
  };

  const calculate = (op1, op2, op) => {
    switch (op) {
      case '+': return op1 + op2;
      case '-': return op1 - op2;
      case 'Ã—': return op1 * op2;
      case 'Ã·': return op1 / op2;
      default: return op2;
    }
  };

  const handleEqualsClick = () => {
    const inputValue = parseFloat(display);
    if (operator && !waitingForSecondOperand) {
      const result = calculate(firstOperand, inputValue, operator);
      setDisplay(String(result));
      setFirstOperand(null);
      setOperator(null);
    }
  };

  const handleClearClick = () => {
    setDisplay('0');
    setFirstOperand(null);
    setOperator(null);
    setWaitingForSecondOperand(false);
  };

  return (
    <div className="p-2">
      {/* Display Screen */}
      <div className="bg-gray-900 text-white text-4xl text-right font-mono p-4 rounded-lg mb-2 overflow-x-auto">
        {display}
      </div>
      {/* Calculator Buttons */}
      <div className="grid grid-cols-4 gap-2">
        <CalcButton onClick={handleClearClick} className="col-span-2 bg-red-600 hover:bg-red-500">C</CalcButton>
        <CalcButton onClick={handleOperatorClick}>Ã·</CalcButton>
        <CalcButton onClick={handleOperatorClick}>Ã—</CalcButton>
        <CalcButton onClick={handleDigitClick}>7</CalcButton>
        <CalcButton onClick={handleDigitClick}>8</CalcButton>
        <CalcButton onClick={handleDigitClick}>9</CalcButton>
        <CalcButton onClick={handleOperatorClick}>-</CalcButton>
        <CalcButton onClick={handleDigitClick}>4</CalcButton>
        <CalcButton onClick={handleDigitClick}>5</CalcButton>
        <CalcButton onClick={handleDigitClick}>6</CalcButton>
        <CalcButton onClick={handleOperatorClick}>+</CalcButton>
        <CalcButton onClick={handleDigitClick}>1</CalcButton>
        <CalcButton onClick={handleDigitClick}>2</CalcButton>
        <CalcButton onClick={handleDigitClick}>3</CalcButton>
        <CalcButton onClick={handleEqualsClick} className="row-span-2 bg-blue-600 hover:bg-blue-500">=</CalcButton>
        <CalcButton onClick={handleDigitClick} className="col-span-2">0</CalcButton>
        <CalcButton onClick={handleDecimalClick}>.</CalcButton>
      </div>
    </div>
  );
};

export default CalculatorApplet;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\sidebar\CalendarApplet.jsx
==================================================
import React, { useState } from 'react';
import Calendar from 'react-calendar';
import 'react-calendar/dist/Calendar.css';

const CalendarApplet = () => {
  const [date, setDate] = useState(new Date());

  return (
    <div className="p-2 text-white">
        {/* This style block helps the calendar theme match our dark mode app */}
        <style>{`
            .react-calendar { background: transparent; border: none; }
            .react-calendar__tile:enabled:hover, .react-calendar__tile:enabled:focus { background-color: #374151; }
            .react-calendar__tile--now { background-color: #3b82f6 !important; color: white !important; }
            .react-calendar__tile--active { background-color: #1d4ed8 !important; color: white !important; }
            .react-calendar__month-view__days__day--neighboringMonth { color: #6b7280 !important; }
        `}</style>
        <Calendar 
            onChange={setDate} 
            value={date} 
            className="bg-transparent border-none"
        />
    </div>
  );
};

export default CalendarApplet;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\sidebar\NotesApplet.jsx
==================================================
import React, { useState, useEffect } from 'react';

const NotesApplet = () => {
  // Load saved notes from localStorage or default to empty
  const [notes, setNotes] = useState(() => {
    const savedNotes = localStorage.getItem('tojemos-sidebar-notes');
    return savedNotes || '';
  });

  // This useEffect hook saves the notes to localStorage whenever they change
  useEffect(() => {
    localStorage.setItem('tojemos-sidebar-notes', notes);
  }, [notes]);

  return (
    <div className="p-2">
      <h4 className="font-bold text-gray-300 text-sm mb-2">Scratchpad</h4>
      <textarea
        value={notes}
        onChange={(e) => setNotes(e.target.value)}
        placeholder="Type your notes here..."
        className="w-full h-48 p-2 bg-gray-900 border border-gray-600 rounded-md text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
      />
    </div>
  );
};

export default NotesApplet;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\sidebar\WeatherApplet.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { Sun, Cloud, CloudRain, Wind, Thermometer, ArrowDown, ArrowUp } from 'lucide-react';
import Button from '../../ui/Button';

// A small component to display a single weather detail
const WeatherDetail = ({ icon, value, unit }) => (
    <div className="flex items-center text-sm text-gray-300">
        {icon}
        <span className="ml-2">{value}{unit}</span>
    </div>
);

const WeatherApplet = () => {
    const [weather, setWeather] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchWeather = async () => {
            // API URL for Cape Town's coordinates with the specific data we want
            const apiUrl = "https://api.open-meteo.com/v1/forecast?latitude=-33.92&longitude=18.42&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max&timezone=auto";
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                // We only need today's data, which is the first item in the arrays
                setWeather({
                    maxTemp: Math.round(data.daily.temperature_2m_max[0]),
                    minTemp: Math.round(data.daily.temperature_2m_min[0]),
                    rainProb: data.daily.precipitation_probability_max[0],
                    windSpeed: Math.round(data.daily.windspeed_10m_max[0]),
                });
            } catch (error) {
                console.error("Failed to fetch weather data:", error);
            } finally {
                setLoading(false);
            }
        };

        fetchWeather();
    }, []);

    if (loading) {
        return <div className="p-2 text-sm text-gray-400">Loading Weather...</div>;
    }

    if (!weather) {
        return <div className="p-2 text-sm text-red-400">Could not load weather.</div>;
    }

    return (
        <div className="p-2 space-y-3">
            <div className="flex items-center justify-between">
                <div className="flex items-center">
                    <CloudRain size={32} className="text-blue-400" />
                    <div className="ml-3">
                        <p className="font-bold text-white">Cape Town</p>
                        <p className="text-xs text-gray-400">Today's Forecast</p>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
                <WeatherDetail icon={<ArrowUp size={16} className="text-red-400"/>} value={weather.maxTemp} unit="Â°C" />
                <WeatherDetail icon={<ArrowDown size={16} className="text-blue-400"/>} value={weather.minTemp} unit="Â°C" />
                <WeatherDetail icon={<CloudRain size={16} className="text-sky-300"/>} value={weather.rainProb} unit="%" />
                <WeatherDetail icon={<Wind size={16} className="text-gray-300"/>} value={weather.windSpeed} unit=" km/h" />
            </div>

            <a href="https://www.google.com/search?q=weather+cape+town" target="_blank" rel="noopener noreferrer">
                 <Button variant="secondary" className="w-full text-xs py-1">
                    View 7-Day Forecast
                 </Button>
            </a>
        </div>
    );
};

export default WeatherApplet;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\stock\ConsignmentStockTake.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { 
    getClientUsers, 
    listenToConsignmentStockForClient, 
    getProducts,
    addConsignmentItem,
    updateConsignmentStockCounts 
} from '../../../api/firestore';
import Button from '../../ui/Button';
import Dropdown from '../../ui/Dropdown';
import Input from '../../ui/Input';
import { User, PackagePlus, Save, ClipboardList, Trash2 } from 'lucide-react';
import toast from 'react-hot-toast';

const ConsignmentStockTake = () => {
    const [clients, setClients] = useState([]);
    const [products, setProducts] = useState([]);
    const [selectedClientId, setSelectedClientId] = useState('');
    const [consignmentStock, setConsignmentStock] = useState([]);
    const [counts, setCounts] = useState({});
    const [loading, setLoading] = useState(true);
    
    // State for adding a new item
    const [newItemProductId, setNewItemProductId] = useState('');
    const [newItemShelf, setNewItemShelf] = useState('');
    const [newItemInitialCount, setNewItemInitialCount] = useState(0);

    useEffect(() => {
        const fetchInitialData = async () => {
            const [clientUsers, allProducts] = await Promise.all([getClientUsers(), getProducts()]);
            // Format clients for the dropdown
            const formattedClients = clientUsers.map(c => ({ id: c.id, name: c.companyName || c.email }));
            setClients(formattedClients);
            setProducts(allProducts);
            setLoading(false);
        };
        fetchInitialData();
    }, []);

    useEffect(() => {
        if (!selectedClientId) {
            setConsignmentStock([]);
            return;
        }
        const unsubscribe = listenToConsignmentStockForClient(selectedClientId, (items) => {
            setConsignmentStock(items);
            // Initialize counts state from fetched data
            const initialCounts = items.reduce((acc, item) => {
                acc[item.id] = item.quantity;
                return acc;
            }, {});
            setCounts(initialCounts);
        });
        return () => unsubscribe();
    }, [selectedClientId]);

    const handleCountChange = (itemId, value) => {
        setCounts(prev => ({ ...prev, [itemId]: value }));
    };

    const handleAddNewItem = async () => {
        if (!newItemProductId || !selectedClientId) {
            return toast.error("Please select a product to add.");
        }

        const product = products.find(p => p.id === newItemProductId);
        if (!product) return toast.error("Selected product not found.");
        
        const client = clients.find(c => c.id === selectedClientId);

        const newItemData = {
            clientId: selectedClientId,
            clientName: client.name,
            productId: product.id,
            productName: product.name,
            partNumber: product.partNumber || 'N/A',
            shelfNumber: newItemShelf || null,
            quantity: Number(newItemInitialCount) || 0,
        };

        try {
            await addConsignmentItem(newItemData);
            toast.success(`${product.name} added to ${client.name}'s consignment stock.`);
            setNewItemProductId('');
            setNewItemShelf('');
            setNewItemInitialCount(0);
        } catch (error) {
            console.error("Error adding consignment item:", error);
            toast.error("Failed to add new item.");
        }
    };
    
    const handleReconcile = async () => {
        const updates = Object.entries(counts).map(([id, newCount]) => ({
            id,
            newCount: Number(newCount) || 0,
        }));

        if (updates.length === 0) return toast.error("No counts have been changed.");
        
        try {
            await updateConsignmentStockCounts(updates);
            toast.success("Consignment stock counts have been updated successfully!");
        } catch (error) {
            console.error("Error reconciling stock:", error);
            toast.error("Failed to update stock levels.");
        }
    };

    // Filter products that are not already in this client's consignment stock
    const availableProducts = useMemo(() => {
        const consignedProductIds = new Set(consignmentStock.map(item => item.productId));
        return products.filter(p => !consignedProductIds.has(p.id));
    }, [products, consignmentStock]);


    if (loading) return <p className="text-gray-400">Loading clients...</p>;

    return (
        <div className="space-y-6">
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-lg">
                <Dropdown
                    label="Select a Client to Perform Stock Take"
                    value={selectedClientId}
                    onChange={(e) => setSelectedClientId(e.target.value)}
                    options={clients}
                    placeholder="Choose a client..."
                />
            </div>

            {selectedClientId && (
                <>
                    <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                        <h3 className="text-xl font-bold text-white mb-4">Add New Product to Consignment</h3>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div className="md:col-span-2">
                                <Dropdown label="Product" options={availableProducts} value={newItemProductId} onChange={e => setNewItemProductId(e.target.value)} placeholder="Select product to add..." />
                            </div>
                            <Input label="Shelf #" value={newItemShelf} onChange={e => setNewItemShelf(e.target.value)} placeholder="Optional"/>
                            <Input label="Initial Count" type="number" value={newItemInitialCount} onChange={e => setNewItemInitialCount(e.target.value)} />
                        </div>
                         <Button onClick={handleAddNewItem} variant="secondary" className="mt-4"><PackagePlus size={16} className="mr-2"/>Add to List</Button>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                         <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-white">Stock Count List</h3>
                            <Button onClick={handleReconcile} variant="primary"><Save size={16} className="mr-2"/>Save All Counts</Button>
                         </div>
                        <div className="space-y-3">
                            {consignmentStock.map(item => (
                                <div key={item.id} className="grid grid-cols-4 gap-4 items-center bg-gray-900/50 p-3 rounded-lg">
                                    <div>
                                        <p className="font-semibold text-white">{item.productName}</p>
                                        <p className="text-xs text-gray-400">P/N: {item.partNumber}</p>
                                    </div>
                                    <p className="text-sm text-gray-300">Shelf: {item.shelfNumber || 'N/A'}</p>
                                    <p className="text-sm text-center font-mono text-gray-400">System: {item.quantity}</p>
                                    <Input 
                                        type="number" 
                                        value={counts[item.id] || ''}
                                        onChange={(e) => handleCountChange(item.id, e.target.value)}
                                        placeholder="Enter count..."
                                    />
                                </div>
                            ))}
                            {consignmentStock.length === 0 && <p className="text-center text-gray-500 py-4">No consignment stock found for this client.</p>}
                        </div>
                    </div>
                </>
            )}
        </div>
    );
};

export default ConsignmentStockTake;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\stock\FutureDemandAnalyzer.jsx
==================================================
import React, { useState, useMemo } from 'react';
import { listenToJobCards, getAllInventoryItems } from '../../../api/firestore';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import { X, TrendingDown, Check, AlertTriangle } from 'lucide-react';

const FutureDemandAnalyzer = ({ onClose }) => {
    const [daysToAnalyze, setDaysToAnalyze] = useState(30); // Default to 30 days for a better forecast
    const [analysis, setAnalysis] = useState(null);
    const [loading, setLoading] = useState(false);

    const handleAnalyze = async () => {
        setLoading(true);
        setAnalysis(null);

        try {
            // We can still use listenToJobCards, but we only need the data once for this manual analysis.
            const allJobs = await new Promise(resolve => {
                const unsubscribe = listenToJobCards(jobs => {
                    unsubscribe();
                    resolve(jobs);
                });
            });

            const inventoryItems = await getAllInventoryItems();
            const inventoryMap = new Map(inventoryItems.map(item => [item.id, item]));

            const now = new Date();
            const futureDate = new Date();
            futureDate.setDate(now.getDate() + Number(daysToAnalyze));

            // Filter for jobs scheduled within the analysis window
            const scheduledJobs = allJobs.filter(job => {
                const scheduled = job.scheduledDate?.toDate();
                return scheduled && scheduled >= now && scheduled <= futureDate;
            });

            const requiredMaterials = new Map();

            // Aggregate all required materials from the scheduled jobs
            for (const job of scheduledJobs) {
                // Ensure we use processedConsumables which includes calculated quantities
                const consumables = job.processedConsumables || [];
                for (const consumable of consumables) {
                    if (consumable.id) { // Ensure the consumable has a valid ID
                         const requiredQty = requiredMaterials.get(consumable.id) || 0;
                         requiredMaterials.set(consumable.id, requiredQty + consumable.quantity);
                    }
                }
            }

            const analysisResults = [];
            for (const [itemId, futureDemand] of requiredMaterials.entries()) {
                const item = inventoryMap.get(itemId);
                if (item) {
                    const projectedStock = (item.currentStock || 0) - futureDemand;
                    analysisResults.push({
                        ...item,
                        futureDemand,
                        projectedStock,
                    });
                }
            }

            // Sort results to show the most critical items first
            analysisResults.sort((a,b) => a.projectedStock - b.projectedStock);
            setAnalysis(analysisResults);

        } catch (error) {
            console.error("Error analyzing future demand:", error);
            alert("Failed to analyze demand. See console for details.");
        }
        setLoading(false);
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold text-white">Predictive Inventory Analyzer</h2>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>

                <div className="p-4 bg-gray-900/50 border-b border-gray-700 flex items-end gap-4">
                    <div className="w-48">
                        <Input
                            label="Days to Analyze"
                            type="number"
                            value={daysToAnalyze}
                            onChange={e => setDaysToAnalyze(e.target.value)}
                        />
                    </div>
                    <Button onClick={handleAnalyze} disabled={loading}>
                        {loading ? 'Analyzing...' : 'Analyze Future Demand'}
                    </Button>
                </div>

                <div className="p-6 overflow-y-auto">
                    {!analysis && <p className="text-center text-gray-500">Enter the number of days you want to forecast and click "Analyze".</p>}
                    {analysis && (
                        <table className="w-full text-left text-sm">
                            <thead>
                                <tr className="border-b border-gray-600">
                                    <th className="p-2">Item</th>
                                    <th className="p-2 text-center">Current</th>
                                    <th className="p-2 text-center">Required</th>
                                    <th className="p-2 text-center">Projected</th>
                                    <th className="p-2">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {analysis.map(item => {
                                    const isCritical = item.projectedStock < 0;
                                    const isLow = item.projectedStock >= 0 && item.projectedStock < item.reorderLevel;
                                    return (
                                        <tr key={item.id} className="border-b border-gray-700">
                                            <td className="p-2 font-semibold text-white">{item.name}</td>
                                            <td className="p-2 text-gray-300 text-center">{item.currentStock}</td>
                                            <td className="p-2 text-blue-400 text-center">{item.futureDemand.toFixed(2)}</td>
                                            <td className={`p-2 font-bold text-center ${isCritical ? 'text-red-500' : isLow ? 'text-yellow-400' : 'text-white'}`}>
                                                {item.projectedStock.toFixed(2)}
                                            </td>
                                            <td className="p-2">
                                                {isCritical && <span className="flex items-center gap-1 text-red-500"><TrendingDown size={14}/> Critical</span>}
                                                {isLow && <span className="flex items-center gap-1 text-yellow-400"><AlertTriangle size={14}/> Low</span>}
                                                {!isCritical && !isLow && <span className="flex items-center gap-1 text-green-400"><Check size={14}/> OK</span>}
                                            </td>
                                        </tr>
                                    );
                                })}
                                {analysis.length === 0 && <p className="text-center text-gray-400 py-6">No material demand found for the scheduled jobs in this period.</p>}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
        </div>
    );
};

export default FutureDemandAnalyzer;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\stock\InTransitOrders.jsx
==================================================
// src/components/features/stock/InTransitOrders.jsx

import React, { useState } from 'react';
import { receiveStockAndUpdateInventory, requeueOrDeleteItem } from '../../../api/firestore';
import Button from '../../ui/Button';
import ConfirmationModal from '../../ui/ConfirmationModal';
import toast from 'react-hot-toast';

const InTransitOrders = ({ items, suppliers, onStockReceived }) => {
  const [receivedQuantities, setReceivedQuantities] = useState({});
  const [confirmation, setConfirmation] = useState({ isOpen: false });

  const getSupplierName = (supplierId) => (suppliers || []).find(s => s.id === supplierId)?.name || 'N/A';
  
  const handleQuantityChange = (itemId, qty) => {
    setReceivedQuantities(prev => ({ ...prev, [itemId]: qty }));
  };

  const confirmReceiveStock = (item) => {
    const qtyReceived = receivedQuantities[item.id] || item.orderedQty;
    if (!qtyReceived || qtyReceived <= 0) {
      return toast.error("Please enter a valid quantity received.");
    }
    setConfirmation({
        isOpen: true,
        title: "Confirm Stock Receipt",
        message: `Are you sure you want to add ${qtyReceived} of ${item.itemName} to your stock?`,
        onConfirm: () => handleReceiveStock(item, qtyReceived),
        confirmText: "Yes, Receive Stock",
        confirmVariant: "primary"
    });
  };

  const handleReceiveStock = async (item, qtyReceived) => {
    try {
      await receiveStockAndUpdateInventory(item, qtyReceived);
      toast.success("Stock updated successfully!");
      if (onStockReceived) onStockReceived();
    } catch (error) {
      console.error("Error receiving stock: ", error);
      toast.error("Failed to update stock.");
    } finally {
        setConfirmation({ isOpen: false });
    }
  };

  const confirmCancelOrder = (item) => {
    setConfirmation({
        isOpen: true,
        title: "Cancel In-Transit Order",
        message: `Are you sure you want to cancel this order for "${item.itemName}"? This may add it back to the purchase queue if stock is still low.`,
        onConfirm: () => handleCancelOrder(item),
        confirmText: "Yes, Cancel Order",
        confirmVariant: "danger"
    });
  };
  
  const handleCancelOrder = async (item) => {
    try {
        await requeueOrDeleteItem(item);
        toast.success("Order cancelled successfully.");
        if (onStockReceived) onStockReceived();
    } catch (error) {
        console.error("Error cancelling order:", error);
        toast.error("Failed to cancel order.");
    } finally {
        setConfirmation({ isOpen: false });
    }
  };
  
  const calculateEta = (etaTimestamp) => {
    if (!etaTimestamp?.seconds) return { text: 'N/A', color: 'text-gray-400' };
    const etaDate = new Date(etaTimestamp.seconds * 1000);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const diffTime = etaDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays < 0) return { text: `Overdue by ${Math.abs(diffDays)} day(s)`, color: 'text-red-500 font-bold' };
    if (diffDays === 0) return { text: 'Arriving Today', color: 'text-yellow-400 font-bold' };
    if (diffDays === 1) return { text: 'Arriving Tomorrow', color: 'text-blue-400' };
    return { text: `Arriving in ${diffDays} days`, color: 'text-gray-300' };
  };

  return (
    <>
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">In-Transit Orders</h3>
            <div className="overflow-x-auto">
                <table className="w-full text-left">
                  <thead>
                    <tr className="border-b border-gray-600">
                      <th className="p-2 text-sm font-semibold text-gray-400">Item</th>
                      <th className="p-2 text-sm font-semibold text-gray-400">Supplier</th>
                      <th className="p-2 text-sm font-semibold text-gray-400 text-center">Qty Ordered</th>
                      <th className="p-2 text-sm font-semibold text-gray-400">ETA</th>
                      <th className="p-2 text-sm font-semibold text-gray-400 w-32">Qty Received</th>
                      <th className="p-2 text-sm font-semibold text-gray-400">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(items || []).map(item => {
                        const eta = calculateEta(item.expectedArrivalDate);
                        return(
                            <tr key={item.id} className="border-b border-gray-700">
                              <td className="p-2 text-gray-200">{item.itemName}</td>
                              <td className="p-2 text-gray-400">{getSupplierName(item.orderedFromSupplierId)}</td>
                              <td className="p-2 text-gray-300 font-bold text-center">{item.orderedQty}</td>
                              <td className={`p-2 text-sm ${eta.color}`}>{eta.text}</td>
                              <td className="p-2">
                                <input 
                                    type="number" 
                                    value={receivedQuantities[item.id] === undefined ? item.orderedQty : receivedQuantities[item.id]}
                                    onChange={(e) => handleQuantityChange(item.id, e.target.value)}
                                    className="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                              </td>
                              <td className="p-2 flex gap-2">
                                <Button variant="success" className="text-xs py-1 px-2" onClick={() => confirmReceiveStock(item)}>Receive</Button>
                                <Button variant="danger" className="text-xs py-1 px-2" onClick={() => confirmCancelOrder(item)}>Cancel</Button>
                              </td>
                            </tr>
                        )
                    })}
                  </tbody>
                </table>
                {items.length === 0 && <p className="text-center p-8 text-gray-400">No items are currently on order.</p>}
            </div>
        </div>
        <ConfirmationModal 
            isOpen={confirmation.isOpen}
            onClose={() => setConfirmation({ isOpen: false })}
            {...confirmation}
        />
    </>
  );
};

export default InTransitOrders;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\stock\PurchaseQueue.jsx
==================================================
// src/components/features/stock/PurchaseQueue.jsx (Upgraded for Dynamic Supplier Quoting)

import React, { useState, useEffect, useMemo } from 'react';
import { getPurchaseQueue, getSuppliers, markItemsAsOrdered, getSupplierPricingForItem } from '../../../api/firestore';
import Button from '../../ui/Button';
import { ThumbsUp, Tag } from 'lucide-react';
import Input from '../../ui/Input';

const PurchaseQueue = ({ onOrderPlaced }) => {
  const [queuedItems, setQueuedItems] = useState([]);
  const [suppliers, setSuppliers] = useState([]);
  const [allPricing, setAllPricing] = useState({});
  const [orderQuantities, setOrderQuantities] = useState({});
  const [selectedSuppliers, setSelectedSuppliers] = useState({});
  const [loading, setLoading] = useState(true);

  const fetchData = async () => {
    setLoading(true);
    const [queue, supplierList] = await Promise.all([getPurchaseQueue(), getSuppliers()]);
    const pendingItems = queue.filter(item => item.status === 'pending');
    setQueuedItems(pendingItems);
    setSuppliers(supplierList);

    // Fetch all pricing info for all queued items
    const pricingMap = {};
    const pricingPromises = pendingItems.map(async (item) => {
      const prices = await getSupplierPricingForItem(item.itemId);
      pricingMap[item.itemId] = prices;
    });
    await Promise.all(pricingPromises);
    setAllPricing(pricingMap);

    // Pre-select the cheapest supplier for each item
    const initialSelections = {};
    pendingItems.forEach(item => {
        const prices = pricingMap[item.itemId] || [];
        if (prices.length > 0) {
            const cheapest = prices.reduce((min, p) => p.price < min.price ? p : min, prices[0]);
            initialSelections[item.itemId] = cheapest.supplierId;
        }
    });
    setSelectedSuppliers(initialSelections);

    setLoading(false);
  };

  useEffect(() => {
    fetchData();
  }, []);

  const handleQuantityChange = (itemId, qty) => {
    setOrderQuantities(prev => ({ ...prev, [itemId]: qty }));
  };

  const handleSupplierSelection = (itemId, supplierId) => {
    setSelectedSuppliers(prev => ({...prev, [itemId]: supplierId}));
  };

  // Group items by the *currently selected* supplier
  const groupedBySelectedSupplier = useMemo(() => {
    const groups = {};
    queuedItems.forEach(item => {
      const selectedSupplierId = selectedSuppliers[item.itemId];
      if (!selectedSupplierId) return; // Skip if no supplier is selected for this item

      if (!groups[selectedSupplierId]) {
        const supplierDetails = suppliers.find(s => s.id === selectedSupplierId);
        if(supplierDetails) {
            groups[selectedSupplierId] = { supplierDetails: supplierDetails, items: [] };
        }
      }
      if(groups[selectedSupplierId]) {
        groups[selectedSupplierId].items.push(item);
      }
    });
    return Object.values(groups).sort((a, b) => a.supplierDetails.name.localeCompare(b.supplierDetails.name));
  }, [queuedItems, suppliers, selectedSuppliers]);

  const handleGenerateEmail = (group) => {
    const supplierEmail = group.supplierDetails.email || '';
    const subject = encodeURIComponent(`Purchase Order - TOJEM`);
    let body = `Hi ${group.supplierDetails.contactPerson || group.supplierDetails.name},\n\nPlease supply the following items:\n\n`;
    
    group.items.forEach(item => {
      const recommendedQty = Math.max(0, (item.standardStockLevel || 0) - (item.currentStock || 0));
      const orderQty = orderQuantities[item.id] || recommendedQty;
      if (orderQty > 0) {
        body += `- ${item.itemName} (Code: ${item.itemCode || 'N/A'}) --- Qty: ${orderQty}\n`;
      }
    });

    body += `\nThank you,\nTojem`;
    const encodedBody = encodeURIComponent(body);
    window.location.href = `mailto:${supplierEmail}?subject=${subject}&body=${encodedBody}`;

    markItemsAsOrdered(group.supplierDetails, group.items, orderQuantities).then(() => {
        alert("Items have been marked as ordered and removed from the queue.");
        fetchData();
        if(onOrderPlaced) onOrderPlaced();
    });
  };
  
  const getItemPricingOptions = (itemId) => {
      return allPricing[itemId] || [];
  };

  if (loading) return <p className="text-center text-gray-400">Loading purchase queue...</p>;

  return (
    <div className="space-y-6">
      {queuedItems.length === 0 && <div className="bg-gray-800 p-8 rounded-xl border border-gray-700 text-center text-gray-400">Your purchase queue is empty.</div>}
      
      {/* Items to be ordered, now listed individually */}
       {queuedItems.length > 0 && (
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4">Items Requiring Purchase</h3>
                <div className="space-y-4">
                    {queuedItems.map(item => {
                        const pricingOptions = getItemPricingOptions(item.itemId);
                        const cheapestOption = pricingOptions.length > 0 ? pricingOptions.reduce((min, p) => p.price < min.price ? p : min) : null;
                        const recommendedQty = Math.max(0, (item.standardStockLevel || 0) - (item.currentStock || 0));
                        return (
                            <div key={item.id} className="grid grid-cols-1 lg:grid-cols-4 gap-4 items-center bg-gray-900/50 p-4 rounded-lg">
                                <div>
                                    <p className="font-semibold text-white">{item.itemName}</p>
                                    <p className="text-xs text-gray-400">{item.itemCode || 'No Code'}</p>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-400 block mb-1">Select Supplier</label>
                                    <select 
                                        value={selectedSuppliers[item.itemId] || ''}
                                        onChange={(e) => handleSupplierSelection(item.itemId, e.target.value)}
                                        className="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm"
                                    >
                                        <option value="" disabled>Choose...</option>
                                        {pricingOptions.map(p => (
                                            <option key={p.id} value={p.supplierId}>
                                                {p.supplierName} - R{p.price.toFixed(2)} {p.supplierId === cheapestOption?.supplierId ? ' (Best Price)' : ''}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <p className="text-xs text-gray-400 text-center">Current: {item.currentStock}</p>
                                    <p className="text-xs text-green-400 text-center">Recommended to order: {recommendedQty}</p>
                                </div>
                                <div>
                                    <Input 
                                        label="Order Qty"
                                        type="number"
                                        value={orderQuantities[item.id] || recommendedQty}
                                        onChange={(e) => handleQuantityChange(item.id, e.target.value)}
                                    />
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        )}

      {/* Grouped orders ready to be generated */}
      {groupedBySelectedSupplier.map(({ supplierDetails, items }) => (
        <div key={supplierDetails.id} className="bg-blue-900/20 p-6 rounded-xl border border-blue-500/50">
          <div className="flex justify-between items-center mb-4">
            <div>
              <h3 className="text-xl font-bold text-white flex items-center gap-2"><ThumbsUp/> Order for: {supplierDetails.name}</h3>
              <p className="text-sm text-gray-400">{supplierDetails.email}</p>
            </div>
            <Button onClick={() => handleGenerateEmail({ supplierDetails, items })}>Generate Email & Mark as Ordered</Button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-left text-sm">
              <thead className="border-b border-blue-400/30">
                <tr>
                  <th className="p-2 font-semibold text-gray-300">Item</th>
                  <th className="p-2 font-semibold text-gray-300 text-center">Order Qty</th>
                  <th className="p-2 font-semibold text-gray-300 text-right">Price</th>
                </tr>
              </thead>
              <tbody>
                {items.map(item => {
                    const pricing = allPricing[item.itemId]?.find(p => p.supplierId === supplierDetails.id);
                    const orderQty = orderQuantities[item.id] || Math.max(0, (item.standardStockLevel || 0) - (item.currentStock || 0));
                  return (
                    <tr key={item.id} className="border-b border-blue-400/20">
                      <td className="p-2 text-gray-200">{item.itemName}</td>
                      <td className="p-2 text-white font-bold text-center">{orderQty}</td>
                      <td className="p-2 text-green-400 font-mono text-right">R {pricing ? pricing.price.toFixed(2) : 'N/A'}</td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </div>
      ))}
    </div>
  );
};

export default PurchaseQueue;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\stock\StockControlDashboard.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { getAllInventoryItems, getSuppliers, getPurchaseQueue, addToPurchaseQueue } from '../../../api/firestore';
import Input from '../../ui/Input';
import Button from '../../ui/Button';
import { Search, Package, Factory, DollarSign } from 'lucide-react'; // Import DollarSign icon

// NEW: KPI Card component for displaying the total value
const KpiCard = ({ icon, title, value, color }) => (
    <div className="bg-gray-900/50 p-6 rounded-lg border border-gray-700">
        <div className="flex items-start space-x-4">
            <div className={`p-3 rounded-full ${color}`}>
                {icon}
            </div>
            <div>
                <p className="text-gray-400 text-sm">{title}</p>
                <p className="text-3xl font-bold text-white">{value}</p>
            </div>
        </div>
    </div>
);

const StockLevelIndicator = ({ currentStock, reorderLevel, standardStockLevel }) => {
    const stock = Number(currentStock);
    const reorder = Number(reorderLevel);
    const standard = Number(standardStockLevel);
    if (isNaN(stock) || isNaN(reorder) || isNaN(standard) || standard <= reorder) return <div className="text-xs text-gray-500 italic">Not tracked</div>;
    const isLowStock = stock < reorder;
    const range = standard - reorder;
    const stockInRange = stock - reorder;
    const percentage = Math.max(0, Math.min((stockInRange / range) * 100, 100));
    return (
        <div className="w-full">
            <div className="flex justify-between text-xs mb-1">
                <span className="font-semibold text-gray-300">{stock} / {standard}</span>
                <span className={`font-bold ${isLowStock ? 'text-red-400' : 'text-green-400'}`}>{isLowStock ? `Low (Reorder at ${reorder})` : 'In Stock'}</span>
            </div>
            <div className="w-full bg-gray-600 rounded-full h-2"><div className={`h-2 rounded-full ${isLowStock ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${percentage}%` }}></div></div>
        </div>
    );
};

const StockControlDashboard = () => {
  const [allItems, setAllItems] = useState([]);
  const [suppliers, setSuppliers] = useState([]);
  const [queuedItemIds, setQueuedItemIds] = useState(new Set());
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('name-asc');
  const [showLowStock, setShowLowStock] = useState(false);
  const [inventoryTypeFilter, setInventoryTypeFilter] = useState('all');

  const fetchData = async () => {
    setLoading(true);
    const [inventory, supplierList, queue] = await Promise.all([getAllInventoryItems(), getSuppliers(), getPurchaseQueue()]);
    setAllItems(inventory);
    setSuppliers(supplierList);
    setQueuedItemIds(new Set(queue.map(item => item.itemId)));
    setLoading(false);
  };

  useEffect(() => { fetchData(); }, []);

  const getSupplierName = (supplierId) => (suppliers || []).find(s => s.id === supplierId)?.name || 'N/A';

  // UPDATED: Added calculation for total inventory value
  const { displayedItems, totalInventoryValue } = useMemo(() => {
    let filtered = [...(allItems || [])];
    let value = 0;

    // Calculate total value before filtering
    filtered.forEach(item => {
        value += (item.currentStock || 0) * (item.price || 0);
    });

    if (inventoryTypeFilter === 'products') {
        filtered = filtered.filter(item => item.category === 'Product');
    } else if (inventoryTypeFilter === 'purchased') {
        filtered = filtered.filter(item => item.category !== 'Product');
    }

    if (showLowStock) { filtered = filtered.filter(item => Number(item.currentStock) < Number(item.reorderLevel)); }
    if (searchTerm) { 
        filtered = filtered.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (item.itemCode && item.itemCode.toLowerCase().includes(searchTerm.toLowerCase()))
        ); 
    }
    filtered.sort((a, b) => {
      switch (sortBy) {
        case 'name-asc': return a.name.localeCompare(b.name);
        case 'supplier': return getSupplierName(a.supplierId).localeCompare(getSupplierName(b.supplierId));
        case 'stock-low-high': return (a.currentStock / a.reorderLevel) - (b.currentStock / b.reorderLevel);
        default: return 0;
      }
    });
    return { displayedItems: filtered, totalInventoryValue: value };
  }, [allItems, searchTerm, sortBy, showLowStock, suppliers, inventoryTypeFilter]);

  const handleAddToQueue = async (item) => {
    try {
      await addToPurchaseQueue({
        itemId: item.id,
        itemName: item.name,
        supplierId: item.supplierId,
        itemCode: item.itemCode || '',
        category: item.category,
        currentStock: item.currentStock,
        reorderLevel: item.reorderLevel,
        standardStockLevel: item.standardStockLevel,
        price: item.price,
        unit: item.unit
      });
      setQueuedItemIds(prev => new Set(prev).add(item.id));
    } catch (error) {
      console.error("Error adding to queue:", error);
      alert("Failed to add to reorder list.");
    }
  };

  if (loading) return <p className="text-center text-gray-400">Loading all inventory...</p>;

  return (
    <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 space-y-6">
      {/* NEW: KPI Card for Total Inventory Value */}
      <KpiCard
        icon={<DollarSign size={28} />}
        title="Total Value of Stock on Hand"
        value={`R ${totalInventoryValue.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`}
        color="bg-green-500/20 text-green-400"
      />

      <div className="flex flex-wrap gap-4 items-center p-4 bg-gray-900/50 rounded-lg">
          <div className="relative flex-grow">
            <Input placeholder="Search all inventory..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
            <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
          </div>
          <div>
            <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <option value="name-asc">Sort by Name</option>
              <option value="supplier">Sort by Supplier</option>
              <option value="stock-low-high">Sort by Stock Level</option>
            </select>
          </div>
          <div className="flex items-center space-x-2 text-white">
            <input type="checkbox" id="lowStockToggle" checked={showLowStock} onChange={e => setShowLowStock(e.target.checked)} className="h-5 w-5 rounded bg-gray-700 text-blue-600 focus:ring-blue-500" />
            <label htmlFor="lowStockToggle" className="text-sm font-medium">Show only low stock</label>
          </div>
          <div className="flex items-center space-x-2 text-white">
            <label htmlFor="inventoryTypeFilter" className="text-sm font-medium">Show:</label>
            <select value={inventoryTypeFilter} onChange={e => setInventoryTypeFilter(e.target.value)} className="p-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm">
                <option value="all">All Inventory</option>
                <option value="products">Manufactured Products</option>
                <option value="purchased">Purchased Items</option>
            </select>
          </div>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-left">
          <thead>
            <tr className="border-b border-gray-600">
              <th className="p-3 text-sm font-semibold text-gray-400">Item Name</th>
              <th className="p-3 text-sm font-semibold text-gray-400">Category</th>
              <th className="p-3 text-sm font-semibold text-gray-400">Supplier</th>
              <th className="p-3 text-sm font-semibold text-gray-400 w-1/4">Stock Level</th>
              <th className="p-3 text-sm font-semibold text-gray-400">Actions</th>
            </tr>
          </thead>
          <tbody>
            {(displayedItems).map(item => {
              const isQueued = queuedItemIds.has(item.id);
              return (
                <tr key={`${item.id}-${item.category}`} className="border-b border-gray-700 hover:bg-gray-700/50">
                  <td className="p-3 text-gray-200 font-semibold flex items-center gap-2">
                    {item.category === 'Product' ? <Factory size={16} className="text-teal-400"/> : <Package size={16} className="text-blue-400"/>}
                    {item.name}
                  </td>
                  <td className="p-3 text-gray-400">{item.category}</td>
                  <td className="p-3 text-gray-400">{getSupplierName(item.supplierId)}</td>
                  <td className="p-3">
                    <StockLevelIndicator 
                        currentStock={item.currentStock} 
                        reorderLevel={item.reorderLevel} 
                        standardStockLevel={item.standardStockLevel} 
                    />
                  </td>
                  <td className="p-3">
                    {isQueued ? (
                      <Button variant="success" disabled={true} className="text-xs">Queued</Button>
                    ) : (
                      <Button variant="primary" onClick={() => handleAddToQueue(item)} className="text-xs">Add to Queue</Button>
                    )}
                  </td>
                </tr>
              )
            })}
          </tbody>
        </table>
        {displayedItems.length === 0 && !loading && <p className="text-center p-8 text-gray-400">No inventory items found.</p>}
      </div>
    </div>
  );
};

export default StockControlDashboard;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\stock\StockTakeApp.jsx
==================================================
// src/components/features/stock/StockTakeApp.jsx (REFACTORED)
// The `handleStartNewSession` function no longer performs a batch write,
// making it safe for large inventories. The logic for filtering remaining vs. completed items
// is now handled entirely by the updated `useStockTakeData` hook.

import React, { useState, useEffect, useMemo } from 'react';
import { useAuth } from '../../../contexts/AuthContext';
import { collection, addDoc, getDocs, serverTimestamp, query, where, orderBy, limit, updateDoc, doc } from 'firebase/firestore';
import { db } from '../../../api/firebase';
import { getAllInventoryItems, updateStockCount } from '../../../api/firestore';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import { Check, ClipboardList, RefreshCw, Search, X, QrCode, Weight, Hash } from 'lucide-react';
import toast from 'react-hot-toast';
import QrScannerModal from '../scanner/QrScannerModal';

// --- Sub-Components (SessionManager, CountingModal, VerificationScanner) remain the same ---
const SessionManager = ({ onStart, onContinue, activeSession }) => (
    <div className="bg-gray-800 p-8 rounded-xl border border-gray-700 max-w-2xl mx-auto text-center">
        <ClipboardList size={48} className="mx-auto text-blue-400 mb-4" />
        <h3 className="text-2xl font-bold text-white">Stock Take</h3>
        <p className="text-gray-400 mb-8">Start a new session or continue a previous one.</p>
        {activeSession ? (
            <Button onClick={() => onContinue(activeSession)} className="w-full max-w-xs mx-auto py-3 text-lg">
                Continue Stock Take
            </Button>
        ) : (
            <Button onClick={onStart} className="w-full max-w-xs mx-auto py-3 text-lg">
                <RefreshCw size={20} className="mr-2"/>
                Start New Stock Take
            </Button>
        )}
    </div>
);

const CountingModal = ({ item, onClose, onUpdate }) => {
    const [countValue, setCountValue] = useState('');
    const [calculatedQty, setCalculatedQty] = useState(null);

    useEffect(() => {
        if (item.stockTakeMethod === 'weight' && !isNaN(parseFloat(countValue))) {
            const grossWeight = parseFloat(countValue);
            const tareWeight = parseFloat(item.tareWeight) || 0;
            const unitWeight = parseFloat(item.unitWeight) || 1;
            if (unitWeight > 0) {
                const netWeight = grossWeight - tareWeight;
                setCalculatedQty(Math.round(netWeight / unitWeight));
            }
        } else {
            setCalculatedQty(null);
        }
    }, [countValue, item]);

    const handleSubmit = () => {
        const finalCount = item.stockTakeMethod === 'weight' ? calculatedQty : parseInt(countValue, 10);
        if (isNaN(finalCount) || finalCount < 0) {
            return toast.error("Please enter a valid, non-negative count.");
        }
        onUpdate(finalCount);
    };

    return (
        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-md">
                <div className="p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white">{item.name}</h3>
                    <p className="text-sm text-gray-400">System predicts: {item.currentStock}</p>
                </div>
                <div className="p-6 space-y-4">
                    {item.stockTakeMethod === 'weight' ? (
                        <div>
                            <Input label="Enter Gross Weight (grams)" type="number" value={countValue} onChange={e => setCountValue(e.target.value)} autoFocus />
                            {calculatedQty !== null && (
                                <p className="text-center text-blue-400 mt-2">Calculated Quantity: <span className="font-bold text-lg">{calculatedQty}</span></p>
                            )}
                        </div>
                    ) : (
                        <Input label="Enter Physical Quantity" type="number" value={countValue} onChange={e => setCountValue(e.target.value)} autoFocus />
                    )}
                </div>
                <div className="p-4 flex justify-end gap-2 bg-gray-900/50">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button variant="primary" onClick={handleSubmit}>Update Count</Button>
                </div>
            </div>
        </div>
    );
};

const VerificationScanner = ({ itemToVerify, onVerified, onClose }) => {
    const [isScannerOpen, setIsScannerOpen] = useState(true);

    const handleScanSuccess = (decodedText) => {
        if (decodedText === itemToVerify.itemCode) {
            onVerified();
        } else {
            toast.error("Incorrect item scanned. Please scan the correct QR code.");
        }
        setIsScannerOpen(false);
        onClose();
    };

    return (
        <>
            {isScannerOpen && (
                <QrScannerModal
                    onClose={onClose}
                    onScanSuccess={handleScanSuccess}
                />
            )}
        </>
    );
};

// --- Main StockTakeApp Component ---
const StockTakeApp = ({ categoryFilter = 'all' }) => {
    const { user } = useAuth();
    const [session, setSession] = useState(null);
    const [loading, setLoading] = useState(true);
    const [inventory, setInventory] = useState([]);
    const [activeTab, setActiveTab] = useState('remaining');
    const [searchTerm, setSearchTerm] = useState('');
    const [itemToCount, setItemToCount] = useState(null);
    const [itemToVerify, setItemToVerify] = useState(null);

    useEffect(() => {
        const checkForActiveSession = async () => {
            const sessionsRef = collection(db, 'stockTakeSessions');
            const q = query(sessionsRef, where('status', '==', 'in-progress'), orderBy('startTime', 'desc'), limit(1));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const activeSessionDoc = snapshot.docs[0];
                setSession({ id: activeSessionDoc.id, ...activeSessionDoc.data() });
            }
            setLoading(false);
        };
        checkForActiveSession();
    }, []);

    useEffect(() => {
        if (session) {
            const fetchInventory = async () => {
                setLoading(true);
                const allItems = await getAllInventoryItems();
                let filteredItems = allItems;
                if (categoryFilter === 'products') {
                    filteredItems = allItems.filter(item => item.category === 'Product');
                } else if (categoryFilter === 'purchased') {
                    filteredItems = allItems.filter(item => item.category !== 'Product');
                }
                setInventory(filteredItems);
                setLoading(false);
            };
            fetchInventory();
        }
    }, [session, categoryFilter]);

    /**
     * Starts a new stock take session.
     * This is now a lightweight operation that only creates a new session document.
     * It no longer performs a batch write on all inventory items.
     */
    const handleStartNewSession = async () => {
        setLoading(true);
        try {
            const sessionsRef = collection(db, 'stockTakeSessions');
            const newSessionDoc = await addDoc(sessionsRef, {
                startTime: serverTimestamp(),
                startedBy: user.email,
                status: 'in-progress'
            });
            setSession({ id: newSessionDoc.id, status: 'in-progress', startTime: new Date() });
            toast.success("New stock take session started!");
        } catch (error) {
            toast.error("Failed to start new session.");
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleItemSelect = (item) => {
        setItemToVerify(item);
        setItemToCount(null);
    };

    const handleUpdateCount = async (newCount) => {
        if (!itemToCount) return;
        try {
            await updateStockCount(itemToCount.id, itemToCount.category, newCount, session.id);
            setInventory(prev => prev.map(item => 
                item.id === itemToCount.id ? { ...item, currentStock: newCount, lastCountedInSessionId: session.id } : item
            ));
            toast.success(`${itemToCount.name} count updated to ${newCount}.`);
        } catch (error) {
            toast.error("Failed to update stock count.");
            console.error(error);
        } finally {
            setItemToCount(null);
        }
    };

    const handleFinishSession = async () => {
        toast((t) => (
            <span>
                Finish this stock take session?
                <Button variant="primary" size="sm" className="ml-2" onClick={async () => {
                    toast.dismiss(t.id);
                    const sessionRef = doc(db, 'stockTakeSessions', session.id);
                    await updateDoc(sessionRef, { status: 'completed', endTime: serverTimestamp() });
                    setSession(null);
                    setInventory([]);
                    toast.success("Stock take session completed!");
                }}>
                    Confirm
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸', duration: 6000 });
    };

    const { remainingItems, completedItems } = useMemo(() => {
        const filtered = inventory.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (item.itemCode && item.itemCode.toLowerCase().includes(searchTerm.toLowerCase()))
        );
        return {
            remainingItems: filtered.filter(item => item.lastCountedInSessionId !== session?.id),
            completedItems: filtered.filter(item => item.lastCountedInSessionId === session?.id),
        };
    }, [inventory, searchTerm, session]);

    const progress = inventory.length > 0 ? (completedItems.length / inventory.length) * 100 : 0;

    if (loading && !session) return <p className="text-center text-gray-400">Loading Stock Take Module...</p>;

    if (!session) {
        return <SessionManager onStart={handleStartNewSession} onContinue={setSession} activeSession={null} />;
    }

    return (
        <div className="space-y-4">
            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 space-y-3">
                <div className="flex justify-between items-center">
                    <h3 className="text-xl font-bold text-white">Stock Take In Progress...</h3>
                    <Button variant="success" onClick={handleFinishSession}>Finish Stock Take</Button>
                </div>
                <div className="w-full bg-gray-700 rounded-full h-4">
                    <div className="bg-blue-600 h-4 rounded-full" style={{ width: `${progress}%` }}></div>
                </div>
                <p className="text-center text-sm text-gray-300">{completedItems.length} of {inventory.length} items counted ({progress.toFixed(0)}%)</p>
            </div>

            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div className="relative mb-4">
                    <Input placeholder="Search by name or code..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="pl-10"/>
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                </div>
                <div className="flex border-b border-gray-600">
                    <button onClick={() => setActiveTab('remaining')} className={`px-4 py-2 font-semibold ${activeTab === 'remaining' ? 'border-b-2 border-blue-500 text-white' : 'text-gray-400'}`}>Remaining ({remainingItems.length})</button>
                    <button onClick={() => setActiveTab('completed')} className={`px-4 py-2 font-semibold ${activeTab === 'completed' ? 'border-b-2 border-blue-500 text-white' : 'text-gray-400'}`}>Completed ({completedItems.length})</button>
                </div>
            </div>

            {loading ? <p className="text-center text-gray-400 p-4">Loading inventory...</p> : (
                <div className="space-y-2 max-h-[50vh] overflow-y-auto pr-2">
                    {(activeTab === 'remaining' ? remainingItems : completedItems).map(item => (
                        <div key={item.id} onClick={() => handleItemSelect(item)} className="bg-gray-700 p-3 rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-600">
                            <div>
                                <p className="font-semibold text-white">{item.name}</p>
                                <p className="text-xs text-gray-400">System: {item.currentStock} | Code: {item.itemCode || 'N/A'}</p>
                            </div>
                            <div className="flex items-center gap-2">
                                {item.stockTakeMethod === 'weight' ? <Weight size={16} className="text-gray-400"/> : <Hash size={16} className="text-gray-400"/>}
                                {item.lastCountedInSessionId === session.id && <Check size={20} className="text-green-500" />}
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {itemToVerify && (
                <VerificationScanner 
                    itemToVerify={itemToVerify}
                    onClose={() => setItemToVerify(null)}
                    onVerified={() => {
                        setItemToCount(itemToVerify);
                        setItemToVerify(null);
                    }}
                />
            )}

            {itemToCount && (
                <CountingModal 
                    item={itemToCount}
                    onClose={() => setItemToCount(null)}
                    onUpdate={handleUpdateCount}
                />
            )}
        </div>
    );
};

export default StockTakeApp;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\stock\StockTakeComponents.jsx
==================================================
// src/components/features/stock/StockTakeComponents.jsx (Whitespace Fixed)

import React from 'react';
import Input from '../../ui/Input';
import { CheckCircle, AlertCircle, XCircle, Hash, Scale } from 'lucide-react';

export const Summary = ({ data }) => {
    return (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h4 className="text-sm text-gray-400 font-medium">Total Items</h4>
                <p className="text-2xl font-bold text-white">{data.totalItems}</p>
            </div>
            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h4 className="text-sm text-gray-400 font-medium flex items-center gap-1"><CheckCircle size={16} className="text-green-500" />Counted</h4>
                <p className="text-2xl font-bold text-white">{data.counted}</p>
            </div>
            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h4 className="text-sm text-gray-400 font-medium flex items-center gap-1"><XCircle size={16} className="text-yellow-500" />Uncounted</h4>
                <p className="text-2xl font-bold text-white">{data.uncounted}</p>
            </div>
            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h4 className="text-sm text-gray-400 font-medium flex items-center gap-1"><AlertCircle size={16} className="text-red-500" />Discrepancies</h4>
                <p className="text-2xl font-bold text-white">{data.discrepancies}</p>
            </div>
        </div>
    );
};

export const StockCountList = ({ items, onCountChange }) => {
    return (
        <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div className="overflow-x-auto">
                <table className="w-full text-left">
                    <thead className="bg-gray-900/50">
                        <tr>
                            <th className="p-3 text-sm font-semibold text-gray-400">Item Name</th>
                            <th className="p-3 text-sm font-semibold text-gray-400">Category</th>
                            <th className="p-3 text-sm font-semibold text-gray-400">Method</th>
                            <th className="p-3 text-sm font-semibold text-gray-400 text-center">System Count</th>
                            <th className="p-3 text-sm font-semibold text-gray-400 text-center w-64">Physical Count Input</th>
                            <th className="p-3 text-sm font-semibold text-gray-400 text-center">Calculated Qty</th>
                            <th className="p-3 text-sm font-semibold text-gray-400 text-center">Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {items.map(item => (
                            <tr key={item.id} className="border-t border-gray-700 hover:bg-gray-700/50">
                                <td className="p-2 text-white font-medium">{item.name}</td>
                                <td className="p-2 text-gray-400">{item.category}</td>
                                <td className="p-2 text-gray-400 font-mono">
                                    <div className="flex items-center gap-2" title={`Unit Weight: ${item.unitWeight}g, Tare: ${item.tareWeight}g`}>
                                        {item.stockTakeMethod === 'weight' ? <Scale size={16}/> : <Hash size={16}/>}
                                        <span>{item.stockTakeMethod === 'weight' ? 'Weight' : 'Quantity'}</span>
                                    </div>
                                </td>
                                <td className="p-2 text-gray-300 font-mono text-center">{item.systemCount}</td>
                                <td className="p-2">
                                    {item.stockTakeMethod === 'weight' ? (
                                        <div className="flex items-center gap-2">
                                            <Input
                                                type="number"
                                                value={item.countedValues?.grossWeight || ''}
                                                onChange={(e) => onCountChange(item.id, 'grossWeight', e.target.value)}
                                                className="text-center bg-gray-900"
                                                placeholder="Gross Wt. (g)"
                                            />
                                        </div>
                                    ) : (
                                        <Input
                                            type="number"
                                            value={item.countedValues?.quantity || ''}
                                            onChange={(e) => onCountChange(item.id, 'quantity', e.target.value)}
                                            className="text-center bg-gray-900"
                                            placeholder="Enter quantity..."
                                        />
                                    )}
                                </td>
                                <td className="p-2 font-bold text-lg font-mono text-center text-blue-400">
                                     {item.hasBeenCounted ? item.physicalCount : '-'}
                                </td>
                                <td className={`p-2 font-bold text-lg font-mono text-center ${item.variance > 0 ? 'text-green-400' : item.variance < 0 ? 'text-red-400' : 'text-gray-500'}`}>
                                    {item.hasBeenCounted ? (item.variance > 0 ? `+${item.variance}` : item.variance) : '-'}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\tracking\JobDetailsModal.jsx
==================================================
// src/components/features/tracking/JobDetailsModal.jsx

import React, { useState, useEffect, useMemo } from 'react';
import Button from '../../ui/Button';
import Input from '../../ui/Input';
import Textarea from '../../ui/Textarea';
import Dropdown from '../../ui/Dropdown';
import { X, CheckCircle2, DollarSign, Clock, Zap, Edit, Trash2, Save, XCircle, Award, Lightbulb, Printer } from 'lucide-react';
import { processConsumables, calculateJobDuration } from '../../../utils/jobUtils';
import { useAuth } from '../../../contexts/AuthContext';
import { giveKudosToJob, updateDocument, addKaizenSuggestion, deleteDocument } from '../../../api/firestore';
import KaizenSuggestionModal from './KaizenSuggestionModal';
import toast from 'react-hot-toast';
import QRCode from 'qrcode';
import PraiseModal from '../../intelligence/PraiseModal';

// Base64 encoded logo to ensure it prints correctly
const tojemLogoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA... (base64 string would be very long)"; // Replace with your actual full base64 string

const DetailRow = ({ label, value, className = 'text-gray-300' }) => (
  <div className="flex justify-between items-center py-2 border-b border-gray-700/50">
    <p className="text-sm text-gray-400">{label}</p>
    <p className={`text-sm font-semibold ${className}`}>{value}</p>
  </div>
);

const JobDetailsModal = ({
  job, onClose, currentTime, employeeHourlyRates, overheadCostPerHour,
  allEmployees, onUpdateJob, onDeleteJob, allInventoryItems, allTools, allToolAccessories
}) => {
  const { user } = useAuth();
  const [isEditing, setIsEditing] = useState(false);
  const [isKaizenModalOpen, setIsKaizenModalOpen] = useState(false);
  const [isPraiseModalOpen, setIsPraiseModalOpen] = useState(false);
  const [editableJobData, setEditableJobData] = useState({});

  useEffect(() => {
    setEditableJobData({
      partName: job.partName,
      description: job.description || '',
      estimatedTime: job.estimatedTime || 0,
      employeeId: job.employeeId,
      steps: Array.isArray(job.steps) ? job.steps.join('\n') : '',
      selectedTools: new Set(job.tools?.map(t => t.id) || []),
      selectedAccessories: new Set(job.accessories?.map(a => a.id) || []),
      selectedConsumables: job.consumables || [],
      vinNumber: job.vinNumber || '',
    });
    setIsEditing(false);
  }, [job]);

  const employeesInDepartment = useMemo(() => allEmployees.filter(emp => emp.departmentId === job.departmentId), [allEmployees, job.departmentId]);

  const formatDate = (timestamp) => !timestamp ? 'N/A' : new Date(timestamp.seconds * 1000).toLocaleString();
  const formatEfficiency = (j, cTime) => {
    if (!j.estimatedTime) return 'N/A';
    const dur = calculateJobDuration(j, cTime);
    if (!dur || dur.totalMinutes === 0) return 'N/A';
    return `${Math.round((j.estimatedTime / dur.totalMinutes) * 100)}%`;
  };

  const calculateLiveTotalCost = (j, cTime) => {
    const materialCost = (j.processedConsumables || []).reduce((sum, c) => sum + ((c.price || 0) * (c.quantity || 0)), 0);
    let laborCost = 0;
    if (j.employeeId && employeeHourlyRates[j.employeeId] !== undefined) {
      const dur = calculateJobDuration(j, cTime);
      if (dur) laborCost = (dur.totalMinutes / 60) * (employeeHourlyRates[j.employeeId] + overheadCostPerHour);
    }
    const machineCost = (j.tools || []).reduce((sum, tool) => {
      const toolDetails = allTools.find(t => t.id === tool.id);
      if (!toolDetails || !toolDetails.hourlyRate) return sum;
      const dur = calculateJobDuration(j, cTime);
      return sum + ((dur?.totalMinutes || 0) / 60) * toolDetails.hourlyRate;
    }, 0);
    return { materialCost, laborCost, machineCost, totalCost: materialCost + laborCost + machineCost };
  };

  const liveDuration = calculateJobDuration(job, currentTime)?.text || 'N/A';
  const efficiency = formatEfficiency(job, currentTime);
  const cost = calculateLiveTotalCost(job, currentTime).totalCost.toFixed(2);

  const handleInputChange = (e) => setEditableJobData(prev => ({ ...prev, [e.target.name]: e.target.value }));
  const handleEmployeeChange = (e) => {
    const selected = allEmployees.find(emp => emp.id === e.target.value);
    setEditableJobData(prev => ({ ...prev, employeeId: e.target.value, employeeName: selected?.name || 'Unassigned' }));
  };

  const handleSave = async () => {
    if (!editableJobData.partName.trim()) return toast.error("Part name required.");
    
    const updatedData = {
        partName: editableJobData.partName,
        description: editableJobData.description,
        estimatedTime: Number(editableJobData.estimatedTime),
        employeeId: editableJobData.employeeId,
        employeeName: allEmployees.find(e => e.id === editableJobData.employeeId)?.name || 'Unassigned',
        steps: editableJobData.steps.split('\n').filter(Boolean),
        tools: Array.from(editableJobData.selectedTools).map(id => allTools.find(t => t.id === id)).filter(Boolean),
        accessories: Array.from(editableJobData.selectedAccessories).map(id => allToolAccessories.find(a => a.id === id)).filter(Boolean),
        consumables: editableJobData.selectedConsumables,
        vinNumber: editableJobData.vinNumber,
    };

    try {
      await onUpdateJob(job.id, updatedData);
      toast.success("Job updated successfully.");
      setIsEditing(false);
    } catch (err) {
      console.error(err);
      toast.error("Update failed.");
    }
  };

  const handleDelete = () => {
    toast((t) => (
      <span>
        Delete job "{job.jobId}"?
        <Button onClick={async () => {
          try {
            await onDeleteJob(job.id);
            toast.success("Job deleted.");
            onClose();
          } catch (err) {
            toast.error("Failed to delete job.");
          }
          toast.dismiss(t.id);
        }} className="ml-2" variant="danger" size="sm">Delete</Button>
        <Button onClick={() => toast.dismiss(t.id)} className="ml-2" size="sm">Cancel</Button>
      </span>
    ), { icon: "âš ï¸" });
  };

  const handleReprint = async () => {
    const qrCodeDataUrl = await QRCode.toDataURL(job.jobId, { width: 80 });

    // --- UPDATED: Using base64 logo ---
    const printContents = `
        <div style="font-family: sans-serif; padding: 20px; color: #333;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <div>
                    <img src="${tojemLogoBase64}" alt="Company Logo" style="height: 50px; margin-bottom: 10px;"/>
                    <h1 style="font-size: 28px; font-weight: bold; margin: 0;">Job Card</h1>
                    <p style="font-size: 14px; color: #666; margin: 0;">Part: <span style="font-weight: 600;">${job.partName} (x${job.quantity})</span></p>
                    <p style="font-size: 14px; color: #666; margin: 0;">Department: <span style="font-weight: 600;">${job.departmentName}</span></p>
                    ${job.vinNumber ? `<p style="font-size: 14px; color: #666; margin: 0;">VIN: <span style="font-weight: 600;">${job.vinNumber}</span></p>` : ''}
                </div>
                <div style="text-align: right;">
                    <img src="${qrCodeDataUrl}" alt="QR Code" style="margin-bottom: 5px;"/>
                    <p style="font-size: 10px; color: #999; margin: 0;">${job.jobId}</p>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div style="font-size: 13px; line-height: 1.6;">
                    <p style="margin: 0;"><b>Employee:</b> ${job.employeeName}</p>
                    <p style="margin: 0;"><b>Est. Time:</b> ${job.estimatedTime || 'N/A'} mins</p>
                    <p style="margin: 0;"><b>Description:</b> ${job.description || 'No description.'}</p>
                </div>
                <div style="font-size: 13px; line-height: 1.6;">
                    <div>
                        <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Required Tools & Accessories</h3>
                        <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                            ${job.tools?.length > 0 ? job.tools.map(tool => `<li>${tool.name}</li>`).join('') : '<li>No tools specified.</li>'}
                            ${job.accessories?.length > 0 ? job.accessories.map(acc => `<li style="margin-left: 15px;">${acc.name}</li>`).join('') : ''}
                        </ul>
                    </div>
                </div>
            </div>
             <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Steps</h3>
                <ol style="list-style: decimal; padding-left: 20px; margin: 0;">
                    ${job.steps?.length > 0 ? job.steps.map(step => `<li>${step}</li>`).join('') : '<li>No steps defined.</li>'}
                </ol>
            </div>
        </div>
    `;
    const printWindow = window.open('', '_blank', 'height=800,width=1000');
    if (printWindow) {
        printWindow.document.write(`<html><head><title>Job Card ${job.jobId}</title></head><body>${printContents}</body></html>`);
        printWindow.document.close();
        printWindow.onload = () => { setTimeout(() => printWindow.print(), 500); };
    } else {
        toast("The print window was blocked. Please allow popups.", { icon: 'â„¹ï¸' });
    }
  };

  return (
    <>
      <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4">
        <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl w-full max-w-2xl border border-gray-700 overflow-y-auto max-h-[90vh]">
          <div className="p-4 border-b border-gray-700 flex justify-between items-center">
            <div>
              <h2 className="text-xl font-bold text-white flex items-center gap-2">{isEditing ? `Editing: ${job.jobId}` : job.partName}{job.kudos && <Award className="text-yellow-400" />}</h2>
              <p className="text-xs text-gray-500">{job.jobId}</p>
            </div>
            <div className="flex items-center gap-2">
                {!isEditing && <Button onClick={() => setIsEditing(true)} variant="secondary" size="sm"><Edit size={14}/> Edit</Button>}
                <Button onClick={onClose} variant="secondary"><X size={20} /></Button>
            </div>
          </div>
          <div className="p-6 space-y-6">
            {!isEditing ? (
              <>
                {/* View Mode */}
                <div className="grid sm:grid-cols-2 gap-2">
                  <DetailRow label="Employee" value={job.employeeName} />
                  <DetailRow label="Status" value={job.status} />
                  <DetailRow label="Started On" value={formatDate(job.startedAt)} />
                  <DetailRow label="Completed On" value={formatDate(job.completedAt)} />
                </div>
                <div className="grid sm:grid-cols-3 gap-4">
                  <div className="bg-gray-900/50 p-4 rounded text-center"><Clock className="text-blue-400 mx-auto mb-2" /><p className="text-xs text-gray-400">Est. Time</p><p className="font-bold">{job.estimatedTime || 'N/A'} min</p></div>
                  <div className="bg-gray-900/50 p-4 rounded text-center"><CheckCircle2 className="text-green-400 mx-auto mb-2" /><p className="text-xs text-gray-400">Actual Time</p><p className="font-bold">{liveDuration}</p></div>
                  <div className="bg-gray-900/50 p-4 rounded text-center"><Zap className="text-purple-400 mx-auto mb-2" /><p className="text-xs text-gray-400">Efficiency</p><p className="font-bold">{efficiency}</p></div>
                </div>
                <div className="grid sm:grid-cols-3 gap-4">
                  <div className="bg-gray-900/50 p-4 rounded text-center"><p className="text-xs text-gray-400">Material</p><p className="font-bold font-mono">R {job.materialCost?.toFixed(2) || '0.00'}</p></div>
                  <div className="bg-gray-900/50 p-4 rounded text-center"><p className="text-xs text-gray-400">Labor</p><p className="font-bold font-mono">R {job.laborCost?.toFixed(2) || '0.00'}</p></div>
                  <div className="bg-gray-900/50 p-4 rounded text-center"><DollarSign className="text-yellow-400 mx-auto mb-2" /><p className="text-xs text-gray-400">Total Cost</p><p className="font-bold font-mono">R {cost}</p></div>
                </div>
              </>
            ) : (
              // Edit Mode
              <div className="space-y-4">
                <Input label="Part Name" name="partName" value={editableJobData.partName} onChange={handleInputChange} />
                <Dropdown label="Employee" name="employeeId" value={editableJobData.employeeId} onChange={handleEmployeeChange} options={employeesInDepartment} />
                <Input label="Est. Time (min)" name="estimatedTime" type="number" value={editableJobData.estimatedTime} onChange={handleInputChange} />
                {job.vinNumber && <Input label="VIN Number" name="vinNumber" value={editableJobData.vinNumber} onChange={handleInputChange} />}
                <Textarea label="Description" name="description" value={editableJobData.description} onChange={handleInputChange} />
                <Textarea label="Steps (1 per line)" name="steps" value={editableJobData.steps} onChange={handleInputChange} />
              </div>
            )}
          </div>
          <div className="p-4 bg-gray-900/50 flex justify-between items-center">
            <div>
                <Button onClick={() => setIsKaizenModalOpen(true)} variant="secondary" size="sm"><Lightbulb size={14} className="mr-2"/>Suggest Improvement</Button>
            </div>
            <div className="flex gap-2">
                {isEditing ? (
                    <>
                        <Button onClick={() => setIsEditing(false)} variant="secondary"><XCircle size={18} className="mr-2" /> Cancel</Button>
                        <Button onClick={handleSave} variant="primary"><Save size={18} className="mr-2" /> Save Changes</Button>
                    </>
                ) : (
                    <>
                        <Button onClick={handleReprint} variant="secondary" size="sm"><Printer size={14} className="mr-2"/>Reprint</Button>
                        <Button onClick={() => setIsPraiseModalOpen(true)} variant="secondary" size="sm"><Award size={14} className="mr-2"/>Give Praise</Button>
                        <Button onClick={handleDelete} variant="danger" size="sm"><Trash2 size={14} className="mr-2"/>Delete Job</Button>
                    </>
                )}
            </div>
          </div>
        </div>
      </div>
      {isKaizenModalOpen && (
        <KaizenSuggestionModal job={job} user={user} onClose={() => setIsKaizenModalOpen(false)} onSubmit={addKaizenSuggestion} />
      )}
      {isPraiseModalOpen && (
          <PraiseModal
            allEmployees={allEmployees}
            currentUser={user}
            onSubmit={() => {
                giveKudosToJob(job.id);
                toast.success("Praise sent!");
                setIsPraiseModalOpen(false);
            }}
            onClose={() => setIsPraiseModalOpen(false)}
          />
      )}
    </>
  );
};

export default JobDetailsModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\tracking\KaizenSuggestionModal.jsx
==================================================
// src/components/features/tracking/KaizenSuggestionModal.jsx (NEW FILE)

import React, { useState } from 'react';
import Button from '../../ui/Button';
import Textarea from '../../ui/Textarea';
import { X, Lightbulb } from 'lucide-react';
import toast from 'react-hot-toast';

const KaizenSuggestionModal = ({ job, user, onSubmit, onClose }) => {
    const [suggestion, setSuggestion] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleSubmit = async () => {
        if (!suggestion.trim()) {
            return toast.error("Please enter a suggestion.");
        }
        setIsSubmitting(true);
        try {
            await onSubmit({
                jobId: job.id,
                jobIdentifier: job.jobId,
                partName: job.partName,
                suggestionText: suggestion,
                submittedBy: user.email,
                userId: user.uid,
            });
            toast.success("Thank you! Your suggestion has been submitted.");
            onClose();
        } catch (error) {
            console.error("Failed to submit suggestion:", error);
            toast.error("Could not submit suggestion. Please try again.");
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                        <Lightbulb className="text-yellow-400" />
                        Suggest an Improvement
                    </h3>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>
                <div className="p-6 space-y-4">
                    <p className="text-sm text-gray-400">
                        How could we improve the process for the job: <strong className="text-white">{job.partName} ({job.jobId})</strong>?
                    </p>
                    <Textarea
                        label="Your Suggestion"
                        value={suggestion}
                        onChange={(e) => setSuggestion(e.target.value)}
                        placeholder="e.g., 'The jig for this part could be improved by...', 'We could save time by doing step 3 before step 2...'"
                        rows={5}
                        autoFocus
                    />
                </div>
                <div className="p-4 bg-gray-900/50 flex justify-end gap-2">
                    <Button onClick={onClose} variant="secondary">Cancel</Button>
                    <Button onClick={handleSubmit} variant="primary" disabled={isSubmitting}>
                        {isSubmitting ? 'Submitting...' : 'Submit Suggestion'}
                    </Button>
                </div>
            </div>
        </div>
    );
};

export default KaizenSuggestionModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\tracking\LiveTrackingTable.jsx
==================================================
// src/components/features/tracking/LiveTrackingTable.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { listenToJobCards, getEmployees, updateDocument, deleteDocument, getAllInventoryItems, getTools, getToolAccessories } from '../../../api/firestore';
import JobDetailsModal from './JobDetailsModal';
import { ChevronDown, ChevronRight, GraduationCap } from 'lucide-react'; // Import GraduationCap
import { calculateJobDuration } from '../../../utils/jobUtils';
import { useSearchParams, useNavigate } from 'react-router-dom';
import Button from '../../ui/Button';

const StatusBadge = ({ status }) => {
    const statusColors = {
        'Pending': 'bg-yellow-500/20 text-yellow-300',
        'In Progress': 'bg-blue-500/20 text-blue-300',
        'Paused': 'bg-orange-500/20 text-orange-300',
        'Awaiting QC': 'bg-purple-500/20 text-purple-300',
        'Complete': 'bg-green-500/20 text-green-300',
        'Issue': 'bg-red-500/20 text-red-400',
        'Halted - Issue': 'bg-red-700/30 text-red-300',
        'Archived - Issue': 'bg-gray-600/20 text-gray-400'
    };
    return <span className={`px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${statusColors[status] || 'bg-gray-500/20 text-gray-300'}`}>{status}</span>;
};

const EfficiencyBadge = ({ actualMinutes, estimatedMinutes }) => {
    if (actualMinutes === null || estimatedMinutes === null || actualMinutes === 0 || !estimatedMinutes) {
        return <span className="text-xs text-gray-500">N/A</span>;
    }
    const efficiency = (estimatedMinutes / actualMinutes) * 100;
    let color = 'bg-yellow-500/20 text-yellow-300';
    if (efficiency < 90) color = 'bg-red-500/20 text-red-400';
    if (efficiency > 110) color = 'bg-green-500/20 text-green-400';
    return <span className={`px-3 py-1 text-xs font-semibold rounded-full ${color}`}>{Math.round(efficiency)}%</span>
};

const JobRow = ({ job, onClick, currentTime, employeeHourlyRates, overheadCostPerHour }) => {
    const liveDuration = calculateJobDuration(job, currentTime);

    // --- NEW: Logic to determine if training is recommended ---
    const isTrainingRecommended = useMemo(() => {
        if (!job.requiredSkills || !job.employeeSkills) return false;
        return job.requiredSkills.some(reqSkill => {
            const employeeProficiency = job.employeeSkills[reqSkill.skillId] || 0;
            return reqSkill.minProficiency > 1 && employeeProficiency < reqSkill.minProficiency;
        });
    }, [job.requiredSkills, job.employeeSkills]);

    const calculateLiveCost = (j, cTime, rates, overheadRate) => {
        if (j.status === 'Complete' && typeof j.totalCost === 'number') {
            return `R ${j.totalCost.toFixed(2)}`;
        }
        if (!j.employeeId || !rates[j.employeeId]) return 'N/A';
        
        const directRate = rates[j.employeeId];
        const burdenedRate = directRate + overheadRate;
        
        const durationResult = calculateJobDuration(j, cTime);
        let liveLaborCost = 0;
        if (durationResult) {
            liveLaborCost = (durationResult.totalMinutes / 60) * burdenedRate;
        }
        
        const currentMaterialCost = j.materialCost || 0;
        const totalLiveCost = liveLaborCost + currentMaterialCost;
        return `R ${totalLiveCost.toFixed(2)}`;
    };

    const liveCost = calculateLiveCost(job, currentTime, employeeHourlyRates, overheadCostPerHour);
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        return new Date(timestamp.seconds * 1000).toLocaleString('en-ZA');
    };

    return (
        <tr onClick={() => onClick(job)} className="border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer">
            <td className="p-3 text-gray-300 text-sm">{formatDate(job.createdAt)}</td>
            <td className="p-3 text-gray-300">
                <div className="flex items-center gap-2">
                    {job.partName}
                    {/* --- NEW: Display training icon if recommended --- */}
                    {isTrainingRecommended && (
                        <span title="Training recommended for this job">
                            <GraduationCap size={16} className="text-yellow-400" />
                        </span>
                    )}
                </div>
            </td>
            <td className="p-3 text-gray-300">{job.employeeName}</td>
            <td className="p-3"><StatusBadge status={job.status} /></td>
            <td className="p-3 text-gray-300 text-sm font-semibold">{liveDuration ? liveDuration.text : 'N/A'}</td>
            <td className="p-3"><EfficiencyBadge actualMinutes={liveDuration?.totalMinutes} estimatedMinutes={job.estimatedTime} /></td>
            <td className="p-3 text-gray-200 text-sm font-semibold font-mono text-right">{liveCost}</td>
        </tr>
    );
};

const LiveTrackingTable = ({ overheadCostPerHour }) => {
    const [allJobs, setAllJobs] = useState([]);
    const [employees, setEmployees] = useState([]);
    const [allInventoryItems, setAllInventoryItems] = useState([]);
    const [allTools, setAllTools] = useState([]);
    const [allToolAccessories, setAllToolAccessories] = useState([]);
    const [loading, setLoading] = useState(true);
    const [loadingMore, setLoadingMore] = useState(false);
    const [selectedJob, setSelectedJob] = useState(null);
    const [showCompleted, setShowCompleted] = useState(false);
    const [currentTime, setCurrentTime] = useState(Date.now());
    
    const [lastVisibleDoc, setLastVisibleDoc] = useState(null);
    const [hasMoreJobs, setHasMoreJobs] = useState(true);

    const [searchParams, setSearchParams] = useSearchParams();
    const navigate = useNavigate();

    const JOBS_PER_PAGE = 25;

    const fetchInitialData = async () => {
        setLoading(true);
        try {
            const [fetchedEmployees, fetchedInventory, fetchedTools, fetchedToolAccessories] = await Promise.all([
                getEmployees(),
                getAllInventoryItems(),
                getTools(),
                getToolAccessories(),
            ]);
            setEmployees(fetchedEmployees);
            setAllInventoryItems(fetchedInventory);
            setAllTools(fetchedTools);
            setAllToolAccessories(fetchedToolAccessories);
        } catch (error) {
            console.error("Failed to fetch initial data for tracking table:", error);
        }
    };
    
    useEffect(() => {
        fetchInitialData();
        
        const unsubscribe = listenToJobCards(({ jobs, lastVisible }) => {
            setAllJobs(jobs);
            setLastVisibleDoc(lastVisible);
            setHasMoreJobs(jobs.length === JOBS_PER_PAGE);
            setLoading(false);
        }, { limit: JOBS_PER_PAGE });

        const intervalId = setInterval(() => setCurrentTime(Date.now()), 1000);

        return () => {
            unsubscribe();
            clearInterval(intervalId);
        };
    }, []);
    
    useEffect(() => {
        const jobIdFromUrl = searchParams.get('jobId');
        if (jobIdFromUrl && !loading && allJobs.length > 0) {
            const jobToOpen = allJobs.find(job => job.jobId === jobIdFromUrl);
            if (jobToOpen) {
                setSelectedJob(jobToOpen);
            }
        }
    }, [searchParams, loading, allJobs]);

    const handleLoadMore = () => {
        if (!hasMoreJobs || loadingMore) return;
        setLoadingMore(true);

        const unsubscribe = listenToJobCards(({ jobs, lastVisible }) => {
            unsubscribe();
            setAllJobs(prevJobs => [...prevJobs, ...jobs]);
            setLastVisibleDoc(lastVisible);
            setHasMoreJobs(jobs.length === JOBS_PER_PAGE);
            setLoadingMore(false);
        }, { limit: JOBS_PER_PAGE, startAfter: lastVisibleDoc });
    };

    const employeeHourlyRates = useMemo(() => {
        return employees.reduce((acc, emp) => {
            acc[emp.id] = emp.hourlyRate || 0;
            return acc;
        }, {});
    }, [employees]);

    // --- NEW: Enrich jobs with employee skill data for the check ---
    const enrichedJobs = useMemo(() => {
        const employeesMap = new Map(employees.map(e => [e.id, e]));
        return allJobs.map(job => {
            const employee = employeesMap.get(job.employeeId);
            return {
                ...job,
                employeeSkills: employee ? employee.skills : {}
            };
        });
    }, [allJobs, employees]);

    const { activeJobs, completedAndArchivedJobs } = useMemo(() => {
        const statusOrder = { 'In Progress': 1, 'Paused': 2, 'Awaiting QC': 3, 'Pending': 4 };
        
        const active = enrichedJobs
            .filter(job => ['In Progress', 'Paused', 'Awaiting QC', 'Pending'].includes(job.status))
            .sort((a, b) => {
                const statusCompare = statusOrder[a.status] - statusOrder[b.status];
                if (statusCompare !== 0) return statusCompare;
                const timeA = a.status === 'In Progress' || a.status === 'Paused' ? a.startedAt : a.createdAt;
                const timeB = b.status === 'In Progress' || b.status === 'Paused' ? b.startedAt : b.createdAt;
                if (timeA && timeB) {
                    return timeB.seconds - timeA.seconds;
                }
                return 0;
            });
        const completed = enrichedJobs.filter(job => ['Complete', 'Issue', 'Archived - Issue'].includes(job.status));
        return { activeJobs: active, completedAndArchivedJobs: completed };
    }, [enrichedJobs]);

    const handleUpdateJob = async (jobId, updatedData) => {
        try {
            await updateDocument('createdJobCards', jobId, updatedData);
        } catch (error) {
            console.error("Error updating job from modal:", error);
            throw error;
        }
    };

    const handleDeleteJob = async (jobId) => {
        try {
            await deleteDocument('createdJobCards', jobId);
        } catch (error) {
            console.error("Error deleting job from modal:", error);
            throw error;
        }
    };

    const handleCloseModal = () => {
        setSelectedJob(null);
        navigate('/tracking', { replace: true });
    };

    if (loading) return <p className="text-center text-gray-400">Loading jobs...</p>;

    return (
        <>
            <div className="bg-gray-800 rounded-xl border border-gray-700 shadow-lg overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left">
                        <thead>
                            <tr className="border-b border-gray-600 bg-gray-900/50">
                                <th className="p-3 text-sm font-semibold text-gray-400">Created</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Part</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Employee</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Status</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Actual Time</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Efficiency</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">Job Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {activeJobs.map(job => (
                                <JobRow
                                    key={job.id}
                                    job={job}
                                    onClick={() => setSelectedJob(job)}
                                    currentTime={currentTime}
                                    employeeHourlyRates={employeeHourlyRates}
                                    overheadCostPerHour={overheadCostPerHour}
                                />
                            ))}
                        </tbody>
                    </table>
                    
                    <div className="border-t border-gray-700">
                        <button
                            onClick={() => setShowCompleted(!showCompleted)}
                            className="w-full flex items-center justify-between p-3 text-left text-sm font-semibold text-gray-300 bg-gray-900/30 hover:bg-gray-700/50 transition-colors"
                        >
                            <span>Completed & Archived Jobs ({completedAndArchivedJobs.length})</span>
                            {showCompleted ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                        </button>
                        {showCompleted && (
                            <table className="w-full text-left">
                                <thead className="invisible h-0">
                                    <tr>
                                        <th className="p-0">Created</th><th className="p-0">Part</th><th className="p-0">Employee</th>
                                        <th className="p-0">Status</th><th className="p-0">Actual Time</th><th className="p-0">Efficiency</th>
                                        <th className="p-0 text-right">Job Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {completedAndArchivedJobs.map(job => (
                                        <JobRow
                                            key={job.id}
                                            job={job}
                                            onClick={() => setSelectedJob(job)}
                                            currentTime={currentTime}
                                            employeeHourlyRates={employeeHourlyRates}
                                            overheadCostPerHour={overheadCostPerHour}
                                        />
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                    {hasMoreJobs && (
                        <div className="p-4 text-center border-t border-gray-700">
                            <Button onClick={handleLoadMore} disabled={loadingMore}>
                                {loadingMore ? 'Loading...' : 'Load More Jobs'}
                            </Button>
                        </div>
                    )}
                </div>
                {selectedJob && (
                    <JobDetailsModal
                        job={selectedJob}
                        onClose={handleCloseModal}
                        currentTime={currentTime}
                        employeeHourlyRates={employeeHourlyRates}
                        overheadCostPerHour={overheadCostPerHour}
                        allEmployees={employees}
                        onUpdateJob={handleUpdateJob}
                        onDeleteJob={handleDeleteJob}
                        allInventoryItems={allInventoryItems}
                        allTools={allTools}
                        allToolAccessories={allToolAccessories}
                    />
                )}
            </div>
        </>
    );
};

export default LiveTrackingTable;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\features\tracking\TrainingModal.jsx
==================================================
// src/components/features/tracking/TrainingModal.jsx (NEW FILE)

import React, { useMemo } from 'react';
import Button from '../../ui/Button';
import { X, GraduationCap, Link as LinkIcon } from 'lucide-react';

const TrainingModal = ({ job, onClose, allSkills, trainingResources }) => {
    
    const trainingSuggestions = useMemo(() => {
        if (!job || !job.requiredSkills || !job.employeeSkills || !allSkills || !trainingResources) {
            return [];
        }

        const allSkillsMap = new Map(allSkills.map(s => [s.id, s.name]));
        
        return job.requiredSkills
            .map(reqSkill => {
                const employeeProficiency = job.employeeSkills[reqSkill.skillId] || 0;
                if (reqSkill.minProficiency > 1 && employeeProficiency < reqSkill.minProficiency) {
                    const relevantResources = trainingResources.filter(res => res.skillId === reqSkill.skillId);
                    return {
                        skillName: allSkillsMap.get(reqSkill.skillId) || 'Unknown Skill',
                        requiredLevel: reqSkill.minProficiency,
                        currentLevel: employeeProficiency,
                        resources: relevantResources,
                    };
                }
                return null;
            })
            .filter(Boolean); // Remove null entries
    }, [job, allSkills, trainingResources]);

    return (
        <div 
            onClick={onClose} 
            className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-fade-in"
        >
            <div 
                onClick={(e) => e.stopPropagation()} 
                className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg"
            >
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                        <GraduationCap className="text-yellow-400" />
                        Training Recommendations
                    </h3>
                    <Button onClick={onClose} variant="secondary" className="p-2">
                        <X size={20} />
                    </Button>
                </div>
                <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    <p className="text-sm text-gray-400">
                        Based on the requirements for <strong className="text-white">{job.partName}</strong> and the assigned employee's current skill set.
                    </p>
                    {trainingSuggestions.map((suggestion, index) => (
                        <div key={index} className="bg-gray-900/50 p-4 rounded-lg">
                            <h4 className="font-bold text-white">{suggestion.skillName}</h4>
                            <p className="text-xs text-gray-400">
                                Required Proficiency: Level {suggestion.requiredLevel} | Current: Level {suggestion.currentLevel}
                            </p>
                            {suggestion.resources.length > 0 && (
                                <div className="mt-3 pt-3 border-t border-gray-700 space-y-2">
                                    {suggestion.resources.map(res => (
                                        <a 
                                            key={res.id} 
                                            href={res.url} 
                                            target="_blank" 
                                            rel="noopener noreferrer" 
                                            className="flex items-center text-sm text-blue-400 hover:underline"
                                        >
                                            <LinkIcon size={14} className="mr-2"/>
                                            {res.resourceName} ({res.type})
                                        </a>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
                 <div className="p-4 bg-gray-900/50 flex justify-end">
                    <Button onClick={onClose} variant="secondary">Close</Button>
                </div>
            </div>
        </div>
    );
};

export default TrainingModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\AssetPerformanceWidget.jsx
==================================================
import React from 'react';
import { Clock, DollarSign, ShieldCheck, Zap } from 'lucide-react';

const KpiCard = ({ icon, title, value, color }) => (
    <div className={`bg-gray-900/50 p-4 rounded-lg border-l-4 ${color}`}>
        <div className="flex items-center gap-3">
            {icon}
            <div>
                <p className="text-sm text-gray-400">{title}</p>
                <p className="text-xl font-bold text-white">{value}</p>
            </div>
        </div>
    </div>
);

const AssetPerformanceWidget = ({ assetData }) => {
    if (!assetData) {
        return (
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center text-gray-500">
                <p>Select an asset from the list to view its performance analysis.</p>
            </div>
        );
    }

    const {
        name,
        totalRunHours,
        totalOperatingCost,
        jobsContributed,
        qualityRate
    } = assetData;

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 space-y-6">
            <h3 className="text-2xl font-bold text-white">Performance Analysis: {name}</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <KpiCard icon={<Clock size={24} />} title="Total Run Time" value={`${totalRunHours.toFixed(1)} hrs`} color="border-blue-500" />
                <KpiCard icon={<DollarSign size={24} />} title="Total Operating Cost" value={`R ${totalOperatingCost.toFixed(2)}`} color="border-yellow-500" />
                <KpiCard icon={<Zap size={24} />} title="Jobs Contributed" value={jobsContributed} color="border-purple-500" />
                <KpiCard icon={<ShieldCheck size={24} />} title="Quality Rate" value={`${qualityRate.toFixed(1)}%`} color="border-green-500" />
            </div>
            <div>
                {/* This section can be expanded in the future with more detailed charts */}
                <p className="text-sm text-gray-400 text-center">Further analysis charts can be added here.</p>
            </div>
        </div>
    );
};

export default AssetPerformanceWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\BottleneckWidget.jsx
==================================================
import React from 'react';
import { Gauge, AlertTriangle } from 'lucide-react';
import { RadialBarChart, RadialBar, ResponsiveContainer, PolarAngleAxis } from 'recharts';

/**
 * A widget to display the current system bottleneck identified by the TOC engine.
 * It visualizes the utilization percentage of the most constrained tool.
 */
const BottleneckWidget = ({ bottleneck }) => {
    // Set default data in case the bottleneck is not yet calculated or available
    const bottleneckName = bottleneck?.bottleneckToolName || "Calculating...";
    const utilization = bottleneck?.bottleneckUtilization || 0;

    // Determine color based on utilization percentage
    const scoreColor = utilization > 95 ? '#ef4444' : utilization > 80 ? '#f59e0b' : '#22c55e';
    
    // Data for the radial bar chart
    const data = [{ name: 'Utilization', value: utilization }];

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col items-center justify-center">
            <h3 className="font-bold text-white mb-2 flex items-center gap-2">
                <AlertTriangle size={20} className="text-orange-400"/>
                System Bottleneck
            </h3>
            <p className="text-lg font-semibold text-white mb-2">{bottleneckName}</p>

            {/* Chart visualization for the utilization percentage */}
            <ResponsiveContainer width="100%" height={200}>
                <RadialBarChart 
                    cx="50%" 
                    cy="50%" 
                    innerRadius="60%" 
                    outerRadius="80%" 
                    barSize={20} 
                    data={data}
                    startAngle={180}
                    endAngle={0}
                >
                    <PolarAngleAxis
                        type="number"
                        domain={[0, 100]}
                        angleAxisId={0}
                        tick={false}
                    />
                    <RadialBar
                        minAngle={15}
                        background
                        clockWise
                        dataKey="value"
                        cornerRadius={10}
                        fill={scoreColor}
                    />
                    <text x="50%" y="55%" textAnchor="middle" dominantBaseline="middle" className="text-4xl font-bold fill-white">
                        {Math.round(utilization)}%
                    </text>
                     <text x="50%" y="70%" textAnchor="middle" dominantBaseline="middle" className="text-sm font-semibold fill-gray-400">
                        Utilization
                    </text>
                </RadialBarChart>
            </ResponsiveContainer>
        </div>
    );
};

export default BottleneckWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\BreakEvenCalculator.jsx
==================================================
// src/components/intelligence/BreakEvenCalculator.jsx (FIXED)
import React, { useMemo } from 'react'; // useMemo is now correctly imported
import { Target, DollarSign } from 'lucide-react';

const BreakEvenCalculator = ({ totalFixedCosts, historicalGrossMargin }) => {

    const breakEvenSales = useMemo(() => {
        if (historicalGrossMargin <= 0) {
            return 0; // Avoid division by zero or negative margin
        }
        return totalFixedCosts / (historicalGrossMargin / 100);
    }, [totalFixedCosts, historicalGrossMargin]);

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <Target className="text-green-400" />
                Monthly Break-Even Target
            </h3>
            <div className="text-center bg-gray-900/50 p-6 rounded-lg">
                <p className="text-sm text-gray-400">Required sales to cover all fixed costs</p>
                <p className="text-5xl font-bold text-green-400 font-mono mt-2">
                    R {breakEvenSales.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                </p>
                <p className="text-xs text-gray-500 mt-2">
                    Based on a historical gross margin of {historicalGrossMargin.toFixed(1)}%
                </p>
            </div>
        </div>
    );
};

export default BreakEvenCalculator;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\CapacityGauge.jsx
==================================================
// src/components/intelligence/CapacityGauge.jsx
import React from 'react';
import { Gauge } from 'lucide-react';
import { RadialBarChart, RadialBar, ResponsiveContainer } from 'recharts';

const CapacityGauge = ({ utilization }) => {
    const scoreColor = utilization > 85 ? '#ef4444' : utilization > 70 ? '#f59e0b' : '#22c55e';
    const data = [{ name: 'Capacity', value: utilization }];

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 flex flex-col items-center justify-center h-full">
            <h3 className="font-bold text-white mb-2 flex items-center gap-2">
                <Gauge size={20} className="text-blue-400"/>
                Capacity Utilization
            </h3>
            <ResponsiveContainer width="100%" height={200}>
                <RadialBarChart 
                    cx="50%" 
                    cy="50%" 
                    innerRadius="60%" 
                    outerRadius="80%" 
                    barSize={20} 
                    data={data}
                    startAngle={180}
                    endAngle={0}
                >
                    <RadialBar
                        minAngle={15}
                        background
                        clockWise
                        dataKey="value"
                        fill={scoreColor}
                        cornerRadius={10}
                    />
                    <text x="50%" y="55%" textAnchor="middle" dominantBaseline="middle" className="text-4xl font-bold fill-white">
                        {Math.round(utilization)}%
                    </text>
                     <text x="50%" y="70%" textAnchor="middle" dominantBaseline="middle" className="text-sm font-semibold fill-gray-400">
                        of available hours
                    </text>
                </RadialBarChart>
            </ResponsiveContainer>
        </div>
    );
};

export default CapacityGauge;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\DepartmentPerformanceChart.jsx
==================================================
// src/components/intelligence/DepartmentPerformanceChart.jsx (NEW FILE)

import React from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { BarChart3 } from 'lucide-react';

const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-gray-900/80 p-3 border border-gray-700 rounded-lg shadow-lg">
        <p className="label text-sm text-white font-bold">{label}</p>
        <p className="intro text-purple-400">{`Avg. Efficiency: ${payload[0].value.toFixed(0)}%`}</p>
        <p className="intro text-green-400">{`Total Value: R ${payload[1].value.toLocaleString('en-ZA')}`}</p>
      </div>
    );
  }
  return null;
};

const DepartmentPerformanceChart = ({ data }) => {
    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full">
            <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                <BarChart3 size={20} className="text-purple-400"/>
                Department Performance Overview
            </h3>
            <ResponsiveContainer width="100%" height={350}>
                <BarChart data={data} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#4b556330" />
                    <XAxis dataKey="name" stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} />
                    <YAxis yAxisId="left" stroke="#8b5cf6" fontSize={12} tickLine={false} axisLine={false} unit="%" />
                    <YAxis yAxisId="right" orientation="right" stroke="#22c55e" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `R${value/1000}k`} />
                    <Tooltip content={<CustomTooltip />} cursor={{fill: 'rgba(107, 114, 128, 0.1)'}}/>
                    <Legend wrapperStyle={{fontSize: "14px"}} />
                    <Bar yAxisId="left" dataKey="avgEfficiency" fill="#8b5cf6" name="Avg. Efficiency" />
                    <Bar yAxisId="right" dataKey="totalValue" fill="#22c55e" name="Total Value Generated" />
                </BarChart>
            </ResponsiveContainer>
        </div>
    );
};

export default DepartmentPerformanceChart;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\EfficiencyAnalysisModal.jsx
==================================================
// src/components/intelligence/EfficiencyAnalysisModal.jsx

import React, { useMemo } from 'react';
import { X } from 'lucide-react';
import Button from '../ui/Button';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';
import { calculateJobDuration } from '../../utils/jobUtils';

const EfficiencyAnalysisModal = ({ jobs, employeeName, onClose }) => {
    
    const analysisData = useMemo(() => {
        if (!jobs || jobs.length === 0) return [];

        const jobsByDept = jobs.reduce((acc, job) => {
            if (!job.departmentName) return acc;
            if (!acc[job.departmentName]) {
                acc[job.departmentName] = [];
            }
            acc[job.departmentName].push(job);
            return acc;
        }, {});

        const analysis = Object.entries(jobsByDept).map(([departmentName, deptJobs]) => {
            const completedJobsWithTime = deptJobs.filter(j => j.status === 'Complete' && j.estimatedTime > 0 && j.startedAt && j.completedAt);
            
            if (completedJobsWithTime.length === 0) {
                return null;
            }

            const totalEfficiencyRatio = completedJobsWithTime.reduce((sum, job) => {
                const duration = calculateJobDuration(job, job.completedAt.toDate());
                if (duration && duration.totalMinutes > 0) {
                    const actualMinutes = duration.totalMinutes;
                    const estimatedMinutes = job.estimatedTime;
                    return sum + (estimatedMinutes / actualMinutes);
                }
                return sum;
            }, 0);

            const avgEfficiency = (totalEfficiencyRatio / completedJobsWithTime.length) * 100;

            return {
                department: departmentName,
                efficiency: Math.round(avgEfficiency),
                jobCount: completedJobsWithTime.length
            };
        }).filter(Boolean);

        return analysis;

    }, [jobs]);

    return (
        <div 
            onClick={onClose}
            className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in"
        >
            <div 
                onClick={(e) => e.stopPropagation()}
                className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-2xl max-h-[80vh] flex flex-col"
            >
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <div>
                        <h2 className="text-xl font-bold text-white">Efficiency Analysis</h2>
                        <p className="text-sm text-gray-400">For {employeeName}</p>
                    </div>
                    <Button onClick={onClose} variant="secondary" className="p-2">
                        <X size={20} />
                    </Button>
                </div>

                <div className="p-6 overflow-y-auto">
                    {analysisData.length > 0 ? (
                        <ResponsiveContainer width="100%" height={300}>
                            <BarChart
                                data={analysisData}
                                layout="vertical"
                                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                            >
                                <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
                                <XAxis type="number" stroke="#9ca3af" unit="%" />
                                <YAxis type="category" dataKey="department" stroke="#9ca3af" width={120} />
                                <Tooltip
                                    cursor={{ fill: 'rgba(107, 114, 128, 0.1)' }}
                                    contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #4b5563' }}
                                    formatter={(value, name, props) => [`${value}% (${props.payload.jobCount} jobs)`, "Efficiency"]}
                                />
                                <Legend />
                                <Bar dataKey="efficiency" fill="#8b5cf6" name="Average Efficiency"/>
                            </BarChart>
                        </ResponsiveContainer>
                    ) : (
                        <p className="text-center text-gray-500 py-8">
                            Not enough completed jobs with time estimates to perform an efficiency analysis for this employee.
                        </p>
                    )}
                </div>
            </div>
        </div>
    );
};

export default EfficiencyAnalysisModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\EfficiencyChart.jsx
==================================================
// src/components/intelligence/EfficiencyChart.jsx

import React, { useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';

const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-gray-900/80 p-4 border border-gray-700 rounded-lg shadow-lg">
        <p className="label text-sm text-gray-400">{`Date: ${label}`}</p>
        <p className="intro text-white font-bold">{`Efficiency: ${payload[0].value.toFixed(0)}%`}</p>
        <p className="desc text-xs text-gray-500">Job: {payload[0].payload.partName}</p>
      </div>
    );
  }
  return null;
};

const EfficiencyChart = ({ jobs }) => {
  const chartData = useMemo(() => {
    if (!jobs || jobs.length === 0) return [];

    return jobs
      .filter(job => job.status === 'Complete' && job.estimatedTime > 0 && job.startedAt && job.completedAt)
      .map(job => {
        const actualSeconds = (job.completedAt.toDate().getTime() - job.startedAt.toDate().getTime() - (job.totalPausedMilliseconds || 0)) / 1000;
        if (actualSeconds <= 0) return null;

        const efficiency = ((job.estimatedTime * 60) / actualSeconds) * 100;

        return {
          date: new Date(job.completedAt.toDate()).toLocaleDateString('en-ZA'),
          efficiency: efficiency,
          partName: job.partName,
        };
      })
      .filter(Boolean)
      .sort((a, b) => new Date(a.date) - new Date(b.date));
  }, [jobs]);

  if (chartData.length === 0) {
    return (
        <div className="flex items-center justify-center h-full">
            <p className="text-gray-500">Not enough data to display performance trend.</p>
        </div>
    );
  }

  return (
    <ResponsiveContainer width="100%" height={300}>
      <LineChart
        data={chartData}
        margin={{
          top: 5,
          right: 30,
          left: 0,
          bottom: 5,
        }}
      >
        <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
        <XAxis dataKey="date" stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} />
        <YAxis stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} unit="%" />
        <Tooltip content={<CustomTooltip />} />
        <Legend wrapperStyle={{fontSize: "14px"}} />
        <Line type="monotone" dataKey="efficiency" stroke="#8b5cf6" strokeWidth={2} activeDot={{ r: 8 }} name="Job Efficiency"/>
      </LineChart>
    </ResponsiveContainer>
  );
};

export default EfficiencyChart;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\GrowthSimulator.jsx
==================================================
// src/components/intelligence/GrowthSimulator.jsx (UPDATED & FIXED)

import React, { useState, useEffect } from 'react';
import Input from '../ui/Input';
import { TrendingUp, Users, Zap, DollarSign } from 'lucide-react';

const GrowthSimulator = ({ baseOverheads, baseEmployeeCount, baseAvgEfficiency, baseAvgHourlyRate }) => {
    const [scenario, setScenario] = useState({
        targetSales: '',
        employeeCount: baseEmployeeCount || 1,
        teamEfficiency: baseAvgEfficiency || 100,
    });
    const [results, setResults] = useState({
        requiredHours: 0,
        availableHours: 0,
        cogs: 0,
        laborCost: 0, // This will now represent the total monthly labor bill
        grossProfit: 0,
        netProfit: 0,
        breakEvenSales: 0,
    });

    useEffect(() => {
        const targetSales = parseFloat(scenario.targetSales) || 0;
        const employeeCount = parseInt(scenario.employeeCount, 10) || baseEmployeeCount;
        const teamEfficiency = parseFloat(scenario.teamEfficiency) || baseAvgEfficiency;

        // --- Core Financial Calculations ---
        // 1. Estimate COGS (assuming a 60% variable cost of sales)
        const cogs = targetSales * 0.60;
        const contributionMarginRatio = 0.40; // (1 - 0.60)

        // 2. Calculate Total Fixed Costs for the scenario
        // Total monthly labor cost is now tied to the number of employees in the scenario
        const totalMonthlyLaborCost = employeeCount * baseAvgHourlyRate * 173.2; // Avg hours in a month
        const totalFixedCosts = baseOverheads + totalMonthlyLaborCost;

        // 3. Calculate Profitability
        const grossProfit = targetSales - cogs;
        const netProfit = grossProfit - totalMonthlyLaborCost - baseOverheads;
        
        // 4. Calculate Break-Even Point
        const breakEvenSales = contributionMarginRatio > 0 ? totalFixedCosts / contributionMarginRatio : 0;


        // --- Capacity/Hour Calculations (for context) ---
        // We'll use a simplified model: assume labor cost is ~25% of sales to estimate hours needed
        const estimatedLaborValueOfSales = targetSales * 0.25;
        const efficiencyFactor = 100 / (teamEfficiency || 100);
        const requiredHours = baseAvgHourlyRate > 0 ? (estimatedLaborValueOfSales / baseAvgHourlyRate) * efficiencyFactor : 0;
        const availableHours = employeeCount * 173.2;

        setResults({
            requiredHours,
            availableHours,
            cogs,
            laborCost: totalMonthlyLaborCost, // Set the total labor cost for display
            grossProfit,
            netProfit,
            breakEvenSales,
        });

    }, [scenario, baseOverheads, baseEmployeeCount, baseAvgEfficiency, baseAvgHourlyRate]);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setScenario(prev => ({ ...prev, [name]: value }));
    };

    const formatCurrency = (value) => `R ${value.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <TrendingUp className="text-blue-400" />
                Growth & Profitability Simulator
            </h3>
            
            {/* INPUTS: The Levers */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 p-4 bg-gray-900/50 rounded-lg">
                <Input 
                    label="Target Monthly Sales (R)" 
                    name="targetSales" 
                    type="number" 
                    value={scenario.targetSales} 
                    onChange={handleInputChange} 
                    placeholder="e.g., 500000" 
                />
                <Input 
                    label="Number of Employees" 
                    name="employeeCount" 
                    type="number" 
                    value={scenario.employeeCount} 
                    onChange={handleInputChange}
                />
                <Input 
                    label="Team Efficiency (%)" 
                    name="teamEfficiency" 
                    type="number" 
                    value={scenario.teamEfficiency} 
                    onChange={handleInputChange}
                />
            </div>

            {/* OUTPUTS: The Results */}
            <div className="space-y-4">
                <h4 className="font-semibold text-lg text-white">Projected Results</h4>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                    <div className="bg-gray-700/50 p-4 rounded-lg">
                        <p className="text-sm text-gray-400">Required Hours vs. Available</p>
                        <p className={`text-2xl font-bold ${results.availableHours < results.requiredHours ? 'text-red-400' : 'text-green-400'}`}>
                            {results.requiredHours.toFixed(0)} / {results.availableHours.toFixed(0)}
                        </p>
                    </div>
                    <div className="bg-gray-700/50 p-4 rounded-lg">
                        <p className="text-sm text-gray-400">Break-Even Sales (R)</p>
                        <p className="text-2xl font-bold text-white">
                            {formatCurrency(results.breakEvenSales)}
                        </p>
                    </div>
                    <div className="bg-blue-600/20 p-4 rounded-lg border border-blue-500">
                        <p className="text-sm text-blue-300">Projected Net Profit</p>
                        <p className={`text-2xl font-bold ${results.netProfit >= 0 ? 'text-white' : 'text-red-400'}`}>
                            {formatCurrency(results.netProfit)}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default GrowthSimulator;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\JobCompletionAnalysisWidget.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { getCompletedJobsForEmployee } from '../../api/firestore';
import { CheckCircle2, AlertTriangle } from 'lucide-react';

const JobCompletionAnalysisWidget = ({ employeeId }) => {
    const [stats, setStats] = useState({ onTime: 0, late: 0, total: 0 });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const calculateStats = async () => {
            if (!employeeId) return;
            setLoading(true);

            try {
                const completedJobs = await getCompletedJobsForEmployee(employeeId);
                
                let onTimeCount = 0;
                let lateCount = 0;

                completedJobs.forEach(job => {
                    // Ensure the job has the necessary data for comparison
                    if (job.estimatedTime && job.startedAt && job.completedAt) {
                        const startTime = job.startedAt.toDate().getTime();
                        const completionTime = job.completedAt.toDate().getTime();
                        const pauseDuration = job.totalPausedMilliseconds || 0;

                        // Calculate actual duration in minutes
                        const actualDurationMinutes = (completionTime - startTime - pauseDuration) / (1000 * 60);

                        if (actualDurationMinutes <= job.estimatedTime) {
                            onTimeCount++;
                        } else {
                            lateCount++;
                        }
                    }
                });

                setStats({
                    onTime: onTimeCount,
                    late: lateCount,
                    total: onTimeCount + lateCount // Only count jobs that could be analyzed
                });

            } catch (error) {
                console.error("Error fetching or calculating job completion stats:", error);
                alert("Could not load job completion stats.");
            }
            setLoading(false);
        };

        calculateStats();
    }, [employeeId]);
    
    const onTimePercentage = stats.total > 0 ? (stats.onTime / stats.total) * 100 : 0;

    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Job Completion Analysis</h3>
            {loading ? (
                <p className="text-gray-400">Analyzing job history...</p>
            ) : stats.total === 0 ? (
                <p className="text-gray-400">No completed jobs with time estimates found for this employee.</p>
            ) : (
                <div className="space-y-4">
                    {/* KPI Cards for On-Time and Late */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-green-500/10 p-4 rounded-lg text-center">
                            <CheckCircle2 className="mx-auto text-green-400 mb-2" size={28} />
                            <p className="text-2xl font-bold text-white">{stats.onTime}</p>
                            <p className="text-sm text-green-400">On-Time / Early</p>
                        </div>
                        <div className="bg-red-500/10 p-4 rounded-lg text-center">
                            <AlertTriangle className="mx-auto text-red-400 mb-2" size={28} />
                            <p className="text-2xl font-bold text-white">{stats.late}</p>
                            <p className="text-sm text-red-400">Late</p>
                        </div>
                    </div>

                    {/* Proportional Bar */}
                    <div>
                        <p className="text-center text-sm text-gray-300 mb-2">
                            On-Time Completion Rate: <span className="font-bold text-white">{onTimePercentage.toFixed(0)}%</span>
                        </p>
                        <div className="flex h-4 w-full bg-red-500/20 rounded-full overflow-hidden border border-gray-700">
                            <div 
                                style={{ width: `${onTimePercentage}%` }}
                                className="bg-green-500 transition-all duration-500"
                            ></div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default JobCompletionAnalysisWidget;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\MonthlySalesTrend.jsx
==================================================
// src/components/intelligence/MonthlySalesTrend.jsx
import React from 'react';
import { TrendingUp, TrendingDown, Minus, Calendar } from 'lucide-react';

const MonthlySalesTrend = ({ percentageChange }) => {
    
    const isPositive = percentageChange > 0;
    const isNegative = percentageChange < 0;

    const getTrendInfo = () => {
        if (isPositive) return {
            icon: <TrendingUp size={32} />,
            textColor: 'text-green-400',
            text: `+${percentageChange.toFixed(1)}%`
        };
        if (isNegative) return {
            icon: <TrendingDown size={32} />,
            textColor: 'text-red-400',
            text: `${percentageChange.toFixed(1)}%`
        };
        return {
            icon: <Minus size={32} />,
            textColor: 'text-gray-400',
            text: `${percentageChange.toFixed(1)}%`
        };
    };
    
    const trend = getTrendInfo();

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col justify-center items-center">
            <p className="text-gray-400 text-sm font-medium mb-2 flex items-center gap-2">
                <Calendar size={14} />
                This Month vs. Last Year
            </p>
            <div className={`flex items-center space-x-3 ${trend.textColor}`}>
                {trend.icon}
                <span className="text-5xl font-bold">
                    {trend.text}
                </span>
            </div>
        </div>
    );
};

export default MonthlySalesTrend;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\MultiYearSalesGraph.jsx
==================================================
// src/components/intelligence/MultiYearSalesGraph.jsx
import React from 'react';
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend } from 'recharts';
import { TrendingUp } from 'lucide-react';

const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-gray-900/80 p-3 border border-gray-700 rounded-lg shadow-lg">
        <p className="label text-sm text-white font-bold">{label}</p>
        {payload.map(pld => (
          <div key={pld.dataKey} style={{ color: pld.color }}>
            {pld.name}: R {pld.value.toLocaleString('en-ZA')}
          </div>
        ))}
      </div>
    );
  }
  return null;
};

const MultiYearSalesGraph = ({ salesData, years }) => {
    const colors = ['#8884d8', '#3b82f6', '#22c55e', '#f59e0b', '#ef4444'];

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full">
            <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                <TrendingUp size={20} className="text-green-400"/>
                Historical Sales Performance
            </h3>
            <ResponsiveContainer width="100%" height={350}>
                <LineChart data={salesData} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#4b556330" />
                    <XAxis dataKey="name" stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} />
                    <YAxis stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `R${value/1000}k`} />
                    <Tooltip content={<CustomTooltip />} cursor={{fill: 'rgba(107, 114, 128, 0.1)'}}/>
                    <Legend />
                    {years.map((year, index) => (
                        <Line 
                            key={year}
                            type="monotone" 
                            dataKey={year} 
                            stroke={colors[index % colors.length]} 
                            strokeWidth={2} 
                            name={`Sales ${year}`} 
                            dot={false}
                        />
                    ))}
                </LineChart>
            </ResponsiveContainer>
        </div>
    );
};

export default MultiYearSalesGraph;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\PerformanceLeaderboard.jsx
==================================================
// src/components/intelligence/PerformanceLeaderboard.jsx

import React, { useMemo } from 'react';
import { Link } from 'react-router-dom';
import { Star, AlertTriangle } from 'lucide-react'; // Import AlertTriangle

const SortButton = ({ label, active, onClick }) => (
    <button
        onClick={onClick}
        className={`px-4 py-2 text-sm font-semibold rounded-md transition-colors flex items-center gap-2 ${
             active
                ? 'bg-blue-600 text-white shadow-md'
                : 'bg-gray-700/50 text-gray-300 hover:bg-gray-600'
        }`}
    >
        {label}
    </button>
);

const getRankColor = (rank) => {
    switch (rank) {
        case 1: return 'border-yellow-400 bg-yellow-400/10';
        case 2: return 'border-gray-400 bg-gray-400/10';
        case 3: return 'border-orange-500 bg-orange-500/10';
        default: return 'border-gray-700';
    }
};

const PerformanceLeaderboard = ({ employees, activeSortKey, setActiveSortKey }) => {
    const sortConfig = {
        ops: { direction: 'desc', label: 'OPS', unit: '' },
        netValueAdded: { direction: 'desc', label: 'Net Value', unit: 'R' },
        avgEfficiency: { direction: 'desc', label: 'Efficiency', unit: '%' },
        reworkRate: { direction: 'asc', label: 'Rework Rate', unit: '%' },
        jobsCompleted: { direction: 'desc', label: 'Jobs Done', unit: '' },
    };

    const sortedEmployees = useMemo(() => {
        if (!employees) return [];
        const key = activeSortKey;
        const direction = sortConfig[key]?.direction || 'desc';
        return [...employees].sort((a, b) => {
            return direction === 'asc' ? a[key] - b[key] : b[key] - a[key];
        });
    }, [employees, activeSortKey]);

    const formatValue = (value, unit) => {
        if (typeof value !== 'number') return 'N/A';
        if (unit === '%') return `${Math.round(value)}%`;
        if (unit === 'R') return `R ${value.toFixed(2)}`;
        if (unit === '') return value.toFixed(1);
        return value;
    };

    return (
        <div>
            <div className="flex flex-wrap gap-2 mb-4">
                 <SortButton label={<><Star size={16}/> Rank by OPS</>} active={activeSortKey === 'ops'} onClick={() => setActiveSortKey('ops')} />
                <SortButton label="Rank by Net Value" active={activeSortKey === 'netValueAdded'} onClick={() => setActiveSortKey('netValueAdded')} />
                <SortButton label="Rank by Efficiency" active={activeSortKey === 'avgEfficiency'} onClick={() => setActiveSortKey('avgEfficiency')} />
                <SortButton label="Rank by Quality" active={activeSortKey === 'reworkRate'} onClick={() => setActiveSortKey('reworkRate')} />
                <SortButton label="Rank by Volume" active={activeSortKey === 'jobsCompleted'} onClick={() => setActiveSortKey('jobsCompleted')} />
            </div>

            <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                {sortedEmployees.map((emp, index) => {
                    const rank = index + 1;
                    const rankColor = getRankColor(rank);
                    const value = emp[activeSortKey];
                    const unit = sortConfig[activeSortKey]?.unit || '';

                    return (
                        <div key={emp.id} className={`flex items-center p-3 rounded-lg border-l-4 transition-all ${rankColor}`}>
                             <span className="font-bold text-lg text-white w-8">{rank}.</span>
                            <div className="flex-grow">
                                <div className="flex items-center gap-2">
                                    <Link to={`/employee/${emp.id}`} className="font-semibold text-blue-400 hover:underline">
                                        {emp.name}
                                    </Link>
                                    {/* ** NEW: Kudos and Rework Icons ** */}
                                    {emp.kudosCount > 0 && <Star size={14} className="text-yellow-400" title={`${emp.kudosCount} Kudos Received`} />}
                                    {emp.reworkCount > 0 && <AlertTriangle size={14} className="text-red-400" title={`${emp.reworkCount} Reworks`} />}
                                </div>
                                <p className="text-xs text-gray-400">Department: {emp.departmentName || 'N/A'}</p>
                            </div>
                             <div className="text-right">
                                <p className="font-bold text-lg text-blue-400">{formatValue(value, unit)}</p>
                                <p className="text-xs text-gray-500">{sortConfig[activeSortKey]?.label}</p>
                            </div>
                         </div>
                    );
                })}
                 {sortedEmployees.length === 0 && (
                    <div className="text-center py-10 text-gray-500">
                        No employee data to display for the selected filter.
                    </div>
                 )}
            </div>
        </div>
    );
};

export default PerformanceLeaderboard;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\PerformanceSnapshot.jsx
==================================================
// src/components/intelligence/PerformanceSnapshot.jsx

import React, { useMemo } from 'react';
import { TrendingUp, AlertTriangle } from 'lucide-react';

const Insight = ({ text, type }) => {
    const config = {
        opportunity: {
            icon: <TrendingUp size={18} className="text-green-400" />,
            textColor: 'text-gray-300'
        },
        alert: {
            icon: <AlertTriangle size={18} className="text-red-400" />,
            textColor: 'text-gray-300'
        }
    };
    const current = config[type] || config.alert;

    return (
        <li className="flex items-start space-x-3">
            <div className="flex-shrink-0 mt-1">{current.icon}</div>
            <p className={`text-sm ${current.textColor}`}>{text}</p>
        </li>
    );
};

const PerformanceSnapshot = ({ metrics }) => {
    const insights = useMemo(() => {
        if (!metrics) return [];

        const {
            individual,
            team,
        } = metrics;

        const results = [];

        if (individual.efficiency > team.efficiency * 1.1) {
            results.push({ text: `Efficiency (${individual.efficiency.toFixed(0)}%) is significantly above the team average of ${team.efficiency.toFixed(0)}%.`, type: 'opportunity' });
        } else if (individual.efficiency < team.efficiency * 0.9) {
            results.push({ text: `Efficiency (${individual.efficiency.toFixed(0)}%) is below the team average of ${team.efficiency.toFixed(0)}%.`, type: 'alert' });
        }

        if (individual.reworkRate > team.reworkRate + 5) {
            results.push({ text: `Rework Rate (${individual.reworkRate.toFixed(1)}%) is higher than the team average of ${team.reworkRate.toFixed(1)}%.`, type: 'alert' });
        } else if (individual.reworkRate < Math.max(team.reworkRate / 2, 0.5)) {
            results.push({ text: `This employee maintains an excellent quality score with a Rework Rate of just ${individual.reworkRate.toFixed(1)}%.`, type: 'opportunity' });
        }

        if (individual.netValueAdded > team.netValueAdded * 1.2) {
            results.push({ text: `This employee is a top value generator, adding R ${individual.netValueAdded.toFixed(0)} compared to the team average of R ${team.netValueAdded.toFixed(0)}.`, type: 'opportunity' });
        } else if (individual.netValueAdded < team.netValueAdded * 0.8) {
             results.push({ text: `Net Value Added (R ${individual.netValueAdded.toFixed(0)}) is lower than the team average (R ${team.netValueAdded.toFixed(0)}).`, type: 'alert' });
        }
        
        return results;

    }, [metrics]);

    return (
        <div className="bg-gray-800/50 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Coach's Corner</h3>
            {insights.length > 0 ? (
                <ul className="space-y-3">
                    {insights.map((insight, index) => (
                        <Insight key={index} text={insight.text} type={insight.type} />
                    ))}
                </ul>
            ) : (
                <p className="text-gray-400 text-sm">This employee is performing consistently with the team average.</p>
            )}
        </div>
    );
};

export default PerformanceSnapshot;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\PraiseModal.jsx
==================================================
// src/components/intelligence/PraiseModal.jsx

import React, { useState } from 'react';
import Button from '../ui/Button';
import Textarea from '../ui/Textarea';
import Dropdown from '../ui/Dropdown';
import { X, Send } from 'lucide-react';
import toast from 'react-hot-toast';

const PraiseModal = ({ allEmployees, currentUser, onSubmit, onClose }) => {
    const [recipientId, setRecipientId] = useState('');
    const [message, setMessage] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);

    // Filter out the current user from the list of recipients
    const recipientOptions = allEmployees.filter(emp => emp.id !== currentUser.uid);

    const handleSubmit = async () => {
        if (!recipientId || !message.trim()) {
            return toast.error("Please select a recipient and write a message.");
        }
        setIsSubmitting(true);
        try {
            const recipient = allEmployees.find(emp => emp.id === recipientId);
            await onSubmit({
                senderId: currentUser.uid,
                senderName: currentUser.email, // Or a display name if available
                recipientId: recipientId,
                recipientName: recipient.name,
                message: message,
            });
            toast.success("Praise sent successfully!");
            onClose();
        } catch (error) {
            console.error("Failed to send praise:", error);
            toast.error("Could not send praise. Please try again.");
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white">Give Praise to a Colleague</h3>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>
                <div className="p-6 space-y-4">
                    <Dropdown
                        label="Send Praise To"
                        options={recipientOptions}
                        value={recipientId}
                        onChange={(e) => setRecipientId(e.target.value)}
                        placeholder="Select an employee..."
                    />
                    <Textarea
                        label="Your Message"
                        value={message}
                        onChange={(e) => setMessage(e.target.value)}
                        placeholder="e.g., 'Thanks for your help with the XYZ job, you saved the day!'"
                        rows={4}
                    />
                </div>
                <div className="p-4 bg-gray-900/50 flex justify-end gap-2">
                    <Button onClick={onClose} variant="secondary">Cancel</Button>
                    <Button onClick={handleSubmit} variant="primary" disabled={isSubmitting}>
                        <Send size={16} className="mr-2" />
                        {isSubmitting ? 'Sending...' : 'Send Praise'}
                    </Button>
                </div>
            </div>
        </div>
    );
};

export default PraiseModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\PraiseWidget.jsx
==================================================
// src/components/intelligence/PraiseWidget.jsx

import React from 'react';
import { ThumbsUp } from 'lucide-react';
import moment from 'moment';

const PraiseWidget = ({ praiseItems, loading }) => {
    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Praise & Recognition</h3>
            {loading && <p className="text-gray-400">Loading praise...</p>}
            {!loading && praiseItems.length === 0 && (
                <p className="text-sm text-gray-500 text-center py-4">No praise received yet. Keep up the great work!</p>
            )}
            {!loading && praiseItems.length > 0 && (
                <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                    {praiseItems.map(item => (
                        <div key={item.id} className="bg-gray-700/50 p-4 rounded-lg">
                            <blockquote className="text-gray-200 italic border-l-4 border-blue-500 pl-4">
                                "{item.message}"
                            </blockquote>
                            <div className="text-right text-sm text-gray-400 mt-2 flex justify-end items-center gap-2">
                                <ThumbsUp size={14} />
                                <span>- {item.senderName}</span>
                                <span className="text-xs text-gray-500">({moment(item.createdAt?.toDate()).fromNow()})</span>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

export default PraiseWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\ProfitTargetMatrix.jsx
==================================================
// src/components/intelligence/ProfitTargetMatrix.jsx (NEW FILE)
import React, { useMemo } from 'react';
import { Target, TrendingUp } from 'lucide-react';

const TargetCard = ({ percent, targetSales, profitAmount, isBreakEven = false }) => {
    const cardColor = isBreakEven ? 'bg-gray-700/50' : 'bg-gray-900/50';
    const textColor = isBreakEven ? 'text-green-400' : 'text-blue-400';

    return (
        <div className={`p-4 rounded-lg flex flex-col items-center text-center ${cardColor}`}>
            <p className={`font-bold text-lg flex items-center gap-2 ${textColor}`}>
                <Target size={20} />
                {percent}% Net Profit
            </p>
            <p className="text-3xl font-bold text-white font-mono mt-2">
                R {targetSales.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
            </p>
            <p className="text-sm text-gray-400">Required Sales</p>
            
            <div className="w-full h-px bg-gray-600 my-3"></div>

            <p className="text-xl font-bold text-green-400 font-mono">
                + R {profitAmount.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
            </p>
            <p className="text-xs text-gray-500">Projected Profit</p>
        </div>
    );
};

const ProfitTargetMatrix = ({ totalFixedCosts, historicalGrossMargin }) => {

    const profitTargets = useMemo(() => {
        if (historicalGrossMargin <= 0) return [];
        
        const grossMarginDecimal = historicalGrossMargin / 100;

        return [0, 10, 20, 30, 40].map(profitPercent => {
            const netMarginDecimal = profitPercent / 100;
            
            if (grossMarginDecimal <= netMarginDecimal) {
                 return {
                    percent: profitPercent,
                    target: Infinity,
                    profitAmount: Infinity,
                };
            }

            const requiredSales = totalFixedCosts / (grossMarginDecimal - netMarginDecimal);
            const projectedProfit = (requiredSales * netMarginDecimal);

            return {
                percent: profitPercent,
                target: requiredSales,
                profitAmount: projectedProfit,
            };
        });
    }, [totalFixedCosts, historicalGrossMargin]);

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">
                Monthly Sales & Profit Targets
            </h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                {profitTargets.map((target) => (
                    target.target === Infinity
                    ? <div key={target.percent} className="p-4 rounded-lg flex flex-col items-center justify-center text-center bg-red-900/50">
                        <p className="font-bold text-lg text-red-400">{target.percent}% Net Profit</p>
                        <p className="text-sm text-red-300 mt-4">Target is unachievable with current Gross Margin.</p>
                      </div>
                    : <TargetCard 
                        key={target.percent}
                        percent={target.percent}
                        targetSales={target.target}
                        profitAmount={target.profitAmount}
                        isBreakEven={target.percent === 0}
                    />
                ))}
            </div>
             <p className="text-xs text-gray-500 mt-4 text-center pt-2 border-t border-gray-700">
                Targets are calculated based on your historical gross margin of **{historicalGrossMargin.toFixed(1)}%** and total fixed costs.
            </p>
        </div>
    );
};

export default ProfitTargetMatrix;




==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\RealTimeValueWidget.jsx
==================================================
// src/components/intelligence/RealTimeValueWidget.jsx

import React, { useMemo } from 'react';
import { TrendingUp, TrendingDown } from 'lucide-react';

const RealTimeValueWidget = ({ jobs, employee, overheadCostPerHour }) => {
    const metrics = useMemo(() => {
        if (!employee || !jobs || jobs.length === 0) {
            return {
                burdenedRate: 0,
                valueGeneratedPerHour: 0,
                profitabilityRatio: 0,
                totalValueGenerated: 0,
                totalHoursWorked: 0
            };
        }

        const completedJobs = jobs.filter(j => j.status === 'Complete' && j.startedAt && j.completedAt);

        if (completedJobs.length === 0) {
            return {
                burdenedRate: (employee.hourlyRate || 0) + overheadCostPerHour,
                valueGeneratedPerHour: 0,
                profitabilityRatio: 0,
                totalValueGenerated: 0,
                totalHoursWorked: 0
            };
        }

        const { totalValue, totalSeconds } = completedJobs.reduce(
            (acc, job) => {
                const durationSeconds = (job.completedAt.toDate().getTime() - job.startedAt.toDate().getTime() - (job.totalPausedMilliseconds || 0)) / 1000;
                acc.totalValue += job.totalCost || 0;
                acc.totalSeconds += durationSeconds > 0 ? durationSeconds : 0;
                return acc;
            },
            { totalValue: 0, totalSeconds: 0 }
        );

        const totalHours = totalSeconds / 3600;
        const burdenedRate = (employee.hourlyRate || 0) + overheadCostPerHour;
        const valueGeneratedPerHour = totalHours > 0 ? totalValue / totalHours : 0;
        const profitabilityRatio = burdenedRate > 0 ? valueGeneratedPerHour / burdenedRate : 0;

        return {
            burdenedRate,
            valueGeneratedPerHour,
            profitabilityRatio,
            totalValueGenerated: totalValue,
            totalHoursWorked: totalHours
        };
    }, [jobs, employee, overheadCostPerHour]);

    const isProfitable = metrics.profitabilityRatio >= 1.0;
    const colorClasses = isProfitable
        ? "bg-green-500/10 text-green-400 border-green-500/30"
        : "bg-red-500/10 text-red-400 border-red-500/30";

    return (
        <div className={`p-6 rounded-lg border ${colorClasses}`}>
            <h3 className="text-xl font-bold text-white mb-4">Real-Time Value Engine</h3>
            <div className="flex flex-col items-center justify-center space-y-4">
                <div className="text-center">
                    <p className="text-sm text-gray-400">Profitability Ratio</p>
                    <p className={`text-6xl font-bold ${isProfitable ? 'text-green-400' : 'text-red-400'}`}>
                        {metrics.profitabilityRatio.toFixed(2)}x
                    </p>
                    <p className="text-xs text-gray-500">
                        (Value Generated per Hour / Cost per Hour)
                    </p>
                </div>

                <div className="w-full grid grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                    <div className="text-center">
                        <p className="text-sm text-gray-400">Value Generated/hr</p>
                        <p className="text-lg font-semibold text-white">
                            R {metrics.valueGeneratedPerHour.toFixed(2)}
                        </p>
                    </div>
                    <div className="text-center">
                        <p className="text-sm text-gray-400">Burdened Cost/hr</p>
                        <p className="text-lg font-semibold text-white">
                            R {metrics.burdenedRate.toFixed(2)}
                        </p>
                    </div>
                </div>

                {isProfitable ? (
                    <div className="flex items-center text-sm text-green-400">
                        <TrendingUp size={16} className="mr-1" />
                        <span>This employee is generating more value than their cost.</span>
                    </div>
                ) : (
                    <div className="flex items-center text-sm text-red-400">
                        <TrendingDown size={16} className="mr-1" />
                        <span>This employee is currently not covering their cost.</span>
                    </div>
                )}
            </div>
        </div>
    );
};

export default RealTimeValueWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\ReliabilityReport.jsx
==================================================
// src/components/intelligence/ReliabilityReport.jsx
import React, { useState, useEffect, useMemo } from 'react';
import { collection, query, where, getDocs, orderBy } from 'firebase/firestore';
import { db } from '../../api/firebase';
import Button from '../ui/Button';
import { Clock, UserCheck } from 'lucide-react';

const KpiCard = ({ title, value, unit }) => (
    <div className="bg-gray-900/50 p-4 rounded-lg text-center">
        <p className="text-sm text-gray-400">{title}</p>
        <p className="text-3xl font-bold text-white">
            {value} <span className="text-xl text-gray-400">{unit}</span>
        </p>
    </div>
);

const checkPunctuality = (date, startTime, endTime) => {
    const dayOfWeek = date.getDay();
    if (dayOfWeek === 0 || dayOfWeek === 6) {
        return { isLate: false, leftEarly: false, minutesLate: 0 };
    }
    
    const standardStartTime = new Date(date.getTime());
    standardStartTime.setHours(7, 0, 0, 0);

    const standardEndTime = new Date(date.getTime());
    if (dayOfWeek >= 1 && dayOfWeek <= 4) { 
        standardEndTime.setHours(17, 0, 0, 0);
    } else { 
        standardEndTime.setHours(15, 45, 0, 0);
    }

    const isLate = startTime > standardStartTime;
    const leftEarly = endTime < standardEndTime;

    let minutesLate = 0;
    if (isLate) {
        minutesLate = (startTime.getTime() - standardStartTime.getTime()) / (1000 * 60);
    }

    return { isLate, leftEarly, minutesLate: Math.max(0, minutesLate) };
};


const ReliabilityReport = ({ employeeId }) => {
    const [timeEntries, setTimeEntries] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filter, setFilter] = useState('month');

    useEffect(() => {
        const fetchScanEventData = async () => {
            if (!employeeId) return;
            setLoading(true);
            try {
                const scanEventsQuery = query(
                    collection(db, 'scanEvents'),
                    where('employeeId', '==', employeeId),
                    orderBy('timestamp', 'asc')
                );
                const snapshot = await getDocs(scanEventsQuery);
                const events = snapshot.docs.map(doc => ({ ...doc.data(), timestamp: doc.data().timestamp.toDate() }));

                const dailyScans = {};
                for (const event of events) {
                    const dateStr = event.timestamp.toISOString().split('T')[0];
                    if (!dailyScans[dateStr]) {
                        dailyScans[dateStr] = {
                            date: new Date(dateStr),
                            scans: []
                        };
                    }
                    dailyScans[dateStr].scans.push(event.timestamp);
                }

                const processedEntries = Object.values(dailyScans).map(dayData => {
                    if (dayData.scans.length === 0) return null;
                    const firstScan = dayData.scans[0];
                    const lastScan = dayData.scans[dayData.scans.length - 1];
                    const punctuality = checkPunctuality(dayData.date, firstScan, lastScan);
                    return {
                        date: dayData.date,
                        ...punctuality
                    };
                }).filter(Boolean);

                setTimeEntries(processedEntries);

            } catch (err) {
                console.error("Error fetching scan event data for reliability report:", err);
            }
            setLoading(false);
        };
        fetchScanEventData();
    }, [employeeId]);

    const filteredMetrics = useMemo(() => {
        const now = new Date();
        let startDate;

        if (filter === 'week') {
            const dayOfWeek = now.getDay();
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); 
            startDate = new Date(now.setDate(diff));
            startDate.setHours(0, 0, 0, 0);
        } else if (filter === 'month') {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        } else {
            startDate = new Date(now.getFullYear(), 0, 1);
        }

        const filtered = timeEntries.filter(entry => entry.date >= startDate);

        let daysLate = 0;
        let daysLeftEarly = 0;
        let totalMinutesLate = 0;

        filtered.forEach(entry => {
            if (entry.isLate) {
                daysLate++;
                totalMinutesLate += entry.minutesLate;
            }
            if (entry.leftEarly) {
                daysLeftEarly++;
            }
        });

        return { daysLate, daysLeftEarly, totalMinutesLate };
    }, [timeEntries, filter]);

    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold text-white flex items-center gap-2">
                    <UserCheck size={20} className="text-teal-400" />
                    Reliability Report
                </h3>
                <div className="flex gap-1 bg-gray-700 p-1 rounded-lg">
                    <Button onClick={() => setFilter('week')} variant={filter === 'week' ? 'primary' : 'secondary'} className="py-1 px-3 text-xs">This Week</Button>
                    <Button onClick={() => setFilter('month')} variant={filter === 'month' ? 'primary' : 'secondary'} className="py-1 px-3 text-xs">This Month</Button>
                    <Button onClick={() => setFilter('year')} variant={filter === 'year' ? 'primary' : 'secondary'} className="py-1 px-3 text-xs">This Year</Button>
                </div>
            </div>
            {loading ? (
                <p className="text-gray-400">Loading reliability data...</p>
            ) : timeEntries.length === 0 ? (
                 <p className="text-gray-500 text-center py-4">No scan event data found for this employee.</p>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <KpiCard title="Days Late" value={filteredMetrics.daysLate} unit="days" />
                    <KpiCard title="Days Left Early" value={filteredMetrics.daysLeftEarly} unit="days" />
                    <KpiCard title="Total Minutes Late" value={Math.round(filteredMetrics.totalMinutesLate)} unit="mins" />
                </div>
            )}
        </div>
    );
};

export default ReliabilityReport;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\ReworkAnalysisModal.jsx
==================================================
// src/components/intelligence/ReworkAnalysisModal.jsx

import React, { useMemo } from 'react';
import { X } from 'lucide-react';
import Button from '../ui/Button';

const ReworkAnalysisModal = ({ jobs, employeeName, onClose }) => {
    const analysis = useMemo(() => {
        if (!jobs) return {};
        
        const issueJobs = jobs.filter(job => job.status === 'Issue' || job.status === 'Archived - Issue');
        
        const reasons = issueJobs.reduce((acc, job) => {
            const reason = job.issueReason || 'No Reason Provided';
            acc[reason] = (acc[reason] || 0) + 1;
            return acc;
        }, {});

        return Object.entries(reasons).sort(([, a], [, b]) => b - a);

    }, [jobs]);

    return (
        <div 
            onClick={onClose}
            className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in"
        >
            <div 
                onClick={(e) => e.stopPropagation()}
                className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg max-h-[80vh] flex flex-col"
            >
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <div>
                        <h2 className="text-xl font-bold text-white">Root Cause Analysis</h2>
                        <p className="text-sm text-gray-400">For {employeeName}</p>
                    </div>
                    <Button onClick={onClose} variant="secondary" className="p-2">
                        <X size={20} />
                    </Button>
                </div>

                <div className="p-6 overflow-y-auto space-y-3">
                    {analysis.length > 0 ? (
                        analysis.map(([reason, count]) => (
                            <div key={reason} className="flex justify-between items-center bg-gray-700/50 p-3 rounded-lg">
                                <span className="font-medium text-gray-200">{reason}</span>
                                <span className="font-bold text-lg text-red-400">{count} {count > 1 ? 'times' : 'time'}</span>
                            </div>
                        ))
                    ) : (
                        <p className="text-center text-gray-500 py-8">This employee has no jobs with recorded issues.</p>
                    )}
                </div>
            </div>
        </div>
    );
};

export default ReworkAnalysisModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\RoiCalculator.jsx
==================================================
import React, { useState, useMemo } from 'react';
import Input from '../ui/Input';
import Button from '../ui/Button';
import Dropdown from '../ui/Dropdown';
import { X, DollarSign, Clock, Package, TrendingUp } from 'lucide-react';

const RoiResultCard = ({ title, value, color }) => (
    <div className={`p-4 rounded-lg text-center ${color}`}>
        <p className="text-sm font-medium">{title}</p>
        <p className="text-3xl font-bold">{value}</p>
    </div>
);

const RoiCalculator = ({ onClose, averageBurdenedRate, allProducts, allRecipes, inventoryItems }) => {
    const [inputs, setInputs] = useState({
        investmentCost: '',
        laborSavingsHours: '',
        throughputIncreaseUnits: '',
        selectedProductId: ''
    });

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setInputs(prev => ({ ...prev, [name]: value }));
    };

    const calculation = useMemo(() => {
        const investment = parseFloat(inputs.investmentCost) || 0;
        const laborSavingsPerWeek = (parseFloat(inputs.laborSavingsHours) || 0) * averageBurdenedRate;
        const annualLaborSavings = laborSavingsPerWeek * 52;

        let annualThroughputValue = 0;
        if (inputs.selectedProductId && inputs.throughputIncreaseUnits > 0) {
            const product = allProducts.find(p => p.id === inputs.selectedProductId);
            if (product) {
                const productRecipes = allRecipes.filter(r => r.productId === product.id);
                const inventoryMap = new Map(inventoryItems.map(item => [item.id, item]));
                
                let totalMaterialCost = 0;
                let totalLaborCost = 0;

                productRecipes.forEach(recipe => {
                    totalMaterialCost += (recipe.consumables || []).reduce((sum, consumable) => {
                        const inventoryItem = inventoryMap.get(consumable.itemId);
                        return sum + ((inventoryItem?.price || 0) * (consumable.quantity || 0));
                    }, 0);
                    totalLaborCost += (recipe.estimatedTime || 0) / 60 * averageBurdenedRate;
                });
                
                const unitCost = totalMaterialCost + totalLaborCost;
                const unitProfit = (product.sellingPrice || 0) - unitCost;
                annualThroughputValue = unitProfit * (parseFloat(inputs.throughputIncreaseUnits) || 0) * 12;
            }
        }
        
        const totalAnnualGains = annualLaborSavings + annualThroughputValue;
        const roiYears = investment > 0 && totalAnnualGains > 0 ? investment / totalAnnualGains : 0;

        return {
            investment,
            annualLaborSavings,
            annualThroughputValue,
            totalAnnualGains,
            roiYears
        };
    }, [inputs, averageBurdenedRate, allProducts, allRecipes, inventoryItems]);

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold text-white">Business Case & ROI Calculator</h2>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>

                <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto">
                    {/* Input Section */}
                    <div className="space-y-4">
                        <h3 className="font-semibold text-lg text-white">Investment Details</h3>
                        <Input label="Total Investment Cost (R)" name="investmentCost" type="number" value={inputs.investmentCost} onChange={handleInputChange} placeholder="e.g., 800000" />
                        
                        <h3 className="font-semibold text-lg text-white pt-4 border-t border-gray-700">Projected Gains</h3>
                        <Input label="Labor Savings (Hours per Week)" name="laborSavingsHours" type="number" value={inputs.laborSavingsHours} onChange={handleInputChange} placeholder="e.g., 10" />
                        
                        <div className="grid grid-cols-2 gap-4">
                            <Dropdown label="Product for Throughput" name="selectedProductId" options={allProducts} value={inputs.selectedProductId} onChange={handleInputChange} placeholder="Select product..." />
                            <Input label="Increased Throughput (Units per Month)" name="throughputIncreaseUnits" type="number" value={inputs.throughputIncreaseUnits} onChange={handleInputChange} placeholder="e.g., 50" />
                        </div>
                    </div>

                    {/* Results Section */}
                    <div className="bg-gray-800/50 p-6 rounded-lg space-y-4">
                        <h3 className="font-semibold text-lg text-white text-center">Projected Financial Impact</h3>
                        <RoiResultCard title="Annual Labor Savings" value={`R ${calculation.annualLaborSavings.toLocaleString('en-ZA', {maximumFractionDigits: 0})}`} color="bg-blue-600/20" />
                        <RoiResultCard title="Annual Throughput Profit" value={`R ${calculation.annualThroughputValue.toLocaleString('en-ZA', {maximumFractionDigits: 0})}`} color="bg-purple-600/20" />
                        <RoiResultCard title="Total Annual Gains" value={`R ${calculation.totalAnnualGains.toLocaleString('en-ZA', {maximumFractionDigits: 0})}`} color="bg-green-600/20" />
                        
                        <div className="pt-4 border-t border-gray-700 text-center">
                             <p className="text-sm text-gray-400">Return on Investment (ROI)</p>
                             <p className="text-5xl font-bold text-white mt-1">{calculation.roiYears > 0 ? `${calculation.roiYears.toFixed(2)}` : '0.00'}<span className="text-2xl text-gray-400 ml-2">years</span></p>
                        </div>
                    </div>
                </div>
                 <div className="p-4 bg-gray-800 border-t border-gray-700">
                    <p className="text-center text-sm text-gray-300">
                        "I am proposing a capital investment of <strong className="text-white">R{calculation.investment.toLocaleString('en-ZA')}</strong>. This will generate <strong className="text-white">R{calculation.totalAnnualGains.toLocaleString('en-ZA', {maximumFractionDigits: 0})}</strong> per year in savings and increased profit, delivering an ROI in under <strong className="text-white">{Math.ceil(calculation.roiYears)}</strong> years."
                    </p>
                </div>
            </div>
        </div>
    );
};

export default RoiCalculator;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\SalesTargetCalculator.jsx
==================================================
// src/components/intelligence/SalesTargetCalculator.jsx (UPGRADED)
import React, { useMemo } from 'react';
import { Target, DollarSign, TrendingUp } from 'lucide-react';

const TargetRow = ({ percent, targetSales, profitAmount, color }) => (
    <div className={`grid grid-cols-3 gap-4 items-center p-3 rounded-lg ${color}`}>
        <p className="font-bold text-lg flex items-center gap-2">
            <TrendingUp size={20} />
            {percent}% Profit Target
        </p>
        <p className="font-mono text-xl text-center">
            R {targetSales.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
        </p>
        <p className="font-mono text-lg text-right text-green-400">
            + R {profitAmount.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
        </p>
    </div>
);


const SalesTargetCalculator = ({ totalFixedCosts, historicalGrossMargin }) => {

    const profitTargets = useMemo(() => {
        if (historicalGrossMargin <= 0) return [];
        
        const marginDecimal = historicalGrossMargin / 100;
        const breakEvenSales = totalFixedCosts / marginDecimal;

        return [0, 10, 20, 30, 40].map(profitPercent => {
            const desiredProfitAmount = breakEvenSales * (profitPercent / 100);
            const requiredSales = (totalFixedCosts + desiredProfitAmount) / marginDecimal;
            return {
                percent: profitPercent,
                target: requiredSales,
                profitAmount: desiredProfitAmount,
            };
        });
    }, [totalFixedCosts, historicalGrossMargin]);

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <Target className="text-green-400" />
                Monthly Sales & Profit Targets
            </h3>
            <div className="space-y-3">
                 <div className="grid grid-cols-3 gap-4 px-3 text-sm font-semibold text-gray-400">
                    <span>Target Level</span>
                    <span className="text-center">Required Sales</span>
                    <span className="text-right">Projected Profit</span>
                </div>
                {profitTargets.map((target, index) => (
                    <TargetRow 
                        key={target.percent}
                        percent={target.percent}
                        targetSales={target.target}
                        profitAmount={target.profitAmount}
                        color={index === 0 ? 'bg-gray-700/50' : 'bg-gray-900/50'}
                    />
                ))}
                 <p className="text-xs text-gray-500 mt-2 text-center pt-2 border-t border-gray-700">
                    Targets are calculated based on your historical gross margin of {historicalGrossMargin.toFixed(1)}% and total fixed costs.
                </p>
            </div>
        </div>
    );
};

export default SalesTargetCalculator;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\SalesTrendWidget.jsx
==================================================
// src/components/intelligence/SalesTrendWidget.jsx (NEW FILE)
import React from 'react';
import { TrendingUp, TrendingDown, Minus } from 'lucide-react';

const SalesTrendWidget = ({ percentageChange }) => {
    
    const isPositive = percentageChange > 0;
    const isNegative = percentageChange < 0;

    const getTrendInfo = () => {
        if (isPositive) return {
            icon: <TrendingUp size={32} />,
            textColor: 'text-green-400',
            text: `${percentageChange.toFixed(1)}%`
        };
        if (isNegative) return {
            icon: <TrendingDown size={32} />,
            textColor: 'text-red-400',
            text: `${percentageChange.toFixed(1)}%`
        };
        return {
            icon: <Minus size={32} />,
            textColor: 'text-gray-400',
            text: `${percentageChange.toFixed(1)}%`
        };
    };
    
    const trend = getTrendInfo();

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col justify-center items-center">
            <p className="text-gray-400 text-sm font-medium mb-2">
                This Month's Sales vs. Last Year
            </p>
            <div className={`flex items-center space-x-3 ${trend.textColor}`}>
                {trend.icon}
                <span className="text-5xl font-bold">
                    {trend.text}
                </span>
            </div>
        </div>
    );
};

export default SalesTrendWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\SkillProgressionWidget.jsx
==================================================
// src/components/intelligence/SkillProgressionWidget.jsx (Upgraded with Toasts)
import React, { useState, useEffect } from 'react';
import { getSkillHistoryForEmployee, getSkills, deleteDocument } from '../../api/firestore';
import Button from '../ui/Button';
import { Trash2 } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const SkillProgressionWidget = ({ employeeId }) => {
    const [skillHistory, setSkillHistory] = useState([]);
    const [allSkills, setAllSkills] = useState([]);
    const [selectedSkillId, setSelectedSkillId] = useState('');
    const [loading, setLoading] = useState(true);

    const fetchData = async () => {
        if (!employeeId) return;
        setLoading(true);
        try {
            const [history, skills] = await Promise.all([
                getSkillHistoryForEmployee(employeeId),
                getSkills()
            ]);

            const sortedHistory = history.sort((a, b) => {
                const dateA = a.assessmentDate?.toDate() || 0;
                const dateB = b.assessmentDate?.toDate() || 0;
                return dateB - dateA;
            });

            setSkillHistory(sortedHistory);
            setAllSkills(skills);
            
            if (sortedHistory.length > 0) {
                const skillCounts = sortedHistory.reduce((acc, record) => {
                    acc[record.skillId] = (acc[record.skillId] || 0) + 1;
                    return acc;
                }, {});
                const mostFrequentSkill = Object.keys(skillCounts).sort((a, b) => skillCounts[b] - skillCounts[a])[0];
                setSelectedSkillId(mostFrequentSkill);
            }
        } catch (error) {
            console.error("Error fetching skill progression data:", error);
            toast.error("Could not load skill history.");
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchData();
    }, [employeeId]);

    const handleDeleteHistory = async (recordId) => {
        // --- REPLACED window.confirm with toast confirmation ---
        toast((t) => (
            <span>
                Delete this history record?
                <Button variant="danger" size="sm" className="ml-2" onClick={async () => {
                    toast.dismiss(t.id);
                    try {
                        await deleteDocument('skillHistory', recordId);
                        setSkillHistory(prev => prev.filter(record => record.id !== recordId));
                        toast.success("Record deleted.");
                    } catch (error) {
                        console.error("Error deleting history record:", error);
                        toast.error("Failed to delete record.");
                    }
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const filteredHistory = skillHistory.filter(record => record.skillId === selectedSkillId);

    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Skill Progression Tracker</h3>
            
            {loading ? (
                <p className="text-gray-400">Loading history...</p>
            ) : allSkills.length === 0 || skillHistory.length === 0 ? (
                <p className="text-gray-400">No skill history available for this employee yet.</p>
            ) : (
                <>
                    <div className="mb-4">
                        <label htmlFor="skill-select" className="block text-sm font-medium text-gray-300 mb-1">
                            Select a skill to see its progression:
                        </label>
                        <select
                            id="skill-select"
                            value={selectedSkillId}
                            onChange={(e) => setSelectedSkillId(e.target.value)}
                            className="bg-gray-900 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                        >
                            <option value="" disabled>-- Select a Skill --</option>
                            {allSkills
                                .filter(skill => skillHistory.some(h => h.skillId === skill.id))
                                .map(skill => (
                                <option key={skill.id} value={skill.id}>{skill.name}</option>
                            ))}
                        </select>
                    </div>

                    <div className="space-y-3">
                        {filteredHistory.length > 0 ? (
                            filteredHistory.map(record => (
                                <div key={record.id} className="flex justify-between items-center bg-gray-900/50 p-3 rounded-md">
                                    <div className="flex flex-col">
                                        <p className="font-semibold text-blue-400">{record.proficiency}</p>
                                        <p className="text-gray-500 text-xs">
                                            {record.assessmentDate ? new Date(record.assessmentDate.toDate()).toLocaleString() : 'Date unknown'}
                                        </p>
                                    </div>
                                    <Button onClick={() => handleDeleteHistory(record.id)} variant="icon" className="text-red-500 hover:text-red-400">
                                        <Trash2 size={18} />
                                    </Button>
                                </div>
                            ))
                        ) : (
                            <p className="text-gray-400">Please select a skill to view its history.</p>
                        )}
                    </div>
                </>
            )}
        </div>
    );
};

export default SkillProgressionWidget;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\TopReworkCausesWidget.jsx
==================================================
// src/components/intelligence/TopReworkCausesWidget.jsx
import React from 'react';
import { AlertCircle } from 'lucide-react';

const TopReworkCausesWidget = ({ data }) => {
    if (!data || data.length === 0) {
        return (
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col">
                <h3 className="font-bold text-white mb-4 flex items-center">
                    <AlertCircle size={20} className="mr-2 text-orange-400"/>
                    Top Rework Causes
                </h3>
                <div className="flex-grow flex items-center justify-center">
                    <p className="text-gray-500 text-sm">No jobs with issues recorded yet.</p>
                </div>
            </div>
        );
    }

    const maxCount = Math.max(...data.map(([, count]) => count), 1);

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="font-bold text-white mb-4 flex items-center">
                <AlertCircle size={20} className="mr-2 text-orange-400"/>
                Top Rework Causes
            </h3>
            <div className="space-y-3">
                {data.map(([reason, count]) => (
                    <div key={reason} className="space-y-1">
                        <div className="flex justify-between items-center text-sm">
                            <p className="text-gray-300 truncate font-medium" title={reason}>{reason}</p>
                            <p className="text-white font-semibold">{count}</p>
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-2.5">
                            <div
                                className="bg-orange-500 h-2.5 rounded-full transition-all duration-500"
                                style={{ width: `${(count / maxCount) * 100}%` }}
                            ></div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default TopReworkCausesWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\TrophyCase.jsx
==================================================
// src/components/intelligence/TrophyCase.jsx
import React from 'react';
import { Award, Zap, ShieldCheck, Star, Gem } from 'lucide-react';

const Badge = ({ icon, label, color, description }) => (
    <div className="flex flex-col items-center text-center p-4 bg-gray-800 rounded-lg border border-gray-700" title={description}>
        <div className={`p-3 rounded-full ${color}`}>
            {icon}
        </div>
        <p className="mt-2 text-sm font-semibold text-white">{label}</p>
    </div>
);

const TrophyCase = ({ badges }) => {
    if (badges.length === 0) {
        return null;
    }

    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <Award size={20} className="text-yellow-400" />
                Trophy Case
            </h3>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                {badges.map(badge => (
                    <Badge key={badge.id} {...badge} />
                ))}
            </div>
        </div>
    );
};

export default TrophyCase;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\ValueWasteAnalysis.jsx
==================================================
// src/components/intelligence/ValueWasteAnalysis.jsx
import React, { useMemo } from 'react';
import { BarChart, Bar, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const ValueWasteAnalysis = ({ jobs }) => {
    const timeAnalysisData = useMemo(() => {
        if (!jobs || jobs.length === 0) {
            return { valueAddedHours: 0, nonValueHours: 0, wastedHours: 0 };
        }

        let valueAddedSeconds = 0;
        let nonValueSeconds = 0; // Paused time
        let wastedSeconds = 0;

        jobs.forEach(job => {
            if (!job.startedAt || !job.completedAt) return;

            const startTime = job.startedAt.toDate().getTime();
            const completionTime = job.completedAt.toDate().getTime();
            const totalDurationSeconds = (completionTime - startTime) / 1000;
            const pauseDurationSeconds = (job.totalPausedMilliseconds || 0) / 1000;
            const actualWorkSeconds = totalDurationSeconds - pauseDurationSeconds;

            if (actualWorkSeconds < 0) return;

            if (job.status === 'Complete') {
                valueAddedSeconds += actualWorkSeconds;
                nonValueSeconds += pauseDurationSeconds;
            } else if (job.status === 'Issue' || job.status === 'Archived - Issue') {
                wastedSeconds += actualWorkSeconds;
                nonValueSeconds += pauseDurationSeconds;
            }
        });

        return {
            valueAddedHours: valueAddedSeconds / 3600,
            nonValueHours: nonValueSeconds / 3600,
            wastedHours: wastedSeconds / 3600,
        };
    }, [jobs]);

    const chartData = [
        {
            name: 'Time Allocation',
            valueAdded: timeAnalysisData.valueAddedHours,
            paused: timeAnalysisData.nonValueHours,
            wasted: timeAnalysisData.wastedHours,
        }
    ];

    const totalHours = timeAnalysisData.valueAddedHours + timeAnalysisData.nonValueHours + timeAnalysisData.wastedHours;
    if (totalHours === 0) {
        return (
             <div className="bg-gray-800/50 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4">Value vs. Waste Analysis</h3>
                <p className="text-gray-500 text-center py-10">Not enough job history to analyze time allocation.</p>
            </div>
        )
    }

    return (
        <div className="bg-gray-800/50 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4">Value vs. Waste Analysis (Total Hours Logged)</h3>
            <ResponsiveContainer width="100%" height={150}>
                <BarChart data={chartData} layout="vertical" stackOffset="expand">
                    <XAxis type="number" hide domain={[0, 1]} />
                    <YAxis type="category" dataKey="name" hide />
                    <Tooltip 
                        formatter={(value, name) => [`${(value * 100).toFixed(1)}%`, name]}
                        contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #4b5563' }}
                    />
                    <Legend
                        formatter={(value, entry) => {
                            const { dataKey, color } = entry;
                            const hours = chartData[0][dataKey];
                            return <span style={{ color }}>{value} ({hours.toFixed(1)} hrs)</span>;
                        }}
                        iconType="circle"
                    />
                    <Bar dataKey="valueAdded" name="Value-Added Time" stackId="a" fill="#22c55e" />
                    <Bar dataKey="paused" name="Non-Value Time (Paused)" stackId="a" fill="#eab308" />
                    <Bar dataKey="wasted" name="Wasted Time (Issues)" stackId="a" fill="#ef4444" />
                </BarChart>
            </ResponsiveContainer>
        </div>
    );
};

export default ValueWasteAnalysis;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\WorkforceCapacityPlanner.jsx
==================================================
// src/components/intelligence/WorkforceCapacityPlanner.jsx (UPDATED with Gross Margin)
import React, { useState, useEffect, useMemo } from 'react';
import Input from '../ui/Input';
import Button from '../ui/Button';
import { TrendingUp, Users, Zap, DollarSign, PlusCircle, Trash2, Percent } from 'lucide-react';

const EmployeeRow = ({ employee, onRemove }) => (
    <div className="grid grid-cols-4 gap-4 items-center p-2 bg-gray-700/50 rounded-lg">
        <p className="text-white font-medium truncate">{employee.name}</p>
        <p className="text-gray-300 font-mono text-center">R {employee.hourlyRate.toFixed(2)}</p>
        <p className={`font-bold text-center ${employee.efficiency >= 100 ? 'text-green-400' : 'text-yellow-400'}`}>
            {employee.efficiency.toFixed(0)}%
        </p>
        {onRemove && (
            <div className="text-right">
                <Button onClick={onRemove} variant="danger" size="sm" className="p-1 h-7 w-7">
                    <Trash2 size={14} />
                </Button>
            </div>
        )}
    </div>
);

const WorkforceCapacityPlanner = ({ realEmployees, jobs }) => {
    const [scenario, setScenario] = useState({
        targetSales: '',
        overheads: '',
        grossMargin: '35', // NEW: Added Gross Margin with a default of 35%
    });
    const [simulatedEmployees, setSimulatedEmployees] = useState([]);
    const [newSimEmployee, setNewSimEmployee] = useState({ name: 'Sim Employee', hourlyRate: '150', efficiency: '95' });

    const allEmployeesInScenario = useMemo(() => {
        return [...realEmployees, ...simulatedEmployees];
    }, [realEmployees, simulatedEmployees]);

    const results = useMemo(() => {
        const targetSales = parseFloat(scenario.targetSales) || 0;
        const overheads = parseFloat(scenario.overheads) || 0;
        const grossMargin = parseFloat(scenario.grossMargin) || 0;

        if (targetSales === 0) return { requiredValue: 0, availableValue: 0, netProfit: 0, requiredEmployees: 'N/A' };

        // 1. Calculate Gross Profit based on the user's input margin
        const grossProfit = targetSales * (grossMargin / 100);

        // 2. Calculate Net Profit by subtracting overheads
        const netProfit = grossProfit - overheads;
        
        // 3. Calculate Required Production Capacity
        // This is now based on the Gross Profit, which represents the value added by the workshop
        const requiredValue = grossProfit;

        // 4. Calculate the team's available capacity
        const totalAvailableValue = allEmployeesInScenario.reduce((total, emp) => {
            const monthlyHours = 173.2;
            const efficiencyFactor = emp.efficiency / 100;
            const valueGenerated = emp.hourlyRate * monthlyHours * efficiencyFactor;
            return total + valueGenerated;
        }, 0);
        
        // 5. Suggest required employees based on value generation
        const avgEmployeeValue = allEmployeesInScenario.length > 0
            ? totalAvailableValue / allEmployeesInScenario.length
            : (parseFloat(newSimEmployee.hourlyRate) || 150) * 173.2 * ((parseFloat(newSimEmployee.efficiency) || 95) / 100);
            
        const requiredEmployees = avgEmployeeValue > 0 ? (requiredValue / avgEmployeeValue).toFixed(1) : 'N/A';

        return {
            requiredValue: requiredValue,
            availableValue: totalAvailableValue,
            netProfit,
            requiredEmployees
        };

    }, [scenario, allEmployeesInScenario, newSimEmployee]);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setScenario(prev => ({ ...prev, [name]: value }));
    };
    
    const handleSimInputChange = (e) => {
        const { name, value } = e.target;
        setNewSimEmployee(prev => ({ ...prev, [name]: value }));
    };
    
    const addSimulatedEmployee = () => {
        if (parseFloat(newSimEmployee.hourlyRate) > 0 && parseFloat(newSimEmployee.efficiency) > 0) {
            setSimulatedEmployees(prev => [...prev, {
                ...newSimEmployee,
                id: `sim-${Date.now()}`,
                hourlyRate: parseFloat(newSimEmployee.hourlyRate),
                efficiency: parseFloat(newSimEmployee.efficiency),
            }]);
        }
    };

    const removeSimulatedEmployee = (id) => {
        setSimulatedEmployees(prev => prev.filter(emp => emp.id !== id));
    };

    const formatCurrency = (value) => `R ${value.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <TrendingUp className="text-blue-400" />
                Workforce & Capacity Planner
            </h3>
            
            {/* INPUTS */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 p-4 bg-gray-900/50 rounded-lg">
                <Input 
                    label="Target Monthly Sales (R)" 
                    name="targetSales" 
                    type="number" 
                    value={scenario.targetSales} 
                    onChange={handleInputChange} 
                    placeholder="e.g., 500000" 
                />
                <Input 
                    label="Fixed Overheads (R)" 
                    name="overheads" 
                    type="number" 
                    value={scenario.overheads} 
                    onChange={handleInputChange}
                    placeholder="e.g., 145000"
                />
                 <Input 
                    label="Gross Margin (%)" 
                    name="grossMargin" 
                    type="number" 
                    value={scenario.grossMargin} 
                    onChange={handleInputChange}
                    placeholder="e.g., 35"
                />
            </div>

            {/* TEAM COMPOSITION */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Employee List */}
                <div className="space-y-3">
                    <h4 className="font-semibold text-lg text-white">Team Composition</h4>
                    <div className="grid grid-cols-4 gap-4 px-2 text-sm text-gray-400 font-bold">
                        <span>Employee</span>
                        <span className="text-center">Rate/hr</span>
                        <span className="text-center">Efficiency</span>
                        <span className="text-right">Action</span>
                    </div>
                    <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {realEmployees.map(emp => <EmployeeRow key={emp.id} employee={emp} />)}
                        {simulatedEmployees.map(emp => <EmployeeRow key={emp.id} employee={emp} onRemove={() => removeSimulatedEmployee(emp.id)} />)}
                    </div>
                     <div className="grid grid-cols-4 gap-2 items-end p-2 border-t border-gray-700 pt-3">
                        <Input label="Sim Rate" name="hourlyRate" type="number" value={newSimEmployee.hourlyRate} onChange={handleSimInputChange} />
                        <Input label="Sim Efficiency" name="efficiency" type="number" value={newSimEmployee.efficiency} onChange={handleSimInputChange} />
                        <div className="col-span-2 text-right">
                             <Button onClick={addSimulatedEmployee}><PlusCircle size={16} className="mr-2"/>Add Sim Employee</Button>
                        </div>
                    </div>
                </div>

                {/* Projected Results */}
                <div className="space-y-4 bg-gray-900/50 p-6 rounded-lg">
                    <h4 className="font-semibold text-lg text-white">Projected Results</h4>
                    <div className="text-center bg-gray-700/50 p-4 rounded-lg">
                        <p className="text-sm text-gray-400">Required Team Value vs. Available</p>
                        <p className={`text-3xl font-bold mt-1 ${results.availableValue < results.requiredValue ? 'text-red-400' : 'text-green-400'}`}>
                            {formatCurrency(results.requiredValue)} / {formatCurrency(results.availableValue)}
                        </p>
                    </div>
                     <div className="grid grid-cols-2 gap-4">
                         <div className="text-center bg-gray-700/50 p-4 rounded-lg">
                            <p className="text-sm text-gray-400">Suggested Workforce</p>
                            <p className="text-3xl font-bold text-white">
                                {results.requiredEmployees}
                                <span className="text-lg ml-1">people</span>
                            </p>
                        </div>
                        <div className="text-center bg-blue-600/20 p-4 rounded-lg border border-blue-500">
                            <p className="text-sm text-blue-300">Projected Net Profit</p>
                            <p className={`text-3xl font-bold ${results.netProfit >= 0 ? 'text-white' : 'text-red-400'}`}>
                                {formatCurrency(results.netProfit)}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default WorkforceCapacityPlanner;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\WorkshopThroughputGraph.jsx
==================================================
// src/components/intelligence/WorkshopThroughputGraph.jsx (NEW FILE)
import React from 'react';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } from 'recharts';
import { HardHat } from 'lucide-react';

const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-gray-900/80 p-3 border border-gray-700 rounded-lg shadow-lg">
        <p className="label text-sm text-white font-bold">{`Week of ${label}`}</p>
        <p className="intro text-blue-400">{`Jobs Completed: ${payload[0].value}`}</p>
      </div>
    );
  }
  return null;
};

const WorkshopThroughputGraph = ({ jobCompletionData }) => {
    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full">
            <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                <HardHat size={20} className="text-yellow-400"/>
                Workshop Throughput (Last 8 Weeks)
            </h3>
            <ResponsiveContainer width="100%" height={300}>
                <BarChart data={jobCompletionData} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#4b556330" />
                    <XAxis dataKey="name" stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} />
                    <YAxis stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} allowDecimals={false} />
                    <Tooltip content={<CustomTooltip />} cursor={{fill: 'rgba(107, 114, 128, 0.1)'}}/>
                    <Bar dataKey="jobs" fill="#f59e0b" radius={[4, 4, 0, 0]} barSize={30} name="Jobs Completed" />
                </BarChart>
            </ResponsiveContainer>
        </div>
    );
};

export default WorkshopThroughputGraph;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\YearToDateComparison.jsx
==================================================
// src/components/intelligence/YearToDateComparison.jsx
import React from 'react';
import { TrendingUp, TrendingDown, Minus, Calendar } from 'lucide-react';

const YearToDateComparison = ({ percentageChange }) => {
    
    const isPositive = percentageChange > 0;
    const isNegative = percentageChange < 0;

    const getTrendInfo = () => {
        if (isPositive) return {
            icon: <TrendingUp size={32} />,
            textColor: 'text-green-400',
            text: `+${percentageChange.toFixed(1)}%`
        };
        if (isNegative) return {
            icon: <TrendingDown size={32} />,
            textColor: 'text-red-400',
            text: `${percentageChange.toFixed(1)}%`
        };
        return {
            icon: <Minus size={32} />,
            textColor: 'text-gray-400',
            text: `${percentageChange.toFixed(1)}%`
        };
    };
    
    const trend = getTrendInfo();

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col justify-center items-center">
            <p className="text-gray-400 text-sm font-medium mb-2 flex items-center gap-2">
                <Calendar size={14} />
                Year-to-Date Sales vs. Last Year
            </p>
            <div className={`flex items-center space-x-3 ${trend.textColor}`}>
                {trend.icon}
                <span className="text-5xl font-bold">
                    {trend.text}
                </span>
            </div>
        </div>
    );
};

export default YearToDateComparison;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\YoYProfitWidget.jsx
==================================================
// src/components/intelligence/YoYProfitWidget.jsx

import React from 'react';
import { TrendingUp, TrendingDown, Minus, Percent } from 'lucide-react';

const YoYProfitWidget = ({ currentMonthProfit, lastYearProfit }) => {
    
    const percentageChange = (() => {
        if (lastYearProfit === 0 && currentMonthProfit > 0) return 100;
        if (lastYearProfit === 0) return 0;
        // Handle case where last year was a loss
        if (lastYearProfit < 0) {
            return ((currentMonthProfit - lastYearProfit) / Math.abs(lastYearProfit)) * 100;
        }
        return ((currentMonthProfit - lastYearProfit) / lastYearProfit) * 100;
    })();

    const isPositive = percentageChange > 0;
    const isNegative = percentageChange < 0;

    const getTrendInfo = () => {
        if (isPositive) return {
            icon: <TrendingUp size={20} />,
            textColor: 'text-green-400',
            text: `+${percentageChange.toFixed(1)}% vs. Last Year`
        };
        if (isNegative) return {
            icon: <TrendingDown size={20} />,
            textColor: 'text-red-400',
            text: `${percentageChange.toFixed(1)}% vs. Last Year`
        };
        return {
            icon: <Minus size={20} />,
            textColor: 'text-gray-400',
            text: 'No Change vs. Last Year'
        };
    };
    
    const trend = getTrendInfo();
    const profitColor = currentMonthProfit >= 0 ? 'text-white' : 'text-red-400';

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col justify-between">
            <div>
                <p className="text-gray-400 text-sm font-medium flex items-center gap-2">
                    <Percent size={16} />
                    This Month's Profit (from Accounting)
                </p>
                <p className={`text-4xl font-bold mt-2 ${profitColor}`}>
                    R {currentMonthProfit.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </p>
            </div>
            <div className={`mt-4 flex items-center space-x-2 ${trend.textColor}`}>
                {trend.icon}
                <span className="font-semibold">
                    {trend.text}
                </span>
            </div>
        </div>
    );
};

export default YoYProfitWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\YoYSalesComparison.jsx
==================================================
// src/components/intelligence/YoYSalesComparison.jsx

import React from 'react';
import { TrendingUp, TrendingDown, Minus, DollarSign } from 'lucide-react';

const YoYSalesComparison = ({ currentMonthSales, lastYearSales }) => {
    
    const percentageChange = (() => {
        if (lastYearSales === 0 && currentMonthSales > 0) return 100; // Growth from zero
        if (lastYearSales === 0) return 0; // No change from zero
        return ((currentMonthSales - lastYearSales) / lastYearSales) * 100;
    })();

    const isPositive = percentageChange > 0;
    const isNegative = percentageChange < 0;

    const getTrendInfo = () => {
        if (isPositive) return {
            icon: <TrendingUp size={20} />,
            textColor: 'text-green-400',
            text: `+${percentageChange.toFixed(1)}% vs. Last Year`
        };
        if (isNegative) return {
            icon: <TrendingDown size={20} />,
            textColor: 'text-red-400',
            text: `${percentageChange.toFixed(1)}% vs. Last Year`
        };
        return {
            icon: <Minus size={20} />,
            textColor: 'text-gray-400',
            text: 'No Change vs. Last Year'
        };
    };
    
    const trend = getTrendInfo();

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col justify-between">
            <div>
                <p className="text-gray-400 text-sm font-medium flex items-center gap-2">
                    <DollarSign size={16} />
                    This Month's Sales (from Accounting)
                </p>
                <p className="text-4xl font-bold text-white mt-2">
                    R {currentMonthSales.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </p>
            </div>
            <div className={`mt-4 flex items-center space-x-2 ${trend.textColor}`}>
                {trend.icon}
                <span className="font-semibold">
                    {trend.text}
                </span>
            </div>
        </div>
    );
};

export default YoYSalesComparison;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\YoYSalesGraph.jsx
==================================================
// src/components/intelligence/YoYSalesGraph.jsx (UPDATED to Line Chart)
import React from 'react';
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend } from 'recharts';
import { TrendingUp } from 'lucide-react';

const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-gray-900/80 p-3 border border-gray-700 rounded-lg shadow-lg">
        <p className="label text-sm text-white font-bold">{label}</p>
        {payload.map(pld => (
          <div key={pld.dataKey} style={{ color: pld.color }}>
            {pld.dataKey}: R {pld.value.toLocaleString('en-ZA')}
          </div>
        ))}
      </div>
    );
  }
  return null;
};

const YoYSalesGraph = ({ salesData, lastYear, currentYear }) => {

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full">
            <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                <TrendingUp size={20} className="text-green-400"/>
                Monthly Sales Comparison
            </h3>
            <ResponsiveContainer width="100%" height={300}>
                <LineChart data={salesData} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#4b556330" />
                    <XAxis dataKey="name" stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} />
                    <YAxis stroke="#9ca3af" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `R${value/1000}k`} />
                    <Tooltip content={<CustomTooltip />} cursor={{fill: 'rgba(107, 114, 128, 0.1)'}}/>
                    <Legend />
                    <Line type="monotone" dataKey={lastYear} stroke="#8884d8" strokeWidth={2} name={`Sales ${lastYear}`} />
                    <Line type="monotone" dataKey={currentYear} stroke="#3b82f6" strokeWidth={2} name={`Sales ${currentYear}`} />
                </LineChart>
            </ResponsiveContainer>
        </div>
    );
};

export default YoYSalesGraph;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\intelligence\YoYSalesWidget.jsx
==================================================
// src/components/intelligence/YoYSalesWidget.jsx (NEW FILE)
import React from 'react';
import { TrendingUp, TrendingDown, Minus } from 'lucide-react';

const YoYSalesWidget = ({ currentMonthSales, lastYearSales }) => {
    // This component is UI-only for now, logic will be added in DashboardPage.jsx
    
    const percentageChange = (() => {
        if (lastYearSales === 0 && currentMonthSales > 0) return 100; // Growth from zero
        if (lastYearSales === 0) return 0; // No change from zero
        return ((currentMonthSales - lastYearSales) / lastYearSales) * 100;
    })();

    const isPositive = percentageChange > 0;
    const isNegative = percentageChange < 0;
    const isNeutral = percentageChange === 0;

    const getTrendInfo = () => {
        if (isPositive) return {
            icon: <TrendingUp size={20} className="text-green-400" />,
            textColor: 'text-green-400',
            text: `${percentageChange.toFixed(1)}% vs. last year`
        };
        if (isNegative) return {
            icon: <TrendingDown size={20} className="text-red-400" />,
            textColor: 'text-red-400',
            text: `${percentageChange.toFixed(1)}% vs. last year`
        };
        return {
            icon: <Minus size={20} className="text-gray-400" />,
            textColor: 'text-gray-400',
            text: 'No change vs. last year'
        };
    };
    
    const trend = getTrendInfo();

    return (
        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 h-full flex flex-col justify-between">
            <div>
                <p className="text-gray-400 text-sm font-medium">This Month's Sales (Live)</p>
                <p className="text-4xl font-bold text-white mt-2">
                    R {currentMonthSales.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </p>
            </div>
            <div className="mt-4 flex items-center space-x-2">
                {trend.icon}
                <span className={`font-semibold ${trend.textColor}`}>
                    {trend.text}
                </span>
            </div>
        </div>
    );
};

export default YoYSalesWidget;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\layout\CustomerLayout.jsx
==================================================
// src/components/layout/CustomerLayout.jsx

import React from 'react';
import { useAuth } from '../../contexts/AuthContext';
import Button from '../ui/Button';
import TojemLogo from '../../assets/TOJEM 2024.png';

const CustomerLayout = ({ children }) => {
    const { user, signOut } = useAuth();

    return (
        <div className="flex flex-col h-screen bg-gray-900 text-white">
            <header className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800/50 flex-shrink-0">
                <img src={TojemLogo} alt="TOJEM OS Logo" className="h-8 sm:h-10 object-contain" />
                <div className="flex items-center space-x-4">
                    <div className="text-right">
                        <p className="font-semibold text-white">{user?.companyName || 'Valued Customer'}</p>
                        <p className="text-xs text-gray-500">{user?.email}</p>
                    </div>
                    <Button onClick={signOut} variant="secondary" className="py-1 px-3 text-sm">
                        Sign Out
                    </Button>
                </div>
            </header>
            <main className="flex-1 overflow-y-auto p-4 sm:p-8">
               {children}
            </main>
        </div>
    );
};

export default CustomerLayout;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\layout\MainLayout.jsx
==================================================
// src/components/layout/MainLayout.jsx (UPDATED)
// The main content area has been updated to prevent forced scrolling,
// allowing child pages like the Kanban board to manage their own layout and scroll behavior.

import React, { useState, useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import Button from '../ui/Button';
import Sidebar from './Sidebar';
import { PanelLeftClose, PanelRightClose } from 'lucide-react';
import TojemLogo from '../../assets/TOJEM 2024.png';
import NotificationBell from './NotificationBell';

const MainLayout = ({ children }) => {
  const { user, signOut } = useAuth();
  const location = useLocation();
  const [isSidebarPinned, setSidebarPinned] = useState(false);
  const [isSidebarHovered, setSidebarHovered] = useState(false);
  const isSidebarOpen = isSidebarPinned || isSidebarHovered;

  useEffect(() => {
    if (window.innerWidth <= 1024) {
      setSidebarPinned(false);
    }
  }, [location.pathname]);

  const handlePinToggle = () => {
    setSidebarPinned(prev => !prev);
  };

  if (user?.hideSidebar) {
    return (
        <div className="flex flex-col h-screen bg-gray-900 text-white">
            <header className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800/50 flex-shrink-0">
                <img src={TojemLogo} alt="TOJEM OS Logo" className="h-8 sm:h-10 object-contain" />
                <div className="flex items-center space-x-4">
                    <div className="text-right">
                        <p className="text-sm text-gray-400">Signed in as {user?.email || 'Guest'}</p>
                        <p className="text-xs text-gray-500 font-semibold">{user?.role || 'No Role'}</p>
                    </div>
                    <Button onClick={signOut} variant="secondary" className="py-1 px-3 text-sm">
                        Sign Out
                    </Button>
                </div>
            </header>
            <main className="flex-1 overflow-y-auto p-4 sm:p-8">
               {children}
            </main>
        </div>
    );
  }

  return (
    <div className="flex h-screen bg-gray-900 text-white">
      <Sidebar 
        isOpen={isSidebarOpen} 
        isPinned={isSidebarPinned}
        onMouseEnter={() => setSidebarHovered(true)}
        onMouseLeave={() => setSidebarHovered(false)}
      />

      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800/50 flex-shrink-0">
          <div className="flex items-center gap-4">
            <Button onClick={handlePinToggle} variant="secondary" className="p-2">
               {isSidebarPinned ? <PanelLeftClose size={20}/> : <PanelRightClose size={20}/>}
            </Button>
            <img src={TojemLogo} alt="TOJEM OS Logo" className="h-8 sm:h-10 object-contain" />
          </div>
          <div className="flex items-center space-x-4">
            <NotificationBell />
            <div className="text-right">
               <p className="text-sm text-gray-400">Signed in as {user?.email || 'Guest'}</p>
              <p className="text-xs text-gray-500 font-semibold">{user?.role || 'No Role'}</p>
            </div>
            <Button onClick={signOut} variant="secondary" className="py-1 px-3 text-sm">
                Sign Out
            </Button>
          </div>
        </header>
        
        {/* --- THIS IS THE FIX --- */}
        {/* This main content area is now a flex container that allows its children to grow and scroll independently. */}
        <main className="flex-1 p-4 sm:p-8 flex flex-col overflow-y-auto">
           {children}
        </main>
      </div>
    </div>
  );
};

export default MainLayout;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\layout\NotificationBell.jsx
==================================================
import React, { useState, useEffect, useRef } from 'react';
import { Bell, XCircle, Mail, Clock } from 'lucide-react';
import { collection, query, where, orderBy, onSnapshot, updateDoc, doc } from 'firebase/firestore';
import { db } from '../../api/firebase'; // Import your Firestore db instance
import { useAuth } from '../../contexts/AuthContext'; // Corrected: Import useAuth directly
import moment from 'moment'; // Import moment.js
import { useNavigate } from 'react-router-dom'; // Import useNavigate

const NotificationBell = () => {
  const { user } = useAuth();
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef(null);
  const navigate = useNavigate();

  useEffect(() => {
    if (!user || !user.role) {
      setNotifications([]);
      setUnreadCount(0);
      return;
    }

    const q = query(
      collection(db, 'notifications'),
      where('targetRole', '==', user.role),
      orderBy('createdAt', 'desc')
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedNotifications = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        createdAt: doc.data().createdAt?.toDate(),
      }));
      setNotifications(fetchedNotifications);
      setUnreadCount(fetchedNotifications.filter(n => !n.read).length);
    }, (error) => {
      console.error("Error listening to notifications:", error);
    });

    return () => unsubscribe();
  }, [user]);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  const handleBellClick = () => {
    setIsOpen(prev => !prev);
  };

  const handleNotificationClick = async (notification) => {
    await handleMarkAsRead(notification.id);

    // Navigate based on notification type, including jobId for deep linking where applicable
    switch (notification.type) {
      case 'qc_awaiting':
        // Navigate to QC page, but if you want to highlight the job, pass jobId.
        // QC page would need to handle the jobId if you want to auto-select/highlight.
        navigate('/qc'); // Current QC page doesn't have deep-linking to specific job
        break;
      case 'job_issue':
        // Navigate to Issues page with jobId to auto-open modal
        navigate(`/issues?jobId=${notification.jobId}`);
        break;
      case 'job_overdue':
        // Navigate to Tracking page with jobId to auto-open modal
        navigate(`/tracking?jobId=${notification.jobId}`);
        break;
      default:
        navigate('/'); // Default to dashboard
        break;
    }
    setIsOpen(false); // Close dropdown after navigation
  };

  const handleMarkAsRead = async (notificationId) => {
    try {
      await updateDoc(doc(db, 'notifications', notificationId), { read: true });
    } catch (error) {
      console.error("Error marking notification as read:", error);
    }
  };

  return (
    <div className="relative" ref={dropdownRef}>
      <button
        onClick={handleBellClick}
        className="relative p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800"
      >
        <Bell size={24} className="text-gray-300" />
        {unreadCount > 0 && (
          <span className="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
            {unreadCount}
          </span>
        )}
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-2 w-72 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50">
          <div className="p-3 border-b border-gray-700 text-white font-semibold flex justify-between items-center">
            Notifications ({unreadCount} unread)
            <button
              onClick={() => setIsOpen(false)}
              className="text-gray-400 hover:text-white"
            >
              <XCircle size={20} />
            </button>
          </div>
          {notifications.length === 0 ? (
            <p className="p-4 text-gray-400 text-sm text-center">No new notifications.</p>
          ) : (
            <ul className="max-h-80 overflow-y-auto">
              {notifications.map(notification => (
                <li
                  key={notification.id}
                  className={`p-3 border-b border-gray-700 text-sm cursor-pointer ${
                    notification.read ? 'bg-gray-700 text-gray-400' : 'bg-gray-900 text-white hover:bg-gray-700'
                  }`}
                  onClick={() => handleNotificationClick(notification)}
                >
                  <div className="flex items-center space-x-2">
                    <Mail size={16} className="text-blue-400" />
                    <p className="font-medium">{notification.message}</p>
                  </div>
                  <div className="flex items-center text-xs text-gray-500 mt-1 ml-6">
                    {notification.createdAt ? moment(notification.createdAt).fromNow() : 'just now'}
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      )}
    </div>
  );
};

export default NotificationBell;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\layout\ProtectedRoute.jsx
==================================================
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';

const ProtectedRoute = ({ children }) => {
  const { user, loading } = useAuth();

  // 1. While Firebase is checking the auth state, show a loading message.
  if (loading) {
    return (
      <div className="bg-gray-900 min-h-screen flex items-center justify-center text-white">
        Loading Application...
      </div>
    );
  }

  // 2. If loading is finished and there's no user, redirect to the login page.
  if (!user) {
    return <Navigate to="/login" />;
  }

  // 3. If loading is finished and a user exists, show the requested page.
  return children;
};

// Ensure this exact line is at the bottom of the file
export default ProtectedRoute;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\layout\RoleBasedRoute.jsx
==================================================
// src/components/layout/RoleBasedRoute.jsx (ENHANCED)
// This component has been upgraded to handle more complex, fine-grained permissions.
// It can now accept an array of permissions and will grant access if the user has AT LEAST ONE of them.
// This allows for more flexible and secure role definitions in the future.

import React from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { Navigate } from 'react-router-dom';

/**
 * A wrapper for routes that checks if the current user has the required permission(s).
 * If the user is not authorized, it redirects them to their default landing page.
 * @param {{children: React.ReactNode, permission: string | string[]}} props
 */
const RoleBasedRoute = ({ children, permission }) => {
    const { user } = useAuth();

    // Ensure the user and their permissions object exist.
    if (!user || !user.permissions) {
        console.warn("RoleBasedRoute: User or user.permissions is undefined. Redirecting.");
        return <Navigate to="/" />;
    }

    const userPermissions = user.permissions;
    
    // The 'permission' prop can now be a single string or an array of strings.
    const requiredPermissions = Array.isArray(permission) ? permission : [permission];

    // Check if the user has AT LEAST ONE of the required permissions.
    // This provides flexibility, e.g., a route could be accessible by a 'manager' OR an 'editor'.
    const hasPermission = requiredPermissions.some(p => userPermissions[p] === true);

    if (hasPermission) {
        return children; // User has permission, render the requested page.
    }

    // If the user does not have permission, redirect them to their designated landing page.
    // This prevents users from getting stuck on an unauthorized page.
    console.log(`Redirecting: User does not have required permission(s): ${requiredPermissions.join(', ')}`);
    return <Navigate to={user.landingPage || '/'} />;
};

export default RoleBasedRoute;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\layout\Sidebar.jsx
==================================================
// src/components/layout/Sidebar.jsx (UPDATED)
// Added a new link for the Time & Attendance report under the Business Intelligence NavGroup.

import React, { useState } from 'react';
import { NavLink } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext.jsx';
import {
  LayoutDashboard, HardHat, Package, Truck, BarChart3,
  FileText, CheckSquare, AlertTriangle, ScanLine,
  Calendar as CalendarIcon, SlidersHorizontal, ChevronDown, ChevronRight,
  Briefcase, Banknote, BrainCircuit, DollarSign,
  Aperture, Calculator, NotebookText, Sun,
  Megaphone, ShoppingCart, ClipboardList, Cpu,
  LayoutGrid, PackageSearch, UserCheck, Map, Clock // <-- Import Clock icon
} from 'lucide-react';
import NotesApplet from '../features/sidebar/NotesApplet.jsx';
import WeatherApplet from '../features/sidebar/WeatherApplet.jsx';
import CalendarApplet from '../features/sidebar/CalendarApplet.jsx';
import CalculatorApplet from '../features/sidebar/CalculatorApplet.jsx';

const SidebarLink = ({ to, icon, text, isOpen }) => {
  const commonClasses = "flex items-center p-3 my-1 rounded-lg transition-colors";
  const activeClass = "bg-blue-600 text-white font-semibold";
  const inactiveClass = "text-gray-300 hover:bg-gray-700";
  return (
    <NavLink to={to} className={({ isActive }) => `${commonClasses} ${isActive ? activeClass : inactiveClass}`}>
      {icon}
      {isOpen && <span className="ml-4 text-sm">{text}</span>}
    </NavLink>
  );
};

const NavGroup = ({ title, icon, children, isOpen, defaultOpen = false }) => {
  const [isGroupOpen, setGroupOpen] = useState(defaultOpen);
  return (
    <div className="py-2">
      <button
        onClick={() => setGroupOpen(!isGroupOpen)}
        className="w-full flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"
      >
        {icon}
        {isOpen && <span className="ml-4 font-semibold text-sm">{title}</span>}
        {isOpen && (isGroupOpen ? <ChevronDown size={16} className="ml-auto" /> : <ChevronRight size={16} className="ml-auto" />)}
      </button>
      {isGroupOpen && isOpen && (
        <div className="mt-1 border-l-2 border-gray-700 ml-5 pl-3 space-y-1">{children}</div>
      )}
    </div>
  );
};

const Applet = ({ icon, text, children, isOpen }) => {
  const [isAppletOpen, setAppletOpen] = useState(false);
  return (
    <div>
      <button
        onClick={() => setAppletOpen(!isAppletOpen)}
        className="w-full flex items-center p-3 my-1 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"
      >
        {icon}
        {isOpen && <span className="ml-4 text-sm">{text}</span>}
        {isOpen && (isAppletOpen ? <ChevronDown size={16} className="ml-auto text-gray-500" /> : <ChevronRight size={16} className="ml-auto text-gray-500" />)}
      </button>
      {isAppletOpen && isOpen && (
        <div className="mt-1 border-l-2 border-blue-500/30 ml-5 pl-1 py-2">{children}</div>
      )}
    </div>
  );
};

const Sidebar = ({ isOpen, isPinned, onMouseEnter, onMouseLeave }) => {
  const { user } = useAuth();
  const canSee = (permission) => !!user?.permissions?.[permission];

  return (
    <div
      onMouseEnter={onMouseEnter}
      onMouseLeave={onMouseLeave}
      className={`bg-gray-800 border-r border-gray-700 p-2 flex flex-col transition-all duration-300 ${isOpen ? 'w-64' : 'w-20'}`}
    >
      <div className="flex-grow overflow-y-auto">

        {canSee('dashboard') && <SidebarLink to="/" icon={<LayoutDashboard size={22} />} text="Dashboard" isOpen={isOpen} />}

        {(canSee('quotes') || canSee('marketing')) && (
          <NavGroup title="Sales & Marketing" icon={<Megaphone size={22} />} isOpen={isOpen}>
            {canSee('quotes') && <SidebarLink to="/quotes" icon={<DollarSign size={18} />} text="Sales Quotes" isOpen={isOpen} />}
            {canSee('marketing') && <SidebarLink to="/marketing" icon={<BarChart3 size={18} />} text="Marketing Dashboard" isOpen={isOpen} />}
          </NavGroup>
        )}

        {(canSee('orders') || canSee('purchasing') || canSee('stockTake')) && (
          <NavGroup title="Supply Chain" icon={<Truck size={22} />} isOpen={isOpen}>
            {canSee('orders') && <SidebarLink to="/orders" icon={<ShoppingCart size={18} />} text="Sales Orders" isOpen={isOpen} />}
            {canSee('purchasing') && <SidebarLink to="/purchasing" icon={<Package size={18} />} text="Purchasing Hub" isOpen={isOpen} />}
            {canSee('stockTake') && <SidebarLink to="/stock-take" icon={<ClipboardList size={18} />} text="Stock Take" isOpen={isOpen} />}
          </NavGroup>
        )}

        {(canSee('tracking') || canSee('scanner') || canSee('calendar') || canSee('kanban') || canSee('picking') || canSee('floorplan')) && (
          <NavGroup title="Workshop Floor" icon={<HardHat size={22} />} isOpen={isOpen} defaultOpen={true}>
            {canSee('tracking') && <SidebarLink to="/tracking" icon={<BarChart3 size={18} />} text="Live Tracking" isOpen={isOpen} />}
            {canSee('kanban') && <SidebarLink to="/kanban" icon={<LayoutGrid size={18} />} text="Kanban Board" isOpen={isOpen} />}
            {canSee('floorplan') && <SidebarLink to="/floorplan" icon={<Map size={18} />} text="Floor Plan" isOpen={isOpen} />}
            {canSee('picking') && <SidebarLink to="/picking-queue" icon={<PackageSearch size={18} />} text="Picking Queue" isOpen={isOpen} />}
            {canSee('scanner') && <SidebarLink to="/scan" icon={<ScanLine size={18} />} text="Scanner" isOpen={isOpen} />}
            {canSee('calendar') && <SidebarLink to="/calendar" icon={<CalendarIcon size={18} />} text="Calendar" isOpen={isOpen} />}
          </NavGroup>
        )}

        {(canSee('jobCreator') || canSee('qc') || canSee('issues') || canSee('adjustment') || canSee('multiStage') || canSee('jobHistory') || canSee('reworkQueue') || canSee('stockAdjust') || canSee('jobReprint')) && (
          <NavGroup title="Production Control" icon={<FileText size={22} />} isOpen={isOpen}>
            {canSee('jobCreator') && <SidebarLink to="/creator" icon={<FileText size={18} />} text="Job Creator" isOpen={isOpen} />}
            {canSee('qc') && <SidebarLink to="/qc" icon={<CheckSquare size={18} />} text="Quality Control" isOpen={isOpen} />}
            {canSee('issues') && <SidebarLink to="/issues" icon={<AlertTriangle size={18} />} text="Issues" isOpen={isOpen} />}
            {canSee('adjustment') && <SidebarLink to="/adjustment" icon={<SlidersHorizontal size={18} />} text="Job Card Adjustment" isOpen={isOpen} />}
            {canSee('multiStage') && <SidebarLink to="/multi-stage-wizard" icon={<FileText size={18} />} text="Multi-Stage Wizard" isOpen={isOpen} />}
            {canSee('jobHistory') && <SidebarLink to="/job-history" icon={<FileText size={18} />} text="Job History" isOpen={isOpen} />}
            {canSee('reworkQueue') && <SidebarLink to="/rework-queue" icon={<AlertTriangle size={18} />} text="Rework Queue" isOpen={isOpen} />}
            {canSee('stockAdjust') && <SidebarLink to="/stock-adjust" icon={<SlidersHorizontal size={18} />} text="Stock Adjustment" isOpen={isOpen} />}
            {canSee('jobReprint') && <SidebarLink to="/job-reprint" icon={<FileText size={18} />} text="Reprint Jobs" isOpen={isOpen} />}
          </NavGroup>
        )}

        {(canSee('performance') || canSee('profitability') || canSee('valuation') || canSee('assets')) && (
          <NavGroup title="Business Intelligence" icon={<BrainCircuit size={22} />} isOpen={isOpen}>
            {canSee('performance') && <SidebarLink to="/performance" icon={<Briefcase size={18} />} text="Performance" isOpen={isOpen} />}
            {canSee('profitability') && <SidebarLink to="/profitability" icon={<DollarSign size={18} />} text="Profitability" isOpen={isOpen} />}
            {canSee('valuation') && <SidebarLink to="/valuation" icon={<Banknote size={18} />} text="Financials & Planning" isOpen={isOpen} />}
            {canSee('assets') && <SidebarLink to="/assets" icon={<Cpu size={18} />} text="Asset Intelligence" isOpen={isOpen} />}
            {/* --- NEW LINK --- */}
            {canSee('performance') && <SidebarLink to="/time-attendance" icon={<Clock size={18} />} text="Time & Attendance" isOpen={isOpen} />}
          </NavGroup>
        )}
        
      </div>

      <div className="flex-shrink-0 border-t border-gray-700 pt-2">
        <NavGroup title="Tools & Applets" icon={<Aperture size={22} />} isOpen={isOpen}>
          <Applet icon={<NotebookText size={18} />} text="Scratchpad" isOpen={isOpen}><NotesApplet /></Applet>
          <Applet icon={<Sun size={18} />} text="Weather" isOpen={isOpen}><WeatherApplet /></Applet>
          <Applet icon={<CalendarIcon size={18} />} text="Mini Calendar" isOpen={isOpen}><CalendarApplet /></Applet>
          <Applet icon={<Calculator size={18} />} text="Calculator" isOpen={isOpen}><CalculatorApplet /></Applet>
        </NavGroup>

        {canSee('settings') && <SidebarLink to="/settings" icon={<SlidersHorizontal size={22} />} text="Settings" isOpen={isOpen} />}
      </div>
    </div>
  );
};

export default Sidebar;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\ui\Button.jsx
==================================================
import React from 'react';

// Base styles for all buttons
const baseStyles = "flex items-center justify-center px-4 py-2 rounded-lg font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900";

// Styles for different button variants
const variants = {
  primary: "bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500",
  secondary: "bg-gray-700 hover:bg-gray-600 text-gray-200 focus:ring-gray-500",
  danger: "bg-red-600 hover:bg-red-700 text-white focus:ring-red-500",
};

const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', ...props }) => {
  return (
    <button
      type={type}
      onClick={onClick}
      // Combine base styles, variant styles, and any custom classes passed in
      className={`${baseStyles} ${variants[variant]} ${className}`}
      {...props}
    >
      {children}
    </button>
  );
};

export default Button;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\ui\ConfirmationModal.jsx
==================================================
// src/components/ui/ConfirmationModal.jsx

import React from 'react';
import Button from './Button';
import { X, AlertTriangle } from 'lucide-react';

const ConfirmationModal = ({
    isOpen,
    onClose,
    onConfirm,
    title = 'Are you sure?',
    message,
    confirmText = 'Confirm',
    cancelText = 'Cancel',
    confirmVariant = 'danger'
}) => {
    if (!isOpen) return null;

    return (
        <div 
            onClick={onClose} 
            className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in"
        >
            <div 
                onClick={(e) => e.stopPropagation()} 
                className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-md"
            >
                <div className="p-6 text-center">
                    <AlertTriangle size={48} className="mx-auto text-yellow-400 mb-4" />
                    <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                    <p className="text-sm text-gray-400">{message}</p>
                </div>
                <div className="p-4 flex justify-end gap-3 bg-gray-900/50 rounded-b-xl">
                    <Button onClick={onClose} variant="secondary">{cancelText}</Button>
                    <Button onClick={onConfirm} variant={confirmVariant}>{confirmText}</Button>
                </div>
            </div>
        </div>
    );
};

export default ConfirmationModal;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\ui\Dropdown.jsx
==================================================
import React from 'react';

// --- UPDATED: Added a default value to the 'options' prop ---
const Dropdown = ({ label, name, value, onChange, options = [], placeholder, ...props }) => {
  const textColorClass = !value ? 'text-green-500' : 'text-white';

  return (
    <div className="w-full">
      {label && (
        <label htmlFor={name} className="block text-sm font-medium text-gray-400 mb-1">
          {label}
        </label>
      )}
      <select
        id={name}
        name={name}
        value={value}
        onChange={onChange}
        className={`w-full p-3 bg-gray-700 border border-gray-600 rounded-lg ${textColorClass} focus:outline-none focus:ring-2 focus:ring-blue-500`}
        {...props}
      >
        {placeholder && <option value="">{placeholder}</option>}
        {/* This line is now safe because 'options' will always be an array */}
        {options.map(option => (
          <option key={option.id} value={option.id} className="text-white">
            {option.name}
          </option>
        ))}
      </select>
    </div>
  );
};

export default Dropdown;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\ui\Input.jsx
==================================================
import React from 'react';

const Input = ({ label, name, type = "text", value, onChange, placeholder, ...props }) => {
  return (
    <div className="w-full">
      {label && (
        <label htmlFor={name} className="block text-sm font-medium text-gray-400 mb-1">
          {label}
        </label>
      )}
      <input
        id={name}
        name={name}
        type={type}
        value={value}
        onChange={onChange}
        placeholder={placeholder}
        className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
        {...props}
      />
    </div>
  );
};

export default Input;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\components\ui\Textarea.jsx
==================================================
import React from 'react';

const Textarea = ({ label, name, value, onChange, placeholder, rows = 3 }) => {
  return (
    <div className="w-full">
      {label && (
        <label htmlFor={name} className="block text-sm font-medium text-gray-400 mb-1">
          {label}
        </label>
      )}
      <textarea
        id={name}
        name={name}
        value={value}
        onChange={onChange}
        placeholder={placeholder}
        rows={rows}
        className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>
  );
};

export default Textarea;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\contexts\AuthContext.jsx
==================================================
import React, { createContext, useState, useEffect, useContext } from 'react';
import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'firebase/auth';
import { auth, db } from '../api/firebase';
import { doc, getDoc } from 'firebase/firestore';
import toast from 'react-hot-toast';

export const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (userAuth) => {
      if (userAuth) {
        let userRole = 'Workshop Employee'; // Default role
        let landingPage = '/'; // Default landing page
        let hideSidebar = false; // Default sidebar visibility

        // 1. Fetch user's role name from the 'users' collection
        const userRoleDocRef = doc(db, 'users', userAuth.uid);
        const userRoleDoc = await getDoc(userRoleDocRef);

        if (userRoleDoc.exists() && userRoleDoc.data().role) {
          userRole = userRoleDoc.data().role;
        } else {
          console.warn(`User document for ${userAuth.uid} not found in 'users' or has no role. Assigning default role.`);
        }

        // 2. Fetch the permissions, landing page, and sidebar visibility for that role from the 'roles' collection
        let permissions = {};
        try {
            const roleDocRef = doc(db, 'roles', userRole);
            const roleDoc = await getDoc(roleDocRef);

            if (roleDoc.exists()) {
                const roleData = roleDoc.data();
                permissions = roleData.permissions || {};
                landingPage = roleData.landingPage || '/'; // Get landing page
                hideSidebar = roleData.hideSidebar || false; // Get hideSidebar status
            } else {
                console.warn(`Permissions document for role "${userRole}" not found. User will have no permissions.`);
                toast.error(`Permissions for role "${userRole}" not found. Please contact an administrator.`, { duration: 6000 });
            }
        } catch (error) {
            console.error("Error fetching role permissions:", error);
        }

        // 3. Combine all user data into a single context object
        const userContextData = {
            uid: userAuth.uid,
            email: userAuth.email,
            role: userRole,
            permissions: permissions,
            landingPage: landingPage, // Add to user context
            hideSidebar: hideSidebar, // Add to user context
        };
        
        setUser(userContextData);
      } else {
        setUser(null);
      }
      setLoading(false);
    });
    return unsubscribe;
  }, []);

  const value = {
    user,
    loading,
    signIn: (email, password) => signInWithEmailAndPassword(auth, email, password),
    signOut: () => signOut(auth),
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  return useContext(AuthContext);
};



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\hooks\useInventoryManager.js
==================================================
// src/hooks/useInventoryManager.js (Upgraded with Toasts & Location Fields)

import React, { useState, useEffect, useMemo } from 'react';
import { 
    getSupplierPricingForItem, 
    addSupplierPrice, 
    deleteSupplierPrice
} from '../api/firestore';
import toast from 'react-hot-toast';
import Button from '../components/ui/Button';

export const useInventoryManager = (api, suppliers, allSkills) => {
  const initialNewItemState = {
    name: '', itemCode: '', price: '', unit: '',
    currentStock: '', reorderLevel: '', standardStockLevel: '',
    requiresCatalyst: false, stockTakeMethod: 'quantity', unitWeight: '', tareWeight: '',
    associatedSkills: [],
    // NEW: Location fields added to initial state
    location: '',
    shelf_number: '',
    bin_number: '',
  };

  const [items, setItems] = useState([]);
  const [newItem, setNewItem] = useState(initialNewItemState);
  const [editingItemId, setEditingItemId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('name-asc');
  const [showLowStock, setShowLowStock] = useState(false);
  const [supplierPrices, setSupplierPrices] = useState([]);

  const fetchData = async () => {
    if (!api) return;
    setLoading(true);
    const fetchedItems = await api.get();
    setItems(fetchedItems);
    setLoading(false);
  };

  useEffect(() => {
    if (api && api.get) {
      fetchData();
    }
    cancelEdit();
  }, [api]);

  useEffect(() => {
      if (editingItemId) {
          const fetchPrices = async () => {
              const prices = await getSupplierPricingForItem(editingItemId);
              setSupplierPrices(prices);
          };
          fetchPrices();
      } else {
          setSupplierPrices([]);
      }
  }, [editingItemId]);

  const getSupplierName = (supplierId) => (suppliers || []).find(s => s.id === supplierId)?.name || 'N/A';

  const displayedItems = useMemo(() => {
    let filtered = [...(items || [])];
    if (showLowStock) {
      filtered = filtered.filter(item => Number(item.currentStock) < Number(item.reorderLevel));
    }
    if (searchTerm) {
      filtered = filtered.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));
    }
    filtered.sort((a, b) => {
      switch (sortBy) {
        case 'name-asc': return a.name.localeCompare(b.name);
        case 'name-desc': return b.name.localeCompare(a.name);
        case 'supplier': return getSupplierName(a.supplierId).localeCompare(getSupplierName(b.supplierId));
        case 'stock-low-high': return (Number(a.currentStock) / Number(a.reorderLevel)) - (Number(b.currentStock) / Number(b.reorderLevel));
        case 'stock-high-low': return (Number(b.currentStock) / Number(a.reorderLevel)) - (Number(a.currentStock) / Number(b.reorderLevel));
        default: return 0;
      }
    });
    return filtered;
  }, [items, searchTerm, sortBy, showLowStock, suppliers]);

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    const val = type === 'checkbox' ? checked : value;
    setNewItem(prevState => ({ ...prevState, [name]: val }));
  };

  const handleToggleSkillAssociation = (skillId, isChecked) => {
    setNewItem(prevItem => {
        if (isChecked) {
            return { ...prevItem, associatedSkills: [...(prevItem.associatedSkills || []), { skillId, defaultMinimumProficiency: 0, importanceWeight: 0 }] };
        } else {
            return { ...prevItem, associatedSkills: prevItem.associatedSkills.filter(s => s.skillId !== skillId) };
        }
    });
  };

  const handleAssociatedSkillChange = (skillId, field, value) => {
    setNewItem(prevItem => ({
        ...prevItem,
        associatedSkills: prevItem.associatedSkills.map(s =>
            s.skillId === skillId ? { ...s, [field]: Number(value) } : s
        )
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!newItem.name.trim()) return toast.error("Item name is required.");

    const filteredAssociatedSkills = (newItem.associatedSkills || []).filter(s =>
        s.defaultMinimumProficiency > 0 || s.importanceWeight > 0
    );

    const dataToSave = {
      name: newItem.name,
      itemCode: newItem.itemCode || '',
      price: parseFloat(newItem.price) || 0,
      unit: newItem.unit || '',
      currentStock: parseInt(newItem.currentStock, 10) || 0,
      reorderLevel: parseInt(newItem.reorderLevel, 10) || 0,
      standardStockLevel: parseInt(newItem.standardStockLevel, 10) || 0,
      requiresCatalyst: newItem.requiresCatalyst || false,
      stockTakeMethod: newItem.stockTakeMethod || 'quantity',
      unitWeight: parseFloat(newItem.unitWeight) || 0,
      tareWeight: parseFloat(newItem.tareWeight) || 0,
      associatedSkills: filteredAssociatedSkills,
      // NEW: Save location data
      location: newItem.location || '',
      shelf_number: newItem.shelf_number || '',
      bin_number: newItem.bin_number || '',
    };
    try {
      if (editingItemId) {
        await api.update(editingItemId, dataToSave);
        toast.success("Item updated successfully!");
      } else {
        await api.add(dataToSave);
        toast.success("Item added successfully!");
      }
      cancelEdit();
      fetchData();
    } catch (error) {
      console.error("Error saving item:", error);
      toast.error("Failed to save item.");
    }
  };

  const handleEdit = (item) => {
    setEditingItemId(item.id);
    setNewItem({ ...initialNewItemState, ...item, associatedSkills: item.associatedSkills || [] });
  };

  const cancelEdit = () => {
    setEditingItemId(null);
    setNewItem(initialNewItemState);
    setSupplierPrices([]);
  };

  const handleDelete = (id) => { 
      toast((t) => React.createElement(
          'span',
          null,
          'Delete this item and all its supplier pricing links?',
          React.createElement(
              Button,
              {
                  variant: "danger",
                  size: "sm",
                  className: "ml-2",
                  onClick: () => {
                      api.delete(id)
                          .then(() => {
                              toast.success("Item deleted.");
                              fetchData();
                          })
                          .catch(err => {
                              toast.error("Failed to delete item.");
                              console.error(err);
                          });
                      toast.dismiss(t.id);
                  }
              },
              'Delete'
          ),
          React.createElement(
              Button,
              {
                  variant: "secondary",
                  size: "sm",
                  className: "ml-2",
                  onClick: () => toast.dismiss(t.id)
              },
              'Cancel'
          )
      ), { icon: 'âš ï¸' });
  };
  
  const handleAddSupplierPrice = async (supplierId, price) => {
      if (!editingItemId || !supplierId || !price) {
          toast.error("Please select a supplier and enter a price.");
          return;
      }
      const supplier = suppliers.find(s => s.id === supplierId);
      if (!supplier) return;

      const priceData = {
          itemId: editingItemId,
          itemName: newItem.name,
          supplierId: supplier.id,
          supplierName: supplier.name,
          price: parseFloat(price)
      };
      await addSupplierPrice(priceData);
      const prices = await getSupplierPricingForItem(editingItemId);
      setSupplierPrices(prices);
      toast.success("Supplier price added.");
  };

  const handleDeleteSupplierPrice = (priceId) => {
      toast((t) => React.createElement(
          'span',
          null,
          'Delete this supplier price link?',
          React.createElement(
              Button,
              {
                  variant: "danger",
                  size: "sm",
                  className: "ml-2",
                  onClick: () => {
                      deleteSupplierPrice(priceId)
                          .then(() => {
                              toast.success("Price link deleted.");
                              setSupplierPrices(prev => prev.filter(p => p.id !== priceId));
                          })
                          .catch(err => {
                              toast.error("Failed to delete price link.");
                              console.error(err);
                          });
                      toast.dismiss(t.id);
                  }
              },
              'Delete'
          ),
          React.createElement(
              Button,
              {
                  variant: "secondary",
                  size: "sm",
                  className: "ml-2",
                  onClick: () => toast.dismiss(t.id)
              },
              'Cancel'
          )
      ), { icon: 'âš ï¸' });
  };

  return {
    newItem, loading, editingItemId, displayedItems, sortBy, searchTerm, showLowStock,
    supplierPrices,
    handleInputChange, handleSubmit, handleEdit, cancelEdit, handleDelete,
    handleToggleSkillAssociation, handleAssociatedSkillChange,
    handleAddSupplierPrice, handleDeleteSupplierPrice,
    setSortBy, setSearchTerm, setShowLowStock, getSupplierName
  };
};



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\hooks\useStockTakeData.js
==================================================
// src/hooks/useStockTakeData.js (REFACTORED)
// This hook now filters for uncounted items by checking if their last counted session ID
// is different from the current session ID, avoiding the need for a large batch write.

import { useState, useEffect, useMemo } from 'react';
import { getAllInventoryItems } from '../api/firestore';

export const useStockTakeData = (inventoryTypeFilter) => { // Accept the filter
    const [allItems, setAllItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [counts, setCounts] = useState({});
    const [searchTerm, setSearchTerm] = useState('');
    const [filter, setFilter] = useState('all');

    const fetchData = async () => {
        setLoading(true);
        setError(null);
        try {
            const items = await getAllInventoryItems();
            // Apply the category filter immediately after fetching
            let filteredItems = items;
            if (inventoryTypeFilter === 'products') {
                filteredItems = items.filter(item => item.category === 'Product');
            } else if (inventoryTypeFilter === 'purchased') {
                filteredItems = items.filter(item => item.category !== 'Product');
            }
            setAllItems(filteredItems);
        } catch (err) {
            setError("Failed to load inventory.");
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    // Refetch data when the inventory type filter changes
    useEffect(() => {
        fetchData();
    }, [inventoryTypeFilter]);

    const handleCountChange = (itemId, field, value) => {
        setCounts(prev => ({
            ...prev,
            [itemId]: {
                ...prev[itemId],
                [field]: value
            }
        }));
    };

    const processedItems = useMemo(() => {
        return allItems.map(item => {
            const systemCount = item.currentStock || 0;
            const countedValues = counts[item.id] || {};
            let physicalCount = '';
            let hasBeenCounted = false;

            if (item.stockTakeMethod === 'weight') {
                const grossWeight = parseFloat(countedValues.grossWeight);
                if (!isNaN(grossWeight)) {
                    hasBeenCounted = true;
                    const tareWeight = parseFloat(item.tareWeight) || 0;
                    const unitWeight = parseFloat(item.unitWeight) || 1;
                    if (unitWeight > 0) {
                        const netWeight = grossWeight - tareWeight;
                        physicalCount = Math.round(netWeight / unitWeight);
                    } else {
                        physicalCount = 0;
                    }
                }
            } else { // Default to 'quantity'
                const qty = countedValues.quantity;
                if (qty !== undefined && qty !== '') {
                    hasBeenCounted = true;
                    physicalCount = Number(qty);
                }
            }
            
            const variance = hasBeenCounted ? physicalCount - systemCount : 0;
            
            return {
                ...item,
                systemCount,
                physicalCount,
                variance,
                hasBeenCounted,
                countedValues, 
            };
        });
    }, [allItems, counts]);

    const filteredItems = useMemo(() => {
        let items = processedItems;
        if (filter === 'discrepancies') {
            items = items.filter(item => item.hasBeenCounted && item.variance !== 0);
        } else if (filter === 'uncounted') {
            items = items.filter(item => !item.hasBeenCounted);
        } else if (filter === 'counted') {
            items = items.filter(item => item.hasBeenCounted);
        }
        if (searchTerm) {
            const lowerCaseSearch = searchTerm.toLowerCase();
            items = items.filter(item =>
                item.name.toLowerCase().includes(lowerCaseSearch) ||
                (item.itemCode && item.itemCode.toLowerCase().includes(lowerCaseSearch))
            );
        }
        return items;
    }, [processedItems, filter, searchTerm]);

    const summary = useMemo(() => {
        const countedItems = processedItems.filter(item => item.hasBeenCounted);
        const discrepancies = countedItems.filter(item => item.variance !== 0);
        return {
            totalItems: allItems.length,
            counted: countedItems.length,
            uncounted: allItems.length - countedItems.length,
            discrepancies: discrepancies.length
        };
    }, [allItems.length, processedItems]);

    const getItemsToReconcile = () => {
        return processedItems
            .filter(item => item.hasBeenCounted)
            .map(item => ({
                id: item.id,
                name: item.name,
                category: item.category,
                systemCount: item.systemCount,
                newCount: item.physicalCount,
            }));
    };

    return {
        loading,
        error,
        filteredItems,
        summary,
        filter,
        setFilter,
        searchTerm,
        setSearchTerm,
        handleCountChange,
        getItemsToReconcile,
        fetchData,
        resetCounts: () => setCounts({}),
    };
};



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\AndonDisplayPage.jsx
==================================================
// src/pages/AndonDisplayPage.jsx (NEW FILE)
// This component serves as a large-format, real-time display for any job
// that has been halted on the workshop floor, acting as a digital "Andon Cord" system.

import React, { useState, useEffect } from 'react';
import { onSnapshot, query, collection, where } from 'firebase/firestore';
import { db } from '../api/firebase';
import { AlertTriangle, Clock } from 'lucide-react';
import moment from 'moment';

const AndonDisplayPage = () => {
    const [haltedJobs, setHaltedJobs] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const jobsRef = collection(db, 'createdJobCards');
        const q = query(jobsRef, where('status', '==', 'Halted - Issue'));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const jobs = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    // Find the most recent halt reason from the issue log if it exists
                    haltReason: (data.issueLog && data.issueLog.length > 0) 
                        ? data.issueLog[data.issueLog.length - 1].reason 
                        : (data.issueReason || 'No reason provided.'),
                    haltedAt: data.pausedAt // Assuming pausedAt is set when a job is halted
                };
            });
            setHaltedJobs(jobs);
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    // This effect will make the background flash for high visibility
    useEffect(() => {
        if (haltedJobs.length > 0) {
            document.body.classList.add('bg-red-900', 'animate-pulse');
        } else {
            document.body.classList.remove('bg-red-900', 'animate-pulse');
        }
        // Cleanup function to remove class when component unmounts
        return () => document.body.classList.remove('bg-red-900', 'animate-pulse');
    }, [haltedJobs.length]);


    if (loading) {
        return <div className="text-white text-2xl text-center p-10">Initializing Andon Display...</div>;
    }

    if (haltedJobs.length === 0) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-gray-900 text-center p-10">
                <h1 className="text-6xl font-bold text-green-400">ALL SYSTEMS GO</h1>
                <p className="text-2xl text-gray-400 mt-4">No production halts detected.</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen p-4 sm:p-8">
            <h1 className="text-5xl font-extrabold text-white text-center mb-8">PRODUCTION HALTED</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {haltedJobs.map(job => (
                    <div key={job.id} className="bg-gray-800 border-4 border-yellow-400 rounded-2xl shadow-2xl p-6 flex flex-col">
                        <div className="flex-grow">
                            <div className="flex items-center gap-4 mb-4">
                                <AlertTriangle size={48} className="text-yellow-400 flex-shrink-0" />
                                <div>
                                    <p className="text-sm text-gray-400">{job.departmentName}</p>
                                    <h2 className="text-3xl font-bold text-white">{job.partName}</h2>
                                </div>
                            </div>
                            <div className="bg-gray-900 p-4 rounded-lg mb-4">
                                <p className="text-sm text-gray-400">Reason for Halt:</p>
                                <p className="text-xl text-yellow-300 font-semibold italic">"{job.haltReason}"</p>
                            </div>
                        </div>
                        <div className="border-t border-gray-700 pt-4 text-sm text-gray-400 flex justify-between items-center">
                            <span>Operator: <span className="font-semibold text-white">{job.employeeName}</span></span>
                            <span className="flex items-center gap-2">
                                <Clock size={16} />
                                {job.haltedAt ? moment(job.haltedAt.toDate()).fromNow() : 'Just now'}
                            </span>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default AndonDisplayPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\AssetIntelligencePage.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { getTools, listenToJobCards, getJobStepDetails } from '../api/firestore';
import Dropdown from '../components/ui/Dropdown';
import AssetPerformanceWidget from '../components/intelligence/AssetPerformanceWidget.jsx';

const AssetIntelligencePage = () => {
    const [tools, setTools] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [recipes, setRecipes] = useState([]);
    const [selectedToolId, setSelectedToolId] = useState('');
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            try {
                const [fetchedTools, fetchedRecipes] = await Promise.all([
                    getTools(),
                    getJobStepDetails()
                ]);
                setTools(fetchedTools.filter(t => t.hourlyRate > 0));
                setRecipes(fetchedRecipes);
                
                const unsubscribeJobs = listenToJobCards(setJobs);
                setLoading(false);
                
                return unsubscribeJobs;
            } catch (error) {
                console.error("Error fetching data for Asset Intelligence:", error);
                setLoading(false);
            }
        };

        const unsubscribePromise = fetchData();
        return () => { unsubscribePromise.then(unsub => unsub && unsub()); };
    }, []);

    const analysisData = useMemo(() => {
        if (!selectedToolId) return null;

        const selectedTool = tools.find(t => t.id === selectedToolId);
        if (!selectedTool) return null;

        let totalRunMinutes = 0;
        const contributingJobIds = new Set();
        
        recipes.forEach(recipe => {
            if(recipe.steps && Array.isArray(recipe.steps)) {
                recipe.steps.forEach(step => {
                    if (step.toolId === selectedToolId) {
                        const completedJobsWithRecipe = jobs.filter(job => 
                            job.status === 'Complete' &&
                            job.partId === recipe.productId &&
                            job.departmentId === recipe.departmentId
                        );

                        completedJobsWithRecipe.forEach(job => {
                            totalRunMinutes += step.time || 0;
                            contributingJobIds.add(job.id);
                        });
                    }
                });
            }
        });
        
        const jobsContributed = contributingJobIds.size;
        const totalRunHours = totalRunMinutes / 60;
        const totalOperatingCost = totalRunHours * (selectedTool.hourlyRate || 0);

        const jobsWithTool = jobs.filter(job => contributingJobIds.has(job.id));
        const issueJobsWithTool = jobsWithTool.filter(job => job.status === 'Issue' || job.status === 'Archived - Issue').length;
        const qualityRate = jobsContributed > 0 ? ((jobsContributed - issueJobsWithTool) / jobsContributed) * 100 : 100;

        return {
            name: selectedTool.name,
            totalRunHours,
            totalOperatingCost,
            jobsContributed,
            qualityRate
        };

    }, [selectedToolId, tools, jobs, recipes]);

    if (loading) {
        return <p className="text-center text-gray-400">Loading Asset Intelligence Engine...</p>;
    }

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Asset Intelligence & ROI</h2>
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-lg">
                <Dropdown
                    label="Select an Asset to Analyze"
                    value={selectedToolId}
                    onChange={(e) => setSelectedToolId(e.target.value)}
                    options={tools}
                    placeholder="Choose a machine..."
                />
                 <p className="text-xs text-gray-500 mt-2">Only assets with an hourly rate configured in Settings will appear here.</p>
            </div>

            <AssetPerformanceWidget assetData={analysisData} />
        </div>
    );
};

export default AssetIntelligencePage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\CalendarPage.jsx
==================================================
// src/pages/CalendarPage.jsx

import React, { useState, useEffect } from 'react';
import { Calendar, momentLocalizer } from 'react-big-calendar';
import moment from 'moment';
import 'react-big-calendar/lib/css/react-big-calendar.css';
import { listenToJobCards, updateDocument, getEmployees, getAllInventoryItems, getTools, getToolAccessories } from '../api/firestore';
import JobDetailsModal from '../components/features/tracking/JobDetailsModal';
import Button from '../components/ui/Button';
import SchedulingAssistantModal from '../components/features/calendar/SchedulingAssistantModal';
import DispatchQueue from '../components/features/dispatch/DispatchQueue';
import { Bot, Calendar as CalendarIcon, ListOrdered } from 'lucide-react';
import toast from 'react-hot-toast';

const localizer = momentLocalizer(moment);

const TabButton = ({ id, label, icon, activeTab, setActiveTab }) => {
    const isActive = activeTab === id;
    return (
      <button
        onClick={() => setActiveTab(id)}
        className={`px-5 py-2 text-sm font-semibold rounded-t-lg border-b-2 flex items-center gap-2 transition-colors ${
          isActive ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:border-gray-500 hover:text-gray-200'
        }`}
      >
        {icon}
        {label}
      </button>
    );
};

const CalendarPage = () => {
  const [events, setEvents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedJob, setSelectedJob] = useState(null);
  const [activeTab, setActiveTab] = useState('calendar');
  
  const [employeeHourlyRates, setEmployeeHourlyRates] = useState({});
  const [allEmployees, setAllEmployees] = useState([]);
  const [allInventoryItems, setAllInventoryItems] = useState([]);
  const [allTools, setAllTools] = useState([]);
  const [allToolAccessories, setAllToolAccessories] = useState([]);
  
  const [isAssistantOpen, setAssistantOpen] = useState(false);

  useEffect(() => {
    let unsubscribeJobs;
    const fetchData = async () => {
      setLoading(true);
      try {
        const [fetchedEmployees, fetchedInventory, fetchedTools, fetchedToolAccessories] = await Promise.all([
          getEmployees(),
          getAllInventoryItems(),
          getTools(),
          getToolAccessories(),
        ]);
        setAllEmployees(fetchedEmployees);
        setAllInventoryItems(fetchedInventory);
        setAllTools(fetchedTools);
        setAllToolAccessories(fetchedToolAccessories);

        const rates = fetchedEmployees.reduce((acc, emp) => {
          acc[emp.id] = emp.hourlyRate || 0;
          return acc;
        }, {});
        setEmployeeHourlyRates(rates);

        unsubscribeJobs = listenToJobCards((fetchedJobs) => {
          const calendarEvents = fetchedJobs
            .filter(job => job.scheduledDate)
            .map(job => ({
              id: job.id,
              title: `${job.jobId} - ${job.partName}`,
              start: job.scheduledDate.toDate(),
              end: moment(job.scheduledDate.toDate()).add(job.estimatedTime || 60, 'minutes').toDate(),
              allDay: false,
              resource: job
            }));
          setEvents(calendarEvents);
          setLoading(false);
        });
      } catch (err) {
        console.error("Error fetching calendar data:", err);
        setError("Failed to load calendar data.");
        setLoading(false);
      }
    };

    fetchData();

    return () => {
      if (unsubscribeJobs) unsubscribeJobs();
    };
  }, []);

  const handleSelectEvent = (event) => {
    setSelectedJob(event.resource);
  };

  const handleEventDrop = async ({ event, start, end }) => {
    toast((t) => (
        <span>
            Reschedule "{event.title}" to {moment(start).format('LLL')}?
            <Button variant="primary" size="sm" className="ml-2" onClick={async () => {
                toast.dismiss(t.id);
                try {
                    await updateDocument('createdJobCards', event.id, { scheduledDate: start });
                    toast.success('Job rescheduled successfully!');
                } catch (err) {
                    console.error("Error rescheduling job:", err);
                    toast.error('Failed to reschedule job.');
                }
            }}>
                Confirm
            </Button>
            <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                Cancel
            </Button>
        </span>
    ));
  };
  
  const handleScheduleComplete = () => {
    setAssistantOpen(false);
    toast.success("Jobs have been scheduled successfully and added to the calendar!");
  };

  if (error) return <p className="text-center text-red-400">{error}</p>;

  const calendarStyles = `
    .rbc-calendar { font-family: 'Inter', sans-serif; color: #e2e8f0; background-color: #1f2937; border-radius: 0.75rem; border: 1px solid #374151; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); padding: 1.5rem; height: 100%; }
    .rbc-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #374151; }
    .rbc-toolbar .rbc-toolbar-label { font-size: 1.5rem; font-weight: 700; color: #f9fafb; flex-grow: 1; text-align: center; }
    .rbc-toolbar button { border: none; background-color: #4b5563; color: #f9fafb; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s ease-in-out; cursor: pointer; }
    .rbc-toolbar button:hover { background-color: #6b7280; }
    .rbc-toolbar button.rbc-active { background-color: #2563eb; color: white; }
    .rbc-toolbar .rbc-btn-group { display: flex; gap: 0.5rem; }
    .rbc-header { padding: 0.5rem 0; font-size: 0.875rem; color: #9ca3af; border-bottom: 1px solid #374151; text-align: center; }
    .rbc-header + .rbc-header { border-left: none; }
    .rbc-month-view, .rbc-time-view, .rbc-agenda-view { border: none; }
    .rbc-row-content { border-top: 1px solid #374151; }
    .rbc-day-bg { border-right: 1px solid #374151; }
    .rbc-day-bg:last-child { border-right: none; }
    .rbc-off-range-bg { background-color: #111827; }
    .rbc-current-time-indicator { background-color: #ef4444; }
    .rbc-today { background-color: #3b82f61a; }
    .rbc-event { background-color: #1d4ed8; border: 1px solid #3b82f6; color: white !important; border-radius: 0.375rem; font-size: 0.875rem; padding: 0.25rem 0.5rem; cursor: pointer; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
    .rbc-event:hover { background-color: #3b82f6; border-color: #60a5fa; }
    .rbc-event.rbc-selected { background-color: #6366f1; border-color: #a78bfa; }
    .rbc-event-content { white-space: normal; }
    .rbc-agenda-table { border: 1px solid #374151; border-radius: 0.75rem; }
    .rbc-agenda-table thead th { color: #9ca3af; border-bottom: 1px solid #374151; }
    .rbc-agenda-table tbody td { border-bottom: 1px solid #374151; color: #e2e8f0; }
    .rbc-agenda-time-cell { color: #9ca3af; }
  `;

  return (
    <>
      <style>{calendarStyles}</style>
      <div className="space-y-4 h-full flex flex-col">
        <div className="flex justify-between items-center flex-shrink-0">
            <h2 className="text-3xl font-bold text-white">Workshop Scheduling</h2>
            <Button onClick={() => setAssistantOpen(true)} variant="primary">
                <Bot size={18} className="mr-2"/>
                Scheduling Assistant
            </Button>
        </div>
        
        <div className="border-b border-gray-700">
            <nav className="-mb-px flex space-x-6">
                <TabButton id="calendar" label="Calendar View" icon={<CalendarIcon size={16}/>} activeTab={activeTab} setActiveTab={setActiveTab} />
                <TabButton id="dispatch" label="Dispatch Queue" icon={<ListOrdered size={16}/>} activeTab={activeTab} setActiveTab={setActiveTab} />
            </nav>
        </div>

        {loading ? <p className="text-center text-gray-400">Loading...</p> : (
            <div className="flex-grow min-h-0"> 
                {activeTab === 'calendar' && (
                    <Calendar
                        localizer={localizer}
                        events={events}
                        startAccessor="start"
                        endAccessor="end"
                        selectable
                        resizable
                        draggableAccessor={() => true}
                        onEventDrop={handleEventDrop}
                        onSelectEvent={handleSelectEvent}
                        defaultView="week"
                        views={['month', 'week', 'day', 'agenda']}
                    />
                )}
                {activeTab === 'dispatch' && <DispatchQueue />}
            </div>
        )}
      </div>
      {selectedJob && (
        <JobDetailsModal
          job={selectedJob}
          onClose={() => setSelectedJob(null)}
          currentTime={Date.now()}
          employeeHourlyRates={employeeHourlyRates}
          overheadCostPerHour={0}
          allEmployees={allEmployees}
          allInventoryItems={allInventoryItems}
          allTools={allTools}
          allToolAccessories={allToolAccessories}
          onUpdateJob={() => {}}
          onDeleteJob={() => {}}
        />
      )}
      {isAssistantOpen && (
        <SchedulingAssistantModal 
            onClose={() => setAssistantOpen(false)}
            onScheduleComplete={handleScheduleComplete}
        />
      )}
    </>
  );
};

export default CalendarPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\CustomerDashboardPage.jsx
==================================================
// src/pages/CustomerDashboardPage.jsx

import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { listenToCustomerSalesOrders, addCustomerFeedback } from '../api/firestore';
import { useNavigate, Link } from 'react-router-dom';
import Button from '../components/ui/Button';
import { ChevronDown, ChevronRight, Package, Star } from 'lucide-react';
import FeedbackModal from '../components/features/portal/FeedbackModal'; // --- IMPORT NEW MODAL ---

const OrderRow = ({ order, onRateClick }) => {
    const [isExpanded, setIsExpanded] = useState(false);

    const getStatusColor = (status) => {
        switch (status) {
            case 'Pending Production': return 'bg-yellow-500/20 text-yellow-300';
            case 'In Production': return 'bg-blue-500/20 text-blue-300';
            case 'Fulfilled': return 'bg-green-500/20 text-green-300';
            default: return 'bg-gray-500/20 text-gray-300';
        }
    };

    return (
        <div className="bg-gray-800 rounded-lg border border-gray-700">
            <div className="flex items-center justify-between p-4 hover:bg-gray-700/50">
                <Link to={`/portal/order/${order.id}`} className="flex items-center gap-4 flex-grow">
                    <Package size={24} className="text-gray-400"/>
                    <div>
                        <p className="font-bold text-white text-lg">{order.salesOrderId}</p>
                        <p className="text-sm text-gray-400">
                            Ordered: {order.createdAt?.toDate().toLocaleDateString('en-ZA') || 'N/A'}
                        </p>
                    </div>
                </Link>
                <div className="flex items-center gap-6">
                    <p className="font-mono text-xl text-green-400">R {order.total.toFixed(2)}</p>
                    <span className={`px-3 py-1 text-sm rounded-full font-semibold ${getStatusColor(order.status)}`}>
                        {order.status}
                    </span>
                    {/* --- NEW: Show Rate button for fulfilled orders --- */}
                    {order.status === 'Fulfilled' && (
                        <Button onClick={() => onRateClick(order)} variant="secondary" size="sm" className="py-1 px-2 text-xs">
                            <Star size={14} className="mr-1"/> Rate Order
                        </Button>
                    )}
                    <button onClick={() => setIsExpanded(!isExpanded)} className="p-2 rounded-full hover:bg-gray-600">
                        {isExpanded ? <ChevronDown /> : <ChevronRight />}
                    </button>
                </div>
            </div>
            {isExpanded && (
                <div className="p-4 border-t border-gray-700 space-y-2">
                    <h4 className="font-semibold text-gray-300 text-sm">Line Items:</h4>
                    <ul className="list-disc list-inside pl-2">
                        {order.lineItems.map(item => (
                            <li key={item.id} className="text-gray-400">{item.description} (Qty: {item.quantity})</li>
                        ))}
                    </ul>
                </div>
            )}
        </div>
    );
};

const CustomerDashboardPage = () => {
    const { user } = useAuth();
    const navigate = useNavigate();
    const [orders, setOrders] = useState([]);
    const [loading, setLoading] = useState(true);
    const [orderToRate, setOrderToRate] = useState(null); // --- NEW STATE ---

    useEffect(() => {
        if (!user || !user.email) return;

        const unsubscribe = listenToCustomerSalesOrders(user.email, (fetchedOrders) => {
            setOrders(fetchedOrders);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [user]);

    return (
        <>
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h2 className="text-3xl font-bold text-white">Your Orders</h2>
                    <Button onClick={() => navigate('/portal/products')} variant="primary">
                        <Package size={18} className="mr-2"/>
                        Browse Products & Create Quote
                    </Button>
                </div>

                {loading && <p className="text-center text-gray-400">Loading your orders...</p>}
                
                {!loading && orders.length === 0 && (
                    <div className="text-center py-16 bg-gray-800 rounded-lg">
                        <p className="text-gray-500">You have not placed any orders yet.</p>
                    </div>
                )}

                {!loading && orders.length > 0 && (
                    <div className="space-y-4">
                        {orders.map(order => (
                            <OrderRow key={order.id} order={order} onRateClick={setOrderToRate} />
                        ))}
                    </div>
                )}
            </div>

            {/* --- RENDER THE MODAL --- */}
            {orderToRate && (
                <FeedbackModal
                    order={orderToRate}
                    user={user}
                    onClose={() => setOrderToRate(null)}
                    onSubmit={addCustomerFeedback}
                />
            )}
        </>
    );
};

export default CustomerDashboardPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\CustomerOrderDetailPage.jsx
==================================================
// src/pages/CustomerOrderDetailPage.jsx (NEW FILE)

import React, { useState, useEffect } from 'react';
import { useParams, Link } from 'react-router-dom';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '../api/firebase';
import { listenToJobsForSalesOrder } from '../api/firestore';
import CustomerKanban from '../components/features/portal/CustomerKanban';
import { ChevronsLeft } from 'lucide-react';

const CustomerOrderDetailPage = () => {
    const { orderId } = useParams();
    const [order, setOrder] = useState(null);
    const [jobs, setJobs] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!orderId) return;

        const fetchOrderDetails = async () => {
            setLoading(true);
            const orderRef = doc(db, 'salesOrders', orderId);
            const orderSnap = await getDoc(orderRef);
            if (orderSnap.exists()) {
                setOrder({ id: orderSnap.id, ...orderSnap.data() });
            } else {
                console.error("No such order found!");
            }
        };

        fetchOrderDetails();

        const unsubscribeJobs = listenToJobsForSalesOrder(orderId, (fetchedJobs) => {
            setJobs(fetchedJobs);
            setLoading(false);
        });

        return () => unsubscribeJobs();
    }, [orderId]);

    if (loading) {
        return <p className="text-center text-gray-400">Loading Order Details...</p>;
    }

    if (!order) {
        return <p className="text-center text-red-400">Order not found.</p>;
    }

    return (
        <div className="space-y-6">
            <div>
                <Link to="/portal" className="flex items-center text-blue-400 hover:text-blue-300 mb-4">
                    <ChevronsLeft size={20} className="mr-1" />
                    Back to All Orders
                </Link>
                <h2 className="text-3xl font-bold text-white">Live Tracking for Order: {order.salesOrderId}</h2>
                <p className="text-gray-400">Customer: {order.customerName}</p>
            </div>
            
            <CustomerKanban jobs={jobs} />
        </div>
    );
};

export default CustomerOrderDetailPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\CustomerPortalHomePage.jsx
==================================================
// src/pages/CustomerPortalHomePage.jsx (NEW FILE)

import React from 'react';

const CustomerPortalHomePage = () => {
    return (
        <div>
            <h2 className="text-3xl font-bold text-white">Welcome to the TOJEM Customer Portal</h2>
            <p className="text-gray-400 mt-2">
                This is where you will browse products and create orders. This page is currently under construction.
            </p>
        </div>
    );
};

export default CustomerPortalHomePage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\DashboardPage.jsx
==================================================
// src/pages/DashboardPage.jsx (UPDATED)
// This version now fetches and displays the RoutineTasksWidget for the current day.

import React, { useState, useEffect, useMemo } from 'react';
import { 
    listenToJobCards, 
    getEmployees, 
    collection, 
    getDocs, 
    listenToSystemStatus,
    getRoutineTasks // <-- NEW IMPORT
} from '../api/firestore';
import { db } from '../api/firebase';
import { HeartPulse, CheckCircle2, AlertTriangle, HardHat } from 'lucide-react';
import moment from 'moment';

// Import all the intelligence widgets
import YoYSalesComparison from '../components/intelligence/YoYSalesComparison.jsx';
import YoYProfitWidget from '../components/intelligence/YoYProfitWidget.jsx';
import MultiYearSalesGraph from '../components/intelligence/MultiYearSalesGraph.jsx';
import TopReworkCausesWidget from '../components/intelligence/TopReworkCausesWidget.jsx';
import BottleneckWidget from '../components/intelligence/BottleneckWidget.jsx';
import WorkshopThroughputGraph from '../components/intelligence/WorkshopThroughputGraph.jsx';
import ManagerFocusWidget from '../components/features/dashboard/ManagerFocusWidget';
import RoutineTasksWidget from '../components/features/dashboard/RoutineTasksWidget'; // <-- NEW IMPORT

const KpiCard = ({ icon, title, value, color }) => (
    <div className="bg-gray-800 p-4 rounded-lg border border-gray-700 flex items-center space-x-3">
        <div className={`p-3 rounded-full ${color}`}>
            {icon}
        </div>
        <div>
            <p className="text-gray-400 text-sm">{title}</p>
            <p className="text-xl font-bold text-white">{value}</p>
        </div>
    </div>
);


const DashboardPage = () => {
    const [jobs, setJobs] = useState([]);
    const [employees, setEmployees] = useState([]);
    const [historicalSales, setHistoricalSales] = useState([]);
    const [systemStatus, setSystemStatus] = useState(null);
    const [todaysTasks, setTodaysTasks] = useState([]); // <-- NEW STATE
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        setLoading(true);
        const fetchData = async () => {
            try {
                const [employeeItems, historicalSalesSnapshot, routineTasks] = await Promise.all([
                    getEmployees(), 
                    getDocs(collection(db, 'historicalSales')),
                    getRoutineTasks() // <-- FETCH ROUTINE TASKS
                ]);
                setEmployees(employeeItems);
                setHistoricalSales(historicalSalesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data()})))

                // --- NEW: Logic to filter tasks for today ---
                const dayOfWeek = moment().format('dddd').toLowerCase(); // e.g., 'friday'
                const filteredTasks = routineTasks.filter(task => {
                    return task.schedule === 'daily' || task.schedule === `weekly_${dayOfWeek}`;
                });
                setTodaysTasks(filteredTasks);
                // --- END NEW LOGIC ---

                const unsubscribeJobs = listenToJobCards(setJobs);
                const unsubscribeStatus = listenToSystemStatus(setSystemStatus);
                
                return () => {
                    unsubscribeJobs();
                    unsubscribeStatus();
                };

            } catch (error) {
                console.error("Failed to fetch dashboard data:", error);
            } finally {
                setLoading(false); 
            }
        }
        
        const unsubscribePromise = fetchData();
        return () => { unsubscribePromise.then(cleanup => cleanup && cleanup()); };
    }, []);

    const dashboardData = useMemo(() => {
        if (loading) return null;

        const now = new Date();
        const currentMonthIndex = now.getMonth();
        const currentYear = now.getFullYear();
        const lastYear = currentYear - 1;

        const currentMonthData = historicalSales.find(d => d.year === currentYear && d.month === (currentMonthIndex + 1));
        const currentMonthSales = currentMonthData?.totalSales || 0;
        const currentMonthProfit = currentMonthData ? (currentMonthData.totalSales - currentMonthData.totalCOGS) : 0;
        
        const lastYearData = historicalSales.find(d => d.year === lastYear && d.month === (currentMonthIndex + 1));
        const lastYearSales = lastYearData?.totalSales || 0;
        const lastYearProfit = lastYearData ? (lastYearData.totalSales - lastYearData.totalCOGS) : 0;
        
        const uniqueYears = [...new Set(historicalSales.map(d => d.year))].sort();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        
        const multiYearSalesData = monthNames.map((monthName, index) => {
            const monthData = { name: monthName };
            uniqueYears.forEach(year => {
                const record = historicalSales.find(d => d.year === year && d.month === (index + 1));
                monthData[year] = record ? record.totalSales : 0;
            });
            return monthData;
        });
        
        const issueJobs = jobs.filter(j => j.status === 'Issue' || j.status === 'Archived - Issue');
        const reworkRate = jobs.length > 0 ? (issueJobs.length / jobs.length) * 100 : 0;

        const reworkCauses = issueJobs
            .filter(j => j.issueReason)
            .reduce((acc, job) => {
                const reason = job.issueReason.trim();
                acc[reason] = (acc[reason] || 0) + 1;
                return acc;
            }, {});

        const topReworkCauses = Object.entries(reworkCauses)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

        const completedJobs = jobs.filter(j => j.status === 'Complete' && j.completedAt);
        const weeklyBuckets = {};
        for (let i = 0; i < 8; i++) {
            const weekStart = moment().subtract(i, 'weeks').startOf('isoWeek').format('MMM D');
            weeklyBuckets[weekStart] = { name: weekStart, jobs: 0 };
        }
        completedJobs.forEach(job => {
            const completionWeekStart = moment(job.completedAt.toDate()).startOf('isoWeek').format('MMM D');
            if (weeklyBuckets[completionWeekStart]) {
                weeklyBuckets[completionWeekStart].jobs += (job.quantity || 1);
            }
        });
        const jobCompletionData = Object.values(weeklyBuckets).reverse();

        return {
            currentMonthSales, lastYearSales, currentMonthProfit, lastYearProfit,
            multiYearSalesData, uniqueYears, topReworkCauses,
            reworkRate: reworkRate.toFixed(1),
            activeJobs: jobs.filter(j => ['In Progress', 'Halted - Issue'].includes(j.status)).length,
            jobsInQc: jobs.filter(j => j.status === 'Awaiting QC').length,
            jobCompletionData,
        };
    }, [jobs, employees, historicalSales, loading]);

    if (loading || !dashboardData) {
        return <p className="text-center text-gray-400">Loading Mission Control...</p>;
    }

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Mission Control</h2>

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <KpiCard icon={<HeartPulse size={24} />} title="Company Health" value={`${(100 - parseFloat(dashboardData.reworkRate)).toFixed(0)} / 100`} color="bg-red-500/20 text-red-400" />
                <KpiCard icon={<HardHat size={24} />} title="Active Jobs" value={dashboardData.activeJobs} color="bg-blue-500/20 text-blue-400" />
                <KpiCard icon={<CheckCircle2 size={24} />} title="Jobs in QC" value={dashboardData.jobsInQc} color="bg-purple-500/20 text-purple-400" />
                <KpiCard icon={<AlertTriangle size={24} />} title="Overall Rework Rate" value={`${dashboardData.reworkRate}%`} color="bg-orange-500/20 text-orange-400" />
            </div>
            
            {/* --- WIDGETS ARE NOW DISPLAYED IN A GRID --- */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <ManagerFocusWidget />
                <RoutineTasksWidget tasks={todaysTasks} />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <YoYSalesComparison 
                        currentMonthSales={dashboardData.currentMonthSales}
                        lastYearSales={dashboardData.lastYearSales}
                    />
                    <YoYProfitWidget 
                        currentMonthProfit={dashboardData.currentMonthProfit}
                        lastYearProfit={dashboardData.lastYearProfit}
                    />
                </div>
                <div className="lg:col-span-1">
                     <BottleneckWidget bottleneck={systemStatus} />
                </div>
            </div>

            <MultiYearSalesGraph 
                salesData={dashboardData.multiYearSalesData} 
                years={dashboardData.uniqueYears}
            />
            
             <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <WorkshopThroughputGraph jobCompletionData={dashboardData.jobCompletionData} />
                <TopReworkCausesWidget data={dashboardData.topReworkCauses} />
            </div>
        </div>
    );
};

export default DashboardPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\EmployeeIntelligencePage.jsx
==================================================
// src/pages/EmployeeIntelligencePage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { useParams, Link } from 'react-router-dom';
import { getDoc, doc } from 'firebase/firestore';
import { db } from '../api/firebase';
import { 
    getCompletedJobsForEmployee, 
    getOverheadCategories, 
    getOverheadExpenses, 
    getEmployees, 
    listenToJobCards, 
    getSkills, 
    getTrainingResources,
    addPraise, // <-- Import addPraise
    listenToPraiseForEmployee // <-- Import listenToPraiseForEmployee
} from '../api/firestore';
import { useAuth } from '../contexts/AuthContext'; // <-- Import useAuth
import { ChevronsLeft, Zap, DollarSign, AlertCircle, CheckCircle2, Users, BarChartHorizontal, Lightbulb, GraduationCap, Link as LinkIcon, Award, Gem, ShieldCheck, Star, TrendingDown, Clock, ShieldAlert, Send } from 'lucide-react';
import Button from '../components/ui/Button'; // <-- Import Button

// Child Components (Widgets)
import EfficiencyChart from '../components/intelligence/EfficiencyChart';
import PerformanceSnapshot from '../components/intelligence/PerformanceSnapshot';
import ValueWasteAnalysis from '../components/intelligence/ValueWasteAnalysis';
import ReworkAnalysisModal from '../components/intelligence/ReworkAnalysisModal';
import RealTimeValueWidget from '../components/intelligence/RealTimeValueWidget';
import SkillProgressionWidget from '../components/intelligence/SkillProgressionWidget';
import EfficiencyAnalysisModal from '../components/intelligence/EfficiencyAnalysisModal';
import TrophyCase from '../components/intelligence/TrophyCase';
import ReliabilityReport from '../components/intelligence/ReliabilityReport';
import PraiseWidget from '../components/intelligence/PraiseWidget'; // <-- Import PraiseWidget
import PraiseModal from '../components/intelligence/PraiseModal'; // <-- Import PraiseModal

const KpiCard = ({ icon, title, value, teamAverage, color, onClick, buttonText }) => (
    <div className={`bg-gray-800 p-5 rounded-lg border border-gray-700 flex flex-col justify-between`}>
        <div className="flex items-start space-x-4">
            <div className={`p-3 rounded-full ${color}`}>{icon}</div>
            <div>
                <p className="text-gray-400 text-sm">{title}</p>
                <p className="text-2xl font-bold text-white">{value}</p>
                {teamAverage && (<div className="flex items-center text-xs text-gray-500 mt-1"><Users size={12} className="mr-1"/><span>Team Avg: {teamAverage}</span></div>)}
            </div>
        </div>
        {onClick && (
            <button onClick={onClick} className="mt-4 text-xs font-semibold text-blue-400 hover:text-blue-300 text-left flex items-center">
                <BarChartHorizontal size={14} className="mr-1" />{buttonText || 'Analyze'}
            </button>
        )}
    </div>
);

const SkillGapAnalysisWidget = ({ employee, jobs, allSkills, trainingResources }) => {
    const skillInsights = useMemo(() => {
        if (!employee || !jobs || !allSkills) return [];
        const insights = [];
        const employeeSkillsMap = new Map(Object.entries(employee.skills || {}));
        const allSkillsMap = new Map(allSkills.map(s => [s.id, s.name]));
        const resourcesMap = (trainingResources || []).reduce((acc, resource) => {
            if (!acc[resource.skillId]) { acc[resource.skillId] = []; }
            acc[resource.skillId].push(resource);
            return acc;
        }, {});
        const { individual } = employee.performanceMetrics || {};
        if (!individual) return [];
        if (individual.efficiency < 90) {
            employeeSkillsMap.forEach((proficiency, skillId) => {
                if (proficiency < 4) { insights.push({ type: 'efficiency_gap', skillId: skillId, skillName: allSkillsMap.get(skillId) || 'Unknown Skill', message: `Consider training in ${allSkillsMap.get(skillId) || 'this skill'} to boost overall efficiency.`, currentProficiency: proficiency }); }
            });
        }
        if (individual.reworkRate > 5) {
             employeeSkillsMap.forEach((proficiency, skillId) => {
                if (proficiency < 5) { insights.push({ type: 'quality_gap', skillId: skillId, skillName: allSkillsMap.get(skillId) || 'Unknown Skill', message: `Review techniques in ${allSkillsMap.get(skillId) || 'this skill'} to reduce rework.`, currentProficiency: proficiency }); }
            });
        }
        const uniqueInsights = [];
        const seenMessages = new Set();
        insights.forEach(insight => {
            if (!seenMessages.has(insight.message)) {
                insight.resources = resourcesMap[insight.skillId] || [];
                uniqueInsights.push(insight);
                seenMessages.add(insight.message);
            }
        });
        return uniqueInsights;
    }, [employee, jobs, allSkills, trainingResources]);

    if (!employee || !allSkills) return null;
    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><GraduationCap size={20} className="text-purple-400"/> Skill Gap & Training Suggestions</h3>
            {skillInsights.length > 0 ? (
                <ul className="space-y-4">
                    {skillInsights.map((insight, index) => (
                        <li key={index} className="bg-gray-700/50 p-4 rounded-lg">
                            <div className="flex items-start space-x-3">
                                <div className="flex-shrink-0 mt-1">{insight.type.includes('efficiency') ? <Zap size={18} className="text-blue-400" /> : <AlertCircle size={18} className="text-red-400" />}</div>
                                <div><p className="text-sm text-gray-200">{insight.message}</p><p className="text-xs text-gray-400">Current Proficiency Level: {insight.currentProficiency}</p></div>
                            </div>
                            {insight.resources.length > 0 && (
                                <div className="mt-3 pt-3 border-t border-gray-600/50 space-y-2">
                                    <p className="text-xs font-semibold text-gray-300">Suggested Resources:</p>
                                    {insight.resources.map(res => (<a key={res.id} href={res.url} target="_blank" rel="noopener noreferrer" className="flex items-center text-sm text-blue-400 hover:underline"><LinkIcon size={14} className="mr-2"/>{res.resourceName} ({res.type})</a>))}
                                </div>
                            )}
                        </li>
                    ))}
                </ul>
            ) : (<p className="text-gray-400 text-sm">No specific skill gaps or training suggestions identified.</p>)}
        </div>
    );
};

const ProactiveInterventionWidget = ({ jobs, employee, allSkills }) => {
    const alerts = useMemo(() => {
        const recentJobs = [...jobs]
            .filter(j => j.status === 'Complete' || j.status === 'Issue')
            .sort((a, b) => b.completedAt.toDate() - a.completedAt.toDate())
            .slice(0, 5);

        if (recentJobs.length < 3) return [];

        const newAlerts = [];
        
        const efficiencies = recentJobs.map(j => {
            if (!j.estimatedTime || !j.completedAt?.toDate() || !j.startedAt?.toDate()) return null;
            const actualSeconds = (j.completedAt.toDate().getTime() - j.startedAt.toDate().getTime() - (j.totalPausedMilliseconds || 0)) / 1000;
            if (actualSeconds <= 0) return null;
            return (j.estimatedTime * 60) / actualSeconds;
        }).filter(e => e !== null);

        if (efficiencies.length >= 3 && efficiencies[0] < efficiencies[efficiencies.length - 1]) {
            newAlerts.push({
                id: 'efficiency-decline',
                icon: <TrendingDown className="text-yellow-400" size={20} />,
                title: "Efficiency Trend Alert",
                message: "A potential decline in efficiency has been observed over the last few jobs. Early review is recommended."
            });
        }
        
        const issueCount = recentJobs.filter(j => j.status === 'Issue' || j.status === 'Archived - Issue').length;
        if (issueCount >= 2) {
             newAlerts.push({
                id: 'rework-increase',
                icon: <ShieldAlert className="text-red-400" size={20} />,
                title: "Rework Rate Concern",
                message: `An increase in jobs with issues (${issueCount} of the last ${recentJobs.length}) has been detected. Consider a quality check-in.`
            });
        }

        const underestimatedJobs = recentJobs.filter(j => {
            if (!j.estimatedTime || !j.completedAt?.toDate() || !j.startedAt?.toDate()) return false;
            const actualSeconds = (j.completedAt.toDate().getTime() - j.startedAt.toDate().getTime() - (j.totalPausedMilliseconds || 0)) / 1000;
            return actualSeconds > (j.estimatedTime * 60);
        }).length;

        if (underestimatedJobs / recentJobs.length >= 0.6) {
             newAlerts.push({
                id: 'time-estimation',
                icon: <Clock className="text-blue-400" size={20} />,
                title: "Time Estimation Pattern",
                message: "A pattern of underestimating job duration has been noted. A review of the estimation process may be helpful."
            });
        }

        return newAlerts;

    }, [jobs, employee, allSkills]);

    if (alerts.length === 0) return null;

    return (
        <div className="bg-gray-800/50 p-6 rounded-lg border border-yellow-500/30">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Lightbulb size={20} className="text-yellow-400"/> Proactive Interventions</h3>
            <p className="text-sm text-gray-400 mb-4">The following trends have been identified from recent activity and may warrant a proactive conversation.</p>
            <ul className="space-y-3">
                {alerts.map(alert => (
                    <li key={alert.id} className="flex items-start space-x-3 p-3 bg-gray-700/40 rounded-md">
                        <div className="flex-shrink-0 mt-1">{alert.icon}</div>
                        <div>
                            <h4 className="font-semibold text-gray-200">{alert.title}</h4>
                            <p className="text-sm text-gray-300">{alert.message}</p>
                        </div>
                    </li>
                ))}
            </ul>
        </div>
    );
};

const EmployeeIntelligencePage = () => {
    const { employeeId } = useParams();
    const { user } = useAuth(); // <-- Get current user
    const [employee, setEmployee] = useState(null);
    const [allEmployees, setAllEmployees] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [allJobs, setAllJobs] = useState([]);
    const [allSkills, setAllSkills] = useState([]);
    const [trainingResources, setTrainingResources] = useState([]);
    const [overheads, setOverheads] = useState(0);
    const [loading, setLoading] = useState(true);
    const [isReworkModalOpen, setReworkModalOpen] = useState(false);
    const [isEfficiencyModalOpen, setEfficiencyModalOpen] = useState(false);
    const [isPraiseModalOpen, setIsPraiseModalOpen] = useState(false); // <-- State for praise modal
    const [praiseItems, setPraiseItems] = useState([]); // <-- State for praise data
    const [loadingPraise, setLoadingPraise] = useState(true); // <-- Loading state for praise

    useEffect(() => {
        let unsubscribeJobs = () => {};
        let unsubscribePraise = () => {};

        const fetchAllData = async () => {
            if (!employeeId) return;
            setLoading(true);
            try {
                const employeeDocRef = doc(db, 'employees', employeeId);
                const [employeeDoc, completedJobs, overheadCategories, allEmps, fetchedSkills, fetchedResources] = await Promise.all([
                    getDoc(employeeDocRef), getCompletedJobsForEmployee(employeeId), getOverheadCategories(), getEmployees(), getSkills(), getTrainingResources(),
                ]);
                if (employeeDoc.exists()) setEmployee({ id: employeeDoc.id, ...employeeDoc.data() });
                setJobs(completedJobs); setAllEmployees(allEmps); setAllSkills(fetchedSkills); setTrainingResources(fetchedResources);
                
                unsubscribeJobs = listenToJobCards(j => setAllJobs(j));
                
                // Set up listener for praise items
                setLoadingPraise(true);
                unsubscribePraise = listenToPraiseForEmployee(employeeId, (fetchedPraise) => {
                    setPraiseItems(fetchedPraise);
                    setLoadingPraise(false);
                });

                let totalOverheads = 0;
                const expensePromises = overheadCategories.map(cat => getOverheadExpenses(cat.id));
                const expenseResults = await Promise.all(expensePromises);
                expenseResults.flat().forEach(exp => { totalOverheads += exp.amount || 0; });
                setOverheads(totalOverheads);
            } catch (error) { console.error("Error fetching employee data:", error); }
            setLoading(false);
        };
        fetchAllData();
        return () => {
            unsubscribeJobs();
            unsubscribePraise();
        };
    }, [employeeId]);

    const { performanceMetrics, overheadCostPerHour, earnedBadges } = useMemo(() => {
        const metrics = { individual: { efficiency: 0, netValueAdded: 0, reworkRate: 0, jobsCompleted: 0 }, team: { efficiency: 0, netValueAdded: 0, reworkRate: 0 } };
        if (!employee || allEmployees.length === 0) return { performanceMetrics: metrics, overheadCostPerHour: 0, earnedBadges: [] };
        
        const calculatedOverheadCostPerHour = overheads > 0 && allEmployees.length > 0 ? overheads / (allEmployees.length * 173.2) : 0;
        const issueJobsCount = jobs.filter(j => j.status === 'Issue' || j.status === 'Archived - Issue').length;
        const completedJobs = jobs.filter(j => j.status === 'Complete');
        let individualTotalWorkMinutes = 0, individualTotalEfficiencyRatioSum = 0, individualTotalJobValue = 0, jobsWithTime = 0;
        
        completedJobs.forEach(job => {
            if (job.startedAt?.toDate && job.completedAt?.toDate) {
                const durationSeconds = (job.completedAt.toDate().getTime() - job.startedAt.toDate().getTime() - (job.totalPausedMilliseconds || 0)) / 1000;
                if(durationSeconds > 0) {
                    individualTotalWorkMinutes += durationSeconds / 60;
                    if (job.estimatedTime > 0) { 
                        individualTotalEfficiencyRatioSum += (job.estimatedTime * 60) / durationSeconds;
                        jobsWithTime++;
                     }
                }
            }
            individualTotalJobValue += job.totalCost || 0;
        });

        const burdenedRate = (employee.hourlyRate || 0) + calculatedOverheadCostPerHour;
        const totalLaborCost = (individualTotalWorkMinutes / 60) * burdenedRate;
        metrics.individual = {
            efficiency: jobsWithTime > 0 ? (individualTotalEfficiencyRatioSum / jobsWithTime) * 100 : 0,
            netValueAdded: individualTotalJobValue - totalLaborCost,
            reworkRate: jobs.length > 0 ? (issueJobsCount / jobs.length) * 100 : 0,
            jobsCompleted: jobs.length
        };
        
        const departmentEmployees = allEmployees.filter(e => e.departmentId === employee.departmentId);
        const departmentEmployeeIds = new Set(departmentEmployees.map(e => e.id));
        const departmentJobs = allJobs.filter(j => j.completedAt && departmentEmployeeIds.has(j.employeeId));
        const teamIssueJobsCount = departmentJobs.filter(j => j.status === 'Issue' || j.status === 'Archived - Issue').length;
        const teamCompletedJobs = departmentJobs.filter(j => j.status === 'Complete' && j.startedAt?.toDate && j.completedAt?.toDate);
        
        const employeeMap = new Map(allEmployees.map(e => [e.id, e]));
        let teamTotalEfficiencyRatioSum = 0, teamTotalValue = 0, teamTotalLaborCost = 0, teamJobsWithTime = 0;
        
        teamCompletedJobs.forEach(job => {
            const jobWorkMinutes = ((job.completedAt.toDate().getTime() - job.startedAt.toDate().getTime() - (job.totalPausedMilliseconds || 0)) / 1000) / 60;
            if (job.estimatedTime > 0 && jobWorkMinutes > 0) {
                const actualSeconds = jobWorkMinutes * 60;
                teamTotalEfficiencyRatioSum += (job.estimatedTime * 60) / actualSeconds;
                teamJobsWithTime++;
            }
            const employeeForJob = employeeMap.get(job.employeeId);
            if(employeeForJob) {
                 const empBurdenedRate = (employeeForJob.hourlyRate || 0) + calculatedOverheadCostPerHour;
                 teamTotalLaborCost += (jobWorkMinutes / 60) * empBurdenedRate;
            }
            teamTotalValue += job.totalCost || 0;
        });

        metrics.team = {
            efficiency: teamJobsWithTime > 0 ? (teamTotalEfficiencyRatioSum / teamJobsWithTime) * 100 : 0,
            netValueAdded: departmentEmployees.length > 0 ? (teamTotalValue - teamTotalLaborCost) / departmentEmployees.length : 0,
            reworkRate: departmentJobs.length > 0 ? (teamIssueJobsCount / departmentJobs.length) * 100 : 0
        };

        const badges = [];
        if (metrics.individual.reworkRate <= 1 && metrics.individual.jobsCompleted >= 10) {
            badges.push({ id: 'quality-champ', icon: <ShieldCheck size={24} />, label: 'Quality Champion', color: 'bg-green-500/20 text-green-300', description: 'Awarded for maintaining a rework rate of 1% or less over at least 10 jobs.' });
        }
        if (metrics.individual.efficiency >= 120 && metrics.individual.jobsCompleted >= 10) {
            badges.push({ id: 'efficiency-king', icon: <Zap size={24} />, label: 'Efficiency King', color: 'bg-purple-500/20 text-purple-300', description: 'Awarded for maintaining an average efficiency of 120% or more.' });
        }
        if (metrics.individual.jobsCompleted >= 100) {
            badges.push({ id: '100-club', icon: <Gem size={24} />, label: '100 Club', color: 'bg-blue-500/20 text-blue-300', description: 'Awarded for completing 100 jobs.' });
        }
        const kudosCount = jobs.filter(j => j.kudos === true).length;
        if (kudosCount > 0) {
            badges.push({ id: 'kudos', icon: <Star size={24} />, label: `${kudosCount}x Kudos`, color: 'bg-yellow-500/20 text-yellow-300', description: 'Recognized by management for outstanding work.' });
        }

        return { performanceMetrics: metrics, overheadCostPerHour: calculatedOverheadCostPerHour, earnedBadges: badges };
    }, [employee, jobs, allEmployees, allJobs, overheads]);

    const employeeWithMetrics = useMemo(() => {
        if (!employee) return null;
        return { ...employee, performanceMetrics };
    }, [employee, performanceMetrics]);

    if (loading) return <p className="text-white text-center">Loading Performance & Value Engine...</p>;
    if (!employee) return <p className="text-red-500 text-center">Employee not found.</p>;

    return (
        <>
            <div className="space-y-8">
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <Link to="/performance" className="flex items-center text-blue-400 hover:text-blue-300">
                            <ChevronsLeft size={20} className="mr-1" />Back to Business Performance Dashboard
                        </Link>
                        {/* NEW: Give Praise Button */}
                        <Button onClick={() => setIsPraiseModalOpen(true)} variant="secondary">
                            <Send size={16} className="mr-2" /> Give Praise
                        </Button>
                    </div>
                    <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                        <h2 className="text-3xl font-bold text-white">{employee.name}</h2>
                        <p className="text-gray-400">Performance & Value Engine</p>
                    </div>
                </div>
                <TrophyCase badges={earnedBadges} />
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <KpiCard icon={<Zap size={24} />} title="Overall Efficiency" value={`${performanceMetrics.individual.efficiency.toFixed(0)}%`} teamAverage={`${performanceMetrics.team.efficiency.toFixed(0)}%`} color="bg-purple-500/20 text-purple-400" onClick={() => setEfficiencyModalOpen(true)} buttonText="Analyze by Department" />
                    <KpiCard icon={<DollarSign size={24} />} title="Net Value Added (Period)" value={`R ${performanceMetrics.individual.netValueAdded.toFixed(2)}`} teamAverage={`R ${performanceMetrics.team.netValueAdded.toFixed(2)}`} color="bg-green-500/20 text-green-400" />
                    <KpiCard icon={<AlertCircle size={24} />} title="Rework / Issue Rate" value={`${performanceMetrics.individual.reworkRate.toFixed(1)}%`} teamAverage={`${performanceMetrics.team.reworkRate.toFixed(1)}%`} color="bg-red-500/20 text-red-400" onClick={() => setReworkModalOpen(true)} buttonText="Analyze Root Causes"/>
                    <KpiCard icon={<CheckCircle2 size={24} />} title="Jobs Completed" value={performanceMetrics.individual.jobsCompleted} color="bg-blue-500/20 text-blue-400" />
                </div>
                
                <ProactiveInterventionWidget jobs={jobs} employee={employee} allSkills={allSkills} />

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2"><PerformanceSnapshot metrics={performanceMetrics} /></div>
                    <RealTimeValueWidget jobs={jobs} employee={employee} overheadCostPerHour={overheadCostPerHour} />
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div className="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                        <h3 className="text-xl font-bold text-white mb-4">Efficiency Over Time</h3>
                        <EfficiencyChart jobs={jobs} />
                    </div>
                    <ValueWasteAnalysis jobs={jobs} />
                </div>
                
                {/* NEW: Praise Widget added to the layout */}
                <PraiseWidget praiseItems={praiseItems} loading={loadingPraise} />

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <ReliabilityReport employeeId={employeeId} />
                    <SkillProgressionWidget employeeId={employeeId} />
                </div>
                {employeeWithMetrics && (<SkillGapAnalysisWidget employee={employeeWithMetrics} jobs={jobs} allSkills={allSkills} trainingResources={trainingResources} />)}
            </div>
            {isEfficiencyModalOpen && (<EfficiencyAnalysisModal jobs={jobs} employeeName={employee.name} onClose={() => setEfficiencyModalOpen(false)} />)}
            {isReworkModalOpen && (<ReworkAnalysisModal jobs={jobs} employeeName={employee.name} onClose={() => setReworkModalOpen(false)} />)}
            {/* NEW: Render Praise Modal */}
            {isPraiseModalOpen && (
                <PraiseModal 
                    allEmployees={allEmployees}
                    currentUser={user}
                    onSubmit={addPraise}
                    onClose={() => setIsPraiseModalOpen(false)}
                />
            )}
        </>
    );
};

export default EmployeeIntelligencePage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\FloorPlanPage.jsx
==================================================
// src/pages/FloorPlanPage.jsx (NEW FILE)

import React, { useState, useEffect } from 'react';
import { listenToJobCards, getDepartments } from '../api/firestore';
import FloorPlan from '../components/features/floorplan/FloorPlan';
import { Map } from 'lucide-react';

const FloorPlanPage = () => {
    const [jobs, setJobs] = useState([]);
    const [departments, setDepartments] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            try {
                const fetchedDepartments = await getDepartments();
                setDepartments(fetchedDepartments);

                const unsubscribeJobs = listenToJobCards((allJobs) => {
                    setJobs(allJobs);
                    setLoading(false);
                });

                return unsubscribeJobs;
            } catch (error) {
                console.error("Error fetching data for Floor Plan:", error);
                setLoading(false);
            }
        };

        const unsubscribePromise = fetchData();
        return () => { unsubscribePromise.then(unsub => unsub && unsub()); };
    }, []);

    if (loading) {
        return <p className="text-center text-gray-400">Loading Digital Twin of Factory Floor...</p>;
    }

    return (
        <div className="space-y-6">
            <div className="flex items-center gap-3">
                <Map size={32} className="text-green-400" />
                <div>
                    <h2 className="text-3xl font-bold text-white">Live Factory Floor Plan</h2>
                    <p className="text-gray-400">A real-time digital twin of all jobs currently in progress.</p>
                </div>
            </div>
            <FloorPlan jobs={jobs} departments={departments} />
        </div>
    );
};

export default FloorPlanPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\IssuesPage.jsx
==================================================
// src/pages/IssuesPage.jsx (Upgraded with Toasts)

import React, { useState, useEffect, useMemo } from 'react';
import { listenToJobCards, updateDocument, getEmployees, getAllInventoryItems, getTools, getToolAccessories, deleteDocument } from '../api/firestore';
import JobDetailsModal from '../components/features/tracking/JobDetailsModal';
import Button from '../components/ui/Button';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { AlertTriangle, HardHat } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const IssuesPage = () => {
    const [jobs, setJobs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedJob, setSelectedJob] = useState(null);
    const [employeeHourlyRates, setEmployeeHourlyRates] = useState({});
    const [allEmployees, setAllEmployees] = useState([]);
    const [allInventoryItems, setAllInventoryItems] = useState([]);
    const [allTools, setAllTools] = useState([]);
    const [allToolAccessories, setAllToolAccessories] = useState([]);
    const [searchParams, setSearchParams] = useSearchParams();
    const navigate = useNavigate();

    useEffect(() => {
        let unsubscribeJobs;
        const fetchData = async () => {
            setLoading(true);
            try {
                const [fetchedEmployees, fetchedInventory, fetchedTools, fetchedToolAccessories] = await Promise.all([
                    getEmployees(),
                    getAllInventoryItems(),
                    getTools(),
                    getToolAccessories(),
                ]);
                setAllEmployees(fetchedEmployees);
                setAllInventoryItems(fetchedInventory);
                setAllTools(fetchedTools);
                setAllToolAccessories(fetchedToolAccessories);

                const rates = fetchedEmployees.reduce((acc, emp) => {
                    acc[emp.id] = emp.hourlyRate || 0;
                    return acc;
                }, {});
                setEmployeeHourlyRates(rates);

                unsubscribeJobs = listenToJobCards((fetchedJobs) => {
                    setJobs(fetchedJobs);
                    setLoading(false);
                });
            } catch (error) {
                console.error("Failed to fetch initial data for issues page:", error);
                setLoading(false);
            }
        };

        fetchData();
        return () => { if (unsubscribeJobs) unsubscribeJobs(); };
    }, []);

    useEffect(() => {
        const jobIdFromUrl = searchParams.get('jobId');
        if (jobIdFromUrl && !loading && jobs.length > 0) {
            const jobToOpen = jobs.find(job => job.jobId === jobIdFromUrl);
            if (jobToOpen) {
                setSelectedJob(jobToOpen);
            }
        }
    }, [searchParams, loading, jobs]);

    const { haltedJobs, qcRejectedJobs } = useMemo(() => {
        const halted = jobs.filter(job => job.status === 'Halted - Issue');
        const rejected = jobs.filter(job => job.status === 'Issue');
        return { haltedJobs: halted, qcRejectedJobs: rejected };
    }, [jobs]);

    const handleArchive = (jobId) => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Are you sure you want to archive this issue?
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    updateDocument('createdJobCards', jobId, { status: 'Archived - Issue' })
                        .then(() => toast.success("Issue has been archived."))
                        .catch(err => {
                            toast.error("Error: Could not archive the issue.");
                            console.error("Failed to archive issue:", err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Archive
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    const handleUpdateJob = async (jobDocId, updatedData) => {
        try {
            await updateDocument('createdJobCards', jobDocId, updatedData);
        } catch (error) {
            console.error("Error updating job from modal:", error);
            throw error;
        }
    };

    const handleDeleteJob = async (jobDocId) => {
        try {
            await deleteDocument('createdJobCards', jobDocId);
            toast.success("Job deleted successfully!"); // --- REPLACE ALERT ---
            setSelectedJob(null);
            navigate('/issues', { replace: true });
        } catch (error) {
            console.error("Error deleting job from modal:", error);
            toast.error("Failed to delete job."); // --- REPLACE ALERT ---
        }
    };

    const handleCloseModal = () => {
        setSelectedJob(null);
        navigate('/issues', { replace: true });
    };

    return (
        <>
            <div className="space-y-8">
                <h2 className="text-3xl font-bold text-white">Issues & Halts</h2>
                
                <div>
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><HardHat className="text-yellow-400"/> Live Halted Jobs (Andon Cord)</h3>
                    <div className="bg-gray-800 rounded-lg border border-yellow-500/50 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead>
                                    <tr className="border-b border-gray-600 bg-gray-900/50">
                                        <th className="p-3 text-sm font-semibold text-gray-400">Part</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Employee</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Reason for Halt</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {loading ? (
                                        <tr><td colSpan="4" className="text-center p-8 text-gray-400">Loading...</td></tr>
                                    ) : haltedJobs.length === 0 ? (
                                        <tr><td colSpan="4" className="text-center p-8 text-gray-400">No jobs are currently halted on the floor.</td></tr>
                                    ) : (
                                        haltedJobs.map(job => (
                                            <tr key={job.id} className="border-b border-gray-700">
                                                <td className="p-3 text-gray-200">{job.partName} <span className="text-xs text-gray-500 block">{job.jobId}</span></td>
                                                <td className="p-3 text-gray-300">{job.employeeName}</td>
                                                <td className="p-3 text-yellow-400 italic">{(job.issueLog && job.issueLog.length > 0) ? job.issueLog[job.issueLog.length - 1].reason : 'No reason provided.'}</td>
                                                <td className="p-3 text-right flex gap-2 justify-end">
                                                    <Button variant="secondary" onClick={() => setSelectedJob(job)}>Review & Resolve</Button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div>
                     <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><AlertTriangle className="text-red-400"/> QC Rejected Jobs</h3>
                    <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead>
                                    <tr className="border-b border-gray-600 bg-gray-900/50">
                                        <th className="p-3 text-sm font-semibold text-gray-400">Part</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Employee</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Reason for Rejection</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {loading ? (
                                        <tr><td colSpan="4" className="text-center p-8 text-gray-400">Loading...</td></tr>
                                    ) : qcRejectedJobs.length === 0 ? (
                                        <tr><td colSpan="4" className="text-center p-8 text-gray-400">No jobs rejected at QC.</td></tr>
                                    ) : (
                                        qcRejectedJobs.map(job => (
                                            <tr key={job.id} className="border-b border-gray-700">
                                                <td className="p-3 text-gray-200">{job.partName} <span className="text-xs text-gray-500 block">{job.jobId}</span></td>
                                                <td className="p-3 text-gray-300">{job.employeeName}</td>
                                                <td className="p-3 text-red-400 italic">{job.issueReason || 'No reason provided.'}</td>
                                                <td className="p-3 text-right flex gap-2 justify-end">
                                                    <Button variant="secondary" onClick={() => setSelectedJob(job)}>View Details</Button>
                                                    <Button variant="danger" onClick={() => handleArchive(job.id)}>Archive</Button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            {selectedJob && (
                <JobDetailsModal 
                    job={selectedJob} 
                    onClose={handleCloseModal}
                    currentTime={Date.now()} 
                    employeeHourlyRates={employeeHourlyRates} 
                    allEmployees={allEmployees} 
                    onUpdateJob={handleUpdateJob} 
                    onDeleteJob={handleDeleteJob} 
                    allInventoryItems={allInventoryItems} 
                    allTools={allTools} 
                    allToolAccessories={allToolAccessories} 
                />
            )}
        </>
    );
};

export default IssuesPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\JobCardAdjustmentPage.jsx
==================================================
// src/pages/JobCardAdjustmentPage.jsx (Upgraded with Toasts)

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { getJobsAwaitingQC, updateJobCardWithAdjustments, getAllInventoryItems } from '../api/firestore';
import Input from '../components/ui/Input';
import Button from '../components/ui/Button';
import Dropdown from '../components/ui/Dropdown';
import Textarea from '../components/ui/Textarea';
import { ArrowLeft } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const JobCardAdjustmentPage = () => {
    const navigate = useNavigate();
    const { user } = useAuth();
    const [jobsAwaitingQC, setJobsAwaitingQC] = useState([]);
    const [selectedJobId, setSelectedJobId] = useState('');
    const [selectedJob, setSelectedJob] = useState(null);
    const [timeAdjustment, setTimeAdjustment] = useState(0);
    const [consumableAdjustments, setConsumableAdjustments] = useState({});
    const [newConsumable, setNewConsumable] = useState({ itemId: '', qtyChange: 0 });
    const [allInventoryItems, setAllInventoryItems] = useState([]);
    const [adjustmentReason, setAdjustmentReason] = useState('');
    const [loading, setLoading] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);

    useEffect(() => {
        const fetchQCJobs = async () => {
            setLoading(true);
            try {
                const qcJobs = await getJobsAwaitingQC();
                setJobsAwaitingQC(qcJobs);
            } catch (error) {
                toast.error("Failed to load completed jobs.");
                console.error(error);
            }
            setLoading(false);
        };

        fetchQCJobs();

        const fetchInventory = async () => {
            const inventory = await getAllInventoryItems();
            setAllInventoryItems(inventory);
        };
        fetchInventory();
    }, []);

    useEffect(() => {
        if (selectedJobId && jobsAwaitingQC.length > 0) {
            const job = jobsAwaitingQC.find(j => j.id === selectedJobId);
            setSelectedJob(job);
        } else {
            setSelectedJob(null);
            setTimeAdjustment(0);
            setConsumableAdjustments({});
            setAdjustmentReason('');
        }
    }, [selectedJobId, jobsAwaitingQC]);

    const handleTimeAdjustmentChange = (e) => setTimeAdjustment(parseInt(e.target.value) || 0);
    const handleReasonChange = (e) => setAdjustmentReason(e.target.value);
    const handleSelectJob = (e) => setSelectedJobId(e.target.value);

    const handleQtyChange = (consumableId, e) => {
        setConsumableAdjustments(prev => ({
            ...prev,
            [consumableId]: parseInt(e.target.value) || 0,
        }));
    };

    const handleNewConsumableItemChange = (e) => {
        setNewConsumable(prev => ({ ...prev, itemId: e.target.value }));
    };

    const handleNewConsumableQtyChange = (e) => {
        setNewConsumable(prev => ({ ...prev, qtyChange: parseInt(e.target.value) || 0 }));
    };

    const handleAddConsumable = () => {
        if (newConsumable.itemId && newConsumable.qtyChange !== 0) {
            setConsumableAdjustments(prev => ({
                ...prev,
                [newConsumable.itemId]: (prev[newConsumable.itemId] || 0) + newConsumable.qtyChange,
            }));
            setNewConsumable({ itemId: '', qtyChange: 0 });
        }
    };

    const handleSubmit = async () => {
        if (!selectedJobId) {
            toast.error('Please select a job to adjust.'); // --- REPLACE ALERT ---
            return;
        }
        if (!adjustmentReason.trim()) {
            toast.error('Please provide a reason for the adjustment.'); // --- REPLACE ALERT ---
            return;
        }

        setIsSubmitting(true);
        try {
            await updateJobCardWithAdjustments(selectedJobId, timeAdjustment, consumableAdjustments, adjustmentReason, user.uid);
            toast.success('Job card adjustments submitted successfully!'); // --- REPLACE ALERT ---
            setSelectedJobId('');
        } catch (error) {
            console.error('Error submitting job card adjustments:', error);
            toast.error('Failed to submit job card adjustments.'); // --- REPLACE ALERT ---
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div>
            <Button onClick={() => navigate(-1)} className="mb-4">
                <ArrowLeft className="mr-2" /> Back
            </Button>
            <h2 className="text-2xl font-bold text-white mb-4">Job Card Adjustment</h2>

            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 space-y-4 max-w-xl">
                <Dropdown
                    label="Select Completed Job Card"
                    name="jobId"
                    value={selectedJobId}
                    onChange={handleSelectJob}
                    options={jobsAwaitingQC.map(job => ({ id: job.id, name: `${job.partName} (${job.jobId.substring(0, 8)})` }))}
                    placeholder="Select a job..."
                />

                {selectedJob && (
                    <div className="space-y-4">
                        <div>
                            <p className="text-gray-300">Original Estimated Time: {selectedJob.estimatedTime} minutes</p>
                            <Input label="Adjust Time (minutes to add/subtract)" type="number" value={timeAdjustment} onChange={handleTimeAdjustmentChange} />
                        </div>

                        <div>
                            <h3 className="text-lg font-semibold text-white mb-2">Adjust Consumables</h3>
                            {selectedJob.processedConsumables && selectedJob.processedConsumables.map(consumable => (
                                <div key={consumable.id} className="flex items-center space-x-2 mb-2">
                                    <p className="text-gray-300 flex-grow">{consumable.name} (Used: {consumable.quantity})</p>
                                    <div className="w-48">
                                        <Input
                                            type="number"
                                            label={`Qty Change`}
                                            onChange={(e) => handleQtyChange(consumable.id, e)}
                                            placeholder="e.g., -1 or 2"
                                        />
                                    </div>
                                </div>
                            ))}
                            <div className="flex items-end space-x-2 border-t border-gray-700 pt-4 mt-4">
                                <div className="flex-grow">
                                    <Dropdown
                                        label="Add New Consumable"
                                        name="newConsumableItem"
                                        value={newConsumable.itemId}
                                        onChange={handleNewConsumableItemChange}
                                        options={allInventoryItems.map(item => ({ id: item.id, name: item.name }))}
                                        placeholder="Select consumable..."
                                    />
                                </div>
                                <div className="w-32">
                                    <Input
                                        type="number"
                                        label="Qty"
                                        value={newConsumable.qtyChange}
                                        onChange={handleNewConsumableQtyChange}
                                        placeholder="e.g., 1"
                                    />
                                </div>
                                <Button onClick={handleAddConsumable}>Add</Button>
                            </div>
                        </div>

                        <Textarea label="Reason for Adjustment" value={adjustmentReason} onChange={handleReasonChange} rows={4} />

                        <Button onClick={handleSubmit} variant="primary" disabled={isSubmitting}>
                            {isSubmitting ? 'Submitting...' : 'Submit Adjustment'}
                        </Button>
                    </div>
                )}

                {!selectedJob && !loading && (
                    <p className="text-gray-400">Select a completed job card to view and adjust its details.</p>
                )}
                 {loading && (
                    <p className="text-gray-400">Loading completed jobs...</p>
                )}
            </div>
        </div>
    );
};

export default JobCardAdjustmentPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\JobCreatorPage.jsx
==================================================
// FILE: src/pages/JobCreatorPage.jsx (UPDATED)

import React, { useState, useEffect } from 'react';
import CustomJobCreator from '../components/features/job_cards/CustomJobCreator';
import { getCampaigns } from '../api/firestore'; // Import campaign fetch function
import JobCardCreator from '../components/features/job_cards/JobCardCreator';
import Dropdown from '../components/ui/Dropdown'; // We'll use this for the new dropdown

const JobCreatorPage = () => {
    const [mode, setMode] = useState('catalog');
    const [campaigns, setCampaigns] = useState([]);
    const [selectedCampaignId, setSelectedCampaignId] = useState(''); // State for the selected campaign

    // Fetch active campaigns when the page loads
    useEffect(() => {
        const fetchActiveCampaigns = async () => {
            try {
                const allCampaigns = await getCampaigns();
                // Filter for campaigns that are currently active or recently ended
                const now = new Date();
                const active = allCampaigns.filter(c => {
                    const startDate = c.startDate?.toDate();
                    const endDate = c.endDate?.toDate();
                    if (!startDate) return false;
                    // If no end date, it's active if start date is in the past
                    if (!endDate) return startDate <= now;
                    // If there is an end date, it's active if today is between start and end
                    return startDate <= now && endDate >= now;
                });
                setCampaigns(active);
            } catch (error) {
                console.error("Failed to fetch campaigns:", error);
            }
        };
        fetchActiveCampaigns();
    }, []);

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Job Card Creator</h2>
            
            {/* New Section: Campaign Selection */}
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-xl mx-auto">
                <Dropdown
                    label="Marketing Campaign (Optional)"
                    name="campaignSelector"
                    value={selectedCampaignId}
                    onChange={(e) => setSelectedCampaignId(e.target.value)}
                    options={campaigns}
                    placeholder="Select campaign that generated this job..."
                />
                <p className="text-xs text-gray-500 mt-2">
                    Tagging a job with a campaign helps track your return on investment. You can manage campaigns in Settings.
                </p>
            </div>

            <div className="flex gap-2 p-1 bg-gray-800 rounded-lg max-w-xl mx-auto">
                <button
                    onClick={() => setMode('catalog')}
                    className={`flex-1 p-2 text-sm font-semibold rounded-md transition-colors ${mode === 'catalog' ? 'bg-blue-600 text-white' : 'hover:bg-gray-700'}`}
                >
                    Create from Catalog
                </button>
                <button
                    onClick={() => setMode('custom')}
                    className={`flex-1 p-2 text-sm font-semibold rounded-md transition-colors ${mode === 'custom' ? 'bg-blue-600 text-white' : 'hover:bg-gray-700'}`}
                >
                    Create Custom Job
                </button>
            </div>

            {mode === 'custom' && 
                <CustomJobCreator 
                    // Pass the selected campaign ID down
                    campaignId={selectedCampaignId} 
                />
            }

            {mode === 'catalog' && (
                <JobCardCreator
                    key="catalog-job-creation"
                    // Pass the selected campaign ID down
                    campaignId={selectedCampaignId} 
                />
            )}
        </div>
    );
};

export default JobCreatorPage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\JobHistoryPage.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { listenToJobCards, getEmployees, getDepartments } from '../api/firestore';
import JobDetailsPanel from '../components/features/job_cards/JobDetailsPanel';
import Input from '../components/ui/Input';
import Dropdown from '../components/ui/Dropdown';
import Button from '../components/ui/Button';

const JobHistoryPage = () => {
  const [allJobs, setAllJobs] = useState([]);
  const [employees, setEmployees] = useState([]);
  const [departments, setDepartments] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // State for filters
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedDept, setSelectedDept] = useState('');
  const [selectedEmp, setSelectedEmp] = useState('');
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');

  const [selectedJobId, setSelectedJobId] = useState(null);

  useEffect(() => {
    const fetchData = async () => {
        setLoading(true);
        const [emps, depts] = await Promise.all([getEmployees(), getDepartments()]);
        setEmployees(emps);
        setDepartments(depts);

        const unsub = listenToJobCards(jobs => {
            const completedJobs = jobs.filter(j =>
                ['Complete', 'Issue', 'Archived - Issue'].includes(j.status)
            ).sort((a,b) => b.createdAt.seconds - a.createdAt.seconds); // Sort newest first
            setAllJobs(completedJobs);
            setLoading(false);
        });

        return () => unsub();
    };
    
    fetchData();
  }, []);

  const filteredJobs = useMemo(() => {
    return allJobs.filter(job => {
        const searchMatch = searchTerm === '' || 
            job.partName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            job.jobId?.toLowerCase().includes(searchTerm.toLowerCase());
        
        const deptMatch = !selectedDept || job.departmentId === selectedDept;
        const empMatch = !selectedEmp || job.employeeId === selectedEmp;
        
        const jobDate = job.completedAt?.toDate();
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;

        if(start) start.setHours(0,0,0,0);
        if(end) end.setHours(23,59,59,999);

        const dateMatch = (!start || jobDate >= start) && (!end || jobDate <= end);

        return searchMatch && deptMatch && empMatch && dateMatch;
    });
  }, [allJobs, searchTerm, selectedDept, selectedEmp, startDate, endDate]);

  const clearFilters = () => {
    setSearchTerm('');
    setSelectedDept('');
    setSelectedEmp('');
    setStartDate('');
    setEndDate('');
  };

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold text-white mb-4">Job History</h1>
      
      <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-6 space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <Dropdown label="Filter by Department" options={departments} value={selectedDept} onChange={e => setSelectedDept(e.target.value)} placeholder="All Departments" />
            <Dropdown label="Filter by Employee" options={employees} value={selectedEmp} onChange={e => setSelectedEmp(e.target.value)} placeholder="All Employees" />
            <Input label="Search by Part Name or Job ID" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <Input label="Completed After (Start Date)" type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
            <Input label="Completed Before (End Date)" type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
            <Button onClick={clearFilters} variant="secondary">Clear All Filters</Button>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="space-y-2 bg-gray-900/50 p-4 rounded-lg max-h-[60vh] overflow-y-auto">
          {loading && <p className="text-gray-400">Loading job history...</p>}
          {!loading && filteredJobs.length === 0 && <p className="text-gray-400 text-center py-8">No jobs match the current filters.</p>}
          {!loading && filteredJobs.map(job => (
            <div
              key={job.id}
              onClick={() => setSelectedJobId(job.jobId)}
              className={`p-3 rounded-lg cursor-pointer transition-all ${
                job.jobId === selectedJobId ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
              }`}
            >
              <p className="font-bold">{job.partName} ({job.jobId})</p>
              <p className="text-xs">{job.departmentName} â€” {job.status}</p>
            </div>
          ))}
        </div>

        <div className="bg-gray-900/50 p-4 rounded-lg">
          {selectedJobId ? (
            <JobDetailsPanel jobId={selectedJobId} />
          ) : (
            <div className="flex items-center justify-center h-full text-gray-500">
                <p>Select a job from the list to view its details.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default JobHistoryPage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\JobReprintPage.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { listenToJobCards } from '../api/firestore';
import Button from '../components/ui/Button';

const JobReprintPage = () => {
  const [jobs, setJobs] = useState([]);
  const [search, setSearch] = useState('');

  useEffect(() => {
    const unsub = listenToJobCards(setJobs);
    return () => unsub();
  }, []);

  const filtered = jobs.filter(j =>
    j.jobId.toLowerCase().includes(search.toLowerCase()) ||
    j.partName?.toLowerCase().includes(search.toLowerCase())
  );

  const printJobCard = (job) => {
    const win = window.open('', '', 'width=600,height=800');
    const html = `
      <html>
        <head>
          <title>${job.jobId}</title>
        </head>
        <body style="font-family: sans-serif; padding: 20px;">
          <h2>Job Card: ${job.jobId}</h2>
          <p><strong>Part:</strong> ${job.partName}</p>
          <p><strong>Department:</strong> ${job.departmentName}</p>
          <p><strong>Employee:</strong> ${job.employeeName}</p>
          <p><strong>Quantity:</strong> ${job.quantity}</p>
          <p><strong>Status:</strong> ${job.status}</p>
          <p><strong>Steps:</strong></p>
          <ul>${(job.steps || []).map(step => `<li>${step}</li>`).join('')}</ul>
        </body>
      </html>
    `;
    win.document.write(html);
    win.document.close();
    win.print();
  };

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold text-white mb-4">Reprint Job Cards</h1>
      <input
        className="w-full p-2 rounded bg-gray-800 text-white border border-gray-600 mb-4"
        placeholder="Search by part name or job ID"
        value={search}
        onChange={(e) => setSearch(e.target.value)}
      />
      <div className="space-y-2">
        {filtered.map(job => (
          <div key={job.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <p className="text-white font-bold">{job.partName} ({job.jobId})</p>
            <p className="text-gray-400 text-sm">Dept: {job.departmentName} | Qty: {job.quantity}</p>
            <Button onClick={() => printJobCard(job)} className="mt-2">Print</Button>
          </div>
        ))}
      </div>
    </div>
  );
};

export default JobReprintPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\KanbanPage.jsx
==================================================
// src/pages/KanbanPage.jsx (UPDATED with layout fix)
// The component's structure has been simplified to work within the updated MainLayout,
// resolving the nested scroll container error from the @hello-pangea/dnd library.

import React, { useState, useEffect, useMemo } from 'react';
import { listenToJobCards, getEmployees } from '../api/firestore';
import KanbanBoard from '../components/features/kanban/KanbanBoard';
import Dropdown from '../components/ui/Dropdown';
import Input from '../components/ui/Input';
import { LayoutGrid } from 'lucide-react';

const KanbanPage = () => {
    const [jobs, setJobs] = useState([]);
    const [employees, setEmployees] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filters, setFilters] = useState({ employeeId: '', searchTerm: '' });

    useEffect(() => {
        const fetchInitialData = async () => {
            setLoading(true);
            try {
                const fetchedEmployees = await getEmployees();
                setEmployees(fetchedEmployees);
                
                const unsubscribe = listenToJobCards((allJobs) => {
                    setJobs(allJobs);
                    setLoading(false);
                });
                return unsubscribe;

            } catch (error) {
                console.error("Error fetching data for Kanban board:", error);
                setLoading(false);
            }
        };
        
        const unsubscribePromise = fetchInitialData();
        return () => { unsubscribePromise.then(unsub => unsub && unsub()); };
    }, []);

    const handleFilterChange = (e) => {
        const { name, value } = e.target;
        setFilters(prev => ({ ...prev, [name]: value }));
    };

    const filteredJobs = useMemo(() => {
        return jobs.filter(job => {
            const employeeMatch = !filters.employeeId || job.employeeId === filters.employeeId;
            const searchMatch = !filters.searchTerm || 
                job.partName.toLowerCase().includes(filters.searchTerm.toLowerCase()) ||
                job.jobId.toLowerCase().includes(filters.searchTerm.toLowerCase());
            return employeeMatch && searchMatch;
        });
    }, [jobs, filters]);

    if (loading) {
        return <p className="text-center text-gray-400">Loading Kanban Board...</p>;
    }

    return (
        // This parent div now correctly uses flexbox to manage its children's height.
        <div className="flex flex-col h-full space-y-6">
            <div className="flex-shrink-0">
                <h2 className="text-3xl font-bold text-white flex items-center gap-2">
                    <LayoutGrid />
                    Workshop Kanban Board
                </h2>
                <p className="text-gray-400 mt-1">Drag and drop jobs to update their status.</p>
            </div>
            
            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 flex-shrink-0">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input 
                        name="searchTerm"
                        placeholder="Search by Job ID or Part Name..."
                        value={filters.searchTerm}
                        onChange={handleFilterChange}
                    />
                    <Dropdown
                        name="employeeId"
                        options={employees}
                        value={filters.employeeId}
                        onChange={handleFilterChange}
                        placeholder="Filter by Employee..."
                    />
                </div>
            </div>

            {/* This container will now correctly grow to fill the available space */}
            <div className="flex-grow min-h-0">
                <KanbanBoard jobs={filteredJobs} employees={employees} />
            </div>
        </div>
    );
};

export default KanbanPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\LiveTrackingPage.jsx
==================================================
// src/pages/LiveTrackingPage.jsx (Upgraded for Burdened Cost)

import React, { useState, useEffect, useMemo } from 'react';
import LiveTrackingTable from '../components/features/tracking/LiveTrackingTable';
import { getEmployees, getOverheadCategories, getOverheadExpenses } from '../api/firestore';

const LiveTrackingPage = () => {
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [overheadCostPerHour, setOverheadCostPerHour] = useState(0);

    useEffect(() => {
        const calculateBurdenedRateData = async () => {
            setLoading(true);
            try {
                const [employees, overheadCats] = await Promise.all([
                    getEmployees(),
                    getOverheadCategories()
                ]);

                const expensePromises = overheadCats.map(cat => getOverheadExpenses(cat.id));
                const expenseResults = await Promise.all(expensePromises);
                const totalMonthlyOverheads = expenseResults.flat().reduce((sum, exp) => sum + (exp.amount || 0), 0);
                
                // Using 173.2 as the average number of working hours in a month
                const totalCompanyProductiveHours = (employees.length || 1) * 173.2; 
                const overheadRate = totalCompanyProductiveHours > 0 ? totalMonthlyOverheads / totalCompanyProductiveHours : 0;
                
                setOverheadCostPerHour(overheadRate);

            } catch (err) {
                console.error("Failed to calculate burdened rate data:", err);
                setError("Could not load financial data for cost calculation.");
            } finally {
                setLoading(false);
            }
        };

        calculateBurdenedRateData();
    }, []);

    if (loading) {
        return <p className="text-center text-gray-400">Initializing Costing Engine...</p>;
    }
    if (error) {
        return <p className="text-center text-red-400">{error}</p>;
    }

    return (
        <div className="space-y-8">
          <h2 className="text-3xl font-bold text-white">Live Job Tracking</h2>
          {/* Pass the calculated overhead rate down to the table */}
          <LiveTrackingTable overheadCostPerHour={overheadCostPerHour} />
        </div>
      );
};

export default LiveTrackingPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\Login.jsx
==================================================
// src/pages/Login.jsx

import React, { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import Button from '../components/ui/Button';
import Input from '../components/ui/Input';
import TojemLogo from '../assets/TOJEM 2024.png';

const LoginPage = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const { signIn } = useAuth();

  const handleLogin = async (e) => {
    e.preventDefault();
    setError('');
    setIsSubmitting(true);
    try {
      await signIn(email, password);
      // After successful sign-in, the AuthContext state will change.
      // The main App component will detect this change and automatically
      // render the correct layout and pages. No navigation is needed here.
    } catch (err) {
      setError('Failed to sign in. Please check your credentials.');
      console.error(err);
    } finally {
        setIsSubmitting(false);
    }
  };

  return (
    <div className="bg-gray-900 min-h-screen flex items-center justify-center text-white">
      <div className="bg-gray-800 p-8 rounded-xl border border-gray-700 shadow-lg w-full max-w-md">
        <img src={TojemLogo} alt="TOJEM OS Logo" className="h-16 mx-auto mb-4 object-contain" />
        <p className="text-gray-400 text-center mb-6">Please sign in to continue</p>
        <form onSubmit={handleLogin} className="space-y-6">
          <Input
            label="Email"
            name="email"
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="you@company.com"
          />
          <Input
            label="Password"
            name="password"
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          />
          {error && <p className="text-red-500 text-sm text-center">{error}</p>}
          <Button type="submit" className="w-full" disabled={isSubmitting}>
            {isSubmitting ? 'Signing In...' : 'Sign In'}
          </Button>
        </form>
      </div> 
    </div>
  );
};

export default LoginPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\MarketingPage.jsx
==================================================
// FILE: src/pages/MarketingPage.jsx (Upgraded with Toasts)

import React, { useState, useEffect, useMemo } from 'react';
import { listenToJobCards } from '../api/firestore';
import { getCampaigns } from '../api/firestore';
import Button from '../components/ui/Button';
import { DollarSign, Users, TrendingUp } from 'lucide-react';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const KpiCard = ({ icon, title, value, color, subValue }) => (
    <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
        <div className="flex items-start space-x-4">
            <div className={`p-3 rounded-full ${color}`}>
                {icon}
            </div>
            <div>
                <p className="text-gray-400 text-sm">{title}</p>
                <p className="text-3xl font-bold text-white">{value}</p>
                {subValue && <p className="text-xs text-gray-500">{subValue}</p>}
            </div>
        </div>
    </div>
);

const MarketingPage = () => {
    const [campaigns, setCampaigns] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeRange, setActiveRange] = useState('all');

    useEffect(() => {
        let unsubscribeJobs = () => {};
        const fetchData = async () => {
            setLoading(true);
            try {
                const fetchedCampaigns = await getCampaigns();
                setCampaigns(fetchedCampaigns);
                
                unsubscribeJobs = listenToJobCards((fetchedJobs) => {
                    setJobs(fetchedJobs);
                });

            } catch (error) {
                console.error("Error fetching marketing data:", error);
                toast.error("Could not load marketing data."); // --- REPLACED ALERT ---
            } finally {
                setLoading(false);
            }
        };
        fetchData();
        
        return () => unsubscribeJobs();
    }, []);

    const processedData = useMemo(() => {
        const now = new Date();
        let startDate = null;

        if (activeRange === '30d') {
            startDate = new Date(new Date().setDate(now.getDate() - 30));
        } else if (activeRange === '90d') {
            startDate = new Date(new Date().setDate(now.getDate() - 90));
        }

        const filteredCampaigns = campaigns.filter(campaign => {
            if (!startDate) return true;
            const campaignStartDate = campaign.startDate?.toDate();
            return campaignStartDate && campaignStartDate >= startDate;
        });
        
        const completedJobs = jobs.filter(j => j.status === 'Complete' && j.campaignId);

        const campaignsWithMetrics = filteredCampaigns.map(campaign => {
            const associatedJobs = completedJobs.filter(job => job.campaignId === campaign.id);
            const salesCount = associatedJobs.length;
            const revenue = associatedJobs.reduce((sum, job) => sum + (job.totalCost || 0), 0);
            
            const estimatedProfit = associatedJobs.reduce((sum, job) => {
                const jobCost = job.totalCost || 0;
                return sum + (jobCost * 0.30);
            }, 0);

            const budget = campaign.budget || 0;
            const leads = campaign.leadsGenerated || 0;
            const conversionRate = leads > 0 ? (salesCount / leads) * 100 : 0;
            const roi = budget > 0 ? (estimatedProfit / budget) * 100 : 0;
            const costPerLead = leads > 0 ? budget / leads : 0;

            return {
                ...campaign,
                salesCount,
                revenue,
                estimatedProfit,
                conversionRate,
                roi,
                costPerLead,
            };
        });

        const totalBudget = campaignsWithMetrics.reduce((sum, c) => sum + c.budget, 0);
        const totalLeads = campaignsWithMetrics.reduce((sum, c) => sum + c.leadsGenerated, 0);
        const totalSales = campaignsWithMetrics.reduce((sum, c) => sum + c.salesCount, 0);
        const totalRevenue = campaignsWithMetrics.reduce((sum, c) => sum + c.revenue, 0);
        const totalProfit = campaignsWithMetrics.reduce((sum, c) => sum + c.estimatedProfit, 0);
        const overallRoi = totalBudget > 0 ? (totalProfit / totalBudget) * 100 : 0;
        
        return {
            campaigns: campaignsWithMetrics,
            totalBudget,
            totalLeads,
            totalSales,
            totalRevenue,
            overallRoi,
        };
    }, [campaigns, jobs, activeRange]);

    const formatDate = (timestamp) => {
        if (!timestamp?.toDate) return 'N/A';
        return timestamp.toDate().toLocaleDateString('en-ZA');
    };

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Marketing Dashboard</h2>
            
            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <div className="flex flex-wrap items-center justify-center gap-2">
                    <Button variant={activeRange === '30d' ? 'primary' : 'secondary'} onClick={() => setActiveRange('30d')}>Last 30 Days</Button>
                    <Button variant={activeRange === '90d' ? 'primary' : 'secondary'} onClick={() => setActiveRange('90d')}>Last 90 Days</Button>
                    <Button variant={activeRange === 'all' ? 'primary' : 'secondary'} onClick={() => setActiveRange('all')}>All Time</Button>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <KpiCard 
                    icon={<DollarSign size={24} />} 
                    title="Marketing Spend" 
                    value={`R ${processedData.totalBudget.toFixed(2)}`}
                    color="bg-yellow-500/20 text-yellow-400" 
                />
                 <KpiCard 
                    icon={<Users size={24} />} 
                    title="Leads Generated" 
                    value={processedData.totalLeads}
                    color="bg-blue-500/20 text-blue-400" 
                />
                 <KpiCard 
                    icon={<DollarSign size={24} />} 
                    title="Revenue from Campaigns" 
                    value={`R ${processedData.totalRevenue.toFixed(2)}`}
                    subValue={`${processedData.totalSales} sales`}
                    color="bg-green-500/20 text-green-400" 
                />
                <KpiCard 
                    icon={<TrendingUp size={24} />} 
                    title="Overall ROI" 
                    value={`${processedData.overallRoi.toFixed(1)}%`}
                    color="bg-purple-500/20 text-purple-400" 
                />
            </div>

            <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                <h3 className="text-xl font-bold text-white p-4 border-b border-gray-700">Campaign Performance</h3>
                <div className="overflow-x-auto">
                    <table className="w-full text-left">
                        <thead className="bg-gray-900/50">
                            <tr>
                                <th className="p-3 text-sm font-semibold text-gray-400">Campaign</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">Budget</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">Leads</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">Sales</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">Conv. Rate</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">Revenue</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">ROI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {loading ? (
                                <tr><td colSpan="7" className="text-center p-8 text-gray-400">Loading campaign performance...</td></tr>
                            ) : processedData.campaigns.length === 0 ? (
                                <tr><td colSpan="7" className="text-center p-8 text-gray-400">No campaigns found for the selected period.</td></tr>
                            ) : (
                                processedData.campaigns.map(campaign => (
                                    <tr key={campaign.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td className="p-3 text-white font-semibold">{campaign.name} <span className="text-xs text-gray-400 font-normal">({campaign.platform})</span></td>
                                        <td className="p-3 text-gray-300 font-mono text-right">R{campaign.budget.toFixed(2)}</td>
                                        <td className="p-3 font-bold text-right">{campaign.leadsGenerated || 0}</td>
                                        <td className="p-3 font-bold text-right">{campaign.salesCount}</td>
                                        <td className="p-3 text-blue-400 font-mono text-right">{campaign.conversionRate.toFixed(1)}%</td>
                                        <td className="p-3 text-green-400 font-mono text-right">R{campaign.revenue.toFixed(2)}</td>
                                        <td className={`p-3 font-bold text-right font-mono ${campaign.roi >= 0 ? 'text-purple-400' : 'text-red-400'}`}>{campaign.roi.toFixed(1)}%</td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

export default MarketingPage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\MultiStageWizard.jsx
==================================================
// src/pages/MultiStageWizard.jsx

import React, { useEffect, useState } from 'react';
import { getProducts, getDepartments, addJobCard } from '../api/firestore';
import Button from '../components/ui/Button';
import Input from '../components/ui/Input';
import Dropdown from '../components/ui/Dropdown';
import toast from 'react-hot-toast';
import { Trash2 } from 'lucide-react'; // <-- ADD THIS IMPORT

const MultiStageWizard = () => {
    const [products, setProducts] = useState([]);
    const [departments, setDepartments] = useState([]);
    const [selectedProductId, setSelectedProductId] = useState('');
    const [quantity, setQuantity] = useState(1);
    const [workflow, setWorkflow] = useState([]);
    const [creating, setCreating] = useState(false);

    useEffect(() => {
        getProducts().then(setProducts);
        getDepartments().then(setDepartments);
    }, []);

    const addStage = () => {
        // Add a department to the workflow
        setWorkflow([...workflow, { departmentId: '' }]);
    };

    const updateStage = (index, departmentId) => {
        const updated = [...workflow];
        updated[index] = { departmentId };
        setWorkflow(updated);
    };

    const removeStage = (index) => {
        const updated = workflow.filter((_, i) => i !== index);
        setWorkflow(updated);
    };

    const submitMultiJob = async () => {
        if (!selectedProductId || workflow.length === 0) {
            return toast.error('Please select a product and add at least one stage.');
        }

        const selectedProduct = products.find(p => p.id === selectedProductId);
        if (!selectedProduct) {
            return toast.error('Selected product could not be found.');
        }

        setCreating(true);
        const parentJobId = `ROUTED-${Date.now()}`;

        try {
            for (let i = 0; i < workflow.length; i++) {
                const stage = workflow[i];
                if (!stage.departmentId) {
                    toast.error(`Stage ${i + 1} is missing a department.`);
                    continue; // Skip this stage if no department is selected
                }
                const department = departments.find(d => d.id === stage.departmentId);

                await addJobCard({
                    jobId: `${parentJobId}-${i + 1}`,
                    partId: selectedProduct.id,
                    partName: selectedProduct.name,
                    quantity: Number(quantity),
                    departmentId: stage.departmentId,
                    departmentName: department?.name || 'Unknown',
                    employeeId: 'unassigned',
                    employeeName: 'Unassigned',
                    status: 'Pending',
                    description: `Stage ${i + 1} of ${workflow.length} for ${selectedProduct.name}`,
                    isCustomJob: false,
                    parentJobId: parentJobId,
                });
            }

            toast.success(`Successfully created ${workflow.length} staged jobs for ${selectedProduct.name}.`);
            setWorkflow([]);
            setSelectedProductId('');
            setQuantity(1);

        } catch (err) {
            console.error(err);
            toast.error('Failed to create multi-stage job.');
        } finally {
            setCreating(false);
        }
    };

    return (
        <div className="p-6 text-white max-w-4xl mx-auto">
            <h1 className="text-2xl font-bold mb-4">Multi-Stage Job Wizard</h1>
            <p className="text-gray-400 mb-6">Create a sequence of jobs for a single product that must pass through multiple departments.</p>

            <div className="space-y-6 bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="md:col-span-2">
                        <Dropdown
                            label="Product"
                            options={products}
                            value={selectedProductId}
                            onChange={(e) => setSelectedProductId(e.target.value)}
                            placeholder="Select a product..."
                        />
                    </div>
                    <Input
                        label="Quantity"
                        type="number"
                        min="1"
                        value={quantity}
                        onChange={(e) => setQuantity(e.target.value)}
                    />
                </div>

                <div className="border-t border-gray-700 pt-4">
                    <h3 className="font-semibold text-lg text-white mb-2">Production Workflow (in order)</h3>
                    <div className="space-y-4">
                        {workflow.map((stage, index) => (
                            <div key={index} className="flex items-end gap-3 bg-gray-900/50 p-3 rounded-lg">
                                <span className="font-bold text-gray-500">{index + 1}.</span>
                                <div className="flex-grow">
                                    <Dropdown
                                        label={`Stage ${index + 1} Department`}
                                        options={departments}
                                        value={stage.departmentId}
                                        onChange={(e) => updateStage(index, e.target.value)}
                                        placeholder="Select department..."
                                    />
                                </div>
                                <Button onClick={() => removeStage(index)} variant="danger" className="p-2 h-12 w-12">
                                    <Trash2 size={18}/>
                                </Button>
                            </div>
                        ))}
                    </div>
                    <Button onClick={addStage} variant="secondary" className="mt-4">
                        Add Stage
                    </Button>
                </div>

                <div className="text-right border-t border-gray-700 pt-4">
                    <Button onClick={submitMultiJob} disabled={creating || workflow.length === 0} variant="primary">
                        {creating ? 'Creating Jobs...' : `Create ${workflow.length}-Stage Job`}
                    </Button>
                </div>
            </div>
        </div>
    );
};

export default MultiStageWizard;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\PayrollPage.jsx
==================================================
// src/pages/PayrollPage.jsx (Decommissioned)

import React from 'react';

const PayrollPage = () => {
    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Payroll & Payments</h2>
            <div className="bg-gray-800 p-8 rounded-xl border border-gray-700 text-center">
                <p className="text-gray-400">
                    The payroll feature is currently undergoing a strategic review and is unavailable.
                </p>
            </div>
        </div>
    );
};

export default PayrollPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\PerformancePage.jsx
==================================================
// src/pages/PerformancePage.jsx (UPDATED)

import React, { useState, useEffect, useMemo } from 'react';
import { getEmployees, listenToJobCards, getOverheadCategories, getOverheadExpenses, getDepartments } from '../api/firestore';
import Dropdown from '../components/ui/Dropdown';
import { CheckCircle2, Clock, DollarSign, Zap } from 'lucide-react';
import PerformanceLeaderboard from '../components/intelligence/PerformanceLeaderboard';
import DepartmentPerformanceChart from '../components/intelligence/DepartmentPerformanceChart'; // <-- IMPORT NEW CHART

const KpiCard = ({ icon, title, value, color }) => (
    <div className="bg-gray-800 p-5 rounded-lg border border-gray-700 flex items-start space-x-4">
        <div className={`p-3 rounded-full ${color}`}>
            {icon}
        </div>
        <div>
            <p className="text-gray-400 text-sm">{title}</p>
            <p className="text-2xl font-bold text-white">{value}</p>
        </div>
    </div>
);

const PerformancePage = () => {
    const [employees, setEmployees] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [departments, setDepartments] = useState([]);
    const [allOverheadExpenses, setAllOverheadExpenses] = useState([]);
    const [loading, setLoading] = useState(true);
    const [leaderboardDepartmentFilter, setLeaderboardDepartmentFilter] = useState('all');
    const [leaderboardSortKey, setLeaderboardSortKey] = useState('ops');

    useEffect(() => {
        let unsubscribeJobs = () => {};
        const fetchAllDataAndSetupListeners = async () => {
            setLoading(true);
            try {
                const [fetchedEmployees, fetchedCategories, fetchedDepartments] = await Promise.all([
                    getEmployees(),
                    getOverheadCategories(),
                    getDepartments()
                ]);

                setDepartments(fetchedDepartments);
                
                const departmentsMap = new Map(fetchedDepartments.map(d => [d.id, d.name]));
                const employeesWithDeptName = fetchedEmployees.map(emp => ({ ...emp, departmentName: departmentsMap.get(emp.departmentId) || 'Unknown' }));
                setEmployees(employeesWithDeptName);

                const expensePromises = fetchedCategories.map(category => getOverheadExpenses(category.id));
                const results = await Promise.all(expensePromises);
                setAllOverheadExpenses(results.flat());
                
                unsubscribeJobs = listenToJobCards((fetchedJobs) => setJobs(fetchedJobs));
                setLoading(false);
            } catch (error) {
                console.error("Failed to fetch all data for performance page:", error);
                setLoading(false);
            }
        };

        fetchAllDataAndSetupListeners();
        return () => { if (unsubscribeJobs) unsubscribeJobs(); };
    }, []);
    
    // --- UPDATED useMemo to calculate department data ---
    const performanceData = useMemo(() => {
        const totalMonthlyOverheads = (allOverheadExpenses || []).reduce((sum, exp) => sum + (exp.amount || 0), 0);
        const employeeCount = employees.length > 0 ? employees.length : 1;
        const overheadCostPerProductiveHour = totalMonthlyOverheads / (employeeCount * 173.2);

        const validCompletedJobs = jobs.filter(job => 
            job.status === 'Complete' && 
            job.startedAt && 
            job.completedAt
        );

        // --- Department level calculations ---
        const departmentData = departments.map(dept => {
            const deptJobs = validCompletedJobs.filter(j => j.departmentId === dept.id);
            if (deptJobs.length === 0) {
                return { name: dept.name, avgEfficiency: 0, totalValue: 0 };
            }

            const totalValue = deptJobs.reduce((sum, j) => sum + (j.totalCost || 0), 0);
            
            let totalEfficiencyRatio = 0;
            let jobsWithTime = 0;
            deptJobs.forEach(job => {
                if (job.estimatedTime > 0) {
                    const durationSeconds = (job.completedAt.seconds - job.startedAt.seconds) - (job.totalPausedMilliseconds / 1000 || 0);
                    if (durationSeconds > 0) {
                        totalEfficiencyRatio += ((job.estimatedTime * 60) / durationSeconds);
                        jobsWithTime++;
                    }
                }
            });
            const avgEfficiency = jobsWithTime > 0 ? (totalEfficiencyRatio / jobsWithTime) * 100 : 0;
            
            return { name: dept.name, avgEfficiency, totalValue };
        });
        // --- End of department calculations ---

        const overallTotalWorkMinutes = validCompletedJobs.reduce((acc, job) => {
            const durationSeconds = (job.completedAt.toDate().getTime() - job.startedAt.toDate().getTime() - (job.totalPausedMilliseconds || 0)) / 1000;
            return acc + (durationSeconds > 0 ? durationSeconds / 60 : 0);
        }, 0);

        const efficiencyData = validCompletedJobs.map(job => {
            if (!job.estimatedTime || job.estimatedTime <= 0) return null;
            const durationSeconds = (job.completedAt.toDate().getTime() - job.startedAt.toDate().getTime() - (job.totalPausedMilliseconds || 0)) / 1000;
            if (durationSeconds <= 0) return null;
            return ((job.estimatedTime * 60) / durationSeconds) * 100;
        }).filter(Boolean);

        const overallAvgEfficiency = efficiencyData.length > 0 ? efficiencyData.reduce((sum, eff) => sum + eff, 0) / efficiencyData.length : 0;
        const overallTotalJobValue = validCompletedJobs.reduce((acc, job) => acc + (job.totalCost || 0), 0);

        let employeeMetrics = (employees || []).map(emp => {
            const empJobs = jobs.filter(job => job.employeeId === emp.id && (job.status === 'Complete' || job.status === 'Issue' || job.status === 'Archived - Issue'));
            const empJobsCompleted = empJobs.length;
            const empIssueJobs = empJobs.filter(j => j.status === 'Issue' || j.status === 'Archived - Issue');
            const empKudosJobs = empJobs.filter(j => j.kudos === true);

            let empTotalWorkMinutes = 0, empTotalEfficiencyRatioSum = 0, empTotalJobValue = 0, jobsWithTime = 0;
            empJobs.forEach(job => {
                if (job.startedAt && job.completedAt) {
                    const durationSeconds = Math.max(0, (job.completedAt.toDate().getTime() - job.startedAt.toDate().getTime() - (job.totalPausedMilliseconds || 0)) / 1000);
                    if (durationSeconds > 0) {
                        empTotalWorkMinutes += durationSeconds / 60;
                        if(job.estimatedTime > 0) {
                           empTotalEfficiencyRatioSum += (job.estimatedTime * 60) / durationSeconds;
                           jobsWithTime++;
                        }
                    }
                }
                if (typeof job.totalCost === 'number') empTotalJobValue += job.totalCost;
            });

            const empAvgEfficiency = jobsWithTime > 0 ? (empTotalEfficiencyRatioSum / jobsWithTime) * 100 : 0;
            const burdenedRate = (emp.hourlyRate || 0) + overheadCostPerProductiveHour;
            const totalLaborCost = (empTotalWorkMinutes / 60) * burdenedRate;
            
            return {
                ...emp,
                jobsCompleted: empJobsCompleted,
                avgEfficiency: empAvgEfficiency,
                netValueAdded: empTotalJobValue - totalLaborCost,
                reworkRate: empJobsCompleted > 0 ? (empIssueJobs.length / empJobsCompleted) * 100 : 0,
                reworkCount: empIssueJobs.length,
                kudosCount: empKudosJobs.length,
            };
        });

        const maxNetValue = Math.max(1, ...employeeMetrics.map(e => e.netValueAdded));
        const maxEfficiency = Math.max(100, ...employeeMetrics.map(e => e.avgEfficiency));
        
        const employeePerformanceMetrics = employeeMetrics.map(emp => {
            const netValueScore = Math.max(0, (emp.netValueAdded / maxNetValue) * 100);
            const efficiencyScore = Math.max(0, (emp.avgEfficiency / maxEfficiency) * 100);
            const qualityScore = Math.max(0, 100 - emp.reworkRate);
            const ops = (efficiencyScore * 0.4) + (netValueScore * 0.4) + (qualityScore * 0.2);
            return { ...emp, ops };
        });

        return {
            overallKpis: {
                jobsCompleted: validCompletedJobs.length,
                totalWorkHours: (overallTotalWorkMinutes / 60).toFixed(1),
                avgEfficiency: `${Math.round(overallAvgEfficiency)}%`,
                totalJobValue: `R ${overallTotalJobValue.toLocaleString('en-ZA', {minimumFractionDigits: 2})}`,
            },
            employeePerformanceMetrics,
            departmentData, // <-- EXPORT NEW DATA
        };
    }, [jobs, employees, allOverheadExpenses, departments]);

    if (loading) return <p className="text-center text-gray-400">Loading Performance Data...</p>;

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Business Performance Dashboard</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <KpiCard icon={<CheckCircle2 size={24} />} title="Jobs Completed" value={performanceData.overallKpis.jobsCompleted} color="bg-green-500/20 text-green-400" />
                <KpiCard icon={<Clock size={24} />} title="Total Work Time" value={`${performanceData.overallKpis.totalWorkHours} hrs`} color="bg-blue-500/20 text-blue-400" />
                <KpiCard icon={<Zap size={24} />} title="Average Efficiency" value={performanceData.overallKpis.avgEfficiency} color="bg-purple-500/20 text-purple-400" />
                <KpiCard icon={<DollarSign size={24} />} title="Total Job Value" value={performanceData.overallKpis.totalJobValue} color="bg-yellow-500/20 text-yellow-400" />
            </div>

            {/* --- RENDER THE NEW CHART --- */}
            <DepartmentPerformanceChart data={performanceData.departmentData} />
            
             <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h3 className="text-xl font-bold text-white">
                        Performance Leaderboard
                    </h3>
                    <div className="w-full sm:w-auto">
                        <Dropdown
                            name="departmentFilter"
                            value={leaderboardDepartmentFilter}
                            onChange={(e) => setLeaderboardDepartmentFilter(e.target.value)}
                            options={[{ id: 'all', name: 'Overall Company' }, ...departments]}
                        />
                     </div>
                </div>
                <PerformanceLeaderboard
                    employees={leaderboardDepartmentFilter === 'all' ? performanceData.employeePerformanceMetrics : performanceData.employeePerformanceMetrics.filter(e => e.departmentId === leaderboardDepartmentFilter)}
                    activeSortKey={leaderboardSortKey}
                    setActiveSortKey={setLeaderboardSortKey}
                 />
            </div>
        </div>
    );
};

export default PerformancePage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\PickingQueuePage.jsx
==================================================
// src/pages/PickingQueuePage.jsx (NEW FILE)

import React from 'react';
import PickingQueue from '../components/features/picking/PickingQueue';
import { PackageSearch } from 'lucide-react';

const PickingQueuePage = () => {
    return (
        <div className="space-y-6">
            <div className="flex items-center gap-3">
                <PackageSearch size={32} className="text-purple-400" />
                <div>
                    <h2 className="text-3xl font-bold text-white">Picking Queue</h2>
                    <p className="text-gray-400">Live list of materials that need to be picked for scheduled jobs.</p>
                </div>
            </div>
            <PickingQueue />
        </div>
    );
};

export default PickingQueuePage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\ProductBrowserPage.jsx
==================================================
// src/pages/ProductBrowserPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getProducts, addQuote, getJobStepDetails, listenToJobCards } from '../api/firestore';
import { useAuth } from '../contexts/AuthContext';
import Input from '../components/ui/Input';
import Dropdown from '../components/ui/Dropdown';
import { Search, CheckCircle, AlertTriangle, Clock, FileText } from 'lucide-react';
import Button from '../components/ui/Button';
import LiveQuoteSidebar from '../components/features/portal/LiveQuoteSidebar';
import toast from 'react-hot-toast';

// Helper component to display stock status with appropriate colors and icons
const StockStatus = ({ product, leadTimeDays }) => {
    const stock = product.currentStock || 0;
    const reorder = product.reorderLevel || 0;
    
    if (stock > reorder) {
        return <span className="flex items-center gap-1 text-xs font-semibold text-green-400"><CheckCircle size={14} /> In Stock</span>;
    }
    if (stock > 0 && stock <= reorder) {
        return <span className="flex items-center gap-1 text-xs font-semibold text-yellow-400"><AlertTriangle size={14} /> Low Stock</span>;
    }
    // --- UPDATED LOGIC TO SHOW DYNAMIC LEAD TIME ---
    return (
        <span className="flex items-center gap-1 text-xs font-semibold text-gray-400" title="Estimated time until dispatch based on current workshop load.">
            <Clock size={14} /> 
            {leadTimeDays !== null ? `~${leadTimeDays} Day Lead Time` : 'Made to Order'}
        </span>
    );
};


const ProductBrowserPage = () => {
    const { user } = useAuth();
    const [products, setProducts] = useState([]);
    const [allRecipes, setAllRecipes] = useState([]); // --- NEW STATE for recipes ---
    const [allJobs, setAllJobs] = useState([]); // --- NEW STATE for jobs ---
    const [loading, setLoading] = useState(true);
    const [cartItems, setCartItems] = useState([]);

    const [searchTerm, setSearchTerm] = useState('');
    const [filters, setFilters] = useState({
        manufacturer: '',
        make: '',
        model: ''
    });

    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            try {
                // --- FETCH ALL NECESSARY DATA ---
                const [fetchedProducts, fetchedRecipes] = await Promise.all([
                    getProducts(),
                    getJobStepDetails()
                ]);
                setProducts(fetchedProducts);
                setAllRecipes(fetchedRecipes);

                // Listen for real-time job updates to keep lead times fresh
                const unsubscribeJobs = listenToJobCards(setAllJobs);
                
                return unsubscribeJobs;
            } catch (error) {
                console.error("Error fetching products:", error);
                toast.error("Could not load product catalog.");
            }
            setLoading(false);
        };
        const unsubscribePromise = fetchData();
        return () => { unsubscribePromise.then(unsub => unsub && unsub()); };
    }, []);

    // --- NEW: Calculation for lead times ---
    const productLeadTimes = useMemo(() => {
        const leadTimes = new Map();
        if (products.length === 0 || allRecipes.length === 0 || allJobs.length === 0) {
            return leadTimes;
        }

        const pendingJobs = allJobs.filter(j => j.status === 'Pending');
        const backlogByDept = pendingJobs.reduce((acc, job) => {
            const deptId = job.departmentId;
            acc[deptId] = (acc[deptId] || 0) + (job.estimatedTime || 0);
            return acc;
        }, {});

        products.forEach(product => {
            const recipesForProduct = allRecipes.filter(r => r.productId === product.id);
            if (recipesForProduct.length === 0) {
                leadTimes.set(product.id, null);
                return;
            }

            let totalManufacturingMinutes = 0;
            let totalBacklogMinutes = 0;
            const departmentsInvolved = new Set();

            recipesForProduct.forEach(recipe => {
                totalManufacturingMinutes += recipe.estimatedTime || 0;
                if (recipe.departmentId) {
                    departmentsInvolved.add(recipe.departmentId);
                }
            });

            departmentsInvolved.forEach(deptId => {
                totalBacklogMinutes += backlogByDept[deptId] || 0;
            });

            const totalMinutes = totalManufacturingMinutes + totalBacklogMinutes;
            const totalDays = Math.ceil(totalMinutes / (8 * 60)); // Assuming 8-hour work day

            leadTimes.set(product.id, totalDays);
        });

        return leadTimes;

    }, [products, allRecipes, allJobs]);

    const handleFilterChange = (e) => {
        const { name, value } = e.target;
        setFilters(prev => {
            const newFilters = { ...prev, [name]: value };
            if (name === 'manufacturer') {
                newFilters.make = '';
                newFilters.model = '';
            }
            if (name === 'make') {
                newFilters.model = '';
            }
            return newFilters;
        });
    };
    
    const handleAddToCart = (product) => {
        if (cartItems.find(item => item.id === product.id)) {
            return toast('Item is already in your quote.', { icon: 'â„¹ï¸' });
        }
        setCartItems(prev => [...prev, product]);
        toast.success(`${product.name} added to quote.`);
    };

    const handleRemoveFromCart = (productId) => {
        setCartItems(prev => prev.filter(item => item.id !== productId));
    };
    
    const handleOrderSubmission = () => {
        setCartItems([]);
    };

    const handleInstantQuote = async (product) => {
        const quoteData = {
            customerName: user.companyName || user.email,
            customerEmail: user.email,
            lineItems: [{
                description: product.name,
                cost: product.sellingPrice,
                productId: product.id,
                quantity: 1,
            }],
            subtotal: product.sellingPrice,
            margin: 0,
            total: product.sellingPrice,
            quoteId: `Q-INST-${Date.now()}`,
            status: 'Customer Generated'
        };

        const promise = addQuote(quoteData);
        toast.promise(promise, {
            loading: 'Generating instant quote...',
            success: `Instant quote ${quoteData.quoteId} created!`,
            error: "Failed to create instant quote."
        });
    };

    const manufacturers = useMemo(() => [...new Set(products.map(p => p.manufacturer).filter(Boolean))].map(m => ({id: m, name: m})), [products]);
    
     const makes = useMemo(() => {
        if (!filters.manufacturer) return [];
        return [...new Set(products.filter(p => p.manufacturer === filters.manufacturer).map(p => p.make).filter(Boolean))].map(m => ({id: m, name: m}));
    }, [products, filters.manufacturer]);

    const models = useMemo(() => {
        if (!filters.make) return [];
        return [...new Set(products.filter(p => p.make === filters.make).map(p => p.model).filter(Boolean))].map(m => ({id: m, name: m}));
    }, [products, filters.make]);

    const displayedProducts = useMemo(() => {
        return products.filter(product => {
            const searchLower = searchTerm.toLowerCase();
            const nameMatch = product.name.toLowerCase().includes(searchLower);
            const partNumberMatch = product.partNumber?.toLowerCase().includes(searchLower);

            const manufacturerMatch = !filters.manufacturer || product.manufacturer === filters.manufacturer;
            const makeMatch = !filters.make || product.make === filters.make;
            const modelMatch = !filters.model || product.model === filters.model;

            return (nameMatch || partNumberMatch) && manufacturerMatch && makeMatch && modelMatch;
        });
    }, [products, searchTerm, filters]);


    if (loading) {
        return <p className="text-center text-gray-400">Loading Product Catalog...</p>;
    }

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
            <div className="lg:col-span-2 space-y-6">
                 <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h3 className="text-xl font-bold text-white mb-4">Find Your Parts</h3>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="relative md:col-span-1">
                             <Input 
                                placeholder="Search by name or part number..." 
                                value={searchTerm}
                                 onChange={e => setSearchTerm(e.target.value)}
                                className="pl-10"
                            />
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                         </div>
                        <Dropdown label="Manufacturer" name="manufacturer" value={filters.manufacturer} onChange={handleFilterChange} options={manufacturers} placeholder="All Manufacturers" />
                        <Dropdown label="Make" name="make" value={filters.make} onChange={handleFilterChange} options={makes} placeholder="All Makes" disabled={!filters.manufacturer} />
                        <Dropdown label="Model" name="model" value={filters.model} onChange={handleFilterChange} options={models} placeholder="All Models" disabled={!filters.make} />
                    </div>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    {displayedProducts.map(product => (
                        <div key={product.id} className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden flex flex-col">
                            <img 
                                src={product.photoUrl || `https://placehold.co/400x300/1f2937/9ca3af?text=No+Image`} 
                                alt={product.name}
                                className="w-full h-48 object-cover"
                            />
                             <div className="p-4 flex flex-col flex-grow">
                                <h4 className="font-bold text-white flex-grow">{product.name}</h4>
                                <p className="text-xs text-gray-500 font-mono mb-2">P/N: {product.partNumber}</p>
                                <div className="flex justify-between items-center mb-4">
                                     <p className="text-lg font-semibold text-green-400">R {product.sellingPrice?.toFixed(2) || 'N/A'}</p>
                                    <StockStatus product={product} leadTimeDays={productLeadTimes.get(product.id)} />
                                </div>
                                 <div className="flex gap-2 mt-auto">
                                    <Button onClick={() => handleAddToCart(product)} variant="primary" className="w-full">Add to Quote</Button>
                                    {product.sellingPrice > 0 && (
                                        <Button 
                                            onClick={() => handleInstantQuote(product)} 
                                            variant="secondary" 
                                            className="p-2"
                                            title="Get Instant Quote for this item"
                                        >
                                            <FileText size={20} />
                                        </Button>
                                    )}
                                 </div>
                            </div>
                        </div>
                    ))}
                </div>
                {displayedProducts.length === 0 && !loading && (
                     <div className="text-center py-16 bg-gray-800 rounded-lg">
                        <p className="text-gray-500">No products match your search criteria.</p>
                    </div>
                )}
            </div>

            <div className="lg:col-span-1">
                 <LiveQuoteSidebar 
                    cartItems={cartItems}
                    onRemoveItem={handleRemoveFromCart}
                    discountPercentage={user?.discountPercentage || 0}
                    onOrderSubmit={handleOrderSubmission}
                />
            </div>
        </div>
    );
};

export default ProductBrowserPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\ProductViabilityPage.jsx
==================================================
// src/pages/ProductViabilityPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getProducts, getLinkedRecipesForProduct, getJobStepDetails, getAllInventoryItems, getEmployees, getOverheadCategories, getOverheadExpenses } from '../api/firestore';
import Dropdown from '../components/ui/Dropdown';
import Input from '../components/ui/Input';
import { DollarSign, Percent, Plus } from 'lucide-react';

const ProductViabilityKpiCard = ({ icon, title, value, color }) => (
    <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
        <div className="flex items-start space-x-4">
            <div className={`p-3 rounded-full ${color}`}>
                {icon}
            </div>
            <div>
                <p className="text-gray-400 text-sm">{title}</p>
                <p className="text-3xl font-bold text-white">{value}</p>
            </div>
        </div>
    </div>
);

const ProductViabilityPage = () => {
    const [products, setProducts] = useState([]);
    const [allRecipes, setAllRecipes] = useState([]);
    const [inventoryItems, setInventoryItems] = useState([]);
    const [averageBurdenedRate, setAverageBurdenedRate] = useState(0);
    const [selectedProductId, setSelectedProductId] = useState('');
    const [linkedRecipes, setLinkedRecipes] = useState([]);
    const [sellingPrice, setSellingPrice] = useState('');
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            setLoading(true);
            try {
                const [prods, recipes, inventory, employees, overheadCats] = await Promise.all([
                    getProducts(),
                    getJobStepDetails(),
                    getAllInventoryItems(),
                    getEmployees(),
                    getOverheadCategories()
                ]);

                setProducts(prods);
                setAllRecipes(recipes);
                setInventoryItems(inventory);

                const expensePromises = overheadCats.map(cat => getOverheadExpenses(cat.id));
                const expenseResults = await Promise.all(expensePromises);
                const totalMonthlyOverheads = expenseResults.flat().reduce((sum, exp) => sum + (exp.amount || 0), 0);
                const totalCompanyProductiveHours = (employees.length || 1) * 45 * 4.33;
                const overheadCostPerHour = totalCompanyProductiveHours > 0 ? totalMonthlyOverheads / totalCompanyProductiveHours : 0;
                const totalHourlyRate = employees.reduce((sum, emp) => sum + (emp.hourlyRate || 0), 0);
                const avgDirectRate = employees.length > 0 ? totalHourlyRate / employees.length : 0;
                setAverageBurdenedRate(avgDirectRate + overheadCostPerHour);
            } catch (error) {
                console.error("Failed to load viability data:", error);
            }
            setLoading(false);
        };
        fetchData();
    }, []);

    useEffect(() => {
        const fetchLinks = async () => {
            if (selectedProductId) {
                const product = products.find(p => p.id === selectedProductId);
                if (product) {
                    setSellingPrice(product.sellingPrice || '');
                }
                const links = await getLinkedRecipesForProduct(selectedProductId);
                
                // For each link, find the corresponding full recipe details
                const detailedRecipes = links.map(link => {
                    return allRecipes.find(r => r.id === link.jobStepDetailId);
                }).filter(Boolean); // Filter out any undefined recipes

                setLinkedRecipes(detailedRecipes);
            } else {
                setLinkedRecipes([]);
            }
        };
        fetchLinks();
    }, [selectedProductId, products, allRecipes]);

    const analysis = useMemo(() => {
        const inventoryMap = new Map(inventoryItems.map(item => [item.id, item]));
        let totalMaterialCost = 0;
        let totalLaborCost = 0;
        const detailedCosts = [];

        linkedRecipes.forEach(recipe => {
            const recipeMaterialCost = (recipe.consumables || []).reduce((sum, consumable) => {
                const inventoryItem = inventoryMap.get(consumable.itemId);
                const price = inventoryItem?.price || 0;
                
                // Handle both fixed and dimensional consumables
                let quantity = 0;
                if(consumable.type === 'fixed') {
                    quantity = consumable.quantity || 0;
                } else if (consumable.type === 'dimensional') {
                    // This is a simplified cost for dimensional - a better model could be built
                    // For now, let's assume the 'quantity' field is stored for cost estimation
                    quantity = consumable.quantity || 1; 
                } else {
                    quantity = consumable.quantity || 0;
                }

                return sum + (price * quantity);
            }, 0);

            const recipeLaborCost = (recipe.estimatedTime || 0) / 60 * averageBurdenedRate;
            
            totalMaterialCost += recipeMaterialCost;
            totalLaborCost += recipeLaborCost;

            detailedCosts.push({
                id: recipe.id,
                partName: recipe.description || 'Recipe Step',
                departmentName: products.find(p=>p.id === recipe.productId)?.name || 'N/A',
                cost: recipeMaterialCost + recipeLaborCost
            });
        });
        
        const totalCost = totalMaterialCost + totalLaborCost;
        const price = parseFloat(sellingPrice) || 0;
        const profit = price > 0 ? price - totalCost : 0;
        const margin = price > 0 ? (profit / price) * 100 : 0;

        return { totalCost, profit, margin, detailedCosts };
    }, [linkedRecipes, sellingPrice, inventoryItems, averageBurdenedRate, products]);

    if (loading) return <p className="text-center text-gray-400">Loading Profitability Engine...</p>;

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Product Profitability Dashboard</h2>

            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <Dropdown
                    label="Select a Product to Analyze"
                    value={selectedProductId}
                    onChange={(e) => setSelectedProductId(e.target.value)}
                    options={products}
                    placeholder="Choose a product..."
                />
            </div>
            
            {selectedProductId && (
                <div className="space-y-8 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <ProductViabilityKpiCard icon={<DollarSign size={24}/>} title="True Manufacturing Cost" value={`R ${analysis.totalCost.toFixed(2)}`} color="bg-orange-500/20 text-orange-400" />
                        <div className="md:col-span-1">
                            <Input label="Enter Selling Price" type="number" value={sellingPrice} onChange={e => setSellingPrice(e.target.value)} placeholder="e.g., 50000" />
                        </div>
                        <ProductViabilityKpiCard icon={<Plus size={24}/>} title="Net Profit" value={`R ${analysis.profit.toFixed(2)}`} color={analysis.profit >= 0 ? "bg-green-500/20 text-green-400" : "bg-red-500/20 text-red-400"} />
                        <ProductViabilityKpiCard icon={<Percent size={24}/>} title="Profit Margin" value={`${analysis.margin.toFixed(1)}%`} color={analysis.margin >= 0 ? "bg-green-500/20 text-green-400" : "bg-red-500/20 text-red-400"} />
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                         <h3 className="text-xl font-bold text-white mb-4">Cost Breakdown</h3>
                         <div className="space-y-3">
                            {analysis.detailedCosts.length > 0 ? (
                                analysis.detailedCosts.map(item => (
                                    <div key={item.id} className="flex justify-between items-center bg-gray-700/50 p-3 rounded-lg">
                                        <div>
                                            <p className="font-semibold text-gray-200">{item.partName}</p>
                                        </div>
                                        <p className="font-mono text-lg text-gray-300">R {item.cost.toFixed(2)}</p>
                                    </div>
                                ))
                            ) : (
                                <p className="text-gray-400 text-center py-4">No linked recipes found for this product. Go to Settings to link recipes.</p>
                            )}
                         </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default ProductViabilityPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\PurchasingPage.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { 
    listenToPurchaseQueue, 
    getSuppliers, 
    markItemsAsOrdered,
    listenToOneOffPurchases,
    markOneOffItemsAsOrdered,
    getSupplierPricingForItem,
    addSupplier,
    listenToJobCards,
    getAllInventoryItems,
    addToPurchaseQueue
} from '../api/firestore';
import Button from '../components/ui/Button';
import Input from '../components/ui/Input';
import { Mail, ThumbsUp, Truck, Package, Wrench, UserPlus, X } from 'lucide-react';
import InTransitOrders from '../components/features/stock/InTransitOrders';
import Dropdown from '../components/ui/Dropdown';
import toast from 'react-hot-toast';
import StockControlDashboard from '../components/features/stock/StockControlDashboard';
import FutureDemandAnalyzer from '../components/features/stock/FutureDemandAnalyzer';
import { BrainCircuit } from 'lucide-react';

// AddSupplierModal Component (Restored)
const AddSupplierModal = ({ onClose, onSupplierAdded }) => {
    const [newSupplier, setNewSupplier] = useState({ name: '', email: '', estimatedEtaDays: '', minOrderAmount: '' });
    
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setNewSupplier(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async () => {
        if (!newSupplier.name || !newSupplier.email) {
            return toast.error("Supplier Name and Email are required.");
        }
        try {
            const supplierData = {
                ...newSupplier,
                estimatedEtaDays: parseInt(newSupplier.estimatedEtaDays, 10) || 0,
                minOrderAmount: parseFloat(newSupplier.minOrderAmount) || 0,
            };
            await addSupplier(supplierData);
            toast.success("Supplier added successfully!");
            onSupplierAdded();
            onClose();
        } catch (error) {
            console.error("Error adding supplier:", error);
            toast.error("Failed to add supplier.");
        }
    };

    return (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div className="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-lg">
                 <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold text-white">Add New Supplier</h2>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20} /></Button>
                </div>
                <div className="p-6 space-y-4">
                    <Input label="Supplier Name" name="name" value={newSupplier.name} onChange={handleInputChange} />
                    <Input label="Email" name="email" type="email" value={newSupplier.email} onChange={handleInputChange} />
                    <Input label="ETA (days)" name="estimatedEtaDays" type="number" value={newSupplier.estimatedEtaDays} onChange={handleInputChange} />
                    <Input label="Min. Order (R)" name="minOrderAmount" type="number" value={newSupplier.minOrderAmount} onChange={handleInputChange} />
                </div>
                <div className="p-4 bg-gray-800/50 flex justify-end">
                    <Button onClick={handleSubmit} variant="primary">Save Supplier</Button>
                </div>
            </div>
        </div>
    );
};

// PurchaseHub Component (Restored)
const PurchaseHub = ({ stockItems, jobItems, suppliers, onAction }) => {
    const [allPricing, setAllPricing] = useState({});
    const [selectedSuppliers, setSelectedSuppliers] = useState({});
    const [orderQuantities, setOrderQuantities] = useState({});
    const [loadingPricing, setLoadingPricing] = useState(true);
    const [isAddSupplierModalOpen, setAddSupplierModalOpen] = useState(false);
    const [sendToAdmin, setSendToAdmin] = useState({});

    const ADMIN_EMAIL = "admin@tojem.co.za";

    const unifiedQueue = useMemo(() => [
        ...stockItems.map(item => ({ ...item, type: 'Stock' })),
        ...jobItems.map(item => ({ ...item, type: 'Job-Specific', itemId: item.id, itemName: item.itemName || item.description }))
    ], [stockItems, jobItems]);

    useEffect(() => {
        const fetchAllPricing = async () => {
            setLoadingPricing(true);
            const pricingMap = {};
            const pricingPromises = unifiedQueue.map(async (item) => {
                if (!item.itemId) return;
                const prices = await getSupplierPricingForItem(item.itemId);
                pricingMap[item.itemId] = prices;
            });
            await Promise.all(pricingPromises);
            setAllPricing(pricingMap);

            const initialSelections = {};
            unifiedQueue.forEach(item => {
                if (!item.itemId) return;
                const prices = pricingMap[item.itemId] || [];
                if (prices.length > 0) {
                    const cheapest = prices.reduce((min, p) => p.price < min.price ? p : min, prices[0]);
                    initialSelections[item.itemId] = cheapest.supplierId;
                }
            });
            setSelectedSuppliers(initialSelections);
            setLoadingPricing(false);
        };

        if (unifiedQueue.length > 0) {
            fetchAllPricing();
        } else {
            setLoadingPricing(false);
        }
    }, [unifiedQueue]);

    const handleSupplierSelection = (itemId, supplierId) => {
        setSelectedSuppliers(prev => ({ ...prev, [itemId]: supplierId }));
    };

    const handleQuantityChange = (itemId, qty) => {
        setOrderQuantities(prev => ({ ...prev, [itemId]: qty }));
    };
    
    const handleSendToAdminToggle = (itemId) => {
        setSendToAdmin(prev => ({...prev, [itemId]: !prev[itemId]}));
    };

    const groupedOrders = useMemo(() => {
        const groups = { admin: { supplierDetails: { name: 'Admin Purchase Request', email: ADMIN_EMAIL }, stockItems: [], jobItems: [] } };
        
        unifiedQueue.forEach(item => {
            if (!item.itemId) return;
            const isForAdmin = sendToAdmin[item.itemId];
            const supplierId = isForAdmin ? 'admin' : selectedSuppliers[item.itemId];

            if (!supplierId) return;

            if (!groups[supplierId]) {
                const supplierDetails = suppliers.find(s => s.id === supplierId);
                if (supplierDetails) {
                    groups[supplierId] = { supplierDetails, stockItems: [], jobItems: [] };
                }
            }
            if (groups[supplierId]) {
                if (item.type === 'Stock') {
                    groups[supplierId].stockItems.push(item);
                } else {
                    groups[supplierId].jobItems.push(item);
                }
            }
        });
        
        return Object.entries(groups)
            .filter(([_, group]) => group.stockItems.length > 0 || group.jobItems.length > 0)
            .map(([_, group]) => group)
            .sort((a, b) => a.supplierDetails.name.localeCompare(b.supplierDetails.name));

    }, [unifiedQueue, suppliers, selectedSuppliers, sendToAdmin]);
    
    const handleGenerateEmail = async (group) => {
        const { supplierDetails, stockItems, jobItems } = group;
        const supplierEmail = supplierDetails.email || '';
        const subject = `Purchase Order - TOJEM - ${supplierDetails.name}`;
        let body = `Hi ${supplierDetails.contactPerson || supplierDetails.name},\n\nPlease supply the following items:\n\n`;

        if(stockItems.length > 0) {
            body += "--- For Stock ---\n";
            stockItems.forEach(item => {
                const recommendedQty = Math.max(0, (item.standardStockLevel || 0) - (item.currentStock || 0));
                const orderQty = orderQuantities[item.itemId] || recommendedQty;
                if (orderQty > 0) body += `- ${item.itemName} (Code: ${item.itemCode || 'N/A'}) --- Qty: ${orderQty}\n`;
            });
            body += "\n";
        }
        
        if(jobItems.length > 0) {
            body += "--- For Specific Jobs ---\n";
            jobItems.forEach(item => {
                 const orderQty = orderQuantities[item.itemId] || item.quantity;
                 if(orderQty > 0) body += `- ${item.itemName} (For SO: ${item.salesOrderId}) --- Qty: ${orderQty}\n`;
            });
        }

        body += `\nThank you,\nTojem`;
        window.location.href = `mailto:${supplierEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

        if (supplierDetails.name !== 'Admin Purchase Request') {
            try {
                if (stockItems.length > 0) {
                    await markItemsAsOrdered(supplierDetails, stockItems, orderQuantities);
                }
                if (jobItems.length > 0) {
                    await markOneOffItemsAsOrdered(jobItems.map(item => item.id));
                }
                toast.success("Items marked as ordered and moved to 'In-Transit'.");
                onAction();
            } catch(error) {
                console.error("Error marking items as ordered:", error);
                toast.error("Failed to mark items as ordered.");
            }
        } else {
            toast.success("Admin purchase request email has been generated.");
        }
    };

    if (loadingPricing) return <p className="text-center p-8 text-gray-400">Analyzing purchasing requirements...</p>;
    if (unifiedQueue.length === 0) return <p className="text-center text-gray-400 p-8">The purchasing queue is empty.</p>;

    return (
        <div className="space-y-6">
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold text-white">Items Requiring Purchase ({unifiedQueue.length})</h3>
                     <Button onClick={() => setAddSupplierModalOpen(true)} variant="secondary"><UserPlus size={16} className="mr-2"/>Add New Supplier</Button>
                </div>
                <div className="space-y-4">
                    {unifiedQueue.map(item => {
                        const pricingOptions = allPricing[item.itemId] || [];
                        const cheapestOption = pricingOptions.length > 0 ? pricingOptions.reduce((min, p) => p.price < min.price ? p : min) : null;
                        const recommendedQty = item.type === 'Stock' ? Math.max(0, (item.standardStockLevel || 0) - (item.currentStock || 0)) : item.quantity;
                        
                        return (
                            <div key={item.id} className="grid grid-cols-1 lg:grid-cols-5 gap-4 items-center bg-gray-900/50 p-4 rounded-lg">
                                <div>
                                    <p className="font-semibold text-white flex items-center gap-2">
                                       {item.type === 'Stock' ? <Package size={16} className="text-blue-400"/> : <Wrench size={16} className="text-purple-400"/>}
                                       {item.itemName}
                                    </p>
                                    <p className="text-xs text-gray-400 ml-8">{item.type === 'Stock' ? (item.itemCode || 'No Code') : `For SO: ${item.salesOrderId}`}</p>
                                </div>
                                <div>
                                     <Dropdown 
                                        label="Select Supplier"
                                        value={selectedSuppliers[item.itemId] || ''}
                                        onChange={(e) => handleSupplierSelection(item.itemId, e.target.value)}
                                        options={pricingOptions.map(p => ({ id: p.supplierId, name: `${p.supplierName} - R${p.price.toFixed(2)}` }))}
                                        placeholder="Choose supplier..."
                                    />
                                </div>
                                <div className="text-center">
                                    {item.type === 'Stock' && <p className="text-xs text-gray-400">Current: {item.currentStock}</p>}
                                    <p className="text-xs text-green-400">Recommended: {recommendedQty}</p>
                                </div>
                                <div className="w-32 mx-auto">
                                     <Input 
                                        label="Order Qty"
                                        type="number"
                                        value={orderQuantities[item.itemId] === undefined ? recommendedQty : orderQuantities[item.itemId]}
                                        onChange={(e) => handleQuantityChange(item.itemId, e.target.value)}
                                    />
                                 </div>
                                <div className="text-center">
                                    <label className="flex items-center justify-center gap-2 text-sm text-gray-300 cursor-pointer">
                                         <input type="checkbox" checked={!!sendToAdmin[item.itemId]} onChange={() => handleSendToAdminToggle(item.itemId)} className="h-4 w-4 rounded bg-gray-700 text-blue-600 focus:ring-blue-500"/>
                                        Send to Admin
                                    </label>
                                 </div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {groupedOrders.map((group) => (
                <div key={group.supplierDetails.email} className="bg-blue-900/20 p-6 rounded-xl border border-blue-500/50">
                     <div className="flex justify-between items-center mb-4">
                         <div>
                             <h3 className="text-xl font-bold text-white flex items-center gap-2"><ThumbsUp/> PO for: {group.supplierDetails.name}</h3>
                             <p className="text-sm text-gray-400">{group.supplierDetails.email}</p>
                         </div>
                         <Button onClick={() => handleGenerateEmail(group)}>Generate Email & Mark as Ordered</Button>
                     </div>
                </div>
            ))}
             {isAddSupplierModalOpen && <AddSupplierModal onClose={() => setAddSupplierModalOpen(false)} onSupplierAdded={onAction}/>}
        </div>
    );
};

// Main Page Component
const PurchasingPage = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [purchaseQueue, setPurchaseQueue] = useState([]);
  const [jobQueue, setJobQueue] = useState([]);
  const [suppliers, setSuppliers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isAnalyzerOpen, setAnalyzerOpen] = useState(false);

  const fetchData = () => {
    setLoading(true);
    getSuppliers().then(setSuppliers).catch(err => console.error("Error fetching suppliers:", err));
    
    const unsubscribeStock = listenToPurchaseQueue(items => {
        setPurchaseQueue(items);
        setLoading(false);
    });
    const unsubscribeJobs = listenToOneOffPurchases(items => {
        setJobQueue(items.filter(item => item.status === 'Pending Purchase'));
        setLoading(false);
    });

    return () => {
        unsubscribeStock();
        unsubscribeJobs();
    };
  };

  useEffect(() => {
    const unsubscribe = fetchData();
    return () => unsubscribe();
  }, []);

  const TabButton = ({ id, label, count }) => {
    const isActive = activeTab === id;
    return (
      <button
        onClick={() => setActiveTab(id)}
        className={`px-5 py-2 text-sm font-semibold rounded-t-lg border-b-2 flex items-center gap-2 transition-colors ${
          isActive ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:border-gray-500 hover:text-gray-200'
        }`}
      >
        {label}
        {count > 0 && <span className={`text-xs rounded-full px-2 py-0.5 ${isActive ? 'bg-white text-blue-600' : 'bg-gray-600 text-gray-200'}`}>{count}</span>}
      </button>
    );
  };

  const { pendingStockItems, inTransitItems } = useMemo(() => {
    return {
        pendingStockItems: purchaseQueue.filter(i => i.status === 'pending'),
        inTransitItems: purchaseQueue.filter(i => i.status === 'ordered')
    }
  }, [purchaseQueue]);

  return (
    <>
      <div className="space-y-4">
        <div className="flex justify-between items-center">
            <h2 className="text-3xl font-bold text-white">Stock Control & Purchasing</h2>
            <Button onClick={() => setAnalyzerOpen(true)} variant="primary">
                <BrainCircuit size={18} className="mr-2"/>
                Predictive Analyzer
            </Button>
        </div>

        <div className="border-b border-gray-700">
            <nav className="-mb-px flex space-x-6">
                <TabButton id="dashboard" label="Stock Overview" />
                <TabButton id="queue" label="Purchase Queue" count={pendingStockItems.length + jobQueue.length} />
                <TabButton id="transit" label="In-Transit Orders" count={inTransitItems.length} />
            </nav>
        </div>
        <div className="mt-6">
            {activeTab === 'dashboard' && <StockControlDashboard />}
            {activeTab === 'queue' && (loading ? <p className="text-center text-gray-400 p-8">Loading Queue...</p> : <PurchaseHub stockItems={pendingStockItems} jobItems={jobQueue} suppliers={suppliers} onAction={fetchData} />)}
            {activeTab === 'transit' && (loading ? <p className="text-center text-gray-400 p-8">Loading In-Transit Orders...</p> : <InTransitOrders items={inTransitItems} suppliers={suppliers} onStockReceived={fetchData} />)}
        </div>
      </div>

      {isAnalyzerOpen && <FutureDemandAnalyzer onClose={() => setAnalyzerOpen(false)} />}
    </>
  );
};

export default PurchasingPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\QcPage.jsx
==================================================
// src/pages/QcPage.jsx (Upgraded with Toasts & Rejection Modal)

import React, { useState, useEffect, useMemo } from 'react';
import { listenToJobCards, processQcDecision, getReworkReasons, getEmployees } from '../api/firestore';
import Button from '../components/ui/Button';
import Dropdown from '../components/ui/Dropdown';
import { X } from 'lucide-react';
import toast from 'react-hot-toast';
import ConfirmationModal from '../components/ui/ConfirmationModal'; // --- IMPORT NEW COMPONENT ---

const RejectionModal = ({ job, reasons, onReject, onClose }) => {
    const [rejectionReasonId, setRejectionReasonId] = useState('');
    const [notes, setNotes] = useState('');
    const [preventDeduction, setPreventDeduction] = useState(false);
    const [requeueForRework, setRequeueForRework] = useState(false);
    const [reworkEmployeeId, setReworkEmployeeId] = useState('');
    const [allEmployees, setAllEmployees] = useState([]);

    useEffect(() => {
        getEmployees().then(setAllEmployees);
    }, []);

    const handleSubmit = () => {
        if (!rejectionReasonId) {
            return toast.error("Please select a reason for rejection.");
        }
        const reasonText = reasons.find(r => r.id === rejectionReasonId)?.name || 'Other';
        const fullReason = notes ? `${reasonText}: ${notes}` : reasonText;
        const selectedEmployee = allEmployees.find(emp => emp.id === reworkEmployeeId);

        const options = {
            rejectionReason: fullReason,
            preventStockDeduction: preventDeduction,
            reworkDetails: {
                requeue: requeueForRework,
                newEmployeeId: reworkEmployeeId || null,
                newEmployeeName: selectedEmployee ? selectedEmployee.name : null
            }
        };
        onReject(job, options);
    };

    return (
        <div onClick={onClose} className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
            <div onClick={(e) => e.stopPropagation()} className="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-lg">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-bold text-white">Reject Job: {job.partName}</h3>
                    <Button onClick={onClose} variant="secondary" className="p-2"><X size={20}/></Button>
                </div>
                <div className="p-6 space-y-4">
                    <Dropdown 
                        label="Reason for Rejection" 
                        options={reasons} 
                        value={rejectionReasonId} 
                        onChange={(e) => setRejectionReasonId(e.target.value)} 
                        placeholder="Select a failure mode..." 
                    />
                    <textarea 
                        value={notes} 
                        onChange={(e) => setNotes(e.target.value)} 
                        placeholder="Add optional specific notes here..." 
                        className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        rows="3"
                    ></textarea>
                    
                    <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                        <input type="checkbox" checked={preventDeduction} onChange={(e) => setPreventDeduction(e.target.checked)} className="h-4 w-4 rounded bg-gray-700 text-blue-600"/>
                        Do NOT deduct stock (parts are salvageable)
                    </label>
                    <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                        <input type="checkbox" checked={requeueForRework} onChange={(e) => setRequeueForRework(e.target.checked)} className="h-4 w-4 rounded bg-gray-700 text-blue-600"/>
                        Re-queue job for rework
                    </label>
                    {requeueForRework && (
                        <div className="animate-fade-in pl-6">
                            <Dropdown
                                label="Assign Rework to (Optional)"
                                options={allEmployees}
                                value={reworkEmployeeId}
                                onChange={(e) => setReworkEmployeeId(e.target.value)}
                                placeholder="Keep original employee or re-assign..."
                            />
                        </div>
                    )}
                </div>
                <div className="p-4 flex justify-end gap-2 bg-gray-900/50 rounded-b-xl">
                    <Button onClick={onClose} variant="secondary">Cancel</Button>
                    <Button onClick={handleSubmit} variant="danger">Confirm Rejection</Button>
                </div>
            </div>
        </div>
    );
};


const QcPage = () => {
  const [allJobs, setAllJobs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [rejectionReasons, setRejectionReasons] = useState([]);
  const [jobToReject, setJobToReject] = useState(null);
  const [jobToApprove, setJobToApprove] = useState(null); // --- NEW STATE for approval confirmation ---

  useEffect(() => {
    const fetchReasons = async () => {
        const reasons = await getReworkReasons();
        setRejectionReasons(reasons);
    };
    fetchReasons();

    const unsubscribe = listenToJobCards((fetchedJobs) => {
       setAllJobs(fetchedJobs);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const qcJobs = useMemo(() => {
    return allJobs.filter(job => job.status === 'Awaiting QC');
  }, [allJobs]);

  const handleApprove = async () => {
    if (!jobToApprove) return;
    
    const promise = processQcDecision(jobToApprove, true);
    toast.promise(promise, {
        loading: `Approving job ${jobToApprove.jobId}...`,
        success: 'Job approved and stock updated!',
        error: 'Failed to process approval.'
    });
    setJobToApprove(null); // Close modal after initiating
  };

  const handleReject = async (job, options) => {
    const promise = processQcDecision(job, false, options);
    
    toast.promise(promise, {
        loading: 'Processing rejection...',
        success: 'Job rejection processed successfully.',
        error: 'Failed to process rejection.'
    });

    try {
        await promise;
        setJobToReject(null); // Close the modal on success
    } catch (err) {
        console.error(err);
    }
  };

  if (loading) return <p className="text-center text-gray-400">Loading QC queue...</p>;
  
  return (
    <>
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Quality Control Queue</h2>
            <div className="bg-gray-800 p-2 sm:p-6 rounded-xl border border-gray-700 shadow-lg">
                <div className="overflow-x-auto">
                    <table className="w-full text-left">
                       <thead>
                            <tr className="border-b border-gray-600">
                                 <th className="p-3 text-sm font-semibold text-gray-400">Job ID</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Part</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Employee</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {(qcJobs || []).map(job => (
                                 <tr key={job.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td className="p-3 text-gray-400 text-xs font-mono">{job.jobId}</td>
                                    <td className="p-3 text-gray-300">{job.partName}</td>
                                     <td className="p-3 text-gray-300">{job.employeeName}</td>
                                    <td className="p-3 flex space-x-2">
                                        <Button onClick={() => setJobToApprove(job)} variant="primary" className="bg-green-600 hover:bg-green-700 py-1 px-3 text-sm">Approve</Button>
                                         <Button onClick={() => setJobToReject(job)} variant="danger" className="py-1 px-3 text-sm">Reject</Button>
                                    </td>
                                </tr>
                            ))}
                         </tbody>
                    </table>
                    {qcJobs.length === 0 && !loading && <p className="text-center p-8 text-gray-400">The QC queue is empty.</p>}
                </div>
            </div>
        </div>
        
        {jobToReject && (
             <RejectionModal 
                job={jobToReject}
                reasons={rejectionReasons}
                onClose={() => setJobToReject(null)}
                onReject={handleReject}
            />
        )}

        {/* --- NEW: Confirmation Modal for Approval --- */}
        <ConfirmationModal
            isOpen={!!jobToApprove}
            onClose={() => setJobToApprove(null)}
            onConfirm={handleApprove}
            title="Confirm Job Approval"
            message={`Are you sure you want to approve this job? This will mark it as complete and deduct used items from stock.`}
            confirmText="Yes, Approve"
            confirmVariant="primary"
        />
    </>
  );
};

export default QcPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\QuotingPage.jsx
==================================================
// src/pages/QuotingPage.jsx (Corrected and Final Version)

import React, { useState, useEffect } from 'react';
import Button from '../components/ui/Button';
import { PlusCircle, CheckCircle } from 'lucide-react';
import { collection, onSnapshot, query, orderBy } from 'firebase/firestore';
import { db } from '../api/firebase';
import { 
    getProducts, 
    getJobStepDetails, 
    getAllInventoryItems, 
    getEmployees, 
    getOverheadCategories, 
    getOverheadExpenses,
    createSalesOrderFromQuote
} from '../api/firestore';
import QuoteCreator from '../components/features/quotes/QuoteCreator';
import toast from 'react-hot-toast';

const QuotingPage = () => {
    const [quotes, setQuotes] = useState([]);
    const [isCreatorOpen, setIsCreatorOpen] = useState(false);
    const [loading, setLoading] = useState(true);

    const [calculationData, setCalculationData] = useState({
        products: [],
        allRecipes: [],
        inventoryItems: [],
        averageBurdenedRate: 0,
    });

    useEffect(() => {
        const q = query(collection(db, 'quotes'), orderBy('createdAt', 'desc'));
        const unsubscribeQuotes = onSnapshot(q, (snapshot) => {
            setQuotes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        const fetchCalculationData = async () => {
            setLoading(true);
            try {
                const [prods, recipes, inventory, employees, overheadCats] = await Promise.all([
                    getProducts(),
                    getJobStepDetails(),
                    getAllInventoryItems(),
                    getEmployees(),
                    getOverheadCategories()
                ]);

                const expensePromises = overheadCats.map(cat => getOverheadExpenses(cat.id));
                const expenseResults = await Promise.all(expensePromises);
                const totalMonthlyOverheads = expenseResults.flat().reduce((sum, exp) => sum + (exp.amount || 0), 0);
                const totalCompanyProductiveHours = (employees.length || 1) * 173.2;
                const overheadCostPerHour = totalCompanyProductiveHours > 0 ? totalMonthlyOverheads / totalCompanyProductiveHours : 0;
                const totalHourlyRate = employees.reduce((sum, emp) => sum + (emp.hourlyRate || 0), 0);
                const avgDirectRate = employees.length > 0 ? totalHourlyRate / employees.length : 0;
                
                setCalculationData({
                    products: prods,
                    allRecipes: recipes,
                    inventoryItems: inventory,
                    averageBurdenedRate: avgDirectRate + overheadCostPerHour,
                });

            } catch (err) {
                console.error("Failed to load data for quoting engine:", err);
                toast.error("Failed to load data for quoting engine.");
            } finally {
                setLoading(false);
            }
        };

        fetchCalculationData();

        return () => unsubscribeQuotes();
    }, []);
    
    const handleAcceptQuote = (quote) => {
        toast((t) => (
            <span>
                Accept this quote and create a Sales Order?
                <Button variant="primary" size="sm" className="ml-2" onClick={() => {
                    createSalesOrderFromQuote(quote)
                        .then(() => {
                            toast.success(`Quote ${quote.quoteId} accepted!`);
                        })
                        .catch(err => {
                            toast.error("Failed to accept the quote.");
                            console.error("Error accepting quote: ", err);
                        });
                    toast.dismiss(t.id);
                }}>
                    Accept
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âœ”ï¸' });
    };
    
    const getStatusComponent = (quote) => {
        const baseClasses = "px-3 py-1 text-xs font-semibold rounded-full inline-block";
        switch (quote.status) {
            case 'draft':
                return (
                    <Button onClick={() => handleAcceptQuote(quote)} variant="primary" className="py-1 px-2 text-xs">
                        <CheckCircle size={14} className="mr-1" />
                        Accept Quote
                    </Button>
                );
            case 'Accepted':
                 return <span className={`${baseClasses} bg-green-500/20 text-green-300`}>Accepted</span>;
            case 'sent':
                return <span className={`${baseClasses} bg-blue-500/20 text-blue-300`}>Sent</span>;
            default:
                return <span className={`${baseClasses} bg-gray-500/20 text-gray-300`}>{quote.status}</span>;
        }
    };

    return (
        <>
            <div className="space-y-8">
                <div className="flex justify-between items-center">
                    <h2 className="text-3xl font-bold text-white">Sales Quotes</h2>
                    <Button onClick={() => setIsCreatorOpen(true)} variant="primary" disabled={loading}>
                        {loading ? 'Loading Engine...' : <><PlusCircle size={18} className="mr-2" />Create New Quote</>}
                    </Button>
                </div>

                <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                    <table className="w-full text-left">
                        <thead className="bg-gray-900/50">
                            <tr>
                                <th className="p-3 text-sm font-semibold text-gray-400">Date</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Quote ID</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Customer</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right">Total</th>
                                <th className="p-3 text-sm font-semibold text-gray-400 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {loading && <tr><td colSpan="5" className="text-center p-8 text-gray-400">Loading quotes...</td></tr>}
                            {!loading && quotes.length === 0 && <tr><td colSpan="5" className="text-center p-8 text-gray-400">No quotes found. Click 'Create New Quote' to start.</td></tr>}
                            {!loading && quotes.map(quote => (
                                <tr key={quote.id} className="border-t border-gray-700 hover:bg-gray-700/50">
                                    <td className="p-3 text-sm text-gray-400">{quote.createdAt?.toDate().toLocaleDateString()}</td>
                                    <td className="p-3 text-sm font-mono text-gray-300">{quote.quoteId}</td>
                                    <td className="p-3 text-sm text-white font-medium">{quote.customerName}</td>
                                    <td className="p-3 text-sm font-mono text-right font-semibold text-green-400">R {quote.total.toFixed(2)}</td>
                                    <td className="p-3 text-center">
                                        {getStatusComponent(quote)}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {isCreatorOpen && (
                <QuoteCreator 
                    onClose={() => setIsCreatorOpen(false)} 
                    calculationData={calculationData}
                />
            )}
        </>
    );
};

export default QuotingPage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\ReworkLoopPage.jsx
==================================================
// src/pages/ReworkLoopPage.jsx

import React, { useEffect, useState } from 'react';
import {
  listenToJobCards,
  getEmployees,
  updateJobStatus
} from '../api/firestore';
import Dropdown from '../components/ui/Dropdown';
import Button from '../components/ui/Button';
import toast from 'react-hot-toast';

const ReworkLoopPage = () => {
  const [jobsWithIssues, setJobsWithIssues] = useState([]);
  const [employees, setEmployees] = useState([]);
  const [reassignments, setReassignments] = useState({});

  useEffect(() => {
    const unsub = listenToJobCards(jobs => {
      const issueJobs = jobs.filter(j =>
        ['Issue', 'Halted - Issue'].includes(j.status)
      );
      setJobsWithIssues(issueJobs);
    });

    getEmployees().then(setEmployees);
    return () => unsub();
  }, []);

  const handleReassign = (jobId, employeeId) => {
    setReassignments(prev => ({ ...prev, [jobId]: employeeId }));
  };

  const processRework = async (job) => {
    const newEmployeeId = reassignments[job.id];
    const selectedEmployee = employees.find(e => e.id === newEmployeeId);
    const newName = selectedEmployee?.name || job.employeeName;

    try {
      await updateJobStatus(job.id, 'Pending', {
        haltReason: `REWORK: ${job.issueReason || 'Manual reassign'}`
      });

      await updateJobStatus(job.id, 'Pending', {
        haltReason: 'Rework restart',
        ...{
          employeeId: newEmployeeId,
          employeeName: newName
        }
      });

      toast.success(`Reassigned ${job.jobId} to ${newName}`);
    } catch (err) {
      console.error(err);
      toast.error("Failed to reassign job.");
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold text-white mb-4">Rework Queue</h1>
      {jobsWithIssues.length === 0 ? (
        <p className="text-gray-400 text-sm">No jobs awaiting rework.</p>
      ) : (
        <div className="space-y-4">
          {jobsWithIssues.map(job => (
            <div key={job.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700">
              <h3 className="text-lg font-semibold text-white">{job.partName} ({job.jobId})</h3>
              <p className="text-gray-400 text-sm mb-2">
                Dept: {job.departmentName} | Current: {job.employeeName} | Status: {job.status}
              </p>
              <p className="text-yellow-400 text-sm mb-2">
                Issue: {job.issueReason || 'No reason recorded'}
              </p>
              <Dropdown
                label="Reassign to:"
                options={employees.map(e => ({ label: e.name, value: e.id }))}
                value={reassignments[job.id] || job.employeeId}
                onChange={(val) => handleReassign(job.id, val)}
              />
              <Button className="mt-2" onClick={() => processRework(job)}>
                Reassign & Relaunch Job
              </Button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default ReworkLoopPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\ReworkQueuePage.jsx
==================================================
import React, { useEffect, useState } from 'react';
import { listenToReworkQueue, resolveReworkJob } from '../api/firestore';
import Button from '../components/ui/Button';
import toast from 'react-hot-toast';

const ReworkQueuePage = () => {
  const [reworks, setReworks] = useState([]);

  useEffect(() => {
    const unsub = listenToReworkQueue(setReworks);
    return () => unsub();
  }, []);

  const handleResolve = async (jobId) => {
    try {
      await resolveReworkJob(jobId);
      toast.success('Rework marked as resolved');
    } catch (err) {
      console.error(err);
      toast.error('Failed to resolve rework');
    }
  };

  return (
    <div className="p-6 text-white">
      <h1 className="text-2xl font-bold mb-4">Rework Queue</h1>

      {reworks.length === 0 && (
        <p className="text-gray-400">No rework jobs currently pending.</p>
      )}

      <div className="space-y-4">
        {reworks.map(job => (
          <div
            key={job.id}
            className="bg-gray-800 border border-yellow-500/30 rounded p-4"
          >
            <p className="text-lg font-semibold text-yellow-400">
              {job.partName} â€“ Job #{job.jobId}
            </p>
            <p className="text-sm text-gray-300">
              Reason: {job.reworkReason || 'N/A'}
            </p>
            <p className="text-sm text-gray-400">
              Department: {job.departmentName} | Qty: {job.quantity}
            </p>
            <Button
              className="mt-2 bg-green-600"
              onClick={() => handleResolve(job.jobId)}
            >
              Mark as Resolved
            </Button>
          </div>
        ))}
      </div>
    </div>
  );
};

export default ReworkQueuePage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\SalesOrderPage.jsx
==================================================
// src/pages/SalesOrderPage.jsx (Upgraded with Toasts)

import React, { useState, useEffect, useMemo } from 'react';
import { listenToSalesOrders, addPurchasedItemToQueue, updateSalesOrderLineItemStatus } from '../api/firestore';
import Button from '../components/ui/Button';
import { ChevronDown, ChevronRight, Package, Wrench, ShoppingBag, X, CheckCircle } from 'lucide-react';
import CustomJobCreator from '../components/features/job_cards/CustomJobCreator';
import StandardJobCreatorModal from '../components/features/job_cards/StandardJobCreatorModal';
import toast from 'react-hot-toast'; // --- IMPORT TOAST ---

const OrderLineItem = ({ item, order, onAction }) => {
    const [isCustomModalOpen, setCustomModalOpen] = useState(false);
    const [isStandardModalOpen, setStandardModalOpen] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleSendToPurchasing = async () => {
        // --- REPLACE window.confirm ---
        toast((t) => (
            <span>
                Send "{item.description}" to the purchasing queue?
                <Button variant="primary" size="sm" className="ml-2" onClick={() => {
                    setIsSubmitting(true);
                    addPurchasedItemToQueue(item, order)
                        .then(() => updateSalesOrderLineItemStatus(order.id, item.id, 'In Purchasing'))
                        .then(() => {
                            toast.success("Item sent to purchasing.");
                            onAction();
                        })
                        .catch(err => {
                            toast.error("Failed to send item to purchasing.");
                            console.error("Error sending item to purchasing:", err);
                        })
                        .finally(() => setIsSubmitting(false));
                    toast.dismiss(t.id);
                }}>
                    Confirm
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ));
    };

    let icon, actionButton;

    if (item.status === 'In Purchasing') {
        icon = <ShoppingBag size={20} className="text-gray-500" />;
        actionButton = <span className="flex items-center gap-1 text-xs text-green-400 font-semibold"><CheckCircle size={14} /> Queued for Purchase</span>;
    } else if (item.isCatalogItem) {
        icon = <Package size={20} className="text-blue-400" />;
        actionButton = <Button variant="primary" className="text-xs py-1 px-2" onClick={() => setStandardModalOpen(true)}>Create Standard Job</Button>;
    } else if (item.isPurchasedItem) {
        icon = <ShoppingBag size={20} className="text-green-400" />;
        actionButton = <Button variant="secondary" className="text-xs py-1 px-2" onClick={handleSendToPurchasing} disabled={isSubmitting}>{isSubmitting ? 'Sending...' : 'Send to Purchasing'}</Button>;
    } else { 
        icon = <Wrench size={20} className="text-purple-400" />;
        actionButton = <Button variant="primary" className="text-xs py-1 px-2" onClick={() => setCustomModalOpen(true)}>Create Custom Job</Button>;
    }

    return (
        <>
            <div className="flex justify-between items-center p-3 bg-gray-900/50 rounded-md">
                <div className="flex items-center gap-3">
                    {icon}
                    <p className="text-white">{item.description}</p>
                </div>
                <div className="flex items-center gap-4">
                    <p className="text-sm font-mono text-gray-400">Cost: R{item.cost.toFixed(2)}</p>
                    {actionButton}
                </div>
            </div>

            {isCustomModalOpen && (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div className="relative bg-gray-800 p-2 rounded-xl border border-gray-700 w-full max-w-4xl max-h-[90vh] flex flex-col">
                         <Button onClick={() => setCustomModalOpen(false)} variant="danger" className="absolute -top-3 -right-3 z-10 rounded-full h-8 w-8 p-1">
                            <X size={16}/>
                        </Button>
                        <div className="overflow-y-auto">
                            <CustomJobCreator salesOrder={order} customLineItem={item} />
                        </div>
                    </div>
                </div>
            )}

            {isStandardModalOpen && (
                <StandardJobCreatorModal 
                    salesOrder={order}
                    lineItem={item}
                    onClose={() => setStandardModalOpen(false)}
                />
            )}
        </>
    );
};

const SalesOrderCard = ({ order, onAction }) => {
    const [isExpanded, setIsExpanded] = useState(false);

    const getStatusColor = (status) => {
        switch (status) {
            case 'Pending Production': return 'bg-yellow-500/20 text-yellow-300';
            case 'In Production': return 'bg-blue-500/20 text-blue-300';
            case 'Fulfilled': return 'bg-green-500/20 text-green-300';
            default: return 'bg-gray-500/20 text-gray-300';
        }
    };

    return (
        <div className="bg-gray-800 rounded-lg border border-gray-700">
            <div className="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-700/50" onClick={() => setIsExpanded(!isExpanded)}>
                <div className="flex items-center gap-4">
                    {isExpanded ? <ChevronDown /> : <ChevronRight />}
                    <div>
                        <p className="font-bold text-white text-lg">{order.salesOrderId}</p>
                        <p className="text-sm text-gray-400">{order.customerName}</p>
                    </div>
                </div>
                <div className="flex items-center gap-6">
                     <p className="font-mono text-xl text-green-400">R {order.total.toFixed(2)}</p>
                     <span className={`px-3 py-1 text-sm rounded-full font-semibold ${getStatusColor(order.status)}`}>
                        {order.status}
                    </span>
                </div>
            </div>

            {isExpanded && (
                <div className="p-4 border-t border-gray-700 space-y-3">
                    <h4 className="font-semibold text-gray-200">Order Line Items:</h4>
                    {order.lineItems.map((item, index) => (
                        <OrderLineItem 
                            key={item.id || index}
                            item={item} 
                            order={order} 
                            onAction={onAction}
                        />
                    ))}
                </div>
            )}
        </div>
    );
};


const SalesOrderPage = () => {
    const [salesOrders, setSalesOrders] = useState([]);
    const [loading, setLoading] = useState(true);

    const fetchData = () => {
        const unsubscribe = listenToSalesOrders((orders) => {
            setSalesOrders(orders);
            if(loading) setLoading(false);
        });
        return unsubscribe;
    };

    useEffect(() => {
        const unsubscribe = fetchData();
        return () => unsubscribe();
    }, []);

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Sales Order Dispatch</h2>
            <p className="text-gray-400 -mt-6">This is your hub for converting approved customer orders into actionable tasks for your team.</p>
            
            <div className="space-y-4">
                {loading && <p className="text-center p-8 text-gray-400">Loading sales orders...</p>}
                {!loading && salesOrders.length === 0 && <p className="text-center p-8 text-gray-400">No sales orders found. Accept a quote to create one.</p>}
                {!loading && salesOrders.map(order => (
                    <SalesOrderCard 
                        key={order.id} 
                        order={order}
                        onAction={fetchData}
                    />
                ))}
            </div>
        </div>
    );
};

export default SalesOrderPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\ScannerPage.jsx
==================================================
// src/pages/ScannerPage.jsx (Reworked as a Hub)

import React, { useState } from 'react';
import JobCardScanner from '../components/features/scanner/JobCardScanner';
import StockTakeApp from '../components/features/stock/StockTakeApp'; // We will create this next
import { ScanLine, ClipboardCheck } from 'lucide-react';

const TabButton = ({ id, label, icon, activeTab, setActiveTab }) => {
    const isActive = activeTab === id;
    return (
      <button
        onClick={() => setActiveTab(id)}
        className={`flex-1 px-5 py-3 text-lg font-semibold flex items-center justify-center gap-3 transition-colors ${
          isActive 
            ? 'bg-gray-800 text-white border-b-2 border-blue-500' 
            : 'bg-gray-900 text-gray-400 hover:bg-gray-800'
        }`}
      >
        {icon}
        {label}
      </button>
    );
};

const ScannerPage = () => {
    // Ensure 'job_scanner' is the default active tab
    const [activeTab, setActiveTab] = useState('job_scanner');

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Workshop Scanners</h2>
            
            <div className="flex rounded-t-lg overflow-hidden border-b border-gray-700">
                <TabButton 
                    id="job_scanner"
                    label="Job Card Scanner"
                    icon={<ScanLine size={22} />}
                    activeTab={activeTab}
                    setActiveTab={setActiveTab}
                />
                <TabButton 
                    id="stock_scanner"
                    label="Stock Take Scanner"
                    icon={<ClipboardCheck size={22} />}
                    activeTab={activeTab}
                    setActiveTab={setActiveTab}
                />
            </div>

            <div>
                {/* Render JobCardScanner directly if it's the active tab */}
                {activeTab === 'job_scanner' && <JobCardScanner />}
                {/* Render StockTakeApp if it's the active tab */}
                {activeTab === 'stock_scanner' && <StockTakeApp />}
            </div>
        </div>
    );
};

export default ScannerPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\SettingsPage.jsx
==================================================
// src/pages/SettingsPage.jsx (UPDATED)
// A new "Kaizen" tab has been added to the settings page,
// which renders the new KaizenManager component for a complete workflow.

import React, { useState, useMemo } from 'react';
import InventoryManager from '../components/features/settings/InventoryManager';
import DepartmentsManager from '../components/features/settings/DepartmentsManager';
import ToolsManager from '../components/features/settings/ToolsManager';
import EmployeesManager from '../components/features/settings/EmployeesManager';
import ToolAccessoriesManager from '../components/features/settings/ToolAccessoriesManager';
import OverheadsManager from '../components/features/settings/OverheadsManager';
import SkillsManager from '../components/features/settings/SkillsManager';
import UserManagementPage from './UserManagementPage';
import CampaignManager from '../components/features/settings/CampaignManager';
import FinancialSettings from '../components/features/settings/FinancialSettings';
import TrainingManager from '../components/features/settings/TrainingManager';
import ReworkReasonsManager from '../components/features/settings/ReworkReasonsManager';
import RoleManager from '../components/features/settings/RoleManager';
import RoutineTasksManager from '../components/features/settings/RoutineTasksManager';
import LearningPathManager from '../components/features/settings/LearningPathManager';
import KaizenManager from '../components/features/settings/KaizenManager'; // <-- NEW IMPORT

const TabButton = ({ label, isActive, onClick }) => {
  const baseClasses = "px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors";
  const activeClasses = "bg-blue-600 text-white";
  const inactiveClasses = "bg-gray-800 text-gray-300 hover:bg-gray-700";
  return (
    <button onClick={onClick} className={`${baseClasses} ${isActive ? activeClasses : inactiveClasses}`}>
      {label}
    </button>
  );
};

const SettingsPage = () => {
  const [activeTab, setActiveTab] = useState('inventory');

  const tabs = useMemo(() => ({
    inventory: {
      label: 'Inventory & Products',
      components: [<InventoryManager key="inventory" />]
    },
    assets: {
      label: 'Tools & Assets',
      components: [<ToolsManager key="tools" />, <ToolAccessoriesManager key="tool-accessories" />]
    },
    company: {
       label: 'Company & Staff',
      components: [
          <DepartmentsManager key="departments" />,
          <EmployeesManager key="employees" />,
          <SkillsManager key="skills" />,
          <ReworkReasonsManager key="rework-reasons" />,
          <RoutineTasksManager key="routine-tasks" />
      ]
    },
    training: {
        label: 'Training',
        components: [<LearningPathManager key="learning-paths" />, <TrainingManager key="training" />]
    },
    // --- NEW KAIZEN TAB ---
    kaizen: {
        label: 'Kaizen (Improvement)',
        components: [<KaizenManager key="kaizen" />]
    },
    financials: {
      label: 'Financials',
      components: [<OverheadsManager key="overheads" />, <FinancialSettings key="financial-settings" />]
    },
    marketing: {
      label: 'Marketing',
      components: [<CampaignManager key="campaigns" />]
    },
    users: {
       label: 'User Logins',
      components: [<UserManagementPage key="user-management" />]
    },
    roles: {
        label: 'Roles & Permissions',
        components: [<RoleManager key="role-manager" />]
    }
  }), []);

  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-bold text-white">Settings & Data Management</h2>

      <div className="flex flex-wrap items-center gap-2 p-2 bg-gray-900/50 rounded-lg">
        {Object.entries(tabs).map(([tabKey, tabData]) => (
          <TabButton
            key={tabKey}
            label={tabData.label}
            isActive={activeTab === tabKey}
            onClick={() => setActiveTab(tabKey)}
          />
        ))}
      </div>

      <div className="space-y-8">
        {tabs[activeTab].components}
      </div>
    </div>
  );
};

export default SettingsPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\StockAdjustmentPage.jsx
==================================================
import React, { useEffect, useState } from 'react';
import { getAllInventoryItems, updateStockCount } from '../api/firestore';
import Button from '../components/ui/Button';
import Input from '../components/ui/Input';
import toast from 'react-hot-toast';

const StockAdjustmentPage = () => {
  const [items, setItems] = useState([]);
  const [sessionId] = useState(`ADJ-${Date.now()}`);

  useEffect(() => {
    getAllInventoryItems().then(setItems);
  }, []);

  const handleChange = (id, value) => {
    setItems(prev =>
      prev.map(i => i.id === id ? { ...i, newCount: value } : i)
    );
  };

  const commitChanges = async () => {
    const changes = items.filter(i => i.newCount !== undefined && i.newCount !== '');
    for (const item of changes) {
      try {
        await updateStockCount(item.id, item.category, parseFloat(item.newCount), sessionId);
        toast.success(`Updated ${item.name}`);
      } catch (err) {
        console.error(err);
        toast.error(`Failed to update ${item.name}`);
      }
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold text-white mb-4">Stock Adjustment</h1>
      <div className="space-y-3">
        {items.map(item => (
          <div key={item.id} className="bg-gray-800 p-3 rounded border border-gray-700">
            <p className="text-white font-semibold">{item.name}</p>
            <p className="text-sm text-gray-400">Current: {item.currentStock} | Unit: {item.unit}</p>
            <Input
              label="New Count"
              type="number"
              value={item.newCount || ''}
              onChange={(e) => handleChange(item.id, e.target.value)}
            />
          </div>
        ))}
      </div>
      <Button onClick={commitChanges} className="mt-4">Commit Stock Changes</Button>
    </div>
  );
};

export default StockAdjustmentPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\StockControlPage.jsx
==================================================
// src/pages/StockControlPage.jsx (UPDATED)

import React, { useState, useEffect, useMemo } from 'react';
import StockControlDashboard from '../components/features/stock/StockControlDashboard';
import PurchaseQueue from '../components/features/stock/PurchaseQueue';
import InTransitOrders from '../components/features/stock/InTransitOrders';
import { getPurchaseQueue, getSuppliers } from '../api/firestore';
import Button from '../components/ui/Button'; // <-- Import Button
import FutureDemandAnalyzer from '../components/features/stock/FutureDemandAnalyzer'; // <-- Import the new component
import { BrainCircuit } from 'lucide-react'; // <-- Import an icon

const StockControlPage = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [purchaseQueueItems, setPurchaseQueueItems] = useState([]);
  const [suppliers, setSuppliers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isAnalyzerOpen, setAnalyzerOpen] = useState(false); // <-- State to control the modal

  const fetchData = () => {
    setLoading(true);
    Promise.all([getPurchaseQueue(), getSuppliers()]).then(([queue, supplierList]) => {
      setPurchaseQueueItems(queue);
      setSuppliers(supplierList);
      setLoading(false);
    });
  };

  useEffect(() => {
    fetchData();
  }, []);

  const TabButton = ({ id, label, count }) => {
    const isActive = activeTab === id;
    return (
      <button
        onClick={() => setActiveTab(id)}
        className={`px-5 py-2 text-sm font-semibold rounded-t-lg border-b-2 flex items-center gap-2 transition-colors ${
          isActive ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:border-gray-500 hover:text-gray-200'
        }`}
      >
        {label}
        {count > 0 && <span className={`text-xs rounded-full px-2 py-0.5 ${isActive ? 'bg-white text-blue-600' : 'bg-gray-600 text-gray-200'}`}>{count}</span>}
      </button>
    );
  };

  const { pendingItems, orderedItems } = useMemo(() => {
    return {
        pendingItems: (purchaseQueueItems || []).filter(i => i.status === 'pending'),
        orderedItems: (purchaseQueueItems || []).filter(i => i.status === 'ordered')
    }
  }, [purchaseQueueItems]);

  return (
    <>
      <div className="space-y-4">
        <div className="flex justify-between items-center">
            <h2 className="text-3xl font-bold text-white">Stock Control & Purchasing</h2>
            {/* --- NEW BUTTON TO OPEN THE ANALYZER --- */}
            <Button onClick={() => setAnalyzerOpen(true)} variant="primary">
                <BrainCircuit size={18} className="mr-2"/>
                Predictive Analyzer
            </Button>
        </div>

        <div className="border-b border-gray-700">
            <nav className="-mb-px flex space-x-6">
                <TabButton id="dashboard" label="Stock Overview" />
                <TabButton id="queue" label="Purchase Queue" count={pendingItems.length} />
                <TabButton id="transit" label="In-Transit Orders" count={orderedItems.length} />
            </nav>
        </div>
        <div className="mt-6">
            {loading ? <p className="text-center text-gray-400 p-8">Loading...</p> : (
                <>
                    {activeTab === 'dashboard' && <StockControlDashboard />}
                    {activeTab === 'queue' && <PurchaseQueue onOrderPlaced={fetchData} />}
                    {activeTab === 'transit' && <InTransitOrders items={orderedItems} suppliers={suppliers} onStockReceived={fetchData} />}
                </>
            )}
        </div>
      </div>

      {/* --- RENDER THE MODAL WHEN isAnalyzerOpen is true --- */}
      {isAnalyzerOpen && <FutureDemandAnalyzer onClose={() => setAnalyzerOpen(false)} />}
    </>
  );
};

export default StockControlPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\StockTakePage.jsx
==================================================
// src/pages/StockTakePage.jsx (Upgraded with Tabs for Inventory Type)

import React, { useState } from 'react';
import { reconcileStockLevels } from '../api/firestore';
import Button from '../components/ui/Button';
import Input from '../components/ui/Input';
import { ClipboardList, Save, Search, RefreshCw, Package, Factory, Truck } from 'lucide-react'; // Import Truck icon
import { useStockTakeData } from '../hooks/useStockTakeData';
import { Summary, StockCountList } from '../components/features/stock/StockTakeComponents';
import ConsignmentStockTake from '../components/features/stock/ConsignmentStockTake'; // <-- IMPORT NEW COMPONENT
import toast from 'react-hot-toast';

// Reusing the TabButton pattern from ScannerPage
const TabButton = ({ id, label, icon, activeTab, setActiveTab }) => {
    const isActive = activeTab === id;
    return (
      <button
        onClick={() => setActiveTab(id)}
        className={`flex-1 px-5 py-3 text-lg font-semibold flex items-center justify-center gap-3 transition-colors ${
          isActive 
            ? 'bg-gray-800 text-white border-b-2 border-blue-500' 
            : 'bg-gray-900 text-gray-400 hover:bg-gray-800'
        }`}
      >
        {icon}
        {label}
      </button>
    );
};

// This component will now be the main content for each tab
const StockTakeContent = ({ inventoryTypeFilter }) => {
    const {
        loading,
        error,
        filteredItems,
        summary,
        filter,
        setFilter,
        searchTerm,
        setSearchTerm,
        handleCountChange,
        getItemsToReconcile,
        fetchData,
        resetCounts,
    } = useStockTakeData(inventoryTypeFilter); // Pass the filter to the hook

    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleReconcile = () => {
        const itemsToUpdate = getItemsToReconcile();
        if (itemsToUpdate.length === 0) {
            return toast.error("You haven't counted any items yet.");
        }

        const varianceCount = itemsToUpdate.filter(item => item.newCount - item.systemCount !== 0).length;
        
        toast((t) => (
            <span>
                Finalize stock-take for {itemsToUpdate.length} items? ({varianceCount} with discrepancies)
                <Button variant="primary" size="sm" className="ml-2" onClick={() => {
                    setIsSubmitting(true);
                    reconcileStockLevels(itemsToUpdate)
                        .then(() => {
                            toast.success("Stock levels reconciled successfully!");
                            resetCounts();
                            fetchData(); // Re-fetch data for the current filter
                        })
                        .catch(err => {
                            toast.error("Failed to reconcile stock levels.");
                            console.error("Error reconciling stock levels:", err);
                        })
                        .finally(() => setIsSubmitting(false));
                    toast.dismiss(t.id);
                }}>
                    Confirm
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), {
            icon: 'âš ï¸',
            duration: 6000
        });
    };
    
    const handleStartNewStockTake = () => {
        toast((t) => (
            <span>
                Start a new stock-take? This will clear all counts for the current view.
                <Button variant="danger" size="sm" className="ml-2" onClick={() => {
                    resetCounts();
                    toast.dismiss(t.id);
                    toast.success("Counts cleared. Ready for new stock-take.");
                }}>
                    Confirm
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    }

    if (error) {
        return <p className="text-center text-red-500 p-8">{error}</p>;
    }

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h3 className="text-2xl font-bold text-white flex items-center gap-2">
                    <ClipboardList/> Stock-Take ({inventoryTypeFilter === 'products' ? 'Manufactured Products' : 'Purchased Items'})
                </h3>
                <div className="flex gap-2">
                     <Button onClick={handleStartNewStockTake} disabled={isSubmitting || loading} variant="secondary">
                        <RefreshCw size={16} className="mr-2" />
                        Start New
                    </Button>
                    <Button onClick={handleReconcile} disabled={isSubmitting || loading || summary.counted === 0} variant="primary">
                        <Save size={16} className="mr-2" />
                        {isSubmitting ? 'Finalizing...' : `Finalize & Reconcile (${summary.counted})`}
                    </Button>
                </div>
            </div>

            <Summary data={summary} />

            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700 flex justify-between items-center">
                <div className="flex items-center gap-2 flex-wrap">
                    <span className="text-sm font-medium text-gray-300">Filter:</span>
                    <Button size="sm" variant={filter === 'all' ? 'primary' : 'secondary'} onClick={() => setFilter('all')}>All</Button>
                    <Button size="sm" variant={filter === 'uncounted' ? 'primary' : 'secondary'} onClick={() => setFilter('uncounted')}>Uncounted</Button>
                    <Button size="sm" variant={filter === 'counted' ? 'primary' : 'secondary'} onClick={() => setFilter('counted')}>Counted</Button>
                    <Button size="sm" variant={filter === 'discrepancies' ? 'primary' : 'secondary'} onClick={() => setFilter('discrepancies')}>Discrepancies</Button>
                </div>
                <div className="relative w-full sm:w-1/3">
                    <Input
                        type="text"
                        placeholder="Search items by name or code..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="pl-10"
                    />
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                </div>
            </div>

            {loading ? (
                <p className="text-center text-gray-400 p-8">Loading inventory...</p>
            ) : (
                <StockCountList items={filteredItems} onCountChange={handleCountChange} />
            )}
        </div>
    );
};


const StockTakePage = () => {
    const [activeTab, setActiveTab] = useState('purchased'); // Default to purchased items

    return (
        <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white">Stock-Take Management</h2>
            
            <div className="flex rounded-t-lg overflow-hidden border-b border-gray-700">
                <TabButton 
                    id="purchased"
                    label="Purchased Items"
                    icon={<Package size={22} />}
                    activeTab={activeTab}
                    setActiveTab={setActiveTab}
                />
                <TabButton 
                    id="products"
                    label="Manufactured Products"
                    icon={<Factory size={22} />}
                    activeTab={activeTab}
                    setActiveTab={setActiveTab}
                />
                <TabButton 
                    id="consignment"
                    label="Consignment Stock"
                    icon={<Truck size={22} />}
                    activeTab={activeTab}
                    setActiveTab={setActiveTab}
                />
            </div>

            <div className="mt-4">
                {activeTab === 'purchased' && <StockTakeContent inventoryTypeFilter="purchased" />}
                {activeTab === 'products' && <StockTakeContent inventoryTypeFilter="products" />}
                {activeTab === 'consignment' && <ConsignmentStockTake />}
            </div>
        </div>
    );
};

export default StockTakePage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\TimeAttendanceReport.jsx
==================================================
// src/pages/TimeAttendanceReport.jsx (CORRECTED & ENHANCED)
// 1. Fixed a bug where date filtering was not being applied correctly.
// 2. Added a live calculation for the current day's "Total Hours" so you don't have to wait for the nightly process.

import React, { useState, useEffect, useMemo } from 'react';
import { db } from '../api/firebase'; 
import { collection, query, getDocs, orderBy } from 'firebase/firestore';
import Input from '../components/ui/Input';
import Button from '../components/ui/Button';
import { CSVLink } from 'react-csv';
import { Download } from 'lucide-react';
import toast from 'react-hot-toast';

const TimeAttendanceReport = () => {
    const [logs, setLogs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');

    useEffect(() => {
        const fetchWorkLogs = async () => {
            setLoading(true);
            try {
                const q = query(collection(db, 'employeeDailyLogs'), orderBy('date', 'desc'));
                const querySnapshot = await getDocs(q);
                
                // Fetch the raw data, keeping the timestamp objects for live calculation
                const logsData = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                setLogs(logsData);
            } catch (error) {
                console.error("Error fetching time attendance logs:", error);
                toast.error("Could not fetch time logs. Check permissions and collection name.");
            } finally {
                setLoading(false);
            }
        };

        fetchWorkLogs();
    }, []);

    // This logic now correctly filters the logs based on the selected dates.
    const filteredLogs = useMemo(() => {
        if (!startDate && !endDate) {
            return logs;
        }
        return logs.filter(log => {
            // Use simple string comparison for dates to avoid timezone issues.
            if (startDate && log.date < startDate) return false;
            if (endDate && log.date > endDate) return false;
            return true;
        });
    }, [logs, startDate, endDate]);


    // This new section processes the filtered logs for display, adding live calculations.
    const displayLogs = useMemo(() => {
        return filteredLogs.map(log => {
            let displayTotalHours = log.totalHours || 0;

            // If the log is for today and not yet finalized, calculate hours live.
            if (log.status === 'pending' && log.startTime && log.endTime) {
                const startTime = log.startTime.toDate();
                const endTime = log.endTime.toDate();
                const breakMinutes = 45;
                const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);
                const workMinutes = Math.max(0, durationMinutes - breakMinutes);
                displayTotalHours = workMinutes / 60;
            }

            return {
                id: log.id,
                date: log.date,
                employeeName: log.employeeName,
                startTime: log.startTime ? log.startTime.toDate().toLocaleTimeString('en-ZA') : 'N/A',
                endTime: log.endTime ? log.endTime.toDate().toLocaleTimeString('en-ZA') : 'Review Needed',
                totalHours: displayTotalHours,
            };
        });
    }, [filteredLogs]);


    const csvHeaders = [
        { label: "Date", key: "date" },
        { label: "Employee Name", key: "employeeName" },
        { label: "Clock In", key: "startTime" },
        { label: "Clock Out", key: "endTime" },
        { label: "Total Hours", key: "totalHours" }
    ];

    const csvData = displayLogs.map(log => ({
        ...log,
        totalHours: log.totalHours.toFixed(2)
    }));

    if (loading) {
        return <p className="text-center text-gray-400">Loading attendance data...</p>;
    }

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-3xl font-bold text-white">Automated Time & Attendance Report</h2>
                    <p className="text-gray-400 -mt-1">This data is captured automatically from the first and last job scans of the day.</p>
                </div>
                <CSVLink
                    data={csvData}
                    headers={csvHeaders}
                    filename={`time_attendance_${startDate}_to_${endDate}.csv`}
                    className="inline-block"
                >
                    <Button variant="secondary">
                        <Download size={16} className="mr-2" />
                        Export to CSV
                    </Button>
                </CSVLink>
            </div>
            
            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input label="Start Date" type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} />
                    <Input label="End Date" type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} />
                </div>
            </div>

            <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                <table className="w-full text-left text-sm">
                    <thead className="bg-gray-900/50">
                        <tr className="border-b border-gray-600">
                            <th className="p-3 font-semibold text-gray-400">Date</th>
                            <th className="p-3 font-semibold text-gray-400">Employee Name</th>
                            <th className="p-3 font-semibold text-gray-400">Clock In Time</th>
                            <th className="p-3 font-semibold text-gray-400">Clock Out Time</th>
                            <th className="p-3 font-semibold text-gray-400 text-right">Total Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        {displayLogs.length > 0 ? (
                            displayLogs.map(log => (
                                <tr key={log.id} className="border-b border-gray-700">
                                    <td className="p-3 text-gray-300">{log.date}</td>
                                    <td className="p-3 text-white font-medium">{log.employeeName}</td>
                                    <td className="p-3 text-gray-300">{log.startTime}</td>
                                    <td className="p-3 text-gray-300">{log.endTime}</td>
                                    <td className="p-3 text-white font-mono text-right">{log.totalHours > 0 ? log.totalHours.toFixed(2) : '--'}</td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="5" className="text-center p-8 text-gray-500">No attendance data found for the selected period.</td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

export default TimeAttendanceReport;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\TrackingPage.jsx
==================================================
import React from 'react';
import MainLayout from '../components/layout/MainLayout';
import LiveJobTracking from '../components/features/tracking/LiveTrackingTable';

const TrackingPage = () => {
  return (
    <MainLayout>
      <div className="space-y-8">
        <h2 className="text-3xl font-bold text-white">Live Job Tracking</h2>
        <LiveJobTracking />
      </div>
    </MainLayout>
  );
};

export default TrackingPage;


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\UserManagementPage.jsx
==================================================
// src/pages/UserManagementPage.jsx (UPDATED with Audit Logging)
// This component now calls the `logAuditEvent` function whenever a new user is
// created or an existing user is deleted, creating a secure record of the action.

import React, { useState, useEffect } from 'react';
import Input from '../components/ui/Input';
import Button from '../components/ui/Button';
import Dropdown from '../components/ui/Dropdown';
import { getAllUsers, updateUserRole, createUserWithRole, deleteUserWithRole, getRoles, logAuditEvent } from '../api/firestore'; // <-- IMPORT logAuditEvent
import { useAuth } from '../contexts/AuthContext'; // <-- IMPORT useAuth
import { PlusCircle, Edit, Trash2, User, Building, Shield, Percent } from 'lucide-react';
import toast from 'react-hot-toast';

const UserManagementPage = () => {
    const { user: currentUser } = useAuth(); // Get the currently logged-in user
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [allRoles, setAllRoles] = useState([]);
    const [newStaffUser, setNewStaffUser] = useState({ email: '', password: '', role: '' });
    const [newClientUser, setNewClientUser] = useState({ companyName: '', email: '', password: '', discountPercentage: '0' });
    const [addingUser, setAddingUser] = useState(false);
    const [editingUserId, setEditingUserId] = useState(null);
    const [editingUserRole, setEditingUserRole] = useState('');
    const [editingUserName, setEditingUserName] = useState('');
    const [editingUserDiscount, setEditingUserDiscount] = useState('');
    const [editingUserCompany, setEditingUserCompany] = useState('');

    const fetchUsersAndRoles = async () => {
        setLoading(true);
        setError(null);
        try {
            const [fetchedUsers, fetchedRoles] = await Promise.all([
                getAllUsers(),
                getRoles()
            ]);
            setUsers(fetchedUsers);
            setAllRoles(fetchedRoles);
        } catch (err) {
            console.error("Error fetching data:", err);
            setError("Failed to load user or role data.");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchUsersAndRoles();
    }, []);

    const handleAddClient = async (e) => {
        e.preventDefault();
        if (!newClientUser.email || !newClientUser.password || !newClientUser.companyName) {
            return toast.error("Company Name, Email, and Password are required for new clients.");
        }
        setAddingUser(true);
        setError(null);
        try {
            const result = await createUserWithRole(newClientUser.email, newClientUser.password, 'Client', newClientUser.discountPercentage, newClientUser.companyName);
            toast.success(`Client user ${result.email} created successfully!`);
            
            // --- NEW: Log the audit event ---
            await logAuditEvent('client_user_created', currentUser.uid, currentUser.email, {
                createdUserEmail: newClientUser.email,
                companyName: newClientUser.companyName,
            });

            setNewClientUser({ companyName: '', email: '', password: '', discountPercentage: '0' });
            fetchUsersAndRoles();
        } catch (err) {
            console.error("Error adding client:", err.message);
            setError(`Failed to add client: ${err.message}`);
        } finally {
            setAddingUser(false);
        }
    };
    
    const handleAddStaff = async (e) => {
        e.preventDefault();
        if (!newStaffUser.email || !newStaffUser.password || !newStaffUser.role) {
            return toast.error("Email, password, and role are required for new staff.");
        }
        setAddingUser(true);
        setError(null);
        try {
            const result = await createUserWithRole(newStaffUser.email, newStaffUser.password, newStaffUser.role);
            toast.success(`Staff user ${result.email} created successfully!`);

            // --- NEW: Log the audit event ---
            await logAuditEvent('staff_user_created', currentUser.uid, currentUser.email, {
                createdUserEmail: newStaffUser.email,
                assignedRole: newStaffUser.role,
            });

            setNewStaffUser({ email: '', password: '', role: '' });
            fetchUsersAndRoles();
        } catch (err) {
            console.error("Error adding staff user:", err.message);
            setError(`Failed to add staff user: ${err.message}`);
        } finally {
            setAddingUser(false);
        }
    };

    const handleEditUser = (user) => {
        setEditingUserId(user.id);
        setEditingUserRole(user.role);
        setEditingUserName(user.email);
        setEditingUserDiscount(user.discountPercentage || '0');
        setEditingUserCompany(user.companyName || '');
    };

    const handleUpdateUser = async (userId) => {
        setError(null);
        try {
            await updateUserRole(userId, editingUserRole, editingUserDiscount, editingUserCompany);
            toast.success(`User updated for ${editingUserName}!`);

            // --- NEW: Log the audit event ---
            await logAuditEvent('user_role_updated', currentUser.uid, currentUser.email, {
                targetUserId: userId,
                targetUserEmail: editingUserName,
                newRole: editingUserRole,
                newDiscount: editingUserDiscount,
                newCompany: editingUserCompany,
            });

            handleCancelEdit();
            fetchUsersAndRoles();
        } catch (err) {
            console.error("Error updating user:", err.message);
            setError(`Failed to update user: ${err.message}`);
        }
    };

    const handleCancelEdit = () => {
        setEditingUserId(null);
        setEditingUserRole('');
        setEditingUserName('');
        setEditingUserDiscount('');
        setEditingUserCompany('');
    };

    const handleDeleteUser = (userToDelete) => {
        toast((t) => (
            <span>
                Delete user {userToDelete.email}? This is permanent.
                <Button variant="danger" size="sm" className="ml-2" onClick={async () => {
                    try {
                        await deleteUserWithRole({ userId: userToDelete.id });
                        toast.success(`User ${userToDelete.email} deleted.`);
                        
                        // --- NEW: Log the audit event ---
                        await logAuditEvent('user_deleted', currentUser.uid, currentUser.email, {
                            deletedUserId: userToDelete.id,
                            deletedUserEmail: userToDelete.email,
                        });

                        fetchUsersAndRoles();
                    } catch (err) {
                        toast.error("Failed to delete user.");
                    }
                    toast.dismiss(t.id);
                }}>
                    Delete
                </Button>
                <Button variant="secondary" size="sm" className="ml-2" onClick={() => toast.dismiss(t.id)}>
                    Cancel
                </Button>
            </span>
        ), { icon: 'âš ï¸' });
    };

    return (
        <div className="space-y-8">
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4 flex items-center"><User size={24} className="mr-2 text-blue-400"/> Add New Staff User</h3>
                <form onSubmit={handleAddStaff} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <Input label="Staff Email" type="email" value={newStaffUser.email} onChange={(e) => setNewStaffUser({...newStaffUser, email: e.target.value})} required />
                    <Input label="Password" type="password" value={newStaffUser.password} onChange={(e) => setNewStaffUser({...newStaffUser, password: e.target.value})} required />
                    <Dropdown label="Role" value={newStaffUser.role} onChange={(e) => setNewStaffUser({...newStaffUser, role: e.target.value})} options={allRoles.filter(r => r.name !== 'Client')} placeholder="Select a role..." required />
                    <Button type="submit" disabled={addingUser} className="md:col-span-3">
                        {addingUser ? 'Adding...' : 'Add Staff User'}
                    </Button>
                </form>
            </div>
            
            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4 flex items-center"><Building size={24} className="mr-2 text-green-400"/> Add New Client User</h3>
                <form onSubmit={handleAddClient} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <Input label="Company Name" value={newClientUser.companyName} onChange={(e) => setNewClientUser({...newClientUser, companyName: e.target.value})} required />
                    <Input label="Client Email" type="email" value={newClientUser.email} onChange={(e) => setNewClientUser({...newClientUser, email: e.target.value})} required />
                    <Input label="Password" type="password" value={newClientUser.password} onChange={(e) => setNewClientUser({...newClientUser, password: e.target.value})} required />
                    <Input label="Discount (%)" type="number" value={newClientUser.discountPercentage} onChange={(e) => setNewClientUser({...newClientUser, discountPercentage: e.target.value})} placeholder="0" min="0" max="100"/>
                    <Button type="submit" disabled={addingUser} className="md:col-span-4">
                        {addingUser ? 'Adding...' : 'Add Client User'}
                    </Button>
                </form>
            </div>

            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4">Existing Users</h3>
                {error && <div className="p-3 bg-red-800 text-red-100 rounded-lg text-center mb-4">{error}</div>}
                <div className="overflow-x-auto">
                    <table className="w-full text-left" aria-label="User Management Table">
                        <thead>
                            <tr className="border-b border-gray-600">
                                <th className="p-3 text-sm font-semibold text-gray-400">User / Company</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Role</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Discount</th>
                                <th className="p-3 text-sm font-semibold text-gray-400">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {loading ? (
                                <tr><td colSpan={4} className="text-center p-8 text-gray-400">Loading users...</td></tr>
                            ) : users.map(user => (
                                <tr key={user.id} className="border-b border-gray-700">
                                    <td className="p-3 text-gray-200">
                                        <div className="flex items-center gap-2 font-semibold">
                                            {user.role === 'Client' ? <Building size={16} className="text-gray-500"/> : <User size={16} className="text-gray-500"/>}
                                            {editingUserId === user.id 
                                                ? <Input value={editingUserCompany} onChange={(e) => setEditingUserCompany(e.target.value)} placeholder="Company Name" aria-label={`Editing company name for ${user.email}`}/>
                                                : (user.companyName || user.email)
                                            }
                                        </div>
                                        {user.role === 'Client' && <p className="text-xs text-gray-400 ml-8">{user.email}</p>}
                                    </td>
                                    <td className="p-3">
                                        {editingUserId === user.id ? (
                                            <Dropdown value={editingUserRole} onChange={(e) => setEditingUserRole(e.target.value)} options={allRoles} className="w-full" aria-label={`Editing role for ${user.email}`} />
                                        ) : (
                                            <span className="flex items-center gap-2 text-gray-300">
                                                <Shield size={16} className="text-gray-500"/>
                                                {user.role}
                                            </span>
                                        )}
                                    </td>
                                    <td className="p-3">
                                        {editingUserId === user.id ? (
                                            <Input type="number" value={editingUserDiscount} onChange={(e) => setEditingUserDiscount(e.target.value)} placeholder="0" min="0" max="100" aria-label={`Editing discount for ${user.email}`} />
                                        ) : (
                                            <span className="flex items-center gap-2 text-gray-300">
                                                <Percent size={16} className="text-gray-500"/>
                                                {(user.discountPercentage || 0).toFixed(0)}%
                                            </span>
                                        )}
                                    </td>
                                    <td className="p-3 flex space-x-2">
                                        {editingUserId === user.id ? (
                                            <>
                                                <Button variant="primary" onClick={() => handleUpdateUser(user.id)} className="py-1 px-3 text-xs" aria-label={`Save changes for ${user.email}`}>Save</Button>
                                                <Button variant="secondary" onClick={handleCancelEdit} className="py-1 px-3 text-xs" aria-label={`Cancel editing for ${user.email}`}>Cancel</Button>
                                            </>
                                        ) : (
                                            <>
                                                <Button variant="secondary" onClick={() => handleEditUser(user)} className="py-1 px-3 text-xs" aria-label={`Edit user ${user.email}`}><Edit size={16} className="mr-1"/> Edit</Button>
                                                <Button variant="danger" onClick={() => handleDeleteUser(user)} className="py-1 px-3 text-xs" aria-label={`Delete user ${user.email}`}><Trash2 size={16} className="mr-1"/> Delete</Button>
                                            </>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

export default UserManagementPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\pages\ValuationPage.jsx
==================================================
// src/pages/ValuationPage.jsx (UPDATED)

import React, { useState, useEffect, useMemo } from 'react';
import Input from '../components/ui/Input';
import Button from '../components/ui/Button';
import { getProducts, getCompletedJobsInRange, getEmployees, getOverheadCategories, getOverheadExpenses, listenToJobCards, getJobStepDetails, getAllInventoryItems } from '../api/firestore';
import { DollarSign, TrendingUp, Package, Percent, Calculator } from 'lucide-react';
import WorkforceCapacityPlanner from '../components/intelligence/WorkforceCapacityPlanner';
import ProfitTargetMatrix from '../components/intelligence/ProfitTargetMatrix';
import RoiCalculator from '../components/intelligence/RoiCalculator';

const ValuationKpiCard = ({ icon, title, value, color }) => (
  <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 flex items-start space-x-4">
    <div className={`p-3 rounded-full ${color}`}>{icon}</div>
    <div>
      <p className="text-gray-400 text-sm">{title}</p>
      <p className="text-3xl font-bold text-white">{value}</p>
    </div>
  </div>
);

const ValuationPage = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  // Data States
  const [allProducts, setAllProducts] = useState([]);
  const [allEmployees, setAllEmployees] = useState([]);
  const [allOverheadExpenses, setAllOverheadExpenses] = useState([]);
  const [allJobs, setAllJobs] = useState([]);
  const [allRecipes, setAllRecipes] = useState([]);
  const [allInventoryItems, setAllInventoryItems] = useState([]); // <-- NEW STATE for inventory
  const [isRoiModalOpen, setIsRoiModalOpen] = useState(false);

  // States for historical period analysis
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');
  const [periodJobs, setPeriodJobs] = useState(null);

  useEffect(() => {
    const fetchStaticData = async () => {
      setLoading(true);
      try {
        const [products, employees, overheadCats, recipes, inventory] = await Promise.all([
          getProducts(), 
          getEmployees(), 
          getOverheadCategories(), 
          getJobStepDetails(),
          getAllInventoryItems() // <-- FETCH INVENTORY
        ]);
        setAllProducts(products);
        setAllEmployees(employees);
        setAllRecipes(recipes);
        setAllInventoryItems(inventory); // <-- SET INVENTORY
        
        const expensePromises = overheadCats.map(cat => getOverheadExpenses(cat.id));
        const expenseResults = await Promise.all(expensePromises);
        setAllOverheadExpenses(expenseResults.flat());

        const unsubscribe = listenToJobCards((jobs) => {
            setAllJobs(jobs);
            setLoading(false);
        });
        return unsubscribe;

      } catch (err) {
        console.error("Error fetching static data:", err);
        setError("Failed to load foundational data.");
        setLoading(false);
      }
    };
    
    const unsubscribePromise = fetchStaticData();
    return () => {
        unsubscribePromise.then(unsubscribe => {
            if (unsubscribe) unsubscribe();
        });
    };
  }, []);

  const handleCalculateAnalysis = async () => {
    if (!startDate || !endDate) {
      setError("Please select both a start and end date.");
      return;
    }
    const startDateTime = new Date(startDate);
    const endDateTime = new Date(endDate);
    endDateTime.setHours(23, 59, 59, 999);

    const filteredJobs = allJobs.filter(job => {
        const completedDate = job.completedAt?.toDate();
        return job.status === 'Complete' && completedDate >= startDateTime && completedDate <= endDateTime;
    });
    setPeriodJobs(filteredJobs);
  };
  
  const masterFinancials = useMemo(() => {
    const productsMap = new Map(allProducts.map(p => [p.id, p]));
    const allCompletedJobs = allJobs.filter(j => j.status === 'Complete');

    let totalSales = 0;
    let totalMaterialCost = 0;
    allCompletedJobs.forEach(job => {
        const product = productsMap.get(job.partId);
        if (product && typeof product.sellingPrice === 'number') {
            totalSales += product.sellingPrice;
        }
        totalMaterialCost += job.materialCost || 0;
    });

    const historicalGrossMargin = totalSales > 0 ? ((totalSales - totalMaterialCost) / totalSales) * 100 : 35;
    const totalFixedCosts = allOverheadExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
    const totalMonthlyLabor = allEmployees.reduce((sum, emp) => sum + ((emp.hourlyRate || 0) * 173.2), 0);
    const totalMonthlyFixedCosts = totalFixedCosts + totalMonthlyLabor;

    const totalHourlyRate = allEmployees.reduce((sum, emp) => sum + (emp.hourlyRate || 0), 0);
    const avgDirectRate = allEmployees.length > 0 ? totalHourlyRate / allEmployees.length : 0;
    const overheadCostPerHour = allOverheadExpenses.length > 0 && allEmployees.length > 0 ? totalFixedCosts / (allEmployees.length * 173.2) : 0;
    const averageBurdenedRate = avgDirectRate + overheadCostPerHour;

    const employeesWithPerformance = allEmployees.map(emp => {
      const empJobs = allCompletedJobs.filter(job => job.employeeId === emp.id && job.status === 'Complete');
      if (empJobs.length === 0) return { ...emp, efficiency: 100 };
      
      let totalEfficiencyRatio = 0, jobsWithTime = 0;
      empJobs.forEach(job => {
        if (job.estimatedTime > 0 && job.startedAt && job.completedAt) {
          const durationSeconds = (job.completedAt.seconds - job.startedAt.seconds) - (job.totalPausedMilliseconds / 1000 || 0);
          if (durationSeconds > 0) {
            totalEfficiencyRatio += ((job.estimatedTime * 60) / durationSeconds);
            jobsWithTime++;
          }
        }
      });
      const avgEfficiency = jobsWithTime > 0 ? (totalEfficiencyRatio / jobsWithTime) * 100 : 100;
      return { ...emp, efficiency: avgEfficiency };
    });

    return { totalFixedCosts: totalMonthlyFixedCosts, historicalGrossMargin, employeesWithPerformance, averageBurdenedRate };
  }, [allProducts, allEmployees, allJobs, allOverheadExpenses]);

  const historicalPeriodAnalysis = useMemo(() => {
    if (!periodJobs) return null;

    let totalSales = 0;
    let totalCogs = 0;
    const productsMap = new Map(allProducts.map(p => [p.id, p]));

    periodJobs.forEach(job => {
        const product = productsMap.get(job.partId);
        if (product && typeof product.sellingPrice === 'number') {
            totalSales += product.sellingPrice;
        }
        if (typeof job.totalCost === 'number') totalCogs += job.totalCost;
    });

    const grossProfit = totalSales - totalCogs;
    const grossProfitMargin = totalSales > 0 ? (grossProfit / totalSales) * 100 : 0;
    
    return { totalSales, totalCogs, grossProfit, grossProfitMargin };
  }, [periodJobs, allProducts]);


  if (loading) return <p>Loading Financials & Planning...</p>

  return (
    <>
        <div className="space-y-8">
            <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold text-white">Financials & Planning</h2>
                <Button onClick={() => setIsRoiModalOpen(true)} variant="secondary">
                    <Calculator size={18} className="mr-2"/>
                    ROI Calculator
                </Button>
            </div>

            <ProfitTargetMatrix 
                totalFixedCosts={masterFinancials.totalFixedCosts}
                historicalGrossMargin={masterFinancials.historicalGrossMargin}
            />
            
            <WorkforceCapacityPlanner 
                realEmployees={masterFinancials.employeesWithPerformance}
                jobs={allJobs}
            />

            <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 className="text-xl font-bold text-white mb-4">Historical Performance Analysis</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-4">
                <Input label="Start Date" type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} />
                <Input label="End Date" type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} />
                <Button onClick={handleCalculateAnalysis} disabled={loading || !startDate || !endDate}>
                    Analyze Period
                </Button>
                </div>
                {error && <p className="text-red-400 text-center">{error}</p>}
            </div>

            {historicalPeriodAnalysis && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
                    <ValuationKpiCard icon={<DollarSign size={24} />} title="Total Revenue" value={`R ${historicalPeriodAnalysis.totalSales.toFixed(2)}`} color="bg-green-500/20 text-green-400" />
                    <ValuationKpiCard icon={<DollarSign size={24} />} title="Total COGS" value={`R ${historicalPeriodAnalysis.totalCogs.toFixed(2)}`} color="bg-red-500/20 text-red-400" />
                    <ValuationKpiCard icon={<Percent size={24} />} title="Gross Profit Margin" value={`${historicalPeriodAnalysis.grossProfitMargin.toFixed(1)}%`} color={historicalPeriodAnalysis.grossProfitMargin >= 0 ? "bg-teal-500/20 text-teal-400" : "bg-red-500/20 text-red-400"} />
                </div>
            )}
        </div>
        
        {isRoiModalOpen && (
            <RoiCalculator 
                onClose={() => setIsRoiModalOpen(false)}
                averageBurdenedRate={masterFinancials.averageBurdenedRate}
                allProducts={allProducts}
                allRecipes={allRecipes}
                inventoryItems={allInventoryItems}
            />
        )}
    </>
  );
};

export default ValuationPage;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\utils\jobUtils.js
==================================================
// src/utils/jobUtils.js

import { CATALYST_RULES } from '../config';

/**
 * Processes raw recipe consumables into a display-friendly format, calculating catalyst additions.
 * This centralized function ensures consistent consumable processing across the app.
 * @param {Array} consumablesFromRecipe - The raw consumables array from a job or recipe.
 * @param {Array} allInventoryItems - The master list of all inventory items.
 * @param {number} temperature - The current temperature for catalyst calculation.
 * @returns {Array} A list of processed consumables ready for display or costing.
 */
export const processConsumables = (consumablesFromRecipe, allInventoryItems, temperature) => {
    if (!consumablesFromRecipe || !Array.isArray(consumablesFromRecipe)) return [];

    const processedList = [];
    const catalystItem = allInventoryItems.find(c => c.name.toLowerCase().includes('catalyst') || c.name.toLowerCase().includes('hardener'));

    for (const consumable of consumablesFromRecipe) {
        const masterItem = allInventoryItems.find(c => c.id === (consumable.itemId || consumable.id));
        const itemDetails = masterItem || consumable;
        if (!itemDetails) continue;

        if (consumable.type === 'fixed') {
            processedList.push({ ...itemDetails, quantity: consumable.quantity, notes: '' });
            if (itemDetails.requiresCatalyst && catalystItem && temperature) {
                let percentage = 0;
                for (const rule of CATALYST_RULES) {
                    if (temperature <= rule.temp_max) {
                        percentage = rule.percentage;
                        break;
                    }
                }
                if (percentage > 0) {
                    const calculatedQty = consumable.quantity * (percentage / 100);
                    processedList.push({ ...catalystItem, quantity: calculatedQty, notes: `(Auto-added at ${percentage}% for ${temperature}Â°C)` });
                }
            }
        } else if (consumable.type === 'dimensional') {
            processedList.push({ ...itemDetails, cuts: consumable.cuts, notes: `See ${consumable.cuts.length} cutting instruction(s)` });
        } else if (!consumable.type && consumable.quantity) {
            processedList.push({ ...itemDetails, notes: '' });
        }
    }
    return processedList;
};

/**
 * Calculates the duration of a job, accounting for pauses.
 * @param {Object} job - The job object from Firestore.
 * @param {number} currentTime - The current time (Date.now()) for live calculation.
 * @returns {{text: string, totalMinutes: number} | null} - The formatted duration and total minutes, or null.
 */
export const calculateJobDuration = (job, currentTime) => {
    if (!job.startedAt) return null;

    let durationSeconds;
    const startTime = job.startedAt.seconds * 1000;
    const pausedMilliseconds = job.totalPausedMilliseconds || 0;

    if (['Complete', 'Awaiting QC', 'Issue', 'Archived - Issue'].includes(job.status)) {
        if (!job.completedAt) return null;
        durationSeconds = (job.completedAt.seconds * 1000 - startTime - pausedMilliseconds) / 1000;
    } else if (job.status === 'In Progress') {
        durationSeconds = (currentTime - startTime - pausedMilliseconds) / 1000;
    } else if (job.status === 'Paused' && job.pausedAt) {
        durationSeconds = (job.pausedAt.seconds * 1000 - startTime - pausedMilliseconds) / 1000;
    } else {
        return null;
    }
    
    if (durationSeconds < 0) return null;

    const totalMinutes = durationSeconds / 60;
    const hours = Math.floor(totalMinutes / 60);
    const minutes = Math.floor(totalMinutes % 60);
    
    let text = '';
    if (hours > 0) text += `${hours}h `;
    text += `${minutes}m`;

    return { text, totalMinutes };
};



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\utils\jobUtils.test.js
==================================================
import { calculateJobDuration } from './jobUtils';

// Helper to create mock date objects from seconds for consistent testing
const createTimestamp = (seconds) => ({ seconds, toDate: () => new Date(seconds * 1000) });

describe('calculateJobDuration', () => {

    const MOCK_CURRENT_TIME = new Date('2025-07-07T16:00:00Z').getTime(); // A fixed point in time for live calculations

    test('should return null if job has not started', () => {
        const job = { status: 'Pending' };
        expect(calculateJobDuration(job, MOCK_CURRENT_TIME)).toBeNull();
    });

    test('should calculate duration for a simple completed job', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720360800), // 14:00:00 UTC
            completedAt: createTimestamp(1720364400) // 15:00:00 UTC
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('60m 0s');
        expect(duration.totalMinutes).toBe(60);
    });

    test('should calculate duration for an active "In Progress" job', () => {
        const job = {
            status: 'In Progress',
            startedAt: createTimestamp(1720366800) // 15:40:00 UTC
        };
        // MOCK_CURRENT_TIME is 16:00:00 UTC, so duration should be 20 minutes
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('20m 0s');
        expect(duration.totalMinutes).toBe(20);
    });

    test('should correctly subtract paused time from a completed job', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720360800), // 14:00:00 UTC
            completedAt: createTimestamp(1720364400), // 15:00:00 UTC
            totalPausedMilliseconds: 600000 // 10 minutes
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('50m 0s');
        expect(duration.totalMinutes).toBe(50);
    });
    
    test('should calculate duration correctly for a job that is currently paused', () => {
        const job = {
            status: 'Paused',
            startedAt: createTimestamp(1720364400), // 15:00:00 UTC
            pausedAt: createTimestamp(1720366200), // 15:30:00 UTC
            totalPausedMilliseconds: 0
        };
        const duration = calculateJobDuration(job, MOCK_CURRENT_TIME);
        expect(duration.text).toBe('30m 0s');
        expect(duration.totalMinutes).toBe(30);
    });

    test('should return null for jobs with inconsistent timestamps', () => {
        const job = {
            status: 'Complete',
            startedAt: createTimestamp(1720364400), // 15:00:00 UTC
            completedAt: createTimestamp(1720360800) // 14:00:00 UTC (completed before started)
        };
        expect(calculateJobDuration(job, MOCK_CURRENT_TIME)).toBeNull();
    });
});


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\App.css
==================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\App.jsx
==================================================
// src/App.jsx (UPDATED)
// Added the import and route for the new TimeAttendanceReportPage.

import React from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate, Outlet } from 'react-router-dom';
import { useAuth } from './contexts/AuthContext.jsx';

// Layouts & Guards
import ProtectedRoute from './components/layout/ProtectedRoute.jsx';
import RoleBasedRoute from './components/layout/RoleBasedRoute.jsx';
import MainLayout from './components/layout/MainLayout.jsx';
import CustomerLayout from './components/layout/CustomerLayout.jsx';

// Pages
import LoginPage from './pages/Login.jsx';
import DashboardPage from './pages/DashboardPage.jsx';
import JobCreatorPage from './pages/JobCreatorPage.jsx';
import LiveTrackingPage from './pages/LiveTrackingPage.jsx';
import ScannerPage from './pages/ScannerPage.jsx';
import QcPage from './pages/QcPage.jsx';
import IssuesPage from './pages/IssuesPage.jsx';
import PerformancePage from './pages/PerformancePage.jsx';
import EmployeeIntelligencePage from './pages/EmployeeIntelligencePage.jsx';
import ProductViabilityPage from './pages/ProductViabilityPage.jsx';
import SettingsPage from './pages/SettingsPage.jsx';
import ValuationPage from './pages/ValuationPage.jsx';
import CalendarPage from './pages/CalendarPage.jsx';
import MarketingPage from './pages/MarketingPage.jsx';
import QuotingPage from './pages/QuotingPage.jsx';
import JobCardAdjustmentPage from './pages/JobCardAdjustmentPage.jsx';
import SalesOrderPage from './pages/SalesOrderPage.jsx';
import PurchasingPage from './pages/PurchasingPage.jsx';
import StockTakePage from './pages/StockTakePage.jsx';
import AssetIntelligencePage from './pages/AssetIntelligencePage.jsx';
import ProductBrowserPage from './pages/ProductBrowserPage.jsx';
import CustomerDashboardPage from './pages/CustomerDashboardPage.jsx';
import CustomerOrderDetailPage from './pages/CustomerOrderDetailPage.jsx';
import JobHistoryPage from './pages/JobHistoryPage.jsx';
import ReworkQueuePage from './pages/ReworkQueuePage.jsx';
import MultiStageWizard from './pages/MultiStageWizard.jsx';
import StockAdjustmentPage from './pages/StockAdjustmentPage.jsx';
import JobReprintPage from './pages/JobReprintPage.jsx';
import KanbanPage from './pages/KanbanPage.jsx';
import PickingQueuePage from './pages/PickingQueuePage.jsx';
import FloorPlanPage from './pages/FloorPlanPage.jsx';
import AndonDisplayPage from './pages/AndonDisplayPage.jsx';
import TimeAttendanceReport from './pages/TimeAttendanceReport.jsx'; // <-- NEW IMPORT

const StaffLayout = () => (
    <MainLayout>
        <Outlet />
    </MainLayout>
);

const PortalLayout = () => (
    <RoleBasedRoute permission="access_portal">
        <CustomerLayout>
            <Outlet />
        </CustomerLayout>
    </RoleBasedRoute>
);

function App() {
    const { user, loading } = useAuth();

    if (loading) {
        return (
            <div className="bg-gray-900 min-h-screen flex items-center justify-center text-white">
                Loading Application...
            </div>
        );
    }

    return (
        <Router>
            <Routes>
                <Route path="/andon-display" element={<ProtectedRoute><AndonDisplayPage /></ProtectedRoute>} />

                {!user ? (
                    <>
                        <Route path="/login" element={<LoginPage />} />
                        <Route path="*" element={<Navigate to="/login" replace />} />
                    </>
                ) : user.role === 'Client' ? (
                    <Route path="/portal/*" element={<ProtectedRoute><PortalLayout /></ProtectedRoute>}>
                        <Route index element={<CustomerDashboardPage />} />
                        <Route path="products" element={<ProductBrowserPage />} />
                        <Route path="order/:orderId" element={<CustomerOrderDetailPage />} />
                        <Route path="*" element={<Navigate to="/portal" replace />} />
                    </Route>
                ) : (
                    <Route element={<ProtectedRoute><StaffLayout /></ProtectedRoute>}>
                        <Route path="/dashboard" element={<RoleBasedRoute permission="dashboard"><DashboardPage /></RoleBasedRoute>} />
                        <Route path="/tracking" element={<RoleBasedRoute permission="tracking"><LiveTrackingPage /></RoleBasedRoute>} />
                        <Route path="/scan" element={<RoleBasedRoute permission="scanner"><ScannerPage /></RoleBasedRoute>} />
                        <Route path="/qc" element={<RoleBasedRoute permission="qc"><QcPage /></RoleBasedRoute>} />
                        <Route path="/orders" element={<RoleBasedRoute permission="orders"><SalesOrderPage /></RoleBasedRoute>} />
                        <Route path="/purchasing" element={<RoleBasedRoute permission="purchasing"><PurchasingPage /></RoleBasedRoute>} />
                        <Route path="/stock-take" element={<RoleBasedRoute permission="stockTake"><StockTakePage /></RoleBasedRoute>} />
                        <Route path="/creator" element={<RoleBasedRoute permission="jobCreator"><JobCreatorPage /></RoleBasedRoute>} />
                        <Route path="/issues" element={<RoleBasedRoute permission="issues"><IssuesPage /></RoleBasedRoute>} />
                        <Route path="/performance" element={<RoleBasedRoute permission="performance"><PerformancePage /></RoleBasedRoute>} />
                        <Route path="/employee/:employeeId" element={<RoleBasedRoute permission="performance"><EmployeeIntelligencePage /></RoleBasedRoute>} />
                        <Route path="/profitability" element={<RoleBasedRoute permission="profitability"><ProductViabilityPage /></RoleBasedRoute>} />
                        <Route path="/valuation" element={<RoleBasedRoute permission="valuation"><ValuationPage /></RoleBasedRoute>} />
                        <Route path="/calendar" element={<RoleBasedRoute permission="calendar"><CalendarPage /></RoleBasedRoute>} />
                        <Route path="/kanban" element={<RoleBasedRoute permission="kanban"><KanbanPage /></RoleBasedRoute>} />
                        <Route path="/picking-queue" element={<RoleBasedRoute permission="picking"><PickingQueuePage /></RoleBasedRoute>} />
                        <Route path="/floorplan" element={<RoleBasedRoute permission="floorplan"><FloorPlanPage /></RoleBasedRoute>} />
                        <Route path="/settings" element={<RoleBasedRoute permission="settings"><SettingsPage /></RoleBasedRoute>} />
                        <Route path="/marketing" element={<RoleBasedRoute permission="marketing"><MarketingPage /></RoleBasedRoute>} />
                        <Route path="/quotes" element={<RoleBasedRoute permission="quotes"><QuotingPage /></RoleBasedRoute>} />
                        <Route path="/adjustment" element={<RoleBasedRoute permission="adjustment"><JobCardAdjustmentPage /></RoleBasedRoute>} />
                        <Route path="/assets" element={<RoleBasedRoute permission="assets"><AssetIntelligencePage /></RoleBasedRoute>} />
                        <Route path="/job-history" element={<RoleBasedRoute permission="jobHistory"><JobHistoryPage /></RoleBasedRoute>} />
                        <Route path="/rework-queue" element={<RoleBasedRoute permission="reworkQueue"><ReworkQueuePage /></RoleBasedRoute>} />
                        <Route path="/multi-stage-wizard" element={<RoleBasedRoute permission="multiStage"><MultiStageWizard /></RoleBasedRoute>} />
                        <Route path="/stock-adjust" element={<RoleBasedRoute permission="stockAdjust"><StockAdjustmentPage /></RoleBasedRoute>} />
                        <Route path="/job-reprint" element={<RoleBasedRoute permission="jobReprint"><JobReprintPage /></RoleBasedRoute>} />
                        {/* --- NEW ROUTE --- */}
                        <Route path="/time-attendance" element={<RoleBasedRoute permission="performance"><TimeAttendanceReport /></RoleBasedRoute>} />
                        <Route path="*" element={<Navigate to="/dashboard" replace />} />
                    </Route>
                )}
            </Routes>
        </Router>
    );
}

export default App;



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\config.js
==================================================
// src/config.js

/**
 * Defines the rules for calculating the percentage of catalyst needed based on ambient temperature.
 * This central configuration makes it easy to adjust business rules without changing component logic.
 */
export const CATALYST_RULES = [
    { temp_max: 18, percentage: 3.0 },
    { temp_max: 28, percentage: 2.0 },
    { temp_max: 100, percentage: 1.0 }
];


==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\index.css
==================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

/* --- GLOBAL DARK THEME BACKGROUND --- */
/* Ensure the html, body, and the main React root element (#root) are dark */
html, body, #root {
  height: 100%; /* Ensure they take full height */
  background-color: #111827; /* Tailwind's gray-900 */
}


/* --- Dropdown options dark background and white text --- */
select option {
  background-color: #374151; /* This is Tailwind's gray-700 */
  color: #ffffff;
}

/* --- Hide the default spinner buttons on number inputs --- */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
  -webkit-appearance: none; 
  margin: 0; 
}
input[type=number] {
  -moz-appearance: textfield; /* For Firefox */
}



==================================================
FILE: C:\Development\TOJEM-OS\tojem-os\src\main.jsx
==================================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import './index.css';
import { AuthProvider } from './contexts/AuthContext.jsx';
import './api/firebase.js';
import { Toaster } from 'react-hot-toast'; // --- 1. IMPORT Toaster

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <AuthProvider>
      {/* --- 2. ADD Toaster component here --- */}
      <Toaster 
        position="top-center"
        reverseOrder={false}
        toastOptions={{
          className: '',
          style: {
            background: '#333',
            color: '#fff',
          },
        }}
      />
      <App />
    </AuthProvider>
  </React.StrictMode>
);

