rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions for Roles ---
    function isAuth() {
      return request.auth != null;
    }
    
    function isManager() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Manager';
    }

    function isClient() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Client';
    }

    // --- Core System Collections ---
    match /users/{userId} {
      allow read: if isAuth() && (request.auth.uid == userId || isManager());
      allow write: if isManager();
    }
    match /roles/{roleId} {
      allow read: if isAuth();
      allow write: if isManager();
    }
    match /scanEvents/{eventId} {
      allow read, update, delete: if false;
      allow create: if isAuth();
    }
    match /notifications/{notificationId} {
      allow read: if isAuth() && resource.data.targetRole == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      allow update: if isAuth();
      allow create, delete: if false;
    }
    
    // --- NEW: Rule for Audit Logging ---
    match /auditLogs/{logId} {
      allow create: if isAuth(); // Any signed-in user can create a log of their actions
      allow read, update, delete: if isManager(); // Only managers can review the logs
    }
    
    // --- Production & Workshop Collections ---
    match /createdJobCards/{jobId} {
      allow read: if isAuth(); // Allows clients to read jobs linked to their order
      allow create, update, delete: if isManager();
    }
    match /jobStepDetails/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /productRecipeLinks/{docId} { allow read: if isAuth(); allow write: if isManager(); }

    // --- Rules for Catalog Data Dropdowns ---
    match /productCategories/{docId} { allow read, write: if isAuth(); }
    match /makes/{docId} { allow read, write: if isAuth(); }
    match /models/{docId} { allow read, write: if isAuth(); }
    match /units/{docId} { allow read, write: if isAuth(); }

    // --- Supply Chain Collections ---
    match /inventoryItems/{itemId} {
      allow read: if isAuth();
      allow write: if isManager();
    }
    match /purchaseQueue/{docId} { allow read, write: if isAuth(); }
    match /suppliers/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /supplierItemPricing/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /oneOffPurchases/{docId} { allow read, write: if isAuth(); }
    match /pickingLists/{docId} { allow read, write: if isAuth(); }
    
    match /consignmentStock/{stockId} {
      allow read: if isManager() || (isClient() && resource.data.clientId == request.auth.uid);
      allow create: if isManager(); // Managers can add new items
      allow update: if isAuth(); // Clients and managers can update counts
      allow delete: if isManager();
    }
    
    match /stockTakeSessions/{sessionId} {
      allow read, create, update: if isAuth();
    }

    // --- Company & Staff Collections ---
    match /employees/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /departments/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /skills/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /skillHistory/{docId} { allow read, write: if isAuth(); }
    match /tools/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /toolAccessories/{docId} { allow read: if isAuth(); allow write: if isManager(); }

    // --- Sales & Customer Collections ---
    match /salesOrders/{orderId} {
      // --- FIX: This rule allows clients to query for their own orders on the dashboard ---
      allow get: if isManager() || (isClient() && resource.data.customerEmail == request.auth.token.email);
      allow list: if isManager() || (isClient() && request.query.where[0][2] == request.auth.token.email);
      allow write: if isManager();
    }
    match /quotes/{docId} { allow read, write: if isManager(); }
    match /marketingCampaigns/{docId} { allow read, write: if isManager(); }
    match /customerFeedback/{feedbackId} {
      allow create: if isClient();
      allow read: if isManager();
    }

    // --- Administration & BI Collections ---
    match /overheadsCategories/{docId=**} { allow read, write: if isManager(); }
    match /historicalSales/{docId} { allow read, write: if isManager(); }
    match /dailyWorkLogs/{docId} { allow read: if isManager(); allow write: if false; }
    match /employeeDailyLogs/{docId} { allow read: if isManager(); allow write: if false; }
    
    // --- KAIZEN, PRAISE, TRAINING ---
    match /kaizenSuggestions/{docId} { allow create: if isAuth(); allow read, update, delete: if isManager(); }
    match /praise/{docId} { allow create: if isAuth(); allow read: if isAuth(); allow update, delete: if isManager(); }
    match /trainingResources/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    
    // --- Rule for Learning Paths ---
    match /learningPaths/{pathId} {
      allow read: if isAuth();
      allow write: if isManager();
    }
    
    // --- OTHER ---
    match /reworkReasons/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /routineTasks/{docId} { allow read: if isAuth(); allow write: if isManager(); }
    match /routineTaskCompletions/{completionId} {
      allow read, create: if isAuth();
      allow update, delete: if false;
    }
    match /systemStatus/{docId} { allow read: if isAuth(); allow write: if false; }
    match /subcontractorAdHocLogs/{docId} { allow read, write: if isManager(); }
    match /subcontractorTeamLogs/{docId} { allow read, write: if isManager(); }
  }
}